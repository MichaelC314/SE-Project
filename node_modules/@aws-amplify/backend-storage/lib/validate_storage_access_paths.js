import { AmplifyUserError } from '@aws-amplify/platform-core';
import { entityIdPathToken } from './constants.js';
/**
 * Validate that the storage path record keys match our conventions and restrictions.
 * If all of the paths are valid, this function is a noop.
 * If some path is invalid, an error is thrown with details
 */
export const validateStorageAccessPaths = (storagePaths) => {
    storagePaths.forEach(validateStoragePath);
};
const validateStoragePath = (path, index, allPaths) => {
    if (path.startsWith('/')) {
        throw new AmplifyUserError('InvalidStorageAccessPathError', {
            message: `Storage access paths must not start with "/". Found [${path}].`,
            resolution: 'Update all paths to match the format requirements.',
        });
    }
    if (!path.endsWith('/*')) {
        throw new AmplifyUserError('InvalidStorageAccessPathError', {
            message: `Storage access paths must end with "/*". Found [${path}].`,
            resolution: 'Update all paths to match the format requirements.',
        });
    }
    if (path.includes('//')) {
        throw new AmplifyUserError('InvalidStorageAccessPathError', {
            message: `Path cannot contain "//". Found [${path}].`,
            resolution: 'Update all paths to match the format requirements.',
        });
    }
    if (path.indexOf('*') < path.length - 1) {
        throw new AmplifyUserError('InvalidStorageAccessPathError', {
            message: `Wildcards are only allowed as the final part of a path. Found [${path}].`,
            resolution: 'Remove all wildcards that are not the final part of the path.',
        });
    }
    /**
     * For any path, at most one other path can be a prefix of that path
     *
     * For example, consider an access definition with the following paths defined:
     * /foo/* - OK (0 other paths are a prefix of this one)
     * /foo/bar/* - OK (1 other path is a prefix of this one)
     * /foo/bar/baz/* - NOT OK (2 other paths are a prefix of this one (/foo and /foo/bar))
     * /foo/baz/* - OK (1 other path is a prefix of this one)
     */
    const otherPrefixes = getPrefixes(path, allPaths);
    if (otherPrefixes.length > 1) {
        throw new AmplifyUserError('InvalidStorageAccessPathError', {
            message: `For any given path, only one other path can be a prefix of it. Found [${path}] which has prefixes [${otherPrefixes.join(', ')}].`,
            resolution: `Update the storage access paths such that any given path has at most one other path that is a prefix.`,
        });
    }
    validateOwnerTokenRules(path, otherPrefixes);
};
/**
 * Extra validations that are only necessary if the path includes an owner token
 */
const validateOwnerTokenRules = (path, otherPrefixes) => {
    // if there's no owner token in the path, this validation is a noop
    if (!path.includes(entityIdPathToken)) {
        return;
    }
    if (otherPrefixes.length > 0) {
        throw new AmplifyUserError('InvalidStorageAccessPathError', {
            message: `A path cannot be a prefix of another path that contains the ${entityIdPathToken} token.`,
            details: `Found [${path}] which has prefixes [${otherPrefixes.join(', ')}].`,
            resolution: `Update the storage access paths such that any given path has at most one other path that is a prefix.`,
        });
    }
    const ownerSplit = path.split(entityIdPathToken);
    if (ownerSplit.length > 2) {
        throw new AmplifyUserError('InvalidStorageAccessPathError', {
            message: `The ${entityIdPathToken} token can only appear once in a path. Found [${path}]`,
            resolution: `Remove all but one occurrence of the ${entityIdPathToken} token`,
        });
    }
    const [substringBeforeOwnerToken, substringAfterOwnerToken] = ownerSplit;
    if (substringAfterOwnerToken !== '/*') {
        throw new AmplifyUserError('InvalidStorageAccessPathError', {
            message: `The ${entityIdPathToken} token must be the path part right before the ending wildcard. Found [${path}].`,
            resolution: `Update the path such that the owner token is the last path part before the ending wildcard. For example: "foo/bar/${entityIdPathToken}/*.`,
        });
    }
    if (substringBeforeOwnerToken === '') {
        throw new AmplifyUserError('InvalidStorageAccessPathError', {
            message: `The ${entityIdPathToken} token must not be the first path part. Found [${path}].`,
            resolution: `Add an additional prefix to the path. For example: "foo/${entityIdPathToken}/*.`,
        });
    }
    if (!substringBeforeOwnerToken.endsWith('/')) {
        throw new AmplifyUserError('InvalidStorageAccessPathError', {
            message: `A path part that includes the ${entityIdPathToken} token cannot include any other characters. Found [${path}].`,
            resolution: `Remove all other characters from the path part with the ${entityIdPathToken} token. For example: "foo/${entityIdPathToken}/*"`,
        });
    }
};
/**
 * Returns a subset of paths where each element is a prefix of path
 * Equivalent paths are NOT considered prefixes of each other (mainly just for simplicity of the calling logic)
 */
const getPrefixes = (path, paths, treatWildcardAsLiteral = false) => paths.filter((p) => path !== p &&
    path.startsWith(treatWildcardAsLiteral ? p : p.replaceAll('*', '')));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGVfc3RvcmFnZV9hY2Nlc3NfcGF0aHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdmFsaWRhdGVfc3RvcmFnZV9hY2Nlc3NfcGF0aHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDOUQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHbkQ7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxNQUFNLDBCQUEwQixHQUFHLENBQUMsWUFBc0IsRUFBRSxFQUFFO0lBQ25FLFlBQVksQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUM1QyxDQUFDLENBQUM7QUFFRixNQUFNLG1CQUFtQixHQUFHLENBQzFCLElBQVksRUFDWixLQUFhLEVBQ2IsUUFBa0IsRUFDbEIsRUFBRTtJQUNGLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUN4QixNQUFNLElBQUksZ0JBQWdCLENBQWUsK0JBQStCLEVBQUU7WUFDeEUsT0FBTyxFQUFFLHdEQUF3RCxJQUFJLElBQUk7WUFDekUsVUFBVSxFQUFFLG9EQUFvRDtTQUNqRSxDQUFDLENBQUM7S0FDSjtJQUNELElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ3hCLE1BQU0sSUFBSSxnQkFBZ0IsQ0FBZSwrQkFBK0IsRUFBRTtZQUN4RSxPQUFPLEVBQUUsbURBQW1ELElBQUksSUFBSTtZQUNwRSxVQUFVLEVBQUUsb0RBQW9EO1NBQ2pFLENBQUMsQ0FBQztLQUNKO0lBRUQsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ3ZCLE1BQU0sSUFBSSxnQkFBZ0IsQ0FBZSwrQkFBK0IsRUFBRTtZQUN4RSxPQUFPLEVBQUUsb0NBQW9DLElBQUksSUFBSTtZQUNyRCxVQUFVLEVBQUUsb0RBQW9EO1NB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R0FBRyxDQUNsQixJQUFZLEVBQ1osS0FBZSxFQUNmLHNCQUFzQixHQUFHLEtBQUssRUFDcEIsRUFBRSxDQUNaLEtBQUssQ0FBQyxNQUFNLENBQ1YsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUNKLElBQUksS0FBSyxDQUFDO0lBQ1YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUN0RSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQW1wbGlmeVVzZXJFcnJvciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7IGVudGl0eUlkUGF0aFRva2VuIH0gZnJvbSAnLi9jb25zdGFudHMuanMnO1xuaW1wb3J0IHsgU3RvcmFnZUVycm9yIH0gZnJvbSAnLi9wcml2YXRlX3R5cGVzLmpzJztcblxuLyoqXG4gKiBWYWxpZGF0ZSB0aGF0IHRoZSBzdG9yYWdlIHBhdGggcmVjb3JkIGtleXMgbWF0Y2ggb3VyIGNvbnZlbnRpb25zIGFuZCByZXN0cmljdGlvbnMuXG4gKiBJZiBhbGwgb2YgdGhlIHBhdGhzIGFyZSB2YWxpZCwgdGhpcyBmdW5jdGlvbiBpcyBhIG5vb3AuXG4gKiBJZiBzb21lIHBhdGggaXMgaW52YWxpZCwgYW4gZXJyb3IgaXMgdGhyb3duIHdpdGggZGV0YWlsc1xuICovXG5leHBvcnQgY29uc3QgdmFsaWRhdGVTdG9yYWdlQWNjZXNzUGF0aHMgPSAoc3RvcmFnZVBhdGhzOiBzdHJpbmdbXSkgPT4ge1xuICBzdG9yYWdlUGF0aHMuZm9yRWFjaCh2YWxpZGF0ZVN0b3JhZ2VQYXRoKTtcbn07XG5cbmNvbnN0IHZhbGlkYXRlU3RvcmFnZVBhdGggPSAoXG4gIHBhdGg6IHN0cmluZyxcbiAgaW5kZXg6IG51bWJlcixcbiAgYWxsUGF0aHM6IHN0cmluZ1tdLFxuKSA9PiB7XG4gIGlmIChwYXRoLnN0YXJ0c1dpdGgoJy8nKSkge1xuICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yPFN0b3JhZ2VFcnJvcj4oJ0ludmFsaWRTdG9yYWdlQWNjZXNzUGF0aEVycm9yJywge1xuICAgICAgbWVzc2FnZTogYFN0b3JhZ2UgYWNjZXNzIHBhdGhzIG11c3Qgbm90IHN0YXJ0IHdpdGggXCIvXCIuIEZvdW5kIFske3BhdGh9XS5gLFxuICAgICAgcmVzb2x1dGlvbjogJ1VwZGF0ZSBhbGwgcGF0aHMgdG8gbWF0Y2ggdGhlIGZvcm1hdCByZXF1aXJlbWVudHMuJyxcbiAgICB9KTtcbiAgfVxuICBpZiAoIXBhdGguZW5kc1dpdGgoJy8qJykpIHtcbiAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcjxTdG9yYWdlRXJyb3I+KCdJbnZhbGlkU3RvcmFnZUFjY2Vzc1BhdGhFcnJvcicsIHtcbiAgICAgIG1lc3NhZ2U6IGBTdG9yYWdlIGFjY2VzcyBwYXRocyBtdXN0IGVuZCB3aXRoIFwiLypcIi4gRm91bmQgWyR7cGF0aH1dLmAsXG4gICAgICByZXNvbHV0aW9uOiAnVXBkYXRlIGFsbCBwYXRocyB0byBtYXRjaCB0aGUgZm9ybWF0IHJlcXVpcmVtZW50cy4nLFxuICAgIH0pO1xuICB9XG5cbiAgaWYgKHBhdGguaW5jbHVkZXMoJy8vJykpIHtcbiAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcjxTdG9yYWdlRXJyb3I+KCdJbnZhbGlkU3RvcmFnZUFjY2Vzc1BhdGhFcnJvcicsIHtcbiAgICAgIG1lc3NhZ2U6IGBQYXRoIGNhbm5vdCBjb250YWluIFwiLy9cIi4gRm91bmQgWyR7cGF0aH1dLmAsXG4gICAgICByZXNvbHV0aW9uOiAnVXBkYXRlIGFsbCBwYXRocyB0byBtYXRjaCB0aGUgZm9ybWF0IHJlcXVpcmVtZW50cy4nLFxuICAgIH0pO1xuICB9XG5cbiAgaWYgKHBhdGguaW5kZXhPZignKicpIDwgcGF0aC5sZW5ndGggLSAxKSB7XG4gICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3I8U3RvcmFnZUVycm9yPignSW52YWxpZFN0b3JhZ2VBY2Nlc3NQYXRoRXJyb3InLCB7XG4gICAgICBtZXNzYWdlOiBgV2lsZGNhcmRzIGFyZSBvbmx5IGFsbG93ZWQgYXMgdGhlIGZpbmFsIHBhcnQgb2YgYSBwYXRoLiBGb3VuZCBbJHtwYXRofV0uYCxcbiAgICAgIHJlc29sdXRpb246XG4gICAgICAgICdSZW1vdmUgYWxsIHdpbGRjYXJkcyB0aGF0IGFyZSBub3QgdGhlIGZpbmFsIHBhcnQgb2YgdGhlIHBhdGguJyxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGb3IgYW55IHBhdGgsIGF0IG1vc3Qgb25lIG90aGVyIHBhdGggY2FuIGJlIGEgcHJlZml4IG9mIHRoYXQgcGF0aFxuICAgKlxuICAgKiBGb3IgZXhhbXBsZSwgY29uc2lkZXIgYW4gYWNjZXNzIGRlZmluaXRpb24gd2l0aCB0aGUgZm9sbG93aW5nIHBhdGhzIGRlZmluZWQ6XG4gICAqIC9mb28vKiAtIE9LICgwIG90aGVyIHBhdGhzIGFyZSBhIHByZWZpeCBvZiB0aGlzIG9uZSlcbiAgICogL2Zvby9iYXIvKiAtIE9LICgxIG90aGVyIHBhdGggaXMgYSBwcmVmaXggb2YgdGhpcyBvbmUpXG4gICAqIC9mb28vYmFyL2Jhei8qIC0gTk9UIE9LICgyIG90aGVyIHBhdGhzIGFyZSBhIHByZWZpeCBvZiB0aGlzIG9uZSAoL2ZvbyBhbmQgL2Zvby9iYXIpKVxuICAgKiAvZm9vL2Jhei8qIC0gT0sgKDEgb3RoZXIgcGF0aCBpcyBhIHByZWZpeCBvZiB0aGlzIG9uZSlcbiAgICovXG4gIGNvbnN0IG90aGVyUHJlZml4ZXMgPSBnZXRQcmVmaXhlcyhwYXRoLCBhbGxQYXRocyk7XG4gIGlmIChvdGhlclByZWZpeGVzLmxlbmd0aCA+IDEpIHtcbiAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcjxTdG9yYWdlRXJyb3I+KCdJbnZhbGlkU3RvcmFnZUFjY2Vzc1BhdGhFcnJvcicsIHtcbiAgICAgIG1lc3NhZ2U6IGBGb3IgYW55IGdpdmVuIHBhdGgsIG9ubHkgb25lIG90aGVyIHBhdGggY2FuIGJlIGEgcHJlZml4IG9mIGl0LiBGb3VuZCBbJHtwYXRofV0gd2hpY2ggaGFzIHByZWZpeGVzIFske290aGVyUHJlZml4ZXMuam9pbihcbiAgICAgICAgJywgJyxcbiAgICAgICl9XS5gLFxuICAgICAgcmVzb2x1dGlvbjogYFVwZGF0ZSB0aGUgc3RvcmFnZSBhY2Nlc3MgcGF0aHMgc3VjaCB0aGF0IGFueSBnaXZlbiBwYXRoIGhhcyBhdCBtb3N0IG9uZSBvdGhlciBwYXRoIHRoYXQgaXMgYSBwcmVmaXguYCxcbiAgICB9KTtcbiAgfVxuXG4gIHZhbGlkYXRlT3duZXJUb2tlblJ1bGVzKHBhdGgsIG90aGVyUHJlZml4ZXMpO1xufTtcblxuLyoqXG4gKiBFeHRyYSB2YWxpZGF0aW9ucyB0aGF0IGFyZSBvbmx5IG5lY2Vzc2FyeSBpZiB0aGUgcGF0aCBpbmNsdWRlcyBhbiBvd25lciB0b2tlblxuICovXG5jb25zdCB2YWxpZGF0ZU93bmVyVG9rZW5SdWxlcyA9IChwYXRoOiBzdHJpbmcsIG90aGVyUHJlZml4ZXM6IHN0cmluZ1tdKSA9PiB7XG4gIC8vIGlmIHRoZXJlJ3Mgbm8gb3duZXIgdG9rZW4gaW4gdGhlIHBhdGgsIHRoaXMgdmFsaWRhdGlvbiBpcyBhIG5vb3BcbiAgaWYgKCFwYXRoLmluY2x1ZGVzKGVudGl0eUlkUGF0aFRva2VuKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmIChvdGhlclByZWZpeGVzLmxlbmd0aCA+IDApIHtcbiAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcjxTdG9yYWdlRXJyb3I+KCdJbnZhbGlkU3RvcmFnZUFjY2Vzc1BhdGhFcnJvcicsIHtcbiAgICAgIG1lc3NhZ2U6IGBBIHBhdGggY2Fubm90IGJlIGEgcHJlZml4IG9mIGFub3RoZXIgcGF0aCB0aGF0IGNvbnRhaW5zIHRoZSAke2VudGl0eUlkUGF0aFRva2VufSB0b2tlbi5gLFxuICAgICAgZGV0YWlsczogYEZvdW5kIFske3BhdGh9XSB3aGljaCBoYXMgcHJlZml4ZXMgWyR7b3RoZXJQcmVmaXhlcy5qb2luKFxuICAgICAgICAnLCAnLFxuICAgICAgKX1dLmAsXG4gICAgICByZXNvbHV0aW9uOiBgVXBkYXRlIHRoZSBzdG9yYWdlIGFjY2VzcyBwYXRocyBzdWNoIHRoYXQgYW55IGdpdmVuIHBhdGggaGFzIGF0IG1vc3Qgb25lIG90aGVyIHBhdGggdGhhdCBpcyBhIHByZWZpeC5gLFxuICAgIH0pO1xuICB9XG5cbiAgY29uc3Qgb3duZXJTcGxpdCA9IHBhdGguc3BsaXQoZW50aXR5SWRQYXRoVG9rZW4pO1xuXG4gIGlmIChvd25lclNwbGl0Lmxlbmd0aCA+IDIpIHtcbiAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcjxTdG9yYWdlRXJyb3I+KCdJbnZhbGlkU3RvcmFnZUFjY2Vzc1BhdGhFcnJvcicsIHtcbiAgICAgIG1lc3NhZ2U6IGBUaGUgJHtlbnRpdHlJZFBhdGhUb2tlbn0gdG9rZW4gY2FuIG9ubHkgYXBwZWFyIG9uY2UgaW4gYSBwYXRoLiBGb3VuZCBbJHtwYXRofV1gLFxuICAgICAgcmVzb2x1dGlvbjogYFJlbW92ZSBhbGwgYnV0IG9uZSBvY2N1cnJlbmNlIG9mIHRoZSAke2VudGl0eUlkUGF0aFRva2VufSB0b2tlbmAsXG4gICAgfSk7XG4gIH1cblxuICBjb25zdCBbc3Vic3RyaW5nQmVmb3JlT3duZXJUb2tlbiwgc3Vic3RyaW5nQWZ0ZXJPd25lclRva2VuXSA9IG93bmVyU3BsaXQ7XG5cbiAgaWYgKHN1YnN0cmluZ0FmdGVyT3duZXJUb2tlbiAhPT0gJy8qJykge1xuICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yPFN0b3JhZ2VFcnJvcj4oJ0ludmFsaWRTdG9yYWdlQWNjZXNzUGF0aEVycm9yJywge1xuICAgICAgbWVzc2FnZTogYFRoZSAke2VudGl0eUlkUGF0aFRva2VufSB0b2tlbiBtdXN0IGJlIHRoZSBwYXRoIHBhcnQgcmlnaHQgYmVmb3JlIHRoZSBlbmRpbmcgd2lsZGNhcmQuIEZvdW5kIFske3BhdGh9XS5gLFxuICAgICAgcmVzb2x1dGlvbjogYFVwZGF0ZSB0aGUgcGF0aCBzdWNoIHRoYXQgdGhlIG93bmVyIHRva2VuIGlzIHRoZSBsYXN0IHBhdGggcGFydCBiZWZvcmUgdGhlIGVuZGluZyB3aWxkY2FyZC4gRm9yIGV4YW1wbGU6IFwiZm9vL2Jhci8ke2VudGl0eUlkUGF0aFRva2VufS8qLmAsXG4gICAgfSk7XG4gIH1cblxuICBpZiAoc3Vic3RyaW5nQmVmb3JlT3duZXJUb2tlbiA9PT0gJycpIHtcbiAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcjxTdG9yYWdlRXJyb3I+KCdJbnZhbGlkU3RvcmFnZUFjY2Vzc1BhdGhFcnJvcicsIHtcbiAgICAgIG1lc3NhZ2U6IGBUaGUgJHtlbnRpdHlJZFBhdGhUb2tlbn0gdG9rZW4gbXVzdCBub3QgYmUgdGhlIGZpcnN0IHBhdGggcGFydC4gRm91bmQgWyR7cGF0aH1dLmAsXG4gICAgICByZXNvbHV0aW9uOiBgQWRkIGFuIGFkZGl0aW9uYWwgcHJlZml4IHRvIHRoZSBwYXRoLiBGb3IgZXhhbXBsZTogXCJmb28vJHtlbnRpdHlJZFBhdGhUb2tlbn0vKi5gLFxuICAgIH0pO1xuICB9XG5cbiAgaWYgKCFzdWJzdHJpbmdCZWZvcmVPd25lclRva2VuLmVuZHNXaXRoKCcvJykpIHtcbiAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcjxTdG9yYWdlRXJyb3I+KCdJbnZhbGlkU3RvcmFnZUFjY2Vzc1BhdGhFcnJvcicsIHtcbiAgICAgIG1lc3NhZ2U6IGBBIHBhdGggcGFydCB0aGF0IGluY2x1ZGVzIHRoZSAke2VudGl0eUlkUGF0aFRva2VufSB0b2tlbiBjYW5ub3QgaW5jbHVkZSBhbnkgb3RoZXIgY2hhcmFjdGVycy4gRm91bmQgWyR7cGF0aH1dLmAsXG4gICAgICByZXNvbHV0aW9uOiBgUmVtb3ZlIGFsbCBvdGhlciBjaGFyYWN0ZXJzIGZyb20gdGhlIHBhdGggcGFydCB3aXRoIHRoZSAke2VudGl0eUlkUGF0aFRva2VufSB0b2tlbi4gRm9yIGV4YW1wbGU6IFwiZm9vLyR7ZW50aXR5SWRQYXRoVG9rZW59LypcImAsXG4gICAgfSk7XG4gIH1cbn07XG5cbi8qKlxuICogUmV0dXJucyBhIHN1YnNldCBvZiBwYXRocyB3aGVyZSBlYWNoIGVsZW1lbnQgaXMgYSBwcmVmaXggb2YgcGF0aFxuICogRXF1aXZhbGVudCBwYXRocyBhcmUgTk9UIGNvbnNpZGVyZWQgcHJlZml4ZXMgb2YgZWFjaCBvdGhlciAobWFpbmx5IGp1c3QgZm9yIHNpbXBsaWNpdHkgb2YgdGhlIGNhbGxpbmcgbG9naWMpXG4gKi9cbmNvbnN0IGdldFByZWZpeGVzID0gKFxuICBwYXRoOiBzdHJpbmcsXG4gIHBhdGhzOiBzdHJpbmdbXSxcbiAgdHJlYXRXaWxkY2FyZEFzTGl0ZXJhbCA9IGZhbHNlLFxuKTogc3RyaW5nW10gPT5cbiAgcGF0aHMuZmlsdGVyKFxuICAgIChwKSA9PlxuICAgICAgcGF0aCAhPT0gcCAmJlxuICAgICAgcGF0aC5zdGFydHNXaXRoKHRyZWF0V2lsZGNhcmRBc0xpdGVyYWwgPyBwIDogcC5yZXBsYWNlQWxsKCcqJywgJycpKSxcbiAgKTtcbiJdfQ==