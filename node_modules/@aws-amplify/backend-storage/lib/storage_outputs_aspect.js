import { storageOutputKey, } from '@aws-amplify/backend-output-schemas';
import { AmplifyUserError } from '@aws-amplify/platform-core';
import { Stack } from 'aws-cdk-lib';
import { AmplifyStorage } from './construct.js';
/**
 * Aspect to store the storage outputs in the backend
 */
export class StorageOutputsAspect {
    isStorageProcessed = false;
    outputStorageStrategy;
    /**
     * Constructs a new instance of the StorageValidator class.
     */
    constructor(outputStorageStrategy) {
        this.outputStorageStrategy = outputStorageStrategy;
    }
    /**
     * Visit the given node.
     * If the node is an AmplifyStorage construct, we will traverse its siblings in the same stack
     * @param node The node to visit.
     */
    visit(node) {
        if (!(node instanceof AmplifyStorage) || this.isStorageProcessed) {
            return;
        }
        /**
         * only traverse the siblings once to store the outputs,
         * storing the same outputs multiple times result in error
         */
        this.isStorageProcessed = true;
        const storageInstances = Stack.of(node).node.children.filter((el) => el instanceof AmplifyStorage);
        const storageCount = storageInstances.length;
        let defaultStorageFound = false;
        Stack.of(node).node.children.forEach((child) => {
            if (!(child instanceof AmplifyStorage)) {
                return;
            }
            if (child.isDefault && !defaultStorageFound) {
                defaultStorageFound = true;
            }
            else if (child.isDefault && defaultStorageFound) {
                throw new AmplifyUserError('MultipleDefaultStorageError', {
                    message: `More than one default storage set in the Amplify project.`,
                    resolution: 'Remove `isDefault: true` from all `defineStorage` calls except for one in your Amplify project.',
                });
            }
        });
        /*
         * If there is no default bucket set and there is only one bucket,
         * we need to set the bucket as default.
         */
        if (!defaultStorageFound && storageCount === 1) {
            this.storeOutput(this.outputStorageStrategy, true, node);
        }
        else if (!defaultStorageFound && storageCount > 1) {
            throw new AmplifyUserError('NoDefaultStorageError', {
                message: 'No default storage set in the Amplify project.',
                resolution: 'Add `isDefault: true` to one of the `defineStorage` calls in your Amplify project.',
            });
        }
        else {
            Stack.of(node).node.children.forEach((child) => {
                if (!(child instanceof AmplifyStorage)) {
                    return;
                }
                this.storeOutput(this.outputStorageStrategy, child.isDefault, child);
            });
        }
    }
    storeOutput = (outputStorageStrategy, isDefault = false, node) => {
        if (isDefault) {
            outputStorageStrategy.addBackendOutputEntry(storageOutputKey, {
                version: '1',
                payload: {
                    storageRegion: Stack.of(node).region,
                    bucketName: node.resources.bucket.bucketName,
                },
            });
        }
        const bucketsPayload = {
            name: node.name,
            bucketName: node.resources.bucket.bucketName,
            storageRegion: Stack.of(node).region,
        };
        if (node.accessDefinition) {
            bucketsPayload.paths = node.accessDefinition;
        }
        // both default and non-default buckets should have the name, bucket name, and storage region stored in `buckets` field
        outputStorageStrategy.appendToBackendOutputList(storageOutputKey, {
            version: '1',
            payload: {
                buckets: JSON.stringify(bucketsPayload),
            },
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZV9vdXRwdXRzX2FzcGVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zdG9yYWdlX291dHB1dHNfYXNwZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxnQkFBZ0IsR0FDakIsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUU5RCxPQUFPLEVBQVcsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTdDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUdoRDs7R0FFRztBQUNILE1BQU0sT0FBTyxvQkFBb0I7SUFDL0Isa0JBQWtCLEdBQUcsS0FBSyxDQUFDO0lBQzNCLHFCQUFxQixDQUFDO0lBQ3RCOztPQUVHO0lBQ0gsWUFDRSxxQkFBa0U7UUFFbEUsSUFBSSxDQUFDLHFCQUFxQixHQUFHLHFCQUFxQixDQUFDO0lBQ3JELENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksS0FBSyxDQUFDLElBQWdCO1FBQzNCLElBQUksQ0FBQyxDQUFDLElBQUksWUFBWSxjQUFjLENBQUMsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7WUFDaEUsT0FBTztTQUNSO1FBQ0Q7OztXQUdHO1FBQ0gsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQztRQUUvQixNQUFNLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQzFELENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLFlBQVksY0FBYyxDQUNyQyxDQUFDO1FBQ0YsTUFBTSxZQUFZLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFDO1FBRTdDLElBQUksbUJBQW1CLEdBQUcsS0FBSyxDQUFDO1FBRWhDLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUM3QyxJQUFJLENBQUMsQ0FBQyxLQUFLLFlBQVksY0FBYyxDQUFDLEVBQUU7Z0JBQ3RDLE9BQU87YUFDUjtZQUNELElBQUksS0FBSyxDQUFDLFNBQVMsSUFBSSxDQUFDLG1CQUFtQixFQUFFO2dCQUMzQyxtQkFBbUIsR0FBRyxJQUFJLENBQUM7YUFDNUI7aUJBQU0sSUFBSSxLQUFLLENBQUMsU0FBUyxJQUFJLG1CQUFtQixFQUFFO2dCQUNqRCxNQUFNLElBQUksZ0JBQWdCLENBQUMsNkJBQTZCLEVBQUU7b0JBQ3hELE9BQU8sRUFBRSwyREFBMkQ7b0JBQ3BFLFVBQVUsRUFDUixpR0FBaUc7aUJBQ3BHLENBQUMsQ0FBQzthQUNKO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSDs7O1dBR0c7UUFDSCxJQUFJLENBQUMsbUJBQW1CLElBQUksWUFBWSxLQUFLLENBQUMsRUFBRTtZQUM5QyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDMUQ7YUFBTSxJQUFJLENBQUMsbUJBQW1CLElBQUksWUFBWSxHQUFHLENBQUMsRUFBRTtZQUNuRCxNQUFNLElBQUksZ0JBQWdCLENBQUMsdUJBQXVCLEVBQUU7Z0JBQ2xELE9BQU8sRUFBRSxnREFBZ0Q7Z0JBQ3pELFVBQVUsRUFDUixvRkFBb0Y7YUFDdkYsQ0FBQyxDQUFDO1NBQ0o7YUFBTTtZQUNMLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtnQkFDN0MsSUFBSSxDQUFDLENBQUMsS0FBSyxZQUFZLGNBQWMsQ0FBQyxFQUFFO29CQUN0QyxPQUFPO2lCQUNSO2dCQUNELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFLEtBQUssQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdkUsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7SUFFTyxXQUFXLEdBQUcsQ0FDcEIscUJBQWtFLEVBQ2xFLFlBQXFCLEtBQUssRUFDMUIsSUFBb0IsRUFDZCxFQUFFO1FBQ1IsSUFBSSxTQUFTLEVBQUU7WUFDYixxQkFBcUIsQ0FBQyxxQkFBcUIsQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDNUQsT0FBTyxFQUFFLEdBQUc7Z0JBQ1osT0FBTyxFQUFFO29CQUNQLGFBQWEsRUFBRSxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU07b0JBQ3BDLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFVO2lCQUM3QzthQUNGLENBQUMsQ0FBQztTQUNKO1FBQ0QsTUFBTSxjQUFjLEdBR2hCO1lBQ0YsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO1lBQ2YsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVU7WUFDNUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTTtTQUNyQyxDQUFDO1FBQ0YsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDekIsY0FBYyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7U0FDOUM7UUFDRCx1SEFBdUg7UUFDdkgscUJBQXFCLENBQUMseUJBQXlCLENBQUMsZ0JBQWdCLEVBQUU7WUFDaEUsT0FBTyxFQUFFLEdBQUc7WUFDWixPQUFPLEVBQUU7Z0JBQ1AsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDO2FBQ3hDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBTdG9yYWdlT3V0cHV0LFxuICBzdG9yYWdlT3V0cHV0S2V5LFxufSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQgeyBBbXBsaWZ5VXNlckVycm9yIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHsgQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgSUFzcGVjdCwgU3RhY2sgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBJQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBBbXBsaWZ5U3RvcmFnZSB9IGZyb20gJy4vY29uc3RydWN0LmpzJztcbmltcG9ydCB7IFN0b3JhZ2VBY2Nlc3NEZWZpbml0aW9uT3V0cHV0IH0gZnJvbSAnLi9wcml2YXRlX3R5cGVzLmpzJztcblxuLyoqXG4gKiBBc3BlY3QgdG8gc3RvcmUgdGhlIHN0b3JhZ2Ugb3V0cHV0cyBpbiB0aGUgYmFja2VuZFxuICovXG5leHBvcnQgY2xhc3MgU3RvcmFnZU91dHB1dHNBc3BlY3QgaW1wbGVtZW50cyBJQXNwZWN0IHtcbiAgaXNTdG9yYWdlUHJvY2Vzc2VkID0gZmFsc2U7XG4gIG91dHB1dFN0b3JhZ2VTdHJhdGVneTtcbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgYSBuZXcgaW5zdGFuY2Ugb2YgdGhlIFN0b3JhZ2VWYWxpZGF0b3IgY2xhc3MuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8U3RvcmFnZU91dHB1dD4sXG4gICkge1xuICAgIHRoaXMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5ID0gb3V0cHV0U3RvcmFnZVN0cmF0ZWd5O1xuICB9XG5cbiAgLyoqXG4gICAqIFZpc2l0IHRoZSBnaXZlbiBub2RlLlxuICAgKiBJZiB0aGUgbm9kZSBpcyBhbiBBbXBsaWZ5U3RvcmFnZSBjb25zdHJ1Y3QsIHdlIHdpbGwgdHJhdmVyc2UgaXRzIHNpYmxpbmdzIGluIHRoZSBzYW1lIHN0YWNrXG4gICAqIEBwYXJhbSBub2RlIFRoZSBub2RlIHRvIHZpc2l0LlxuICAgKi9cbiAgcHVibGljIHZpc2l0KG5vZGU6IElDb25zdHJ1Y3QpOiB2b2lkIHtcbiAgICBpZiAoIShub2RlIGluc3RhbmNlb2YgQW1wbGlmeVN0b3JhZ2UpIHx8IHRoaXMuaXNTdG9yYWdlUHJvY2Vzc2VkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8qKlxuICAgICAqIG9ubHkgdHJhdmVyc2UgdGhlIHNpYmxpbmdzIG9uY2UgdG8gc3RvcmUgdGhlIG91dHB1dHMsXG4gICAgICogc3RvcmluZyB0aGUgc2FtZSBvdXRwdXRzIG11bHRpcGxlIHRpbWVzIHJlc3VsdCBpbiBlcnJvclxuICAgICAqL1xuICAgIHRoaXMuaXNTdG9yYWdlUHJvY2Vzc2VkID0gdHJ1ZTtcblxuICAgIGNvbnN0IHN0b3JhZ2VJbnN0YW5jZXMgPSBTdGFjay5vZihub2RlKS5ub2RlLmNoaWxkcmVuLmZpbHRlcihcbiAgICAgIChlbCkgPT4gZWwgaW5zdGFuY2VvZiBBbXBsaWZ5U3RvcmFnZSxcbiAgICApO1xuICAgIGNvbnN0IHN0b3JhZ2VDb3VudCA9IHN0b3JhZ2VJbnN0YW5jZXMubGVuZ3RoO1xuXG4gICAgbGV0IGRlZmF1bHRTdG9yYWdlRm91bmQgPSBmYWxzZTtcblxuICAgIFN0YWNrLm9mKG5vZGUpLm5vZGUuY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGQpID0+IHtcbiAgICAgIGlmICghKGNoaWxkIGluc3RhbmNlb2YgQW1wbGlmeVN0b3JhZ2UpKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmIChjaGlsZC5pc0RlZmF1bHQgJiYgIWRlZmF1bHRTdG9yYWdlRm91bmQpIHtcbiAgICAgICAgZGVmYXVsdFN0b3JhZ2VGb3VuZCA9IHRydWU7XG4gICAgICB9IGVsc2UgaWYgKGNoaWxkLmlzRGVmYXVsdCAmJiBkZWZhdWx0U3RvcmFnZUZvdW5kKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdNdWx0aXBsZURlZmF1bHRTdG9yYWdlRXJyb3InLCB7XG4gICAgICAgICAgbWVzc2FnZTogYE1vcmUgdGhhbiBvbmUgZGVmYXVsdCBzdG9yYWdlIHNldCBpbiB0aGUgQW1wbGlmeSBwcm9qZWN0LmAsXG4gICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICdSZW1vdmUgYGlzRGVmYXVsdDogdHJ1ZWAgZnJvbSBhbGwgYGRlZmluZVN0b3JhZ2VgIGNhbGxzIGV4Y2VwdCBmb3Igb25lIGluIHlvdXIgQW1wbGlmeSBwcm9qZWN0LicsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICAgIC8qXG4gICAgICogSWYgdGhlcmUgaXMgbm8gZGVmYXVsdCBidWNrZXQgc2V0IGFuZCB0aGVyZSBpcyBvbmx5IG9uZSBidWNrZXQsXG4gICAgICogd2UgbmVlZCB0byBzZXQgdGhlIGJ1Y2tldCBhcyBkZWZhdWx0LlxuICAgICAqL1xuICAgIGlmICghZGVmYXVsdFN0b3JhZ2VGb3VuZCAmJiBzdG9yYWdlQ291bnQgPT09IDEpIHtcbiAgICAgIHRoaXMuc3RvcmVPdXRwdXQodGhpcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3ksIHRydWUsIG5vZGUpO1xuICAgIH0gZWxzZSBpZiAoIWRlZmF1bHRTdG9yYWdlRm91bmQgJiYgc3RvcmFnZUNvdW50ID4gMSkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ05vRGVmYXVsdFN0b3JhZ2VFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogJ05vIGRlZmF1bHQgc3RvcmFnZSBzZXQgaW4gdGhlIEFtcGxpZnkgcHJvamVjdC4nLFxuICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICdBZGQgYGlzRGVmYXVsdDogdHJ1ZWAgdG8gb25lIG9mIHRoZSBgZGVmaW5lU3RvcmFnZWAgY2FsbHMgaW4geW91ciBBbXBsaWZ5IHByb2plY3QuJyxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBTdGFjay5vZihub2RlKS5ub2RlLmNoaWxkcmVuLmZvckVhY2goKGNoaWxkKSA9PiB7XG4gICAgICAgIGlmICghKGNoaWxkIGluc3RhbmNlb2YgQW1wbGlmeVN0b3JhZ2UpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3RvcmVPdXRwdXQodGhpcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3ksIGNoaWxkLmlzRGVmYXVsdCwgY2hpbGQpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdG9yZU91dHB1dCA9IChcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8U3RvcmFnZU91dHB1dD4sXG4gICAgaXNEZWZhdWx0OiBib29sZWFuID0gZmFsc2UsXG4gICAgbm9kZTogQW1wbGlmeVN0b3JhZ2UsXG4gICk6IHZvaWQgPT4ge1xuICAgIGlmIChpc0RlZmF1bHQpIHtcbiAgICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneS5hZGRCYWNrZW5kT3V0cHV0RW50cnkoc3RvcmFnZU91dHB1dEtleSwge1xuICAgICAgICB2ZXJzaW9uOiAnMScsXG4gICAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgICBzdG9yYWdlUmVnaW9uOiBTdGFjay5vZihub2RlKS5yZWdpb24sXG4gICAgICAgICAgYnVja2V0TmFtZTogbm9kZS5yZXNvdXJjZXMuYnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgYnVja2V0c1BheWxvYWQ6IFJlY29yZDxcbiAgICAgIHN0cmluZyxcbiAgICAgIHN0cmluZyB8IFN0b3JhZ2VBY2Nlc3NEZWZpbml0aW9uT3V0cHV0XG4gICAgPiA9IHtcbiAgICAgIG5hbWU6IG5vZGUubmFtZSxcbiAgICAgIGJ1Y2tldE5hbWU6IG5vZGUucmVzb3VyY2VzLmJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgc3RvcmFnZVJlZ2lvbjogU3RhY2sub2Yobm9kZSkucmVnaW9uLFxuICAgIH07XG4gICAgaWYgKG5vZGUuYWNjZXNzRGVmaW5pdGlvbikge1xuICAgICAgYnVja2V0c1BheWxvYWQucGF0aHMgPSBub2RlLmFjY2Vzc0RlZmluaXRpb247XG4gICAgfVxuICAgIC8vIGJvdGggZGVmYXVsdCBhbmQgbm9uLWRlZmF1bHQgYnVja2V0cyBzaG91bGQgaGF2ZSB0aGUgbmFtZSwgYnVja2V0IG5hbWUsIGFuZCBzdG9yYWdlIHJlZ2lvbiBzdG9yZWQgaW4gYGJ1Y2tldHNgIGZpZWxkXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LmFwcGVuZFRvQmFja2VuZE91dHB1dExpc3Qoc3RvcmFnZU91dHB1dEtleSwge1xuICAgICAgdmVyc2lvbjogJzEnLFxuICAgICAgcGF5bG9hZDoge1xuICAgICAgICBidWNrZXRzOiBKU09OLnN0cmluZ2lmeShidWNrZXRzUGF5bG9hZCksXG4gICAgICB9LFxuICAgIH0pO1xuICB9O1xufVxuIl19