import { AmplifyStorage } from './construct.js';
import { StorageAccessOrchestratorFactory } from './storage_access_orchestrator.js';
import { EventType } from 'aws-cdk-lib/aws-s3';
import { StorageAccessPolicyFactory } from './storage_access_policy_factory.js';
import { Tags } from 'aws-cdk-lib';
import { TagName } from '@aws-amplify/platform-core';
/**
 * Generates a single instance of storage resources
 */
export class StorageContainerEntryGenerator {
    props;
    getInstanceProps;
    storageAccessOrchestratorFactory;
    resourceGroupName = 'storage';
    /**
     * Initialize with context from storage factory
     */
    constructor(props, getInstanceProps, storageAccessOrchestratorFactory = new StorageAccessOrchestratorFactory()) {
        this.props = props;
        this.getInstanceProps = getInstanceProps;
        this.storageAccessOrchestratorFactory = storageAccessOrchestratorFactory;
    }
    generateContainerEntry = ({ scope, ssmEnvironmentEntriesGenerator, }) => {
        const amplifyStorage = new AmplifyStorage(scope, this.props.name, {
            ...this.props,
            outputStorageStrategy: this.getInstanceProps.outputStorageStrategy,
        });
        Tags.of(amplifyStorage).add(TagName.FRIENDLY_NAME, this.props.name);
        Object.entries(this.props.triggers || {}).forEach(([triggerEvent, handlerFactory]) => {
            const events = [];
            const handler = handlerFactory.getInstance(this.getInstanceProps)
                .resources.lambda;
            // triggerEvent is converted string from Object.entries
            switch (triggerEvent) {
                case 'onDelete':
                    events.push(EventType.OBJECT_REMOVED);
                    break;
                case 'onUpload':
                    events.push(EventType.OBJECT_CREATED);
                    break;
            }
            amplifyStorage.addTrigger(events, handler);
        });
        if (!this.props.access) {
            return amplifyStorage;
        }
        // generate the ssm environment context necessary to access the s3 bucket (in this case, just the bucket name)
        const ssmEnvironmentEntries = ssmEnvironmentEntriesGenerator.generateSsmEnvironmentEntries({
            [`${this.props.name}_BUCKET_NAME`]: amplifyStorage.resources.bucket.bucketName,
        });
        // we pass the access definition along with other dependencies to the storageAccessOrchestrator
        const storageAccessOrchestrator = this.storageAccessOrchestratorFactory.getInstance(this.props.access, this.getInstanceProps, ssmEnvironmentEntries, new StorageAccessPolicyFactory(amplifyStorage.resources.bucket));
        // the orchestrator generates policies according to the accessDefinition and attaches the policies to appropriate roles
        const storageAccessOutput = storageAccessOrchestrator.orchestrateStorageAccess();
        amplifyStorage.addAccessDefinition(storageAccessOutput);
        return amplifyStorage;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZV9jb250YWluZXJfZW50cnlfZ2VuZXJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3N0b3JhZ2VfY29udGFpbmVyX2VudHJ5X2dlbmVyYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFNQSxPQUFPLEVBQUUsY0FBYyxFQUE4QixNQUFNLGdCQUFnQixDQUFDO0FBQzVFLE9BQU8sRUFBRSxnQ0FBZ0MsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBRXBGLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMvQyxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUNoRixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ25DLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUVyRDs7R0FFRztBQUNILE1BQU0sT0FBTyw4QkFBOEI7SUFTdEI7SUFDQTtJQUNBO0lBUlYsaUJBQWlCLEdBQTZCLFNBQVMsQ0FBQztJQUVqRTs7T0FFRztJQUNILFlBQ21CLEtBQWlDLEVBQ2pDLGdCQUFrRCxFQUNsRCxtQ0FBcUUsSUFBSSxnQ0FBZ0MsRUFBRTtRQUYzRyxVQUFLLEdBQUwsS0FBSyxDQUE0QjtRQUNqQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtDO1FBQ2xELHFDQUFnQyxHQUFoQyxnQ0FBZ0MsQ0FBMkU7SUFDM0gsQ0FBQztJQUVKLHNCQUFzQixHQUFHLENBQUMsRUFDeEIsS0FBSyxFQUNMLDhCQUE4QixHQUNGLEVBQUUsRUFBRTtRQUNoQyxNQUFNLGNBQWMsR0FBRyxJQUFJLGNBQWMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUU7WUFDaEUsR0FBRyxJQUFJLENBQUMsS0FBSztZQUNiLHFCQUFxQixFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxxQkFBcUI7U0FDbkUsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXBFLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxDQUMvQyxDQUFDLENBQUMsWUFBWSxFQUFFLGNBQWMsQ0FBQyxFQUFFLEVBQUU7WUFDakMsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDO1lBQ2xCLE1BQU0sT0FBTyxHQUFHLGNBQWMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDO2lCQUM5RCxTQUFTLENBQUMsTUFBTSxDQUFDO1lBQ3BCLHVEQUF1RDtZQUN2RCxRQUFRLFlBQTBDLEVBQUU7Z0JBQ2xELEtBQUssVUFBVTtvQkFDYixNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQztvQkFDdEMsTUFBTTtnQkFDUixLQUFLLFVBQVU7b0JBQ2IsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUM7b0JBQ3RDLE1BQU07YUFDVDtZQUNELGNBQWMsQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzdDLENBQUMsQ0FDRixDQUFDO1FBRUYsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ3RCLE9BQU8sY0FBYyxDQUFDO1NBQ3ZCO1FBRUQsOEdBQThHO1FBQzlHLE1BQU0scUJBQXFCLEdBQ3pCLDhCQUE4QixDQUFDLDZCQUE2QixDQUFDO1lBQzNELENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksY0FBYyxDQUFDLEVBQ2hDLGNBQWMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVU7U0FDN0MsQ0FBQyxDQUFDO1FBRUwsK0ZBQStGO1FBQy9GLE1BQU0seUJBQXlCLEdBQzdCLElBQUksQ0FBQyxnQ0FBZ0MsQ0FBQyxXQUFXLENBQy9DLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUNqQixJQUFJLENBQUMsZ0JBQWdCLEVBQ3JCLHFCQUFxQixFQUNyQixJQUFJLDBCQUEwQixDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQ2hFLENBQUM7UUFFSix1SEFBdUg7UUFDdkgsTUFBTSxtQkFBbUIsR0FDdkIseUJBQXlCLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztRQUN2RCxjQUFjLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUV4RCxPQUFPLGNBQWMsQ0FBQztJQUN4QixDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZSxcbiAgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3IsXG4gIENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgQW1wbGlmeVN0b3JhZ2UsIEFtcGxpZnlTdG9yYWdlVHJpZ2dlckV2ZW50IH0gZnJvbSAnLi9jb25zdHJ1Y3QuanMnO1xuaW1wb3J0IHsgU3RvcmFnZUFjY2Vzc09yY2hlc3RyYXRvckZhY3RvcnkgfSBmcm9tICcuL3N0b3JhZ2VfYWNjZXNzX29yY2hlc3RyYXRvci5qcyc7XG5pbXBvcnQgeyBBbXBsaWZ5U3RvcmFnZUZhY3RvcnlQcm9wcyB9IGZyb20gJy4vdHlwZXMuanMnO1xuaW1wb3J0IHsgRXZlbnRUeXBlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLXMzJztcbmltcG9ydCB7IFN0b3JhZ2VBY2Nlc3NQb2xpY3lGYWN0b3J5IH0gZnJvbSAnLi9zdG9yYWdlX2FjY2Vzc19wb2xpY3lfZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBUYWdzIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgVGFnTmFtZSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcblxuLyoqXG4gKiBHZW5lcmF0ZXMgYSBzaW5nbGUgaW5zdGFuY2Ugb2Ygc3RvcmFnZSByZXNvdXJjZXNcbiAqL1xuZXhwb3J0IGNsYXNzIFN0b3JhZ2VDb250YWluZXJFbnRyeUdlbmVyYXRvclxuICBpbXBsZW1lbnRzIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yXG57XG4gIHJlYWRvbmx5IHJlc291cmNlR3JvdXBOYW1lOiBBbXBsaWZ5UmVzb3VyY2VHcm91cE5hbWUgPSAnc3RvcmFnZSc7XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgd2l0aCBjb250ZXh0IGZyb20gc3RvcmFnZSBmYWN0b3J5XG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBBbXBsaWZ5U3RvcmFnZUZhY3RvcnlQcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGdldEluc3RhbmNlUHJvcHM6IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3RvcmFnZUFjY2Vzc09yY2hlc3RyYXRvckZhY3Rvcnk6IFN0b3JhZ2VBY2Nlc3NPcmNoZXN0cmF0b3JGYWN0b3J5ID0gbmV3IFN0b3JhZ2VBY2Nlc3NPcmNoZXN0cmF0b3JGYWN0b3J5KCksXG4gICkge31cblxuICBnZW5lcmF0ZUNvbnRhaW5lckVudHJ5ID0gKHtcbiAgICBzY29wZSxcbiAgICBzc21FbnZpcm9ubWVudEVudHJpZXNHZW5lcmF0b3IsXG4gIH06IEdlbmVyYXRlQ29udGFpbmVyRW50cnlQcm9wcykgPT4ge1xuICAgIGNvbnN0IGFtcGxpZnlTdG9yYWdlID0gbmV3IEFtcGxpZnlTdG9yYWdlKHNjb3BlLCB0aGlzLnByb3BzLm5hbWUsIHtcbiAgICAgIC4uLnRoaXMucHJvcHMsXG4gICAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IHRoaXMuZ2V0SW5zdGFuY2VQcm9wcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gICAgfSk7XG5cbiAgICBUYWdzLm9mKGFtcGxpZnlTdG9yYWdlKS5hZGQoVGFnTmFtZS5GUklFTkRMWV9OQU1FLCB0aGlzLnByb3BzLm5hbWUpO1xuXG4gICAgT2JqZWN0LmVudHJpZXModGhpcy5wcm9wcy50cmlnZ2VycyB8fCB7fSkuZm9yRWFjaChcbiAgICAgIChbdHJpZ2dlckV2ZW50LCBoYW5kbGVyRmFjdG9yeV0pID0+IHtcbiAgICAgICAgY29uc3QgZXZlbnRzID0gW107XG4gICAgICAgIGNvbnN0IGhhbmRsZXIgPSBoYW5kbGVyRmFjdG9yeS5nZXRJbnN0YW5jZSh0aGlzLmdldEluc3RhbmNlUHJvcHMpXG4gICAgICAgICAgLnJlc291cmNlcy5sYW1iZGE7XG4gICAgICAgIC8vIHRyaWdnZXJFdmVudCBpcyBjb252ZXJ0ZWQgc3RyaW5nIGZyb20gT2JqZWN0LmVudHJpZXNcbiAgICAgICAgc3dpdGNoICh0cmlnZ2VyRXZlbnQgYXMgQW1wbGlmeVN0b3JhZ2VUcmlnZ2VyRXZlbnQpIHtcbiAgICAgICAgICBjYXNlICdvbkRlbGV0ZSc6XG4gICAgICAgICAgICBldmVudHMucHVzaChFdmVudFR5cGUuT0JKRUNUX1JFTU9WRUQpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnb25VcGxvYWQnOlxuICAgICAgICAgICAgZXZlbnRzLnB1c2goRXZlbnRUeXBlLk9CSkVDVF9DUkVBVEVEKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGFtcGxpZnlTdG9yYWdlLmFkZFRyaWdnZXIoZXZlbnRzLCBoYW5kbGVyKTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGlmICghdGhpcy5wcm9wcy5hY2Nlc3MpIHtcbiAgICAgIHJldHVybiBhbXBsaWZ5U3RvcmFnZTtcbiAgICB9XG5cbiAgICAvLyBnZW5lcmF0ZSB0aGUgc3NtIGVudmlyb25tZW50IGNvbnRleHQgbmVjZXNzYXJ5IHRvIGFjY2VzcyB0aGUgczMgYnVja2V0IChpbiB0aGlzIGNhc2UsIGp1c3QgdGhlIGJ1Y2tldCBuYW1lKVxuICAgIGNvbnN0IHNzbUVudmlyb25tZW50RW50cmllcyA9XG4gICAgICBzc21FbnZpcm9ubWVudEVudHJpZXNHZW5lcmF0b3IuZ2VuZXJhdGVTc21FbnZpcm9ubWVudEVudHJpZXMoe1xuICAgICAgICBbYCR7dGhpcy5wcm9wcy5uYW1lfV9CVUNLRVRfTkFNRWBdOlxuICAgICAgICAgIGFtcGxpZnlTdG9yYWdlLnJlc291cmNlcy5idWNrZXQuYnVja2V0TmFtZSxcbiAgICAgIH0pO1xuXG4gICAgLy8gd2UgcGFzcyB0aGUgYWNjZXNzIGRlZmluaXRpb24gYWxvbmcgd2l0aCBvdGhlciBkZXBlbmRlbmNpZXMgdG8gdGhlIHN0b3JhZ2VBY2Nlc3NPcmNoZXN0cmF0b3JcbiAgICBjb25zdCBzdG9yYWdlQWNjZXNzT3JjaGVzdHJhdG9yID1cbiAgICAgIHRoaXMuc3RvcmFnZUFjY2Vzc09yY2hlc3RyYXRvckZhY3RvcnkuZ2V0SW5zdGFuY2UoXG4gICAgICAgIHRoaXMucHJvcHMuYWNjZXNzLFxuICAgICAgICB0aGlzLmdldEluc3RhbmNlUHJvcHMsXG4gICAgICAgIHNzbUVudmlyb25tZW50RW50cmllcyxcbiAgICAgICAgbmV3IFN0b3JhZ2VBY2Nlc3NQb2xpY3lGYWN0b3J5KGFtcGxpZnlTdG9yYWdlLnJlc291cmNlcy5idWNrZXQpLFxuICAgICAgKTtcblxuICAgIC8vIHRoZSBvcmNoZXN0cmF0b3IgZ2VuZXJhdGVzIHBvbGljaWVzIGFjY29yZGluZyB0byB0aGUgYWNjZXNzRGVmaW5pdGlvbiBhbmQgYXR0YWNoZXMgdGhlIHBvbGljaWVzIHRvIGFwcHJvcHJpYXRlIHJvbGVzXG4gICAgY29uc3Qgc3RvcmFnZUFjY2Vzc091dHB1dCA9XG4gICAgICBzdG9yYWdlQWNjZXNzT3JjaGVzdHJhdG9yLm9yY2hlc3RyYXRlU3RvcmFnZUFjY2VzcygpO1xuICAgIGFtcGxpZnlTdG9yYWdlLmFkZEFjY2Vzc0RlZmluaXRpb24oc3RvcmFnZUFjY2Vzc091dHB1dCk7XG5cbiAgICByZXR1cm4gYW1wbGlmeVN0b3JhZ2U7XG4gIH07XG59XG4iXX0=