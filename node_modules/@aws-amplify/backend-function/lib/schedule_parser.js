import { Schedule } from 'aws-cdk-lib/aws-events';
import os from 'os';
/**
 * Parses function schedule props in order to create EventBridge rules.
 */
export const convertFunctionSchedulesToRuleSchedules = (lambda, functionSchedules) => {
    const errors = [];
    const ruleSchedules = [];
    const schedules = Array.isArray(functionSchedules)
        ? functionSchedules
        : [functionSchedules];
    schedules.forEach((schedule) => {
        if (isTimeInterval(schedule)) {
            const { value, unit } = parseTimeInterval(schedule);
            if (value && !isPositiveWholeNumber(value)) {
                errors.push('Function schedule rate must be set with a positive whole number');
            }
            else if (value &&
                lambda.timeout &&
                unit === 'm' &&
                value * 60 < lambda.timeout.toSeconds()) {
                const timeout = lambda.timeout.toSeconds();
                errors.push(`Function schedule rate must be greater than the function timeout of ${timeout} ${timeout > 1 ? 'seconds' : 'second'}`);
            }
        }
        else {
            const cronErrors = validateCron(schedule);
            if (cronErrors.length > 0) {
                errors.push(...cronErrors);
            }
        }
        if (errors.length === 0) {
            ruleSchedules.push(Schedule.cron(translateToCronOptions(schedule)));
        }
    });
    if (errors.length > 0) {
        throw new Error(errors.join(os.EOL));
    }
    return ruleSchedules;
};
const isTimeInterval = (schedule) => {
    const parts = schedule.split(' ');
    return (parts[0] === 'every' &&
        ['m', 'h', 'day', 'week', 'month', 'year'].some((a) => parts[1].endsWith(a)) &&
        parts.length === 2);
};
const parseTimeInterval = (timeInterval) => {
    const part = timeInterval.split(' ')[1];
    const value = part.match(/-?\d+\.?\d*/);
    const unit = part.match(/[a-zA-Z]+/);
    return {
        value: value ? Number(value[0]) : undefined,
        unit: unit ? unit[0] : undefined,
    };
};
const isPositiveWholeNumber = (test) => test > 0 && test % 1 === 0;
const validateCron = (cron) => {
    const errors = [];
    const cronParts = cron.split(' ');
    const [minute, hour, dayOfMonth, month, dayOfWeek, year] = cronParts;
    const minuteValidationErrors = validateCronPart('minutes', minute, 0, 59);
    const hourValidationErrors = validateCronPart('hours', hour, 0, 23);
    const dayOfMonthValidationErrors = dayOfMonth === '?'
        ? []
        : validateCronPart('day-of-month', dayOfMonth, 1, 31);
    const monthValidationErrors = validateCronPart('month', month, 1, 12);
    const dayOfWeekValidationErrors = dayOfWeek === '?' ? [] : validateCronPart('day-of-week', dayOfWeek, 1, 7);
    const yearValidationErrors = year
        ? validateCronPart('year', year, 1970, 2199)
        : [];
    errors.push(...minuteValidationErrors, ...hourValidationErrors, ...dayOfMonthValidationErrors, ...monthValidationErrors, ...dayOfWeekValidationErrors, ...yearValidationErrors);
    if (dayOfMonth !== '?' && dayOfWeek !== '?') {
        errors.push('Cron expressions cannot have both day-of-month and day-of-week defined, you must use a ? in one of the fields');
    }
    return errors;
};
const validateCronPart = (cronPart, value, min, max) => {
    const errors = [];
    if (value === '*') {
        return errors;
    }
    const hasStep = value.includes('/');
    const hasRange = value.includes('-');
    const hasList = value.includes(',');
    if (hasList) {
        const listError = validateList(cronPart, value, min, max);
        if (listError) {
            errors.push(listError);
        }
        const listItems = value.split(',');
        listItems.forEach((listItem) => {
            if (listItem.includes('/')) {
                const stepError = validateStepValue(cronPart, listItem, min, max);
                if (stepError) {
                    errors.push(stepError);
                }
            }
            else if (listItem.includes('-')) {
                const rangeError = validateRange(cronPart, listItem, min, max);
                if (rangeError) {
                    errors.push(rangeError);
                }
            }
        });
    }
    else if (hasStep) {
        const stepError = validateStepValue(cronPart, value, min, max);
        if (stepError) {
            errors.push(stepError);
        }
    }
    else if (hasRange) {
        const rangeError = validateRange(cronPart, value, min, max);
        if (rangeError) {
            errors.push(rangeError);
        }
    }
    if (!hasStep &&
        !hasRange &&
        !hasList &&
        !isWholeNumberBetweenInclusive(Number(value), min, max)) {
        errors.push(`Cron field for ${cronPart} must be a whole number between ${min} and ${max}`);
    }
    return errors;
};
const validateStepValue = (cronPart, value, min, max) => {
    const originalBase = value.split('/')[0];
    const [base, step] = value.split('/').map(Number);
    if (originalBase === '*') {
        if (isNaN(step) || step <= 0 || !isPositiveWholeNumber(step)) {
            return `Cron step values for ${cronPart} must be positive whole numbers`;
        }
    }
    else if (isNaN(base) ||
        isNaN(step) ||
        !isWholeNumberBetweenInclusive(base, min, max) ||
        step <= 0) {
        return `Cron step values for ${cronPart} must be whole numbers between ${min} and ${max}`;
    }
    return;
};
const validateRange = (cronPart, value, min, max) => {
    const [start, end] = value.split('-').map(Number);
    if (isNaN(start) ||
        isNaN(end) ||
        !isWholeNumberBetweenInclusive(start, min, max) ||
        !isWholeNumberBetweenInclusive(end, min, max) ||
        start > end) {
        return `Cron range for ${cronPart} must be whole numbers between ${min} and ${max}`;
    }
    return;
};
const validateList = (cronPart, value, min, max) => {
    if (!value
        .split(',')
        .every((v) => isWholeNumberBetweenInclusive(Number(v), min, max))) {
        return `Cron list for ${cronPart} must contain whole numbers between ${min} and ${max}`;
    }
    return;
};
const isWholeNumberBetweenInclusive = (test, min, max) => min <= test && test <= max && test % 1 === 0;
const translateToCronOptions = (schedule) => {
    if (isTimeInterval(schedule)) {
        const { value, unit } = parseTimeInterval(schedule);
        switch (unit) {
            case 'm':
                return { minute: `*/${value}` };
            case 'h':
                return { minute: '0', hour: `*/${value}` };
            case 'day':
                return { minute: '0', hour: '0', day: `*` };
            case 'week':
                return { minute: '0', hour: '0', weekDay: `1` };
            case 'month':
                return { minute: '0', hour: '0', day: '1', month: `*` };
            case 'year':
                return {
                    minute: '0',
                    hour: '0',
                    day: '1',
                    month: '1',
                    year: `*`,
                };
            default:
                // This should never happen with strict types
                throw new Error('Could not determine the schedule rate for the function');
        }
    }
    else {
        const cronArray = schedule.split(' ');
        const result = {
            minute: cronArray[0],
            hour: cronArray[1],
            month: cronArray[3],
            year: cronArray.length === 6 ? cronArray[5] : '*',
        };
        // Branching logic here is because we cannot supply both day and weekDay
        if (cronArray[2] === '?') {
            result.weekDay = cronArray[4];
        }
        else {
            result.day = cronArray[2];
        }
        return result;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZWR1bGVfcGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3NjaGVkdWxlX3BhcnNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWUsUUFBUSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFPL0QsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBVXBCOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sdUNBQXVDLEdBQUcsQ0FDckQsTUFBc0IsRUFDdEIsaUJBQXdELEVBQ3hELEVBQUU7SUFDRixNQUFNLE1BQU0sR0FBYSxFQUFFLENBQUM7SUFDNUIsTUFBTSxhQUFhLEdBQWUsRUFBRSxDQUFDO0lBRXJDLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUM7UUFDaEQsQ0FBQyxDQUFDLGlCQUFpQjtRQUNuQixDQUFDLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBRXhCLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtRQUM3QixJQUFJLGNBQWMsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUM1QixNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxHQUFHLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXBELElBQUksS0FBSyxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQzFDLE1BQU0sQ0FBQyxJQUFJLENBQ1QsaUVBQWlFLENBQ2xFLENBQUM7YUFDSDtpQkFBTSxJQUNMLEtBQUs7Z0JBQ0wsTUFBTSxDQUFDLE9BQU87Z0JBQ2QsSUFBSSxLQUFLLEdBQUc7Z0JBQ1osS0FBSyxHQUFHLEVBQUUsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxFQUN2QztnQkFDQSxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUMzQyxNQUFNLENBQUMsSUFBSSxD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R0FBRyxFQUFFLENBQUM7WUFDMUQsS0FBSyxNQUFNO2dCQUNULE9BQU87b0JBQ0wsTUFBTSxFQUFFLEdBQUc7b0JBQ1gsSUFBSSxFQUFFLEdBQUc7b0JBQ1QsR0FBRyxFQUFFLEdBQUc7b0JBQ1IsS0FBSyxFQUFFLEdBQUc7b0JBQ1YsSUFBSSxFQUFFLEdBQUc7aUJBQ1YsQ0FBQztZQUNKO2dCQUNFLDZDQUE2QztnQkFDN0MsTUFBTSxJQUFJLEtBQUssQ0FDYix3REFBd0QsQ0FDekQsQ0FBQztTQUNMO0tBQ0Y7U0FBTTtRQUNMLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEMsTUFBTSxNQUFNLEdBQTJCO1lBQ3JDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLEtBQUssRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ25CLElBQUksRUFBRSxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHO1NBQ2xELENBQUM7UUFFRix3RUFBd0U7UUFDeEUsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQ3hCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQy9CO2FBQU07WUFDTCxNQUFNLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMzQjtRQUVELE9BQU8sTUFBTSxDQUFDO0tBQ2Y7QUFDSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDcm9uT3B0aW9ucywgU2NoZWR1bGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZXZlbnRzJztcbmltcG9ydCB7IE5vZGVqc0Z1bmN0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYS1ub2RlanMnO1xuaW1wb3J0IHR5cGUge1xuICBDcm9uU2NoZWR1bGUsXG4gIEZ1bmN0aW9uU2NoZWR1bGUsXG4gIFRpbWVJbnRlcnZhbCxcbn0gZnJvbSAnLi9mYWN0b3J5LmpzJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5cbnR5cGUgQ3JvblBhcnQgPVxuICB8ICdtaW51dGVzJ1xuICB8ICdob3VycydcbiAgfCAnZGF5LW9mLW1vbnRoJ1xuICB8ICdtb250aCdcbiAgfCAnZGF5LW9mLXdlZWsnXG4gIHwgJ3llYXInO1xuXG4vKipcbiAqIFBhcnNlcyBmdW5jdGlvbiBzY2hlZHVsZSBwcm9wcyBpbiBvcmRlciB0byBjcmVhdGUgRXZlbnRCcmlkZ2UgcnVsZXMuXG4gKi9cbmV4cG9ydCBjb25zdCBjb252ZXJ0RnVuY3Rpb25TY2hlZHVsZXNUb1J1bGVTY2hlZHVsZXMgPSAoXG4gIGxhbWJkYTogTm9kZWpzRnVuY3Rpb24sXG4gIGZ1bmN0aW9uU2NoZWR1bGVzOiBGdW5jdGlvblNjaGVkdWxlIHwgRnVuY3Rpb25TY2hlZHVsZVtdLFxuKSA9PiB7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgY29uc3QgcnVsZVNjaGVkdWxlczogU2NoZWR1bGVbXSA9IFtdO1xuXG4gIGNvbnN0IHNjaGVkdWxlcyA9IEFycmF5LmlzQXJyYXkoZnVuY3Rpb25TY2hlZHVsZXMpXG4gICAgPyBmdW5jdGlvblNjaGVkdWxlc1xuICAgIDogW2Z1bmN0aW9uU2NoZWR1bGVzXTtcblxuICBzY2hlZHVsZXMuZm9yRWFjaCgoc2NoZWR1bGUpID0+IHtcbiAgICBpZiAoaXNUaW1lSW50ZXJ2YWwoc2NoZWR1bGUpKSB7XG4gICAgICBjb25zdCB7IHZhbHVlLCB1bml0IH0gPSBwYXJzZVRpbWVJbnRlcnZhbChzY2hlZHVsZSk7XG5cbiAgICAgIGlmICh2YWx1ZSAmJiAhaXNQb3NpdGl2ZVdob2xlTnVtYmVyKHZhbHVlKSkge1xuICAgICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgICAnRnVuY3Rpb24gc2NoZWR1bGUgcmF0ZSBtdXN0IGJlIHNldCB3aXRoIGEgcG9zaXRpdmUgd2hvbGUgbnVtYmVyJyxcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgIHZhbHVlICYmXG4gICAgICAgIGxhbWJkYS50aW1lb3V0ICYmXG4gICAgICAgIHVuaXQgPT09ICdtJyAmJlxuICAgICAgICB2YWx1ZSAqIDYwIDwgbGFtYmRhLnRpbWVvdXQudG9TZWNvbmRzKClcbiAgICAgICkge1xuICAgICAgICBjb25zdCB0aW1lb3V0ID0gbGFtYmRhLnRpbWVvdXQudG9TZWNvbmRzKCk7XG4gICAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICAgIGBGdW5jdGlvbiBzY2hlZHVsZSByYXRlIG11c3QgYmUgZ3JlYXRlciB0aGFuIHRoZSBmdW5jdGlvbiB0aW1lb3V0IG9mICR7dGltZW91dH0gJHtcbiAgICAgICAgICAgIHRpbWVvdXQgPiAxID8gJ3NlY29uZHMnIDogJ3NlY29uZCdcbiAgICAgICAgICB9YCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgY3JvbkVycm9ycyA9IHZhbGlkYXRlQ3JvbihzY2hlZHVsZSk7XG5cbiAgICAgIGlmIChjcm9uRXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZXJyb3JzLnB1c2goLi4uY3JvbkVycm9ycyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGVycm9ycy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJ1bGVTY2hlZHVsZXMucHVzaChTY2hlZHVsZS5jcm9uKHRyYW5zbGF0ZVRvQ3Jvbk9wdGlvbnMoc2NoZWR1bGUpKSk7XG4gICAgfVxuICB9KTtcblxuICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JzLmpvaW4ob3MuRU9MKSk7XG4gIH1cblxuICByZXR1cm4gcnVsZVNjaGVkdWxlcztcbn07XG5cbmNvbnN0IGlzVGltZUludGVydmFsID0gKFxuICBzY2hlZHVsZTogRnVuY3Rpb25TY2hlZHVsZSxcbik6IHNjaGVkdWxlIGlzIFRpbWVJbnRlcnZhbCA9PiB7XG4gIGNvbnN0IHBhcnRzID0gc2NoZWR1bGUuc3BsaXQoJyAnKTtcblxuICByZXR1cm4gKFxuICAgIHBhcnRzWzBdID09PSAnZXZlcnknICYmXG4gICAgWydtJywgJ2gnLCAnZGF5JywgJ3dlZWsnLCAnbW9udGgnLCAneWVhciddLnNvbWUoKGEpID0+XG4gICAgICBwYXJ0c1sxXS5lbmRzV2l0aChhKSxcbiAgICApICYmXG4gICAgcGFydHMubGVuZ3RoID09PSAyXG4gICk7XG59O1xuXG5jb25zdCBwYXJzZVRpbWVJbnRlcnZhbCA9ICh0aW1lSW50ZXJ2YWw6IFRpbWVJbnRlcnZhbCkgPT4ge1xuICBjb25zdCBwYXJ0ID0gdGltZUludGVydmFsLnNwbGl0KCcgJylbMV07XG4gIGNvbnN0IHZhbHVlID0gcGFydC5tYXRjaCgvLT9cXGQrXFwuP1xcZCovKTtcbiAgY29uc3QgdW5pdCA9IHBhcnQubWF0Y2goL1thLXpBLVpdKy8pO1xuXG4gIHJldHVybiB7XG4gICAgdmFsdWU6IHZhbHVlID8gTnVtYmVyKHZhbHVlWzBdKSA6IHVuZGVmaW5lZCxcbiAgICB1bml0OiB1bml0ID8gdW5pdFswXSA6IHVuZGVmaW5lZCxcbiAgfTtcbn07XG5cbmNvbnN0IGlzUG9zaXRpdmVXaG9sZU51bWJlciA9ICh0ZXN0OiBudW1iZXIpID0+IHRlc3QgPiAwICYmIHRlc3QgJSAxID09PSAwO1xuXG5jb25zdCB2YWxpZGF0ZUNyb24gPSAoY3JvbjogQ3JvblNjaGVkdWxlKSA9PiB7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgY29uc3QgY3JvblBhcnRzID0gY3Jvbi5zcGxpdCgnICcpO1xuXG4gIGNvbnN0IFttaW51dGUsIGhvdXIsIGRheU9mTW9udGgsIG1vbnRoLCBkYXlPZldlZWssIHllYXJdID0gY3JvblBhcnRzO1xuXG4gIGNvbnN0IG1pbnV0ZVZhbGlkYXRpb25FcnJvcnMgPSB2YWxpZGF0ZUNyb25QYXJ0KCdtaW51dGVzJywgbWludXRlLCAwLCA1OSk7XG4gIGNvbnN0IGhvdXJWYWxpZGF0aW9uRXJyb3JzID0gdmFsaWRhdGVDcm9uUGFydCgnaG91cnMnLCBob3VyLCAwLCAyMyk7XG4gIGNvbnN0IGRheU9mTW9udGhWYWxpZGF0aW9uRXJyb3JzID1cbiAgICBkYXlPZk1vbnRoID09PSAnPydcbiAgICAgID8gW11cbiAgICAgIDogdmFsaWRhdGVDcm9uUGFydCgnZGF5LW9mLW1vbnRoJywgZGF5T2ZNb250aCwgMSwgMzEpO1xuICBjb25zdCBtb250aFZhbGlkYXRpb25FcnJvcnMgPSB2YWxpZGF0ZUNyb25QYXJ0KCdtb250aCcsIG1vbnRoLCAxLCAxMik7XG4gIGNvbnN0IGRheU9mV2Vla1ZhbGlkYXRpb25FcnJvcnMgPVxuICAgIGRheU9mV2VlayA9PT0gJz8nID8gW10gOiB2YWxpZGF0ZUNyb25QYXJ0KCdkYXktb2Ytd2VlaycsIGRheU9mV2VlaywgMSwgNyk7XG4gIGNvbnN0IHllYXJWYWxpZGF0aW9uRXJyb3JzID0geWVhclxuICAgID8gdmFsaWRhdGVDcm9uUGFydCgneWVhcicsIHllYXIsIDE5NzAsIDIxOTkpXG4gICAgOiBbXTtcblxuICBlcnJvcnMucHVzaChcbiAgICAuLi5taW51dGVWYWxpZGF0aW9uRXJyb3JzLFxuICAgIC4uLmhvdXJWYWxpZGF0aW9uRXJyb3JzLFxuICAgIC4uLmRheU9mTW9udGhWYWxpZGF0aW9uRXJyb3JzLFxuICAgIC4uLm1vbnRoVmFsaWRhdGlvbkVycm9ycyxcbiAgICAuLi5kYXlPZldlZWtWYWxpZGF0aW9uRXJyb3JzLFxuICAgIC4uLnllYXJWYWxpZGF0aW9uRXJyb3JzLFxuICApO1xuXG4gIGlmIChkYXlPZk1vbnRoICE9PSAnPycgJiYgZGF5T2ZXZWVrICE9PSAnPycpIHtcbiAgICBlcnJvcnMucHVzaChcbiAgICAgICdDcm9uIGV4cHJlc3Npb25zIGNhbm5vdCBoYXZlIGJvdGggZGF5LW9mLW1vbnRoIGFuZCBkYXktb2Ytd2VlayBkZWZpbmVkLCB5b3UgbXVzdCB1c2UgYSA/IGluIG9uZSBvZiB0aGUgZmllbGRzJyxcbiAgICApO1xuICB9XG5cbiAgcmV0dXJuIGVycm9ycztcbn07XG5cbmNvbnN0IHZhbGlkYXRlQ3JvblBhcnQgPSAoXG4gIGNyb25QYXJ0OiBDcm9uUGFydCxcbiAgdmFsdWU6IHN0cmluZyxcbiAgbWluOiBudW1iZXIsXG4gIG1heDogbnVtYmVyLFxuKSA9PiB7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICBpZiAodmFsdWUgPT09ICcqJykge1xuICAgIHJldHVybiBlcnJvcnM7XG4gIH1cblxuICBjb25zdCBoYXNTdGVwID0gdmFsdWUuaW5jbHVkZXMoJy8nKTtcbiAgY29uc3QgaGFzUmFuZ2UgPSB2YWx1ZS5pbmNsdWRlcygnLScpO1xuICBjb25zdCBoYXNMaXN0ID0gdmFsdWUuaW5jbHVkZXMoJywnKTtcblxuICBpZiAoaGFzTGlzdCkge1xuICAgIGNvbnN0IGxpc3RFcnJvciA9IHZhbGlkYXRlTGlzdChjcm9uUGFydCwgdmFsdWUsIG1pbiwgbWF4KTtcblxuICAgIGlmIChsaXN0RXJyb3IpIHtcbiAgICAgIGVycm9ycy5wdXNoKGxpc3RFcnJvcik7XG4gICAgfVxuICAgIGNvbnN0IGxpc3RJdGVtcyA9IHZhbHVlLnNwbGl0KCcsJyk7XG5cbiAgICBsaXN0SXRlbXMuZm9yRWFjaCgobGlzdEl0ZW0pID0+IHtcbiAgICAgIGlmIChsaXN0SXRlbS5pbmNsdWRlcygnLycpKSB7XG4gICAgICAgIGNvbnN0IHN0ZXBFcnJvciA9IHZhbGlkYXRlU3RlcFZhbHVlKGNyb25QYXJ0LCBsaXN0SXRlbSwgbWluLCBtYXgpO1xuXG4gICAgICAgIGlmIChzdGVwRXJyb3IpIHtcbiAgICAgICAgICBlcnJvcnMucHVzaChzdGVwRXJyb3IpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGxpc3RJdGVtLmluY2x1ZGVzKCctJykpIHtcbiAgICAgICAgY29uc3QgcmFuZ2VFcnJvciA9IHZhbGlkYXRlUmFuZ2UoY3JvblBhcnQsIGxpc3RJdGVtLCBtaW4sIG1heCk7XG5cbiAgICAgICAgaWYgKHJhbmdlRXJyb3IpIHtcbiAgICAgICAgICBlcnJvcnMucHVzaChyYW5nZUVycm9yKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9IGVsc2UgaWYgKGhhc1N0ZXApIHtcbiAgICBjb25zdCBzdGVwRXJyb3IgPSB2YWxpZGF0ZVN0ZXBWYWx1ZShjcm9uUGFydCwgdmFsdWUsIG1pbiwgbWF4KTtcblxuICAgIGlmIChzdGVwRXJyb3IpIHtcbiAgICAgIGVycm9ycy5wdXNoKHN0ZXBFcnJvcik7XG4gICAgfVxuICB9IGVsc2UgaWYgKGhhc1JhbmdlKSB7XG4gICAgY29uc3QgcmFuZ2VFcnJvciA9IHZhbGlkYXRlUmFuZ2UoY3JvblBhcnQsIHZhbHVlLCBtaW4sIG1heCk7XG5cbiAgICBpZiAocmFuZ2VFcnJvcikge1xuICAgICAgZXJyb3JzLnB1c2gocmFuZ2VFcnJvcik7XG4gICAgfVxuICB9XG5cbiAgaWYgKFxuICAgICFoYXNTdGVwICYmXG4gICAgIWhhc1JhbmdlICYmXG4gICAgIWhhc0xpc3QgJiZcbiAgICAhaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUoTnVtYmVyKHZhbHVlKSwgbWluLCBtYXgpXG4gICkge1xuICAgIGVycm9ycy5wdXNoKFxuICAgICAgYENyb24gZmllbGQgZm9yICR7Y3JvblBhcnR9IG11c3QgYmUgYSB3aG9sZSBudW1iZXIgYmV0d2VlbiAke21pbn0gYW5kICR7bWF4fWAsXG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiBlcnJvcnM7XG59O1xuXG5jb25zdCB2YWxpZGF0ZVN0ZXBWYWx1ZSA9IChcbiAgY3JvblBhcnQ6IENyb25QYXJ0LFxuICB2YWx1ZTogc3RyaW5nLFxuICBtaW46IG51bWJlcixcbiAgbWF4OiBudW1iZXIsXG4pID0+IHtcbiAgY29uc3Qgb3JpZ2luYWxCYXNlID0gdmFsdWUuc3BsaXQoJy8nKVswXTtcbiAgY29uc3QgW2Jhc2UsIHN0ZXBdID0gdmFsdWUuc3BsaXQoJy8nKS5tYXAoTnVtYmVyKTtcblxuICBpZiAob3JpZ2luYWxCYXNlID09PSAnKicpIHtcbiAgICBpZiAoaXNOYU4oc3RlcCkgfHwgc3RlcCA8PSAwIHx8ICFpc1Bvc2l0aXZlV2hvbGVOdW1iZXIoc3RlcCkpIHtcbiAgICAgIHJldHVybiBgQ3JvbiBzdGVwIHZhbHVlcyBmb3IgJHtjcm9uUGFydH0gbXVzdCBiZSBwb3NpdGl2ZSB3aG9sZSBudW1iZXJzYDtcbiAgICB9XG4gIH0gZWxzZSBpZiAoXG4gICAgaXNOYU4oYmFzZSkgfHxcbiAgICBpc05hTihzdGVwKSB8fFxuICAgICFpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZShiYXNlLCBtaW4sIG1heCkgfHxcbiAgICBzdGVwIDw9IDBcbiAgKSB7XG4gICAgcmV0dXJuIGBDcm9uIHN0ZXAgdmFsdWVzIGZvciAke2Nyb25QYXJ0fSBtdXN0IGJlIHdob2xlIG51bWJlcnMgYmV0d2VlbiAke21pbn0gYW5kICR7bWF4fWA7XG4gIH1cblxuICByZXR1cm47XG59O1xuXG5jb25zdCB2YWxpZGF0ZVJhbmdlID0gKFxuICBjcm9uUGFydDogQ3JvblBhcnQsXG4gIHZhbHVlOiBzdHJpbmcsXG4gIG1pbjogbnVtYmVyLFxuICBtYXg6IG51bWJlcixcbikgPT4ge1xuICBjb25zdCBbc3RhcnQsIGVuZF0gPSB2YWx1ZS5zcGxpdCgnLScpLm1hcChOdW1iZXIpO1xuXG4gIGlmIChcbiAgICBpc05hTihzdGFydCkgfHxcbiAgICBpc05hTihlbmQpIHx8XG4gICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKHN0YXJ0LCBtaW4sIG1heCkgfHxcbiAgICAhaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUoZW5kLCBtaW4sIG1heCkgfHxcbiAgICBzdGFydCA+IGVuZFxuICApIHtcbiAgICByZXR1cm4gYENyb24gcmFuZ2UgZm9yICR7Y3JvblBhcnR9IG11c3QgYmUgd2hvbGUgbnVtYmVycyBiZXR3ZWVuICR7bWlufSBhbmQgJHttYXh9YDtcbiAgfVxuXG4gIHJldHVybjtcbn07XG5cbmNvbnN0IHZhbGlkYXRlTGlzdCA9IChcbiAgY3JvblBhcnQ6IENyb25QYXJ0LFxuICB2YWx1ZTogc3RyaW5nLFxuICBtaW46IG51bWJlcixcbiAgbWF4OiBudW1iZXIsXG4pID0+IHtcbiAgaWYgKFxuICAgICF2YWx1ZVxuICAgICAgLnNwbGl0KCcsJylcbiAgICAgIC5ldmVyeSgodikgPT4gaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUoTnVtYmVyKHYpLCBtaW4sIG1heCkpXG4gICkge1xuICAgIHJldHVybiBgQ3JvbiBsaXN0IGZvciAke2Nyb25QYXJ0fSBtdXN0IGNvbnRhaW4gd2hvbGUgbnVtYmVycyBiZXR3ZWVuICR7bWlufSBhbmQgJHttYXh9YDtcbiAgfVxuXG4gIHJldHVybjtcbn07XG5cbmNvbnN0IGlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlID0gKFxuICB0ZXN0OiBudW1iZXIsXG4gIG1pbjogbnVtYmVyLFxuICBtYXg6IG51bWJlcixcbikgPT4gbWluIDw9IHRlc3QgJiYgdGVzdCA8PSBtYXggJiYgdGVzdCAlIDEgPT09IDA7XG5cbmNvbnN0IHRyYW5zbGF0ZVRvQ3Jvbk9wdGlvbnMgPSAoc2NoZWR1bGU6IEZ1bmN0aW9uU2NoZWR1bGUpOiBDcm9uT3B0aW9ucyA9PiB7XG4gIGlmIChpc1RpbWVJbnRlcnZhbChzY2hlZHVsZSkpIHtcbiAgICBjb25zdCB7IHZhbHVlLCB1bml0IH0gPSBwYXJzZVRpbWVJbnRlcnZhbChzY2hlZHVsZSk7XG4gICAgc3dpdGNoICh1bml0KSB7XG4gICAgICBjYXNlICdtJzpcbiAgICAgICAgcmV0dXJuIHsgbWludXRlOiBgKi8ke3ZhbHVlfWAgfTtcbiAgICAgIGNhc2UgJ2gnOlxuICAgICAgICByZXR1cm4geyBtaW51dGU6ICcwJywgaG91cjogYCovJHt2YWx1ZX1gIH07XG4gICAgICBjYXNlICdkYXknOlxuICAgICAgICByZXR1cm4geyBtaW51dGU6ICcwJywgaG91cjogJzAnLCBkYXk6IGAqYCB9O1xuICAgICAgY2FzZSAnd2Vlayc6XG4gICAgICAgIHJldHVybiB7IG1pbnV0ZTogJzAnLCBob3VyOiAnMCcsIHdlZWtEYXk6IGAxYCB9O1xuICAgICAgY2FzZSAnbW9udGgnOlxuICAgICAgICByZXR1cm4geyBtaW51dGU6ICcwJywgaG91cjogJzAnLCBkYXk6ICcxJywgbW9udGg6IGAqYCB9O1xuICAgICAgY2FzZSAneWVhcic6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbWludXRlOiAnMCcsXG4gICAgICAgICAgaG91cjogJzAnLFxuICAgICAgICAgIGRheTogJzEnLFxuICAgICAgICAgIG1vbnRoOiAnMScsXG4gICAgICAgICAgeWVhcjogYCpgLFxuICAgICAgICB9O1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgLy8gVGhpcyBzaG91bGQgbmV2ZXIgaGFwcGVuIHdpdGggc3RyaWN0IHR5cGVzXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnQ291bGQgbm90IGRldGVybWluZSB0aGUgc2NoZWR1bGUgcmF0ZSBmb3IgdGhlIGZ1bmN0aW9uJyxcbiAgICAgICAgKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgY3JvbkFycmF5ID0gc2NoZWR1bGUuc3BsaXQoJyAnKTtcbiAgICBjb25zdCByZXN1bHQ6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgICBtaW51dGU6IGNyb25BcnJheVswXSxcbiAgICAgIGhvdXI6IGNyb25BcnJheVsxXSxcbiAgICAgIG1vbnRoOiBjcm9uQXJyYXlbM10sXG4gICAgICB5ZWFyOiBjcm9uQXJyYXkubGVuZ3RoID09PSA2ID8gY3JvbkFycmF5WzVdIDogJyonLFxuICAgIH07XG5cbiAgICAvLyBCcmFuY2hpbmcgbG9naWMgaGVyZSBpcyBiZWNhdXNlIHdlIGNhbm5vdCBzdXBwbHkgYm90aCBkYXkgYW5kIHdlZWtEYXlcbiAgICBpZiAoY3JvbkFycmF5WzJdID09PSAnPycpIHtcbiAgICAgIHJlc3VsdC53ZWVrRGF5ID0gY3JvbkFycmF5WzRdO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQuZGF5ID0gY3JvbkFycmF5WzJdO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbn07XG4iXX0=