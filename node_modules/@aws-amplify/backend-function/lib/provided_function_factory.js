import { Tags } from 'aws-cdk-lib';
import { AmplifyUserError, TagName } from '@aws-amplify/platform-core';
import { AmplifyFunctionBase } from './function_construct_base.js';
import { FunctionResourceAccessAcceptor } from './resource_access_acceptor.js';
/**
 * Adapts provided CDK function as Amplify function.
 */
export class ProvidedFunctionFactory {
    functionProvider;
    props;
    generator;
    /**
     * Creates provided function factory.
     */
    constructor(functionProvider, props) {
        this.functionProvider = functionProvider;
        this.props = props;
    }
    /**
     * Creates a function instance.
     */
    getInstance(props) {
        if (!this.generator) {
            this.generator = new ProvidedFunctionGenerator(this.functionProvider, props.outputStorageStrategy, this.props);
        }
        return props.constructContainer.getOrCompute(this.generator);
    }
}
class ProvidedFunctionGenerator {
    functionProvider;
    outputStorageStrategy;
    resourceGroupName;
    constructor(functionProvider, outputStorageStrategy, props) {
        this.functionProvider = functionProvider;
        this.outputStorageStrategy = outputStorageStrategy;
        this.resourceGroupName = props?.resourceGroupName ?? 'function';
    }
    generateContainerEntry = ({ scope }) => {
        let providedFunction;
        try {
            providedFunction = this.functionProvider(scope);
        }
        catch (e) {
            if (e instanceof Error &&
                (e.message.includes('docker exited with status 1') ||
                    e.message.includes('docker ENOENT'))) {
                throw new AmplifyUserError('CustomFunctionProviderDockerError', {
                    message: 'Failed to instantiate custom function provider',
                    resolution: 'See https://docs.amplify.aws/react/build-a-backend/functions/custom-functions for more details about current limitations and troubleshooting steps.',
                }, e);
            }
            else {
                throw new AmplifyUserError('CustomFunctionProviderError', {
                    message: 'Failed to instantiate custom function provider',
                    resolution: 'Check the definition of your custom function provided in `defineFunction` and refer to the logs for more information. See https://docs.amplify.aws/react/build-a-backend/functions/custom-functions for more details.',
                }, e instanceof Error ? e : undefined);
            }
        }
        return new ProvidedAmplifyFunction(scope, `${providedFunction.node.id}-provided`, this.outputStorageStrategy, providedFunction);
    };
}
class ProvidedAmplifyFunction extends AmplifyFunctionBase {
    resources;
    constructor(scope, id, outputStorageStrategy, providedFunction) {
        super(scope, id, outputStorageStrategy);
        const cfnFunction = providedFunction.node.findChild('Resource');
        Tags.of(cfnFunction).add(TagName.FRIENDLY_NAME, providedFunction.node.id);
        this.resources = {
            lambda: providedFunction,
            cfnResources: {
                cfnFunction,
            },
        };
        this.storeOutput();
    }
    getResourceAccessAcceptor = () => new FunctionResourceAccessAcceptor(this);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZWRfZnVuY3Rpb25fZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wcm92aWRlZF9mdW5jdGlvbl9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWNBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDbkMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE9BQU8sRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ25FLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBWS9FOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHVCQUF1QjtJQVNmO0lBQ0E7SUFQWCxTQUFTLENBQW1DO0lBRXBEOztPQUVHO0lBQ0gsWUFDbUIsZ0JBQWlELEVBQ2pELEtBQTZCO1FBRDdCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBaUM7UUFDakQsVUFBSyxHQUFMLEtBQUssQ0FBd0I7SUFDN0MsQ0FBQztJQUVKOztPQUVHO0lBQ0gsV0FBVyxDQUFDLEtBQXVDO1FBQ2pELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ25CLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSx5QkFBeUIsQ0FDNUMsSUFBSSxDQUFDLGdCQUFnQixFQUNyQixLQUFLLENBQUMscUJBQXFCLEVBQzNCLElBQUksQ0FBQyxLQUFLLENBQ1gsQ0FBQztTQUNIO1FBQ0QsT0FBTyxLQUFLLENBQUMsa0JBQWtCLENBQUMsWUFBWSxDQUMxQyxJQUFJLENBQUMsU0FBUyxDQUNJLENBQUM7SUFDdkIsQ0FBQztDQUNGO0FBRUQsTUFBTSx5QkFBeUI7SUFJVjtJQUNBO0lBSlYsaUJBQWlCLENBQTJCO0lBRXJELFlBQ21CLGdCQUFpRCxFQUNqRCxxQkFBbUUsRUFDcEYsS0FBNkI7UUFGWixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWlDO1FBQ2pELDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBOEM7UUFHcEYsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEtBQUssRUFBRSxpQkFBaUIsSUFBSSxVQUFVLENBQUM7SUFDbEUsQ0FBQztJQUVELHNCQUFzQixHQUFHLENBQUMsRUFBRSxLQUFLLEVBQStCLEVBQUUsRUFBRTtRQUNsRSxJQUFJLGdCQUEyQixDQUFDO1FBQ2hDLElBQUk7WUFDRixnQkFBZ0IsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDakQ7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLElBQ0UsQ0FBQyxZQUFZLEtBQUs7Z0JBQ2xCLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsNkJBQTZCLENBQUM7b0JBQ2hELENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxDQUFDLEVBQ3RDO2dCQUNBLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsbUNBQW1DLEVBQ25DO29CQUNFLE9BQU8sRUFBRSxnREFBZ0Q7b0JBQ3pELFVBQVUsRUFDUixxSkFBcUo7aUJBQ3hKLEVBQ0QsQ0FBQyxDQUNGLENBQUM7YUFDSDtpQkFBTTtnQkFDTCxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLDZCQUE2QixFQUM3QjtvQkFDRSxPQUFPLEVBQUUsZ0RBQWdEO29CQUN6RCxVQUFVLEVBQ1IsdU5BQXVOO2lCQUMxTixFQUNELENBQUMsWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUNuQyxDQUFDO2FBQ0g7U0FDRjtRQUNELE9BQU8sSUFBSSx1QkFBdUIsQ0FDaEMsS0FBSyxFQUNMLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEVBQUUsV0FBVyxFQUN0QyxJQUFJLENBQUMscUJBQXFCLEVBQzFCLGdCQUFnQixDQUNqQixDQUFDO0lBQ0osQ0FBQyxDQUFDO0NBQ0g7QUFFRCxNQUFNLHVCQUF3QixTQUFRLG1CQUFtQjtJQUM5QyxTQUFTLENBQW9CO0lBQ3RDLFlBQ0UsS0FBZ0IsRUFDaEIsRUFBVSxFQUNWLHFCQUFtRSxFQUNuRSxnQkFBMkI7UUFFM0IsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUscUJBQXFCLENBQUMsQ0FBQztRQUV4QyxNQUFNLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUNqRCxVQUFVLENBQ0ksQ0FBQztRQUVqQixJQUFJLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUFFLGdCQUFnQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUUxRSxJQUFJLENBQUMsU0FBUyxHQUFHO1lBQ2YsTUFBTSxFQUFFLGdCQUFnQjtZQUN4QixZQUFZLEVBQUU7Z0JBQ1osV0FBVzthQUNaO1NBQ0YsQ0FBQztRQUVGLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQseUJBQXlCLEdBQUcsR0FBMkIsRUFBRSxDQUN2RCxJQUFJLDhCQUE4QixDQUFDLElBQUksQ0FBQyxDQUFDO0NBQzVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQW1wbGlmeUZ1bmN0aW9uLFxuICBBbXBsaWZ5UmVzb3VyY2VHcm91cE5hbWUsXG4gIEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yLFxuICBDb25zdHJ1Y3RGYWN0b3J5LFxuICBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyxcbiAgRnVuY3Rpb25SZXNvdXJjZXMsXG4gIEdlbmVyYXRlQ29udGFpbmVyRW50cnlQcm9wcyxcbiAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IENmbkZ1bmN0aW9uLCBJRnVuY3Rpb24gfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IEZ1bmN0aW9uT3V0cHV0IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHsgVGFncyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IsIFRhZ05hbWUgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQgeyBBbXBsaWZ5RnVuY3Rpb25CYXNlIH0gZnJvbSAnLi9mdW5jdGlvbl9jb25zdHJ1Y3RfYmFzZS5qcyc7XG5pbXBvcnQgeyBGdW5jdGlvblJlc291cmNlQWNjZXNzQWNjZXB0b3IgfSBmcm9tICcuL3Jlc291cmNlX2FjY2Vzc19hY2NlcHRvci5qcyc7XG5cbmV4cG9ydCB0eXBlIFByb3ZpZGVkRnVuY3Rpb25Qcm9wcyA9IHtcbiAgLyoqXG4gICAqIEdyb3VwIHRoZSBmdW5jdGlvbiB3aXRoIGV4aXN0aW5nIEFtcGxpZnkgcmVzb3VyY2VzIG9yIHNlcGFyYXRlIHRoZSBmdW5jdGlvbiBpbnRvIGl0cyBvd24gZ3JvdXAuXG4gICAqIEBkZWZhdWx0ICdmdW5jdGlvbicgLy8gZ3JvdXBpbmcgd2l0aCBvdGhlciBBbXBsaWZ5IGZ1bmN0aW9uc1xuICAgKiBAZXhhbXBsZVxuICAgKiByZXNvdXJjZUdyb3VwTmFtZTogJ2F1dGgnIC8vIHRvIGdyb3VwIGFuIGF1dGggdHJpZ2dlciB3aXRoIGFuIGF1dGggcmVzb3VyY2VcbiAgICovXG4gIHJlc291cmNlR3JvdXBOYW1lPzogQW1wbGlmeVJlc291cmNlR3JvdXBOYW1lO1xufTtcblxuLyoqXG4gKiBBZGFwdHMgcHJvdmlkZWQgQ0RLIGZ1bmN0aW9uIGFzIEFtcGxpZnkgZnVuY3Rpb24uXG4gKi9cbmV4cG9ydCBjbGFzcyBQcm92aWRlZEZ1bmN0aW9uRmFjdG9yeVxuICBpbXBsZW1lbnRzIENvbnN0cnVjdEZhY3Rvcnk8QW1wbGlmeUZ1bmN0aW9uPlxue1xuICBwcml2YXRlIGdlbmVyYXRvcjogQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3I7XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgcHJvdmlkZWQgZnVuY3Rpb24gZmFjdG9yeS5cbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25Qcm92aWRlcjogKHNjb3BlOiBDb25zdHJ1Y3QpID0+IElGdW5jdGlvbixcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzPzogUHJvdmlkZWRGdW5jdGlvblByb3BzLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBmdW5jdGlvbiBpbnN0YW5jZS5cbiAgICovXG4gIGdldEluc3RhbmNlKHByb3BzOiBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyk6IEFtcGxpZnlGdW5jdGlvbiB7XG4gICAgaWYgKCF0aGlzLmdlbmVyYXRvcikge1xuICAgICAgdGhpcy5nZW5lcmF0b3IgPSBuZXcgUHJvdmlkZWRGdW5jdGlvbkdlbmVyYXRvcihcbiAgICAgICAgdGhpcy5mdW5jdGlvblByb3ZpZGVyLFxuICAgICAgICBwcm9wcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gICAgICAgIHRoaXMucHJvcHMsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gcHJvcHMuY29uc3RydWN0Q29udGFpbmVyLmdldE9yQ29tcHV0ZShcbiAgICAgIHRoaXMuZ2VuZXJhdG9yLFxuICAgICkgYXMgQW1wbGlmeUZ1bmN0aW9uO1xuICB9XG59XG5cbmNsYXNzIFByb3ZpZGVkRnVuY3Rpb25HZW5lcmF0b3IgaW1wbGVtZW50cyBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvciB7XG4gIHJlYWRvbmx5IHJlc291cmNlR3JvdXBOYW1lOiBBbXBsaWZ5UmVzb3VyY2VHcm91cE5hbWU7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvblByb3ZpZGVyOiAoc2NvcGU6IENvbnN0cnVjdCkgPT4gSUZ1bmN0aW9uLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEZ1bmN0aW9uT3V0cHV0PixcbiAgICBwcm9wcz86IFByb3ZpZGVkRnVuY3Rpb25Qcm9wcyxcbiAgKSB7XG4gICAgdGhpcy5yZXNvdXJjZUdyb3VwTmFtZSA9IHByb3BzPy5yZXNvdXJjZUdyb3VwTmFtZSA/PyAnZnVuY3Rpb24nO1xuICB9XG5cbiAgZ2VuZXJhdGVDb250YWluZXJFbnRyeSA9ICh7IHNjb3BlIH06IEdlbmVyYXRlQ29udGFpbmVyRW50cnlQcm9wcykgPT4ge1xuICAgIGxldCBwcm92aWRlZEZ1bmN0aW9uOiBJRnVuY3Rpb247XG4gICAgdHJ5IHtcbiAgICAgIHByb3ZpZGVkRnVuY3Rpb24gPSB0aGlzLmZ1bmN0aW9uUHJvdmlkZXIoc2NvcGUpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChcbiAgICAgICAgZSBpbnN0YW5jZW9mIEVycm9yICYmXG4gICAgICAgIChlLm1lc3NhZ2UuaW5jbHVkZXMoJ2RvY2tlciBleGl0ZWQgd2l0aCBzdGF0dXMgMScpIHx8XG4gICAgICAgICAgZS5tZXNzYWdlLmluY2x1ZGVzKCdkb2NrZXIgRU5PRU5UJykpXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgJ0N1c3RvbUZ1bmN0aW9uUHJvdmlkZXJEb2NrZXJFcnJvcicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBpbnN0YW50aWF0ZSBjdXN0b20gZnVuY3Rpb24gcHJvdmlkZXInLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgJ1NlZSBodHRwczovL2RvY3MuYW1wbGlmeS5hd3MvcmVhY3QvYnVpbGQtYS1iYWNrZW5kL2Z1bmN0aW9ucy9jdXN0b20tZnVuY3Rpb25zIGZvciBtb3JlIGRldGFpbHMgYWJvdXQgY3VycmVudCBsaW1pdGF0aW9ucyBhbmQgdHJvdWJsZXNob290aW5nIHN0ZXBzLicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBlLFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgJ0N1c3RvbUZ1bmN0aW9uUHJvdmlkZXJFcnJvcicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBpbnN0YW50aWF0ZSBjdXN0b20gZnVuY3Rpb24gcHJvdmlkZXInLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgJ0NoZWNrIHRoZSBkZWZpbml0aW9uIG9mIHlvdXIgY3VzdG9tIGZ1bmN0aW9uIHByb3ZpZGVkIGluIGBkZWZpbmVGdW5jdGlvbmAgYW5kIHJlZmVyIHRvIHRoZSBsb2dzIGZvciBtb3JlIGluZm9ybWF0aW9uLiBTZWUgaHR0cHM6Ly9kb2NzLmFtcGxpZnkuYXdzL3JlYWN0L2J1aWxkLWEtYmFja2VuZC9mdW5jdGlvbnMvY3VzdG9tLWZ1bmN0aW9ucyBmb3IgbW9yZSBkZXRhaWxzLicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBlIGluc3RhbmNlb2YgRXJyb3IgPyBlIDogdW5kZWZpbmVkLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb3ZpZGVkQW1wbGlmeUZ1bmN0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICBgJHtwcm92aWRlZEZ1bmN0aW9uLm5vZGUuaWR9LXByb3ZpZGVkYCxcbiAgICAgIHRoaXMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgICAgcHJvdmlkZWRGdW5jdGlvbixcbiAgICApO1xuICB9O1xufVxuXG5jbGFzcyBQcm92aWRlZEFtcGxpZnlGdW5jdGlvbiBleHRlbmRzIEFtcGxpZnlGdW5jdGlvbkJhc2Uge1xuICByZWFkb25seSByZXNvdXJjZXM6IEZ1bmN0aW9uUmVzb3VyY2VzO1xuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEZ1bmN0aW9uT3V0cHV0PixcbiAgICBwcm92aWRlZEZ1bmN0aW9uOiBJRnVuY3Rpb24sXG4gICkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5KTtcblxuICAgIGNvbnN0IGNmbkZ1bmN0aW9uID0gcHJvdmlkZWRGdW5jdGlvbi5ub2RlLmZpbmRDaGlsZChcbiAgICAgICdSZXNvdXJjZScsXG4gICAgKSBhcyBDZm5GdW5jdGlvbjtcblxuICAgIFRhZ3Mub2YoY2ZuRnVuY3Rpb24pLmFkZChUYWdOYW1lLkZSSUVORExZX05BTUUsIHByb3ZpZGVkRnVuY3Rpb24ubm9kZS5pZCk7XG5cbiAgICB0aGlzLnJlc291cmNlcyA9IHtcbiAgICAgIGxhbWJkYTogcHJvdmlkZWRGdW5jdGlvbixcbiAgICAgIGNmblJlc291cmNlczoge1xuICAgICAgICBjZm5GdW5jdGlvbixcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHRoaXMuc3RvcmVPdXRwdXQoKTtcbiAgfVxuXG4gIGdldFJlc291cmNlQWNjZXNzQWNjZXB0b3IgPSAoKTogUmVzb3VyY2VBY2Nlc3NBY2NlcHRvciA9PlxuICAgIG5ldyBGdW5jdGlvblJlc291cmNlQWNjZXNzQWNjZXB0b3IodGhpcyk7XG59XG4iXX0=