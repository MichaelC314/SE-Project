import { NamingConverter } from '@aws-amplify/platform-core';
import { GetObjectCommand, NoSuchKey, S3Client, S3ServiceException, } from '@aws-sdk/client-s3';
const dataKeyNameContent = '_MODEL_INTROSPECTION_SCHEMA_KEY';
const dataBucketNameContent = '_MODEL_INTROSPECTION_SCHEMA_BUCKET_NAME';
const dataEndpointNameContent = '_GRAPHQL_ENDPOINT';
/* eslint-enable @typescript-eslint/naming-convention */
const getResourceConfig = (env, modelIntrospectionSchema) => {
    return {
        API: {
            GraphQL: {
                endpoint: env.dataEndpoint,
                region: env.AWS_REGION,
                defaultAuthMode: 'iam',
                modelIntrospection: modelIntrospectionSchema,
            },
        },
    };
};
const getLibraryOptions = (env) => {
    return {
        Auth: {
            credentialsProvider: {
                getCredentialsAndIdentityId: async () => ({
                    credentials: {
                        accessKeyId: env.AWS_ACCESS_KEY_ID,
                        secretAccessKey: env.AWS_SECRET_ACCESS_KEY,
                        sessionToken: env.AWS_SESSION_TOKEN,
                    },
                }),
                clearCredentialsAndIdentityId: () => {
                    /* noop */
                },
            },
        },
    };
};
const extendEnv = (env, dataName) => {
    const bucketName = `${dataName}${dataBucketNameContent}`;
    const keyName = `${dataName}${dataKeyNameContent}`;
    const endpointName = `${dataName}${dataEndpointNameContent}`;
    if (!(bucketName in env &&
        keyName in env &&
        endpointName in env &&
        typeof env[bucketName] === 'string' &&
        typeof env[keyName] === 'string' &&
        typeof env[endpointName] === 'string')) {
        throw new Error(`The data environment variables are malformed. env=${JSON.stringify(env)}`);
    }
    const dataBucket = env[bucketName];
    const dataKey = env[keyName];
    const dataEndpoint = env[endpointName];
    return {
        ...env,
        dataBucket,
        dataKey,
        dataEndpoint,
    };
};
/**
 * Generate the `resourceConfig` and `libraryOptions` need to configure
 * Amplify for the data client in a lambda.
 *
 * Your function needs to be granted resource access on your schema for this to work
 * `a.schema(...).authorization((allow) => [a.resource(myFunction)])`
 * @param env - The environment variables for the data client
 * @returns An object containing the `resourceConfig` and `libraryOptions`
 */
export const getAmplifyDataClientConfig = async (env, s3Client) => {
    if (!s3Client) {
        s3Client = new S3Client();
    }
    const dataName = new NamingConverter().toScreamingSnakeCase(env.AMPLIFY_DATA_DEFAULT_NAME);
    const extendedEnv = extendEnv(env, dataName);
    let modelIntrospectionSchema;
    try {
        const response = await s3Client.send(new GetObjectCommand({
            Bucket: extendedEnv.dataBucket,
            Key: extendedEnv.dataKey,
        }));
        const modelIntrospectionSchemaJson = await response.Body?.transformToString();
        modelIntrospectionSchema = JSON.parse(modelIntrospectionSchemaJson ?? '{}');
    }
    catch (caught) {
        if (caught instanceof NoSuchKey) {
            throw new Error('Error retrieving the schema from S3. Please confirm that your project has a `defineData` included in the `defineBackend` definition.', { cause: caught });
        }
        else if (caught instanceof S3ServiceException) {
            throw new Error(`Error retrieving the schema from S3. You may need to grant this function authorization on the schema. ${caught.name}: ${caught.message}.`, { cause: caught });
        }
        else {
            throw caught;
        }
    }
    const libraryOptions = getLibraryOptions(env);
    const resourceConfig = getResourceConfig(extendedEnv, modelIntrospectionSchema);
    return { resourceConfig, libraryOptions };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0X2FtcGxpZnlfY2xpZW50c19jb25maWd1cmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3J1bnRpbWUvZ2V0X2FtcGxpZnlfY2xpZW50c19jb25maWd1cmF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLFNBQVMsRUFDVCxRQUFRLEVBQ1Isa0JBQWtCLEdBQ25CLE1BQU0sb0JBQW9CLENBQUM7QUFFNUIsTUFBTSxrQkFBa0IsR0FBRyxpQ0FBaUMsQ0FBQztBQUM3RCxNQUFNLHFCQUFxQixHQUFHLHlDQUF5QyxDQUFDO0FBQ3hFLE1BQU0sdUJBQXVCLEdBQUcsbUJBQW1CLENBQUM7QUFrQ3BELHdEQUF3RDtBQUV4RCxNQUFNLGlCQUFpQixHQUFHLENBQ3hCLEdBQTZCLEVBQzdCLHdCQUFnQyxFQUNoQixFQUFFO0lBQ2xCLE9BQU87UUFDTCxHQUFHLEVBQUU7WUFDSCxPQUFPLEVBQUU7Z0JBQ1AsUUFBUSxFQUFFLEdBQUcsQ0FBQyxZQUFZO2dCQUMxQixNQUFNLEVBQUUsR0FBRyxDQUFDLFVBQVU7Z0JBQ3RCLGVBQWUsRUFBRSxLQUFjO2dCQUMvQixrQkFBa0IsRUFBRSx3QkFBd0I7YUFDN0M7U0FDRjtLQUNGLENBQUM7QUFDSixDQUFDLENBQUM7QUFrQkYsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLEdBQWtCLEVBQWtCLEVBQUU7SUFDL0QsT0FBTztRQUNMLElBQUksRUFBRTtZQUNKLG1CQUFtQixFQUFFO2dCQUNuQiwyQkFBMkIsRUFBRSxLQUFLLElBQUksRUFBRSxDQUFDLENBQUM7b0JBQ3hDLFdBQVcsRUFBRTt3QkFDWCxXQUFXLEVBQUUsR0FBRyxDQUFDLGlCQUFpQjt3QkFDbEMsZUFBZSxFQUFFLEdBQUcsQ0FBQyxxQkFBcUI7d0JBQzFDLFlBQVksRUFBRSxHQUFHLENBQUMsaUJB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QUFDO0lBRTlDLE1BQU0sY0FBYyxHQUFHLGlCQUFpQixDQUN0QyxXQUFXLEVBQ1gsd0JBQXdCLENBQ3pCLENBQUM7SUFFRixPQUFPLEVBQUUsY0FBYyxFQUFFLGNBQWMsRUFBRSxDQUFDO0FBQzVDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5hbWluZ0NvbnZlcnRlciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7XG4gIEdldE9iamVjdENvbW1hbmQsXG4gIE5vU3VjaEtleSxcbiAgUzNDbGllbnQsXG4gIFMzU2VydmljZUV4Y2VwdGlvbixcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcblxuY29uc3QgZGF0YUtleU5hbWVDb250ZW50ID0gJ19NT0RFTF9JTlRST1NQRUNUSU9OX1NDSEVNQV9LRVknO1xuY29uc3QgZGF0YUJ1Y2tldE5hbWVDb250ZW50ID0gJ19NT0RFTF9JTlRST1NQRUNUSU9OX1NDSEVNQV9CVUNLRVRfTkFNRSc7XG5jb25zdCBkYXRhRW5kcG9pbnROYW1lQ29udGVudCA9ICdfR1JBUEhRTF9FTkRQT0lOVCc7XG5cbmV4cG9ydCB0eXBlIERhdGFDbGllbnRFbnYgPSB7XG4gIC8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiAqL1xuICBBV1NfQUNDRVNTX0tFWV9JRDogc3RyaW5nO1xuICBBV1NfU0VDUkVUX0FDQ0VTU19LRVk6IHN0cmluZztcbiAgQVdTX1NFU1NJT05fVE9LRU46IHN0cmluZztcbiAgQVdTX1JFR0lPTjogc3RyaW5nO1xuICBBTVBMSUZZX0RBVEFfREVGQVVMVF9OQU1FOiBzdHJpbmc7XG4gIC8qIGVzbGludC1lbmFibGUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uICovXG59ICYgUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG5cbnR5cGUgRGF0YUVudkV4dGVuc2lvbiA9IHtcbiAgZGF0YUJ1Y2tldDogc3RyaW5nO1xuICBkYXRhS2V5OiBzdHJpbmc7XG4gIGRhdGFFbmRwb2ludDogc3RyaW5nO1xufTtcblxudHlwZSBFeHRlbmRlZEFtcGxpZnlDbGllbnRFbnYgPSBEYXRhQ2xpZW50RW52ICYgRGF0YUVudkV4dGVuc2lvbjtcblxuLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uICovXG5leHBvcnQgdHlwZSBSZXNvdXJjZUNvbmZpZyA9IHtcbiAgQVBJOiB7XG4gICAgR3JhcGhRTDoge1xuICAgICAgZW5kcG9pbnQ6IHN0cmluZztcbiAgICAgIHJlZ2lvbjogc3RyaW5nO1xuICAgICAgZGVmYXVsdEF1dGhNb2RlOiAnaWFtJztcbiAgICAgIC8vIFVzaW5nIGBhbnlgIHRvIGF2b2lkIHJlcHJvZHVjaW5nIDEwMCsgbGluZXMgb2YgdHlwaW5nIHRvIG1hdGNoIHRoZSBleHBlY3RlZCBzaGFwZSBkZWZpbmVkIGluIGF3cy1hbXBsaWZ5OlxuICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2F3cy1hbXBsaWZ5L2FtcGxpZnktanMvYmxvYi9tYWluL3BhY2thZ2VzL2NvcmUvc3JjL3NpbmdsZXRvbi9BUEkvdHlwZXMudHMjTDE0My1MMTUzXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgbW9kZWxJbnRyb3NwZWN0aW9uOiBhbnk7XG4gICAgfTtcbiAgfTtcbn07XG4vKiBlc2xpbnQtZW5hYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiAqL1xuXG5jb25zdCBnZXRSZXNvdXJjZUNvbmZpZyA9IChcbiAgZW52OiBFeHRlbmRlZEFtcGxpZnlDbGllbnRFbnYsXG4gIG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYTogb2JqZWN0LFxuKTogUmVzb3VyY2VDb25maWcgPT4ge1xuICByZXR1cm4ge1xuICAgIEFQSToge1xuICAgICAgR3JhcGhRTDoge1xuICAgICAgICBlbmRwb2ludDogZW52LmRhdGFFbmRwb2ludCxcbiAgICAgICAgcmVnaW9uOiBlbnYuQVdTX1JFR0lPTixcbiAgICAgICAgZGVmYXVsdEF1dGhNb2RlOiAnaWFtJyBhcyBjb25zdCxcbiAgICAgICAgbW9kZWxJbnRyb3NwZWN0aW9uOiBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWEsXG4gICAgICB9LFxuICAgIH0sXG4gIH07XG59O1xuXG5leHBvcnQgdHlwZSBMaWJyYXJ5T3B0aW9ucyA9IHtcbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiAqL1xuICBBdXRoOiB7XG4gICAgY3JlZGVudGlhbHNQcm92aWRlcjoge1xuICAgICAgZ2V0Q3JlZGVudGlhbHNBbmRJZGVudGl0eUlkOiAoKSA9PiBQcm9taXNlPHtcbiAgICAgICAgY3JlZGVudGlhbHM6IHtcbiAgICAgICAgICBhY2Nlc3NLZXlJZDogc3RyaW5nO1xuICAgICAgICAgIHNlY3JldEFjY2Vzc0tleTogc3RyaW5nO1xuICAgICAgICAgIHNlc3Npb25Ub2tlbjogc3RyaW5nO1xuICAgICAgICB9O1xuICAgICAgfT47XG4gICAgICBjbGVhckNyZWRlbnRpYWxzQW5kSWRlbnRpdHlJZDogKCkgPT4gdm9pZDtcbiAgICB9O1xuICB9O1xufTtcblxuY29uc3QgZ2V0TGlicmFyeU9wdGlvbnMgPSAoZW52OiBEYXRhQ2xpZW50RW52KTogTGlicmFyeU9wdGlvbnMgPT4ge1xuICByZXR1cm4ge1xuICAgIEF1dGg6IHtcbiAgICAgIGNyZWRlbnRpYWxzUHJvdmlkZXI6IHtcbiAgICAgICAgZ2V0Q3JlZGVudGlhbHNBbmRJZGVudGl0eUlkOiBhc3luYyAoKSA9PiAoe1xuICAgICAgICAgIGNyZWRlbnRpYWxzOiB7XG4gICAgICAgICAgICBhY2Nlc3NLZXlJZDogZW52LkFXU19BQ0NFU1NfS0VZX0lELFxuICAgICAgICAgICAgc2VjcmV0QWNjZXNzS2V5OiBlbnYuQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZLFxuICAgICAgICAgICAgc2Vzc2lvblRva2VuOiBlbnYuQVdTX1NFU1NJT05fVE9LRU4sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICAgIGNsZWFyQ3JlZGVudGlhbHNBbmRJZGVudGl0eUlkOiAoKSA9PiB7XG4gICAgICAgICAgLyogbm9vcCAqL1xuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9O1xufTtcblxuZXhwb3J0IHR5cGUgRGF0YUNsaWVudENvbmZpZyA9IHtcbiAgcmVzb3VyY2VDb25maWc6IFJlc291cmNlQ29uZmlnO1xuICBsaWJyYXJ5T3B0aW9uczogTGlicmFyeU9wdGlvbnM7XG59O1xuXG5jb25zdCBleHRlbmRFbnYgPSAoXG4gIGVudjogRGF0YUNsaWVudEVudiAmIFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICBkYXRhTmFtZTogc3RyaW5nLFxuKTogRXh0ZW5kZWRBbXBsaWZ5Q2xpZW50RW52ID0+IHtcbiAgY29uc3QgYnVja2V0TmFtZSA9IGAke2RhdGFOYW1lfSR7ZGF0YUJ1Y2tldE5hbWVDb250ZW50fWA7XG4gIGNvbnN0IGtleU5hbWUgPSBgJHtkYXRhTmFtZX0ke2RhdGFLZXlOYW1lQ29udGVudH1gO1xuICBjb25zdCBlbmRwb2ludE5hbWUgPSBgJHtkYXRhTmFtZX0ke2RhdGFFbmRwb2ludE5hbWVDb250ZW50fWA7XG4gIGlmIChcbiAgICAhKFxuICAgICAgYnVja2V0TmFtZSBpbiBlbnYgJiZcbiAgICAgIGtleU5hbWUgaW4gZW52ICYmXG4gICAgICBlbmRwb2ludE5hbWUgaW4gZW52ICYmXG4gICAgICB0eXBlb2YgZW52W2J1Y2tldE5hbWVdID09PSAnc3RyaW5nJyAmJlxuICAgICAgdHlwZW9mIGVudltrZXlOYW1lXSA9PT0gJ3N0cmluZycgJiZcbiAgICAgIHR5cGVvZiBlbnZbZW5kcG9pbnROYW1lXSA9PT0gJ3N0cmluZydcbiAgICApXG4gICkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBUaGUgZGF0YSBlbnZpcm9ubWVudCB2YXJpYWJsZXMgYXJlIG1hbGZvcm1lZC4gZW52PSR7SlNPTi5zdHJpbmdpZnkoZW52KX1gLFxuICAgICk7XG4gIH1cblxuICBjb25zdCBkYXRhQnVja2V0ID0gZW52W2J1Y2tldE5hbWVdIGFzIHN0cmluZztcbiAgY29uc3QgZGF0YUtleSA9IGVudltrZXlOYW1lXSBhcyBzdHJpbmc7XG4gIGNvbnN0IGRhdGFFbmRwb2ludCA9IGVudltlbmRwb2ludE5hbWVdIGFzIHN0cmluZztcblxuICByZXR1cm4ge1xuICAgIC4uLmVudixcbiAgICBkYXRhQnVja2V0LFxuICAgIGRhdGFLZXksXG4gICAgZGF0YUVuZHBvaW50LFxuICB9O1xufTtcblxuLyoqXG4gKiBHZW5lcmF0ZSB0aGUgYHJlc291cmNlQ29uZmlnYCBhbmQgYGxpYnJhcnlPcHRpb25zYCBuZWVkIHRvIGNvbmZpZ3VyZVxuICogQW1wbGlmeSBmb3IgdGhlIGRhdGEgY2xpZW50IGluIGEgbGFtYmRhLlxuICpcbiAqIFlvdXIgZnVuY3Rpb24gbmVlZHMgdG8gYmUgZ3JhbnRlZCByZXNvdXJjZSBhY2Nlc3Mgb24geW91ciBzY2hlbWEgZm9yIHRoaXMgdG8gd29ya1xuICogYGEuc2NoZW1hKC4uLikuYXV0aG9yaXphdGlvbigoYWxsb3cpID0+IFthLnJlc291cmNlKG15RnVuY3Rpb24pXSlgXG4gKiBAcGFyYW0gZW52IC0gVGhlIGVudmlyb25tZW50IHZhcmlhYmxlcyBmb3IgdGhlIGRhdGEgY2xpZW50XG4gKiBAcmV0dXJucyBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgYHJlc291cmNlQ29uZmlnYCBhbmQgYGxpYnJhcnlPcHRpb25zYFxuICovXG5leHBvcnQgY29uc3QgZ2V0QW1wbGlmeURhdGFDbGllbnRDb25maWcgPSBhc3luYyAoXG4gIGVudjogRGF0YUNsaWVudEVudixcbiAgczNDbGllbnQ/OiBTM0NsaWVudCxcbik6IFByb21pc2U8RGF0YUNsaWVudENvbmZpZz4gPT4ge1xuICBpZiAoIXMzQ2xpZW50KSB7XG4gICAgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoKTtcbiAgfVxuXG4gIGNvbnN0IGRhdGFOYW1lID0gbmV3IE5hbWluZ0NvbnZlcnRlcigpLnRvU2NyZWFtaW5nU25ha2VDYXNlKFxuICAgIGVudi5BTVBMSUZZX0RBVEFfREVGQVVMVF9OQU1FLFxuICApO1xuICBjb25zdCBleHRlbmRlZEVudiA9IGV4dGVuZEVudihlbnYsIGRhdGFOYW1lKTtcblxuICBsZXQgbW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hOiBvYmplY3Q7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHMzQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgR2V0T2JqZWN0Q29tbWFuZCh7XG4gICAgICAgIEJ1Y2tldDogZXh0ZW5kZWRFbnYuZGF0YUJ1Y2tldCxcbiAgICAgICAgS2V5OiBleHRlbmRlZEVudi5kYXRhS2V5LFxuICAgICAgfSksXG4gICAgKTtcbiAgICBjb25zdCBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWFKc29uID1cbiAgICAgIGF3YWl0IHJlc3BvbnNlLkJvZHk/LnRyYW5zZm9ybVRvU3RyaW5nKCk7XG4gICAgbW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hID0gSlNPTi5wYXJzZShtb2RlbEludHJvc3BlY3Rpb25TY2hlbWFKc29uID8/ICd7fScpO1xuICB9IGNhdGNoIChjYXVnaHQpIHtcbiAgICBpZiAoY2F1Z2h0IGluc3RhbmNlb2YgTm9TdWNoS2V5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdFcnJvciByZXRyaWV2aW5nIHRoZSBzY2hlbWEgZnJvbSBTMy4gUGxlYXNlIGNvbmZpcm0gdGhhdCB5b3VyIHByb2plY3QgaGFzIGEgYGRlZmluZURhdGFgIGluY2x1ZGVkIGluIHRoZSBgZGVmaW5lQmFja2VuZGAgZGVmaW5pdGlvbi4nLFxuICAgICAgICB7IGNhdXNlOiBjYXVnaHQgfSxcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChjYXVnaHQgaW5zdGFuY2VvZiBTM1NlcnZpY2VFeGNlcHRpb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEVycm9yIHJldHJpZXZpbmcgdGhlIHNjaGVtYSBmcm9tIFMzLiBZb3UgbWF5IG5lZWQgdG8gZ3JhbnQgdGhpcyBmdW5jdGlvbiBhdXRob3JpemF0aW9uIG9uIHRoZSBzY2hlbWEuICR7Y2F1Z2h0Lm5hbWV9OiAke2NhdWdodC5tZXNzYWdlfS5gLFxuICAgICAgICB7IGNhdXNlOiBjYXVnaHQgfSxcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IGNhdWdodDtcbiAgICB9XG4gIH1cblxuICBjb25zdCBsaWJyYXJ5T3B0aW9ucyA9IGdldExpYnJhcnlPcHRpb25zKGVudik7XG5cbiAgY29uc3QgcmVzb3VyY2VDb25maWcgPSBnZXRSZXNvdXJjZUNvbmZpZyhcbiAgICBleHRlbmRlZEVudixcbiAgICBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWEsXG4gICk7XG5cbiAgcmV0dXJuIHsgcmVzb3VyY2VDb25maWcsIGxpYnJhcnlPcHRpb25zIH07XG59O1xuIl19