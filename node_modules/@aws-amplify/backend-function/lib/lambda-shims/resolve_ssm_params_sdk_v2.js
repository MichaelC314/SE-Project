/**
 * This code loads environment values from SSM and places them in their corresponding environment variables.
 * If there are no SSM environment values for this function, this is a noop.
 *
 * We include the cjs shim here because it is required for the ssm shim to work both in the lambda and in tests
 */
// cjs shim
import { createRequire } from 'node:module';
import path from 'node:path';
import url from 'node:url';
global.require = createRequire(import.meta.url);
global.__filename = url.fileURLToPath(import.meta.url);
global.__dirname = path.dirname(__filename);
// aws-sdk v2 does not play nice with normal ESM imports so we have to use require here
// eslint-disable-next-line @typescript-eslint/no-require-imports
const aws = require('aws-sdk');
/**
 * Reads SSM environment context from a known Amplify environment variable,
 * fetches values from SSM and places those values in the corresponding environment variables
 */
export const internalAmplifyFunctionResolveSsmParams = async (client = new aws.SSM()) => {
    const envPathObject = JSON.parse(process.env.AMPLIFY_SSM_ENV_CONFIG ?? '{}');
    const paths = Object.keys(envPathObject);
    if (paths.length === 0) {
        return;
    }
    const chunkArray = (array, chunkSize) => {
        const chunks = [];
        for (let i = 0; i < array.length; i += chunkSize) {
            chunks.push(array.slice(i, i + chunkSize));
        }
        return chunks;
    };
    const resolveSecrets = async (paths) => {
        const response = (await Promise.all(chunkArray(paths, 10).map(async (chunkedPaths) => await client
            .getParameters({
            Names: chunkedPaths,
            WithDecryption: true,
        })
            .promise()))).reduce((accumulator, response) => {
            accumulator.Parameters?.push(...(response.Parameters ?? []));
            accumulator.InvalidParameters?.push(...(response.InvalidParameters ?? []));
            return accumulator;
        }, {
            Parameters: [],
            InvalidParameters: [],
        });
        if (response.Parameters && response.Parameters.length > 0) {
            for (const parameter of response.Parameters) {
                if (parameter.Name) {
                    const envKey = Object.keys(envPathObject).find((key) => envPathObject[key].sharedPath === parameter.Name);
                    const envName = envKey
                        ? envPathObject[envKey].name
                        : envPathObject[parameter.Name]?.name;
                    process.env[envName] = parameter.Value;
                }
            }
        }
        return response;
    };
    const response = await resolveSecrets(paths);
    const sharedPaths = (response?.InvalidParameters || [])
        .map((invalidParam) => envPathObject[invalidParam].sharedPath)
        .filter((sharedParam) => !!sharedParam); // this assertion is safe because we are filtering out undefined
    if (sharedPaths.length > 0) {
        await resolveSecrets(sharedPaths);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb2x2ZV9zc21fcGFyYW1zX3Nka192Mi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW1iZGEtc2hpbXMvcmVzb2x2ZV9zc21fcGFyYW1zX3Nka192Mi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUNILFdBQVc7QUFDWCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzVDLE9BQU8sSUFBSSxNQUFNLFdBQVcsQ0FBQztBQUM3QixPQUFPLEdBQUcsTUFBTSxVQUFVLENBQUM7QUFDM0IsTUFBTSxDQUFDLE9BQU8sR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNoRCxNQUFNLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN2RCxNQUFNLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFNNUMsdUZBQXVGO0FBQ3ZGLGlFQUFpRTtBQUNqRSxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFL0I7OztHQUdHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sdUNBQXVDLEdBQUcsS0FBSyxFQUMxRCxTQUFTLElBQUksR0FBRyxDQUFDLEdBQUcsRUFBUyxFQUM3QixFQUFFO0lBQ0YsTUFBTSxhQUFhLEdBQWUsSUFBSSxDQUFDLEtBQUssQ0FDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsSUFBSSxJQUFJLENBQzNDLENBQUM7SUFDRixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBRXpDLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDdEIsT0FBTztLQUNSO0lBRUQsTUFBTSxVQUFVLEdBQUcsQ0FBSSxLQUFVLEVBQUUs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aXMgY29kZSBsb2FkcyBlbnZpcm9ubWVudCB2YWx1ZXMgZnJvbSBTU00gYW5kIHBsYWNlcyB0aGVtIGluIHRoZWlyIGNvcnJlc3BvbmRpbmcgZW52aXJvbm1lbnQgdmFyaWFibGVzLlxuICogSWYgdGhlcmUgYXJlIG5vIFNTTSBlbnZpcm9ubWVudCB2YWx1ZXMgZm9yIHRoaXMgZnVuY3Rpb24sIHRoaXMgaXMgYSBub29wLlxuICpcbiAqIFdlIGluY2x1ZGUgdGhlIGNqcyBzaGltIGhlcmUgYmVjYXVzZSBpdCBpcyByZXF1aXJlZCBmb3IgdGhlIHNzbSBzaGltIHRvIHdvcmsgYm90aCBpbiB0aGUgbGFtYmRhIGFuZCBpbiB0ZXN0c1xuICovXG4vLyBjanMgc2hpbVxuaW1wb3J0IHsgY3JlYXRlUmVxdWlyZSB9IGZyb20gJ25vZGU6bW9kdWxlJztcbmltcG9ydCBwYXRoIGZyb20gJ25vZGU6cGF0aCc7XG5pbXBvcnQgdXJsIGZyb20gJ25vZGU6dXJsJztcbmdsb2JhbC5yZXF1aXJlID0gY3JlYXRlUmVxdWlyZShpbXBvcnQubWV0YS51cmwpO1xuZ2xvYmFsLl9fZmlsZW5hbWUgPSB1cmwuZmlsZVVSTFRvUGF0aChpbXBvcnQubWV0YS51cmwpO1xuZ2xvYmFsLl9fZGlybmFtZSA9IHBhdGguZGlybmFtZShfX2ZpbGVuYW1lKTtcblxuLy8gdHlwZSBpbXBvcnRzIHRoYXQgd2lsbCBiZSBlcmFzZWQgZnJvbSB0aGUgYnVuZGxlIG91dHB1dFxuaW1wb3J0IHR5cGUgeyBTU00gfSBmcm9tICdhd3Mtc2RrJztcbmltcG9ydCB0eXBlIHsgU3NtRW52VmFycyB9IGZyb20gJy4uL2Z1bmN0aW9uX2Vudl90cmFuc2xhdG9yLmpzJztcblxuLy8gYXdzLXNkayB2MiBkb2VzIG5vdCBwbGF5IG5pY2Ugd2l0aCBub3JtYWwgRVNNIGltcG9ydHMgc28gd2UgaGF2ZSB0byB1c2UgcmVxdWlyZSBoZXJlXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXJlcXVpcmUtaW1wb3J0c1xuY29uc3QgYXdzID0gcmVxdWlyZSgnYXdzLXNkaycpO1xuXG4vKipcbiAqIFJlYWRzIFNTTSBlbnZpcm9ubWVudCBjb250ZXh0IGZyb20gYSBrbm93biBBbXBsaWZ5IGVudmlyb25tZW50IHZhcmlhYmxlLFxuICogZmV0Y2hlcyB2YWx1ZXMgZnJvbSBTU00gYW5kIHBsYWNlcyB0aG9zZSB2YWx1ZXMgaW4gdGhlIGNvcnJlc3BvbmRpbmcgZW52aXJvbm1lbnQgdmFyaWFibGVzXG4gKi9cbmV4cG9ydCBjb25zdCBpbnRlcm5hbEFtcGxpZnlGdW5jdGlvblJlc29sdmVTc21QYXJhbXMgPSBhc3luYyAoXG4gIGNsaWVudCA9IG5ldyBhd3MuU1NNKCkgYXMgU1NNLFxuKSA9PiB7XG4gIGNvbnN0IGVudlBhdGhPYmplY3Q6IFNzbUVudlZhcnMgPSBKU09OLnBhcnNlKFxuICAgIHByb2Nlc3MuZW52LkFNUExJRllfU1NNX0VOVl9DT05GSUcgPz8gJ3t9JyxcbiAgKTtcbiAgY29uc3QgcGF0aHMgPSBPYmplY3Qua2V5cyhlbnZQYXRoT2JqZWN0KTtcblxuICBpZiAocGF0aHMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgY2h1bmtBcnJheSA9IDxUPihhcnJheTogVFtdLCBjaHVua1NpemU6IG51bWJlcik6IFRbXVtdID0+IHtcbiAgICBjb25zdCBjaHVua3M6IFRbXVtdID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkgKz0gY2h1bmtTaXplKSB7XG4gICAgICBjaHVua3MucHVzaChhcnJheS5zbGljZShpLCBpICsgY2h1bmtTaXplKSk7XG4gICAgfVxuICAgIHJldHVybiBjaHVua3M7XG4gIH07XG5cbiAgY29uc3QgcmVzb2x2ZVNlY3JldHMgPSBhc3luYyAocGF0aHM6IHN0cmluZ1tdKSA9PiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSAoXG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgY2h1bmtBcnJheShwYXRocywgMTApLm1hcChcbiAgICAgICAgICBhc3luYyAoY2h1bmtlZFBhdGhzKSA9PlxuICAgICAgICAgICAgYXdhaXQgY2xpZW50XG4gICAgICAgICAgICAgIC5nZXRQYXJhbWV0ZXJzKHtcbiAgICAgICAgICAgICAgICBOYW1lczogY2h1bmtlZFBhdGhzLFxuICAgICAgICAgICAgICAgIFdpdGhEZWNyeXB0aW9uOiB0cnVlLFxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAucHJvbWlzZSgpLFxuICAgICAgICApLFxuICAgICAgKVxuICAgICkucmVkdWNlKFxuICAgICAgKGFjY3VtdWxhdG9yLCByZXNwb25zZSkgPT4ge1xuICAgICAgICBhY2N1bXVsYXRvci5QYXJhbWV0ZXJzPy5wdXNoKC4uLihyZXNwb25zZS5QYXJhbWV0ZXJzID8/IFtdKSk7XG4gICAgICAgIGFjY3VtdWxhdG9yLkludmFsaWRQYXJhbWV0ZXJzPy5wdXNoKFxuICAgICAgICAgIC4uLihyZXNwb25zZS5JbnZhbGlkUGFyYW1ldGVycyA/PyBbXSksXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiBhY2N1bXVsYXRvcjtcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIFBhcmFtZXRlcnM6IFtdLFxuICAgICAgICBJbnZhbGlkUGFyYW1ldGVyczogW10sXG4gICAgICB9IGFzIFNTTS5HZXRQYXJhbWV0ZXJzUmVzdWx0LFxuICAgICk7XG5cbiAgICBpZiAocmVzcG9uc2UuUGFyYW1ldGVycyAmJiByZXNwb25zZS5QYXJhbWV0ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIGZvciAoY29uc3QgcGFyYW1ldGVyIG9mIHJlc3BvbnNlLlBhcmFtZXRlcnMpIHtcbiAgICAgICAgaWYgKHBhcmFtZXRlci5OYW1lKSB7XG4gICAgICAgICAgY29uc3QgZW52S2V5ID0gT2JqZWN0LmtleXMoZW52UGF0aE9iamVjdCkuZmluZChcbiAgICAgICAgICAgIChrZXkpID0+IGVudlBhdGhPYmplY3Rba2V5XS5zaGFyZWRQYXRoID09PSBwYXJhbWV0ZXIuTmFtZSxcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnN0IGVudk5hbWUgPSBlbnZLZXlcbiAgICAgICAgICAgID8gZW52UGF0aE9iamVjdFtlbnZLZXldLm5hbWVcbiAgICAgICAgICAgIDogZW52UGF0aE9iamVjdFtwYXJhbWV0ZXIuTmFtZV0/Lm5hbWU7XG4gICAgICAgICAgcHJvY2Vzcy5lbnZbZW52TmFtZV0gPSBwYXJhbWV0ZXIuVmFsdWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzcG9uc2U7XG4gIH07XG5cbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXNvbHZlU2VjcmV0cyhwYXRocyk7XG5cbiAgY29uc3Qgc2hhcmVkUGF0aHMgPSAocmVzcG9uc2U/LkludmFsaWRQYXJhbWV0ZXJzIHx8IFtdKVxuICAgIC5tYXAoKGludmFsaWRQYXJhbSkgPT4gZW52UGF0aE9iamVjdFtpbnZhbGlkUGFyYW1dLnNoYXJlZFBhdGgpXG4gICAgLmZpbHRlcigoc2hhcmVkUGFyYW0pID0+ICEhc2hhcmVkUGFyYW0pIGFzIHN0cmluZ1tdOyAvLyB0aGlzIGFzc2VydGlvbiBpcyBzYWZlIGJlY2F1c2Ugd2UgYXJlIGZpbHRlcmluZyBvdXQgdW5kZWZpbmVkXG5cbiAgaWYgKHNoYXJlZFBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICBhd2FpdCByZXNvbHZlU2VjcmV0cyhzaGFyZWRQYXRocyk7XG4gIH1cbn07XG4iXX0=