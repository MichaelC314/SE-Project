import { AmplifyUserError, CallerDirectoryExtractor, TagName, } from '@aws-amplify/platform-core';
import { Duration, Size, Stack, Tags } from 'aws-cdk-lib';
import { Rule } from 'aws-cdk-lib/aws-events';
import * as targets from 'aws-cdk-lib/aws-events-targets';
import { Architecture, LayerVersion, Runtime, } from 'aws-cdk-lib/aws-lambda';
import { NodejsFunction, OutputFormat } from 'aws-cdk-lib/aws-lambda-nodejs';
import { readFileSync } from 'fs';
import { createRequire } from 'module';
import { EOL } from 'os';
import * as path from 'path';
import { FunctionEnvironmentTranslator } from './function_env_translator.js';
import { FunctionEnvironmentTypeGenerator } from './function_env_type_generator.js';
import { FunctionLayerArnParser } from './layer_parser.js';
import { convertLoggingOptionsToCDK } from './logging_options_parser.js';
import { convertFunctionSchedulesToRuleSchedules } from './schedule_parser.js';
import { ProvidedFunctionFactory, } from './provided_function_factory.js';
import { AmplifyFunctionBase } from './function_construct_base.js';
import { FunctionResourceAccessAcceptor } from './resource_access_acceptor.js';
/**
 * Entry point for defining a function in the Amplify ecosystem
 */
// This is the "implementation overload", it's not visible in public api.
// We have to use function notation instead of arrow notation.
// Arrow notation does not support overloads.
// eslint-disable-next-line no-restricted-syntax
export function defineFunction(propsOrProvider = {}, providerProps) {
    if (propsOrProvider && typeof propsOrProvider === 'function') {
        return new ProvidedFunctionFactory(propsOrProvider, providerProps);
    }
    return new FunctionFactory(propsOrProvider, new Error().stack);
}
/**
 * Create Lambda functions in the context of an Amplify backend definition
 */
class FunctionFactory {
    props;
    callerStack;
    generator;
    /**
     * Create a new AmplifyFunctionFactory
     */
    constructor(props, callerStack) {
        this.props = props;
        this.callerStack = callerStack;
    }
    /**
     * Creates an instance of AmplifyFunction within the provided Amplify context
     */
    getInstance = ({ constructContainer, outputStorageStrategy, resourceNameValidator, }) => {
        if (!this.generator) {
            this.generator = new FunctionGenerator(this.hydrateDefaults(resourceNameValidator), outputStorageStrategy);
        }
        return constructContainer.getOrCompute(this.generator);
    };
    hydrateDefaults = (resourceNameValidator) => {
        const name = this.resolveName();
        resourceNameValidator?.validate(name);
        return {
            name,
            entry: this.resolveEntry(),
            timeoutSeconds: this.resolveTimeout(),
            memoryMB: this.resolveMemory(),
            ephemeralStorageSizeMB: this.resolveEphemeralStorageSize(),
            environment: this.resolveEnvironment(),
            runtime: this.resolveRuntime(),
            architecture: this.resolveArchitecture(),
            schedule: this.resolveSchedule(),
            bundling: this.resolveBundling(),
            layers: this.props.layers ?? {},
            resourceGroupName: this.props.resourceGroupName ?? 'function',
            logging: this.props.logging ?? {},
        };
    };
    resolveName = () => {
        // If name is set explicitly, use that
        if (this.props.name) {
            return this.props.name;
        }
        // If entry is set, use the basename of the entry path
        if (this.props.entry) {
            return path.parse(this.props.entry).name;
        }
        // Otherwise, use the directory name where the function is defined
        return path.basename(new CallerDirectoryExtractor(this.callerStack).extract());
    };
    resolveEntry = () => {
        // if entry is not set, default to handler.ts
        if (!this.props.entry) {
            return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), 'handler.ts');
        }
        // if entry is absolute use that
        if (path.isAbsolute(this.props.entry)) {
            return this.props.entry;
        }
        // if entry is relative, compute with respect to the caller directory
        return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), this.props.entry);
    };
    resolveTimeout = () => {
        const timeoutMin = 1;
        const timeoutMax = 60 * 15; // 15 minutes in seconds
        const timeoutDefault = 3;
        if (this.props.timeoutSeconds === undefined) {
            return timeoutDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.timeoutSeconds, timeoutMin, timeoutMax)) {
            throw new AmplifyUserError('InvalidTimeoutError', {
                message: `Invalid function timeout of ${this.props.timeoutSeconds}`,
                resolution: `timeoutSeconds must be a whole number between ${timeoutMin} and ${timeoutMax} inclusive`,
            });
        }
        return this.props.timeoutSeconds;
    };
    resolveMemory = () => {
        const memoryMin = 128;
        const memoryMax = 10240;
        const memoryDefault = 512;
        if (this.props.memoryMB === undefined) {
            return memoryDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.memoryMB, memoryMin, memoryMax)) {
            throw new AmplifyUserError('InvalidMemoryMBError', {
                message: `Invalid function memoryMB of ${this.props.memoryMB}`,
                resolution: `memoryMB must be a whole number between ${memoryMin} and ${memoryMax} inclusive`,
            });
        }
        return this.props.memoryMB;
    };
    resolveEphemeralStorageSize = () => {
        const ephemeralStorageSizeMin = 512;
        const ephemeralStorageSizeMax = 10240;
        const ephemeralStorageSizeDefault = 512;
        if (this.props.ephemeralStorageSizeMB === undefined) {
            return ephemeralStorageSizeDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.ephemeralStorageSizeMB, ephemeralStorageSizeMin, ephemeralStorageSizeMax)) {
            throw new AmplifyUserError('InvalidEphemeralStorageSizeMBError', {
                message: `Invalid function ephemeralStorageSizeMB of ${this.props.ephemeralStorageSizeMB}`,
                resolution: `ephemeralStorageSizeMB must be a whole number between ${ephemeralStorageSizeMin} and ${ephemeralStorageSizeMax} inclusive`,
            });
        }
        return this.props.ephemeralStorageSizeMB;
    };
    resolveEnvironment = () => {
        if (this.props.environment === undefined) {
            return {};
        }
        const invalidKeys = [];
        Object.keys(this.props.environment).forEach((key) => {
            // validate using key pattern from https://docs.aws.amazon.com/lambda/latest/api/API_Environment.html
            if (!key.match(/^[a-zA-Z]([a-zA-Z0-9_])+$/)) {
                invalidKeys.push(key);
            }
        });
        if (invalidKeys.length > 0) {
            throw new AmplifyUserError('InvalidEnvironmentKeyError', {
                message: `Invalid function environment key(s): ${invalidKeys.join(', ')}`,
                resolution: 'Environment keys must match [a-zA-Z]([a-zA-Z0-9_])+ and be at least 2 characters',
            });
        }
        return this.props.environment;
    };
    resolveRuntime = () => {
        const runtimeDefault = 18;
        // if runtime is not set, default to the oldest LTS
        if (!this.props.runtime) {
            return runtimeDefault;
        }
        if (!(this.props.runtime in nodeVersionMap)) {
            throw new AmplifyUserError('InvalidRuntimeError', {
                message: `Invalid function runtime of ${this.props.runtime}`,
                resolution: `runtime must be one of the following: ${Object.keys(nodeVersionMap).join(', ')}`,
            });
        }
        return this.props.runtime;
    };
    resolveArchitecture = () => {
        const architectureDefault = 'x86_64';
        if (!this.props.architecture) {
            return architectureDefault;
        }
        if (!(this.props.architecture in architectureMap)) {
            throw new AmplifyUserError('InvalidArchitectureError', {
                message: `Invalid function architecture of ${this.props.architecture}`,
                resolution: `architecture must be one of the following: ${Object.keys(architectureMap).join(', ')}`,
            });
        }
        return this.props.architecture;
    };
    resolveSchedule = () => {
        if (!this.props.schedule) {
            return [];
        }
        return this.props.schedule;
    };
    resolveBundling = () => {
        const bundlingDefault = {
            format: OutputFormat.ESM,
            bundleAwsSDK: true,
            loader: {
                '.node': 'file',
            },
            minify: true,
            sourceMap: true,
        };
        return {
            ...bundlingDefault,
            minify: this.resolveMinify(this.props.bundling),
        };
    };
    resolveMinify = (bundling) => {
        return bundling?.minify === undefined ? true : bundling.minify;
    };
}
class FunctionGenerator {
    props;
    outputStorageStrategy;
    resourceGroupName;
    constructor(props, outputStorageStrategy) {
        this.props = props;
        this.outputStorageStrategy = outputStorageStrategy;
        this.resourceGroupName = props.resourceGroupName;
    }
    generateContainerEntry = ({ scope, backendSecretResolver, }) => {
        // Move layer resolution here where we have access to scope
        const parser = new FunctionLayerArnParser(Stack.of(scope).region, Stack.of(scope).account);
        const resolvedLayerArns = parser.parseLayers(this.props.layers ?? {}, this.props.name);
        // resolve layers to LayerVersion objects for the NodejsFunction constructor
        const resolvedLayers = Object.entries(resolvedLayerArns).map(([key, arn]) => LayerVersion.fromLayerVersionArn(scope, `${this.props.name}-${key}-layer`, arn));
        return new AmplifyFunction(scope, this.props.name, { ...this.props, resolvedLayers }, backendSecretResolver, this.outputStorageStrategy);
    };
}
class AmplifyFunction extends AmplifyFunctionBase {
    resources;
    functionEnvironmentTranslator;
    constructor(scope, id, props, backendSecretResolver, outputStorageStrategy) {
        super(scope, id, outputStorageStrategy);
        const runtime = nodeVersionMap[props.runtime];
        const require = createRequire(import.meta.url);
        const shims = runtime === Runtime.NODEJS_16_X
            ? []
            : [require.resolve('./lambda-shims/cjs_shim')];
        const ssmResolverFile = runtime === Runtime.NODEJS_16_X
            ? require.resolve('./lambda-shims/resolve_ssm_params_sdk_v2') // use aws cdk v2 in node 16
            : require.resolve('./lambda-shims/resolve_ssm_params');
        const invokeSsmResolverFile = require.resolve('./lambda-shims/invoke_ssm_shim');
        /**
         * This code concatenates the contents of the ssm resolver and invoker into a single line that can be used as the esbuild banner content
         * This banner is responsible for resolving the customer's SSM parameters at runtime
         */
        const bannerCode = readFileSync(ssmResolverFile, 'utf-8')
            .concat(readFileSync(invokeSsmResolverFile, 'utf-8'))
            .split(new RegExp(`${EOL}|\n|\r`, 'g'))
            .map((line) => line.replace(/\/\/.*$/, '')) // strip out inline comments because the banner is going to be flattened into a single line
            .join('');
        const functionEnvironmentTypeGenerator = new FunctionEnvironmentTypeGenerator(id);
        // esbuild runs as part of the NodejsFunction constructor, so we eagerly generate the process env shim without types so it can be included in the function bundle.
        // This will be overwritten with the typed file at the end of synthesis
        functionEnvironmentTypeGenerator.generateProcessEnvShim();
        let functionLambda;
        const cdkLoggingOptions = convertLoggingOptionsToCDK(props.logging);
        try {
            functionLambda = new NodejsFunction(scope, `${id}-lambda`, {
                entry: props.entry,
                timeout: Duration.seconds(props.timeoutSeconds),
                memorySize: props.memoryMB,
                architecture: architectureMap[props.architecture],
                ephemeralStorageSize: Size.mebibytes(props.ephemeralStorageSizeMB),
                runtime: nodeVersionMap[props.runtime],
                layers: props.resolvedLayers,
                bundling: {
                    ...props.bundling,
                    banner: bannerCode,
                    inject: shims,
                    externalModules: Object.keys(props.layers),
                },
                logRetention: cdkLoggingOptions.retention,
                applicationLogLevelV2: cdkLoggingOptions.level,
                loggingFormat: cdkLoggingOptions.format,
            });
        }
        catch (error) {
            // If the error is from ES Bundler which is executed as a child process by CDK,
            // then the error from CDK contains the command that was executed along with the exit status.
            // Wrapping it here  would cause the cdk_deployer to re-throw this wrapped exception
            // instead of scraping the stderr for actual ESBuild error.
            if (error instanceof Error &&
                error.message.match(/Failed to bundle asset.*exited with status/)) {
                throw error;
            }
            throw new AmplifyUserError('NodeJSFunctionConstructInitializationError', {
                message: 'Failed to instantiate nodejs function construct',
                resolution: 'See the underlying error message for more details. Use `--debug` for additional debugging information.',
            }, error);
        }
        try {
            const schedules = convertFunctionSchedulesToRuleSchedules(functionLambda, props.schedule);
            const lambdaTarget = new targets.LambdaFunction(functionLambda);
            schedules.forEach((schedule, index) => {
                // Lambda name will be prepended to rule id, so only using index here for uniqueness
                const rule = new Rule(functionLambda, `schedule${index}`, {
                    schedule,
                });
                rule.addTarget(lambdaTarget);
            });
        }
        catch (error) {
            throw new AmplifyUserError('FunctionScheduleInitializationError', {
                message: 'Failed to instantiate schedule for nodejs function',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(functionLambda).add(TagName.FRIENDLY_NAME, id);
        this.functionEnvironmentTranslator = new FunctionEnvironmentTranslator(functionLambda, props.environment, backendSecretResolver, functionEnvironmentTypeGenerator);
        this.resources = {
            lambda: functionLambda,
            cfnResources: {
                cfnFunction: functionLambda.node.findChild('Resource'),
            },
        };
        this.storeOutput();
    }
    addEnvironment = (key, value) => {
        this.functionEnvironmentTranslator.addEnvironmentEntry(key, value);
    };
    getResourceAccessAcceptor = () => new FunctionResourceAccessAcceptor(this, this.functionEnvironmentTranslator);
}
const isWholeNumberBetweenInclusive = (test, min, max) => min <= test && test <= max && test % 1 === 0;
const nodeVersionMap = {
    16: Runtime.NODEJS_16_X,
    18: Runtime.NODEJS_18_X,
    20: Runtime.NODEJS_20_X,
    22: Runtime.NODEJS_22_X,
};
const architectureMap = {
    arm64: Architecture.ARM_64,
    x86_64: Architecture.X86_64,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsd0JBQXdCLEVBQ3hCLE9BQU8sR0FDUixNQUFNLDRCQUE0QixDQUFDO0FBbUJwQyxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzFELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM5QyxPQUFPLEtBQUssT0FBTyxNQUFNLGdDQUFnQyxDQUFDO0FBQzFELE9BQU8sRUFDTCxZQUFZLEVBSVosWUFBWSxFQUNaLE9BQU8sR0FDUixNQUFNLHdCQUF3QixDQUFDO0FBQ2hDLE9BQU8sRUFBRSxjQUFjLEVBQUUsWUFBWSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFFN0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLElBQUksQ0FBQztBQUNsQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDN0UsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDcEYsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDM0QsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDekUsT0FBTyxFQUFFLHVDQUF1QyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0UsT0FBTyxFQUNMLHVCQUF1QixHQUV4QixNQUFNLGdDQUFnQyxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxN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SUFDckIsQ0FBQztJQUVELGNBQWMsR0FBRyxDQUFDLEdBQVcsRUFBRSxLQUE2QixFQUFFLEVBQUU7UUFDOUQsSUFBSSxDQUFDLDZCQUE2QixDQUFDLG1CQUFtQixDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNyRSxDQUFDLENBQUM7SUFFRix5QkFBeUIsR0FBRyxHQUEyQixFQUFFLENBQ3ZELElBQUksOEJBQThCLENBQ2hDLElBQUksRUFDSixJQUFJLENBQUMsNkJBQTZCLENBQ25DLENBQUM7Q0FDTDtBQUVELE1BQU0sNkJBQTZCLEdBQUcsQ0FDcEMsSUFBWSxFQUNaLEdBQVcsRUFDWCxHQUFXLEVBQ1gsRUFBRSxDQUFDLEdBQUcsSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLEdBQUcsSUFBSSxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUlsRCxNQUFNLGNBQWMsR0FBaUM7SUFDbkQsRUFBRSxFQUFFLE9BQU8sQ0FBQyxXQUFXO0lBQ3ZCLEVBQUUsRUFBRSxPQUFPLENBQUMsV0FBVztJQUN2QixFQUFFLEVBQUUsT0FBTyxDQUFDLFdBQVc7SUFDdkIsRUFBRSxFQUFFLE9BQU8sQ0FBQyxXQUFXO0NBQ3hCLENBQUM7QUFJRixNQUFNLGVBQWUsR0FBK0M7SUFDbEUsS0FBSyxFQUFFLFlBQVksQ0FBQyxNQUFNO0lBQzFCLE1BQU0sRUFBRSxZQUFZLENBQUMsTUFBTTtDQUM1QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRnVuY3Rpb25PdXRwdXQgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQge1xuICBBbXBsaWZ5VXNlckVycm9yLFxuICBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IsXG4gIFRhZ05hbWUsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7XG4gIEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZSxcbiAgQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgQmFja2VuZFNlY3JldCxcbiAgQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvcixcbiAgQ29uc3RydWN0RmFjdG9yeSxcbiAgQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4gIEZ1bmN0aW9uUmVzb3VyY2VzLFxuICBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMsXG4gIExvZ0xldmVsLFxuICBMb2dSZXRlbnRpb24sXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3IsXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5LFxuICBSZXNvdXJjZU5hbWVWYWxpZGF0b3IsXG4gIFJlc291cmNlUHJvdmlkZXIsXG4gIFN0YWNrUHJvdmlkZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgRHVyYXRpb24sIFNpemUsIFN0YWNrLCBUYWdzIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgUnVsZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1ldmVudHMnO1xuaW1wb3J0ICogYXMgdGFyZ2V0cyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZXZlbnRzLXRhcmdldHMnO1xuaW1wb3J0IHtcbiAgQXJjaGl0ZWN0dXJlLFxuICBDZm5GdW5jdGlvbixcbiAgSUZ1bmN0aW9uLFxuICBJTGF5ZXJWZXJzaW9uLFxuICBMYXllclZlcnNpb24sXG4gIFJ1bnRpbWUsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgTm9kZWpzRnVuY3Rpb24sIE91dHB1dEZvcm1hdCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgY3JlYXRlUmVxdWlyZSB9IGZyb20gJ21vZHVsZSc7XG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgRnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IgfSBmcm9tICcuL2Z1bmN0aW9uX2Vudl90cmFuc2xhdG9yLmpzJztcbmltcG9ydCB7IEZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yIH0gZnJvbSAnLi9mdW5jdGlvbl9lbnZfdHlwZV9nZW5lcmF0b3IuanMnO1xuaW1wb3J0IHsgRnVuY3Rpb25MYXllckFyblBhcnNlciB9IGZyb20gJy4vbGF5ZXJfcGFyc2VyLmpzJztcbmltcG9ydCB7IGNvbnZlcnRMb2dnaW5nT3B0aW9uc1RvQ0RLIH0gZnJvbSAnLi9sb2dnaW5nX29wdGlvbnNfcGFyc2VyLmpzJztcbmltcG9ydCB7IGNvbnZlcnRGdW5jdGlvblNjaGVkdWxlc1RvUnVsZVNjaGVkdWxlcyB9IGZyb20gJy4vc2NoZWR1bGVfcGFyc2VyLmpzJztcbmltcG9ydCB7XG4gIFByb3ZpZGVkRnVuY3Rpb25GYWN0b3J5LFxuICBQcm92aWRlZEZ1bmN0aW9uUHJvcHMsXG59IGZyb20gJy4vcHJvdmlkZWRfZnVuY3Rpb25fZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBBbXBsaWZ5RnVuY3Rpb25CYXNlIH0gZnJvbSAnLi9mdW5jdGlvbl9jb25zdHJ1Y3RfYmFzZS5qcyc7XG5pbXBvcnQgeyBGdW5jdGlvblJlc291cmNlQWNjZXNzQWNjZXB0b3IgfSBmcm9tICcuL3Jlc291cmNlX2FjY2Vzc19hY2NlcHRvci5qcyc7XG5cbmV4cG9ydCB0eXBlIEFkZEVudmlyb25tZW50RmFjdG9yeSA9IHtcbiAgYWRkRW52aXJvbm1lbnQ6IChrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZyB8IEJhY2tlbmRTZWNyZXQpID0+IHZvaWQ7XG59O1xuXG5leHBvcnQgdHlwZSBDcm9uU2NoZWR1bGUgPVxuICB8IGAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9YFxuICB8IGAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfWA7XG5leHBvcnQgdHlwZSBUaW1lSW50ZXJ2YWwgPVxuICB8IGBldmVyeSAke251bWJlcn1tYFxuICB8IGBldmVyeSAke251bWJlcn1oYFxuICB8IGBldmVyeSBkYXlgXG4gIHwgYGV2ZXJ5IHdlZWtgXG4gIHwgYGV2ZXJ5IG1vbnRoYFxuICB8IGBldmVyeSB5ZWFyYDtcbmV4cG9ydCB0eXBlIEZ1bmN0aW9uU2NoZWR1bGUgPSBUaW1lSW50ZXJ2YWwgfCBDcm9uU2NoZWR1bGU7XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uTG9nTGV2ZWwgPSBFeHRyYWN0PFxuICBMb2dMZXZlbCxcbiAgJ2luZm8nIHwgJ2RlYnVnJyB8ICd3YXJuJyB8ICdlcnJvcicgfCAnZmF0YWwnIHwgJ3RyYWNlJ1xuPjtcbmV4cG9ydCB0eXBlIEZ1bmN0aW9uTG9nUmV0ZW50aW9uID0gTG9nUmV0ZW50aW9uO1xuXG5leHBvcnQgZnVuY3Rpb24gZGVmaW5lRnVuY3Rpb24oXG4gIHByb3BzPzogRnVuY3Rpb25Qcm9wcyxcbik6IENvbnN0cnVjdEZhY3Rvcnk8XG4gIFJlc291cmNlUHJvdmlkZXI8RnVuY3Rpb25SZXNvdXJjZXM+ICZcbiAgICBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yRmFjdG9yeSAmXG4gICAgQWRkRW52aXJvbm1lbnRGYWN0b3J5ICZcbiAgICBTdGFja1Byb3ZpZGVyXG4+O1xuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZUZ1bmN0aW9uKFxuICBwcm92aWRlcjogKHNjb3BlOiBDb25zdHJ1Y3QpID0+IElGdW5jdGlvbixcbiAgcHJvdmlkZXJQcm9wcz86IFByb3ZpZGVkRnVuY3Rpb25Qcm9wcyxcbik6IENvbnN0cnVjdEZhY3Rvcnk8XG4gIFJlc291cmNlUHJvdmlkZXI8RnVuY3Rpb25SZXNvdXJjZXM+ICZcbiAgICBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yRmFjdG9yeSAmXG4gICAgU3RhY2tQcm92aWRlclxuPjtcbi8qKlxuICogRW50cnkgcG9pbnQgZm9yIGRlZmluaW5nIGEgZnVuY3Rpb24gaW4gdGhlIEFtcGxpZnkgZWNvc3lzdGVtXG4gKi9cbi8vIFRoaXMgaXMgdGhlIFwiaW1wbGVtZW50YXRpb24gb3ZlcmxvYWRcIiwgaXQncyBub3QgdmlzaWJsZSBpbiBwdWJsaWMgYXBpLlxuLy8gV2UgaGF2ZSB0byB1c2UgZnVuY3Rpb24gbm90YXRpb24gaW5zdGVhZCBvZiBhcnJvdyBub3RhdGlvbi5cbi8vIEFycm93IG5vdGF0aW9uIGRvZXMgbm90IHN1cHBvcnQgb3ZlcmxvYWRzLlxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXJlc3RyaWN0ZWQtc3ludGF4XG5leHBvcnQgZnVuY3Rpb24gZGVmaW5lRnVuY3Rpb24oXG4gIHByb3BzT3JQcm92aWRlcjogRnVuY3Rpb25Qcm9wcyB8ICgoc2NvcGU6IENvbnN0cnVjdCkgPT4gSUZ1bmN0aW9uKSA9IHt9LFxuICBwcm92aWRlclByb3BzPzogUHJvdmlkZWRGdW5jdGlvblByb3BzLFxuKTogdW5rbm93biB7XG4gIGlmIChwcm9wc09yUHJvdmlkZXIgJiYgdHlwZW9mIHByb3BzT3JQcm92aWRlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBuZXcgUHJvdmlkZWRGdW5jdGlvbkZhY3RvcnkocHJvcHNPclByb3ZpZGVyLCBwcm92aWRlclByb3BzKTtcbiAgfVxuICByZXR1cm4gbmV3IEZ1bmN0aW9uRmFjdG9yeShwcm9wc09yUHJvdmlkZXIsIG5ldyBFcnJvcigpLnN0YWNrKTtcbn1cblxuZXhwb3J0IHR5cGUgRnVuY3Rpb25Qcm9wcyA9IHtcbiAgLyoqXG4gICAqIEEgbmFtZSBmb3IgdGhlIGZ1bmN0aW9uLlxuICAgKiBEZWZhdWx0cyB0byB0aGUgYmFzZW5hbWUgb2YgdGhlIGVudHJ5IHBhdGggaWYgc3BlY2lmaWVkLlxuICAgKiBJZiBubyBlbnRyeSBpcyBzcGVjaWZpZWQsIGRlZmF1bHRzIHRvIHRoZSBkaXJlY3RvcnkgbmFtZSBpbiB3aGljaCB0aGlzIGZ1bmN0aW9uIGlzIGRlZmluZWQuXG4gICAqXG4gICAqIEV4YW1wbGU6XG4gICAqIElmIGVudHJ5IGlzIGAuL3NjaGVkdWxlZC1kYi1iYWNrdXAudHNgIHRoZSBuYW1lIHdpbGwgZGVmYXVsdCB0byBcInNjaGVkdWxlZC1kYi1iYWNrdXBcIlxuICAgKiBJZiBlbnRyeSBpcyBub3Qgc2V0IGFuZCB0aGUgZnVuY3Rpb24gaXMgZGVmaW5lZCBpbiBgYW1wbGlmeS9mdW5jdGlvbnMvZGItYmFja3VwL3Jlc291cmNlLnRzYCB0aGUgbmFtZSB3aWxsIGRlZmF1bHQgdG8gXCJkYi1iYWNrdXBcIlxuICAgKi9cbiAgbmFtZT86IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBmaWxlIHRoYXQgY29udGFpbnMgdGhlIGZ1bmN0aW9uIGVudHJ5IHBvaW50LlxuICAgKiBJZiB0aGlzIGlzIGEgcmVsYXRpdmUgcGF0aCwgaXQgaXMgY29tcHV0ZWQgcmVsYXRpdmUgdG8gdGhlIGZpbGUgd2hlcmUgdGhpcyBmdW5jdGlvbiBpcyBkZWZpbmVkXG4gICAqXG4gICAqIERlZmF1bHRzIHRvICcuL2hhbmRsZXIudHMnXG4gICAqL1xuICBlbnRyeT86IHN0cmluZztcblxuICAvKipcbiAgICogQW4gYW1vdW50IG9mIHRpbWUgaW4gc2Vjb25kcyBiZXR3ZWVuIDEgc2Vjb25kIGFuZCAxNSBtaW51dGVzLlxuICAgKiBNdXN0IGJlIGEgd2hvbGUgbnVtYmVyLlxuICAgKiBEZWZhdWx0IGlzIDMgc2Vjb25kcy5cbiAgICovXG4gIHRpbWVvdXRTZWNvbmRzPzogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBBbiBhbW91bnQgb2YgbWVtb3J5IChSQU0pIHRvIGFsbG9jYXRlIHRvIHRoZSBmdW5jdGlvbiBiZXR3ZWVuIDEyOCBhbmQgMTAyNDAgTUIuXG4gICAqIE11c3QgYmUgYSB3aG9sZSBudW1iZXIuXG4gICAqIERlZmF1bHQgaXMgNTEyTUIuXG4gICAqL1xuICBtZW1vcnlNQj86IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIHNpemUgb2YgdGhlIGZ1bmN0aW9uJ3MgL3RtcCBkaXJlY3RvcnkgaW4gTUIuXG4gICAqIE11c3QgYmUgYSB3aG9sZSBudW1iZXIuXG4gICAqIEBkZWZhdWx0IDUxMlxuICAgKi9cbiAgZXBoZW1lcmFsU3RvcmFnZVNpemVNQj86IG51bWJlcjtcblxuICAvKipcbiAgICogRW52aXJvbm1lbnQgdmFyaWFibGVzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgZHVyaW5nIGZ1bmN0aW9uIGV4ZWN1dGlvblxuICAgKi9cbiAgZW52aXJvbm1lbnQ/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCBCYWNrZW5kU2VjcmV0PjtcblxuICAvKipcbiAgICogTm9kZSBydW50aW1lIHZlcnNpb24gZm9yIHRoZSBsYW1iZGEgZW52aXJvbm1lbnQuXG4gICAqXG4gICAqIERlZmF1bHRzIHRvIHRoZSBvbGRlc3QgTm9kZUpTIExUUyB2ZXJzaW9uLiBTZWUgaHR0cHM6Ly9ub2RlanMub3JnL2VuL2Fib3V0L3ByZXZpb3VzLXJlbGVhc2VzXG4gICAqL1xuICBydW50aW1lPzogTm9kZVZlcnNpb247XG5cbiAgLyoqXG4gICAqIFRoZSBhcmNoaXRlY3R1cmUgb2YgdGhlIHRhcmdldCBwbGF0Zm9ybSBmb3IgdGhlIGxhbWJkYSBlbnZpcm9ubWVudC5cbiAgICogRGVmYXVsdHMgdG8gWDg2XzY0LlxuICAgKi9cbiAgYXJjaGl0ZWN0dXJlPzogRnVuY3Rpb25BcmNoaXRlY3R1cmU7XG5cbiAgLyoqXG4gICAqIEEgdGltZSBpbnRlcnZhbCBzdHJpbmcgdG8gcGVyaW9kaWNhbGx5IHJ1biB0aGUgZnVuY3Rpb24uXG4gICAqIFRoaXMgY2FuIGJlIGVpdGhlciBhIHN0cmluZyBvZiBgXCJldmVyeSA8cG9zaXRpdmUgd2hvbGUgbnVtYmVyPjxtIChtaW51dGUpIG9yIGggKGhvdXIpPlwiYCwgYFwiZXZlcnkgZGF5fHdlZWt8bW9udGh8eWVhclwiYCBvciBjcm9uIGV4cHJlc3Npb24uXG4gICAqIERlZmF1bHRzIHRvIG5vIHNjaGVkdWxpbmcgZm9yIHRoZSBmdW5jdGlvbi5cbiAgICogQGV4YW1wbGVcbiAgICogc2NoZWR1bGU6IFwiZXZlcnkgNW1cIlxuICAgKiBAZXhhbXBsZVxuICAgKiBzY2hlZHVsZTogXCJldmVyeSB3ZWVrXCJcbiAgICogQGV4YW1wbGVcbiAgICogc2NoZWR1bGU6IFwiMCA5ID8gKiAyICpcIiAvLyBldmVyeSBNb25kYXkgYXQgOWFtXG4gICAqL1xuICBzY2hlZHVsZT86IEZ1bmN0aW9uU2NoZWR1bGUgfCBGdW5jdGlvblNjaGVkdWxlW107XG5cbiAgLyoqXG4gICAqIEF0dGFjaCBMYW1iZGEgbGF5ZXJzIHRvIGEgZnVuY3Rpb25cbiAgICogLSBBIExhbWJkYSBsYXllciBpcyByZXByZXNlbnRlZCBieSBhbiBvYmplY3Qgb2Yga2V5L3ZhbHVlIHBhaXIgd2hlcmUgdGhlIGtleSBpcyB0aGUgbW9kdWxlIG5hbWUgdGhhdCBpcyBleHBvcnRlZCBmcm9tIHlvdXIgbGF5ZXIgYW5kIHRoZSB2YWx1ZSBpcyB0aGUgQVJOIG9mIHRoZSBsYXllci4gVGhlIGtleSAobW9kdWxlIG5hbWUpIGlzIHVzZWQgdG8gZXh0ZXJuYWxpemUgdGhlIG1vZHVsZSBkZXBlbmRlbmN5IHNvIGl0IGRvZXNuJ3QgZ2V0IGJ1bmRsZWQgd2l0aCB5b3VyIGxhbWJkYSBmdW5jdGlvblxuICAgKiAtIE1heGltdW0gb2YgNSBsYXllcnMgY2FuIGJlIGF0dGFjaGVkIHRvIGEgZnVuY3Rpb24gYW5kIG11c3QgYmUgaW4gdGhlIHNhbWUgcmVnaW9uIGFzIHRoZSBmdW5jdGlvbi5cbiAgICogQGV4YW1wbGVcbiAgICogbGF5ZXJzOiB7XG4gICAqICAgIFwiQGF3cy1sYW1iZGEtcG93ZXJ0b29scy9sb2dnZXJcIjogXCJhcm46YXdzOmxhbWJkYTo8Y3VycmVudC1yZWdpb24+OjA5NDI3NDEwNTkxNTpsYXllcjpBV1NMYW1iZGFQb3dlcnRvb2xzVHlwZVNjcmlwdFYyOjExXCJcbiAgICogfSxcbiAgICogb3JcbiAgICogQGV4YW1wbGVcbiAgICogbGF5ZXJzOiB7XG4gICAqICAgIFwiU2hhcnBcIjogXCJTaGFycExheWVyOjFcIlxuICAgKiB9LFxuICAgKiBAc2VlIFtBbXBsaWZ5IGRvY3VtZW50YXRpb24gZm9yIExhbWJkYSBsYXllcnNdKGh0dHBzOi8vZG9jcy5hbXBsaWZ5LmF3cy9yZWFjdC9idWlsZC1hLWJhY2tlbmQvZnVuY3Rpb25zL2FkZC1sYW1iZGEtbGF5ZXJzKVxuICAgKiBAc2VlIFtBV1MgZG9jdW1lbnRhdGlvbiBmb3IgTGFtYmRhIGxheWVyc10oaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2xhbWJkYS9sYXRlc3QvZGcvY2hhcHRlci1sYXllcnMuaHRtbClcbiAgICovXG4gIGxheWVycz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5cbiAgLypcbiAgICogT3B0aW9ucyBmb3IgYnVuZGxpbmcgdGhlIGZ1bmN0aW9uIGNvZGUuXG4gICAqL1xuICBidW5kbGluZz86IEZ1bmN0aW9uQnVuZGxpbmdPcHRpb25zO1xuXG4gIC8qKlxuICAgKiBHcm91cCB0aGUgZnVuY3Rpb24gd2l0aCBleGlzdGluZyBBbXBsaWZ5IHJlc291cmNlcyBvciBzZXBhcmF0ZSB0aGUgZnVuY3Rpb24gaW50byBpdHMgb3duIGdyb3VwLlxuICAgKiBAZGVmYXVsdCAnZnVuY3Rpb24nIC8vIGdyb3VwaW5nIHdpdGggb3RoZXIgQW1wbGlmeSBmdW5jdGlvbnNcbiAgICogQGV4YW1wbGVcbiAgICogcmVzb3VyY2VHcm91cE5hbWU6ICdhdXRoJyAvLyB0byBncm91cCBhbiBhdXRoIHRyaWdnZXIgd2l0aCBhbiBhdXRoIHJlc291cmNlXG4gICAqL1xuICByZXNvdXJjZUdyb3VwTmFtZT86IEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZTtcblxuICBsb2dnaW5nPzogRnVuY3Rpb25Mb2dnaW5nT3B0aW9ucztcbn07XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uQnVuZGxpbmdPcHRpb25zID0ge1xuICAvKipcbiAgICogV2hldGhlciB0byBtaW5pZnkgdGhlIGZ1bmN0aW9uIGNvZGUuXG4gICAqXG4gICAqIERlZmF1bHRzIHRvIHRydWUuXG4gICAqL1xuICBtaW5pZnk/OiBib29sZWFuO1xufTtcblxuZXhwb3J0IHR5cGUgRnVuY3Rpb25Mb2dnaW5nT3B0aW9ucyA9IChcbiAgfCB7XG4gICAgICBmb3JtYXQ6ICdqc29uJztcbiAgICAgIGxldmVsPzogRnVuY3Rpb25Mb2dMZXZlbDtcbiAgICB9XG4gIHwge1xuICAgICAgZm9ybWF0PzogJ3RleHQnO1xuICAgIH1cbikgJiB7XG4gIHJldGVudGlvbj86IEZ1bmN0aW9uTG9nUmV0ZW50aW9uO1xufTtcblxuLyoqXG4gKiBDcmVhdGUgTGFtYmRhIGZ1bmN0aW9ucyBpbiB0aGUgY29udGV4dCBvZiBhbiBBbXBsaWZ5IGJhY2tlbmQgZGVmaW5pdGlvblxuICovXG5jbGFzcyBGdW5jdGlvbkZhY3RvcnkgaW1wbGVtZW50cyBDb25zdHJ1Y3RGYWN0b3J5PEFtcGxpZnlGdW5jdGlvbj4ge1xuICBwcml2YXRlIGdlbmVyYXRvcjogQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3I7XG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgQW1wbGlmeUZ1bmN0aW9uRmFjdG9yeVxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogRnVuY3Rpb25Qcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNhbGxlclN0YWNrPzogc3RyaW5nLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgQW1wbGlmeUZ1bmN0aW9uIHdpdGhpbiB0aGUgcHJvdmlkZWQgQW1wbGlmeSBjb250ZXh0XG4gICAqL1xuICBnZXRJbnN0YW5jZSA9ICh7XG4gICAgY29uc3RydWN0Q29udGFpbmVyLFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3IsXG4gIH06IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzKTogQW1wbGlmeUZ1bmN0aW9uID0+IHtcbiAgICBpZiAoIXRoaXMuZ2VuZXJhdG9yKSB7XG4gICAgICB0aGlzLmdlbmVyYXRvciA9IG5ldyBGdW5jdGlvbkdlbmVyYXRvcihcbiAgICAgICAgdGhpcy5oeWRyYXRlRGVmYXVsdHMocmVzb3VyY2VOYW1lVmFsaWRhdG9yKSxcbiAgICAgICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnN0cnVjdENvbnRhaW5lci5nZXRPckNvbXB1dGUodGhpcy5nZW5lcmF0b3IpIGFzIEFtcGxpZnlGdW5jdGlvbjtcbiAgfTtcblxuICBwcml2YXRlIGh5ZHJhdGVEZWZhdWx0cyA9IChcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3I/OiBSZXNvdXJjZU5hbWVWYWxpZGF0b3IsXG4gICk6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyA9PiB7XG4gICAgY29uc3QgbmFtZSA9IHRoaXMucmVzb2x2ZU5hbWUoKTtcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3I/LnZhbGlkYXRlKG5hbWUpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICBlbnRyeTogdGhpcy5yZXNvbHZlRW50cnkoKSxcbiAgICAgIHRpbWVvdXRTZWNvbmRzOiB0aGlzLnJlc29sdmVUaW1lb3V0KCksXG4gICAgICBtZW1vcnlNQjogdGhpcy5yZXNvbHZlTWVtb3J5KCksXG4gICAgICBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1COiB0aGlzLnJlc29sdmVFcGhlbWVyYWxTdG9yYWdlU2l6ZSgpLFxuICAgICAgZW52aXJvbm1lbnQ6IHRoaXMucmVzb2x2ZUVudmlyb25tZW50KCksXG4gICAgICBydW50aW1lOiB0aGlzLnJlc29sdmVSdW50aW1lKCksXG4gICAgICBhcmNoaXRlY3R1cmU6IHRoaXMucmVzb2x2ZUFyY2hpdGVjdHVyZSgpLFxuICAgICAgc2NoZWR1bGU6IHRoaXMucmVzb2x2ZVNjaGVkdWxlKCksXG4gICAgICBidW5kbGluZzogdGhpcy5yZXNvbHZlQnVuZGxpbmcoKSxcbiAgICAgIGxheWVyczogdGhpcy5wcm9wcy5sYXllcnMgPz8ge30sXG4gICAgICByZXNvdXJjZUdyb3VwTmFtZTogdGhpcy5wcm9wcy5yZXNvdXJjZUdyb3VwTmFtZSA/PyAnZnVuY3Rpb24nLFxuICAgICAgbG9nZ2luZzogdGhpcy5wcm9wcy5sb2dnaW5nID8/IHt9LFxuICAgIH07XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlTmFtZSA9ICgpID0+IHtcbiAgICAvLyBJZiBuYW1lIGlzIHNldCBleHBsaWNpdGx5LCB1c2UgdGhhdFxuICAgIGlmICh0aGlzLnByb3BzLm5hbWUpIHtcbiAgICAgIHJldHVybiB0aGlzLnByb3BzLm5hbWU7XG4gICAgfVxuICAgIC8vIElmIGVudHJ5IGlzIHNldCwgdXNlIHRoZSBiYXNlbmFtZSBvZiB0aGUgZW50cnkgcGF0aFxuICAgIGlmICh0aGlzLnByb3BzLmVudHJ5KSB7XG4gICAgICByZXR1cm4gcGF0aC5wYXJzZSh0aGlzLnByb3BzLmVudHJ5KS5uYW1lO1xuICAgIH1cblxuICAgIC8vIE90aGVyd2lzZSwgdXNlIHRoZSBkaXJlY3RvcnkgbmFtZSB3aGVyZSB0aGUgZnVuY3Rpb24gaXMgZGVmaW5lZFxuICAgIHJldHVybiBwYXRoLmJhc2VuYW1lKFxuICAgICAgbmV3IENhbGxlckRpcmVjdG9yeUV4dHJhY3Rvcih0aGlzLmNhbGxlclN0YWNrKS5leHRyYWN0KCksXG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVFbnRyeSA9ICgpID0+IHtcbiAgICAvLyBpZiBlbnRyeSBpcyBub3Qgc2V0LCBkZWZhdWx0IHRvIGhhbmRsZXIudHNcbiAgICBpZiAoIXRoaXMucHJvcHMuZW50cnkpIHtcbiAgICAgIHJldHVybiBwYXRoLmpvaW4oXG4gICAgICAgIG5ldyBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IodGhpcy5jYWxsZXJTdGFjaykuZXh0cmFjdCgpLFxuICAgICAgICAnaGFuZGxlci50cycsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIGlmIGVudHJ5IGlzIGFic29sdXRlIHVzZSB0aGF0XG4gICAgaWYgKHBhdGguaXNBYnNvbHV0ZSh0aGlzLnByb3BzLmVudHJ5KSkge1xuICAgICAgcmV0dXJuIHRoaXMucHJvcHMuZW50cnk7XG4gICAgfVxuXG4gICAgLy8gaWYgZW50cnkgaXMgcmVsYXRpdmUsIGNvbXB1dGUgd2l0aCByZXNwZWN0IHRvIHRoZSBjYWxsZXIgZGlyZWN0b3J5XG4gICAgcmV0dXJuIHBhdGguam9pbihcbiAgICAgIG5ldyBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IodGhpcy5jYWxsZXJTdGFjaykuZXh0cmFjdCgpLFxuICAgICAgdGhpcy5wcm9wcy5lbnRyeSxcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZVRpbWVvdXQgPSAoKSA9PiB7XG4gICAgY29uc3QgdGltZW91dE1pbiA9IDE7XG4gICAgY29uc3QgdGltZW91dE1heCA9IDYwICogMTU7IC8vIDE1IG1pbnV0ZXMgaW4gc2Vjb25kc1xuICAgIGNvbnN0IHRpbWVvdXREZWZhdWx0ID0gMztcbiAgICBpZiAodGhpcy5wcm9wcy50aW1lb3V0U2Vjb25kcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gdGltZW91dERlZmF1bHQ7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKFxuICAgICAgICB0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzLFxuICAgICAgICB0aW1lb3V0TWluLFxuICAgICAgICB0aW1lb3V0TWF4LFxuICAgICAgKVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ0ludmFsaWRUaW1lb3V0RXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6IGBJbnZhbGlkIGZ1bmN0aW9uIHRpbWVvdXQgb2YgJHt0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzfWAsXG4gICAgICAgIHJlc29sdXRpb246IGB0aW1lb3V0U2Vjb25kcyBtdXN0IGJlIGEgd2hvbGUgbnVtYmVyIGJldHdlZW4gJHt0aW1lb3V0TWlufSBhbmQgJHt0aW1lb3V0TWF4fSBpbmNsdXNpdmVgLFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZU1lbW9yeSA9ICgpID0+IHtcbiAgICBjb25zdCBtZW1vcnlNaW4gPSAxMjg7XG4gICAgY29uc3QgbWVtb3J5TWF4ID0gMTAyNDA7XG4gICAgY29uc3QgbWVtb3J5RGVmYXVsdCA9IDUxMjtcbiAgICBpZiAodGhpcy5wcm9wcy5tZW1vcnlNQiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gbWVtb3J5RGVmYXVsdDtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKHRoaXMucHJvcHMubWVtb3J5TUIsIG1lbW9yeU1pbiwgbWVtb3J5TWF4KVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ0ludmFsaWRNZW1vcnlNQkVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBmdW5jdGlvbiBtZW1vcnlNQiBvZiAke3RoaXMucHJvcHMubWVtb3J5TUJ9YCxcbiAgICAgICAgcmVzb2x1dGlvbjogYG1lbW9yeU1CIG11c3QgYmUgYSB3aG9sZSBudW1iZXIgYmV0d2VlbiAke21lbW9yeU1pbn0gYW5kICR7bWVtb3J5TWF4fSBpbmNsdXNpdmVgLFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByb3BzLm1lbW9yeU1CO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZUVwaGVtZXJhbFN0b3JhZ2VTaXplID0gKCkgPT4ge1xuICAgIGNvbnN0IGVwaGVtZXJhbFN0b3JhZ2VTaXplTWluID0gNTEyO1xuICAgIGNvbnN0IGVwaGVtZXJhbFN0b3JhZ2VTaXplTWF4ID0gMTAyNDA7XG4gICAgY29uc3QgZXBoZW1lcmFsU3RvcmFnZVNpemVEZWZhdWx0ID0gNTEyO1xuICAgIGlmICh0aGlzLnByb3BzLmVwaGVtZXJhbFN0b3JhZ2VTaXplTUIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGVwaGVtZXJhbFN0b3JhZ2VTaXplRGVmYXVsdDtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKFxuICAgICAgICB0aGlzLnByb3BzLmVwaGVtZXJhbFN0b3JhZ2VTaXplTUIsXG4gICAgICAgIGVwaGVtZXJhbFN0b3JhZ2VTaXplTWluLFxuICAgICAgICBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1heCxcbiAgICAgIClcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkRXBoZW1lcmFsU3RvcmFnZVNpemVNQkVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBmdW5jdGlvbiBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1CIG9mICR7dGhpcy5wcm9wcy5lcGhlbWVyYWxTdG9yYWdlU2l6ZU1CfWAsXG4gICAgICAgIHJlc29sdXRpb246IGBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1CIG11c3QgYmUgYSB3aG9sZSBudW1iZXIgYmV0d2VlbiAke2VwaGVtZXJhbFN0b3JhZ2VTaXplTWlufSBhbmQgJHtlcGhlbWVyYWxTdG9yYWdlU2l6ZU1heH0gaW5jbHVzaXZlYCxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5lcGhlbWVyYWxTdG9yYWdlU2l6ZU1CO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZUVudmlyb25tZW50ID0gKCkgPT4ge1xuICAgIGlmICh0aGlzLnByb3BzLmVudmlyb25tZW50ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnZhbGlkS2V5czogc3RyaW5nW10gPSBbXTtcblxuICAgIE9iamVjdC5rZXlzKHRoaXMucHJvcHMuZW52aXJvbm1lbnQpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgLy8gdmFsaWRhdGUgdXNpbmcga2V5IHBhdHRlcm4gZnJvbSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vbGFtYmRhL2xhdGVzdC9hcGkvQVBJX0Vudmlyb25tZW50Lmh0bWxcbiAgICAgIGlmICgha2V5Lm1hdGNoKC9eW2EtekEtWl0oW2EtekEtWjAtOV9dKSskLykpIHtcbiAgICAgICAgaW52YWxpZEtleXMucHVzaChrZXkpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKGludmFsaWRLZXlzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkRW52aXJvbm1lbnRLZXlFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogYEludmFsaWQgZnVuY3Rpb24gZW52aXJvbm1lbnQga2V5KHMpOiAke2ludmFsaWRLZXlzLmpvaW4oXG4gICAgICAgICAgJywgJyxcbiAgICAgICAgKX1gLFxuICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICdFbnZpcm9ubWVudCBrZXlzIG11c3QgbWF0Y2ggW2EtekEtWl0oW2EtekEtWjAtOV9dKSsgYW5kIGJlIGF0IGxlYXN0IDIgY2hhcmFjdGVycycsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5lbnZpcm9ubWVudDtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVSdW50aW1lID0gKCkgPT4ge1xuICAgIGNvbnN0IHJ1bnRpbWVEZWZhdWx0ID0gMTg7XG5cbiAgICAvLyBpZiBydW50aW1lIGlzIG5vdCBzZXQsIGRlZmF1bHQgdG8gdGhlIG9sZGVzdCBMVFNcbiAgICBpZiAoIXRoaXMucHJvcHMucnVudGltZSkge1xuICAgICAgcmV0dXJuIHJ1bnRpbWVEZWZhdWx0O1xuICAgIH1cblxuICAgIGlmICghKHRoaXMucHJvcHMucnVudGltZSBpbiBub2RlVmVyc2lvbk1hcCkpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkUnVudGltZUVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBmdW5jdGlvbiBydW50aW1lIG9mICR7dGhpcy5wcm9wcy5ydW50aW1lfWAsXG4gICAgICAgIHJlc29sdXRpb246IGBydW50aW1lIG11c3QgYmUgb25lIG9mIHRoZSBmb2xsb3dpbmc6ICR7T2JqZWN0LmtleXMoXG4gICAgICAgICAgbm9kZVZlcnNpb25NYXAsXG4gICAgICAgICkuam9pbignLCAnKX1gLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJvcHMucnVudGltZTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVBcmNoaXRlY3R1cmUgPSAoKSA9PiB7XG4gICAgY29uc3QgYXJjaGl0ZWN0dXJlRGVmYXVsdCA9ICd4ODZfNjQnO1xuXG4gICAgaWYgKCF0aGlzLnByb3BzLmFyY2hpdGVjdHVyZSkge1xuICAgICAgcmV0dXJuIGFyY2hpdGVjdHVyZURlZmF1bHQ7XG4gICAgfVxuXG4gICAgaWYgKCEodGhpcy5wcm9wcy5hcmNoaXRlY3R1cmUgaW4gYXJjaGl0ZWN0dXJlTWFwKSkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ0ludmFsaWRBcmNoaXRlY3R1cmVFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogYEludmFsaWQgZnVuY3Rpb24gYXJjaGl0ZWN0dXJlIG9mICR7dGhpcy5wcm9wcy5hcmNoaXRlY3R1cmV9YCxcbiAgICAgICAgcmVzb2x1dGlvbjogYGFyY2hpdGVjdHVyZSBtdXN0IGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nOiAke09iamVjdC5rZXlzKFxuICAgICAgICAgIGFyY2hpdGVjdHVyZU1hcCxcbiAgICAgICAgKS5qb2luKCcsICcpfWAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5hcmNoaXRlY3R1cmU7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlU2NoZWR1bGUgPSAoKSA9PiB7XG4gICAgaWYgKCF0aGlzLnByb3BzLnNjaGVkdWxlKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJvcHMuc2NoZWR1bGU7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlQnVuZGxpbmcgPSAoKSA9PiB7XG4gICAgY29uc3QgYnVuZGxpbmdEZWZhdWx0ID0ge1xuICAgICAgZm9ybWF0OiBPdXRwdXRGb3JtYXQuRVNNLFxuICAgICAgYnVuZGxlQXdzU0RLOiB0cnVlLFxuICAgICAgbG9hZGVyOiB7XG4gICAgICAgICcubm9kZSc6ICdmaWxlJyxcbiAgICAgIH0sXG4gICAgICBtaW5pZnk6IHRydWUsXG4gICAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgfTtcblxuICAgIHJldHVybiB7XG4gICAgICAuLi5idW5kbGluZ0RlZmF1bHQsXG4gICAgICBtaW5pZnk6IHRoaXMucmVzb2x2ZU1pbmlmeSh0aGlzLnByb3BzLmJ1bmRsaW5nKSxcbiAgICB9O1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZU1pbmlmeSA9IChidW5kbGluZz86IEZ1bmN0aW9uQnVuZGxpbmdPcHRpb25zKSA9PiB7XG4gICAgcmV0dXJuIGJ1bmRsaW5nPy5taW5pZnkgPT09IHVuZGVmaW5lZCA/IHRydWUgOiBidW5kbGluZy5taW5pZnk7XG4gIH07XG59XG5cbnR5cGUgSHlkcmF0ZWRGdW5jdGlvblByb3BzID0gUmVxdWlyZWQ8RnVuY3Rpb25Qcm9wcz47XG5cbmNsYXNzIEZ1bmN0aW9uR2VuZXJhdG9yIGltcGxlbWVudHMgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3Ige1xuICByZWFkb25seSByZXNvdXJjZUdyb3VwTmFtZTogQW1wbGlmeVJlc291cmNlR3JvdXBOYW1lO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxGdW5jdGlvbk91dHB1dD4sXG4gICkge1xuICAgIHRoaXMucmVzb3VyY2VHcm91cE5hbWUgPSBwcm9wcy5yZXNvdXJjZUdyb3VwTmFtZTtcbiAgfVxuXG4gIGdlbmVyYXRlQ29udGFpbmVyRW50cnkgPSAoe1xuICAgIHNjb3BlLFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgfTogR2VuZXJhdGVDb250YWluZXJFbnRyeVByb3BzKSA9PiB7XG4gICAgLy8gTW92ZSBsYXllciByZXNvbHV0aW9uIGhlcmUgd2hlcmUgd2UgaGF2ZSBhY2Nlc3MgdG8gc2NvcGVcbiAgICBjb25zdCBwYXJzZXIgPSBuZXcgRnVuY3Rpb25MYXllckFyblBhcnNlcihcbiAgICAgIFN0YWNrLm9mKHNjb3BlKS5yZWdpb24sXG4gICAgICBTdGFjay5vZihzY29wZSkuYWNjb3VudCxcbiAgICApO1xuICAgIGNvbnN0IHJlc29sdmVkTGF5ZXJBcm5zID0gcGFyc2VyLnBhcnNlTGF5ZXJzKFxuICAgICAgdGhpcy5wcm9wcy5sYXllcnMgPz8ge30sXG4gICAgICB0aGlzLnByb3BzLm5hbWUsXG4gICAgKTtcblxuICAgIC8vIHJlc29sdmUgbGF5ZXJzIHRvIExheWVyVmVyc2lvbiBvYmplY3RzIGZvciB0aGUgTm9kZWpzRnVuY3Rpb24gY29uc3RydWN0b3JcbiAgICBjb25zdCByZXNvbHZlZExheWVycyA9IE9iamVjdC5lbnRyaWVzKHJlc29sdmVkTGF5ZXJBcm5zKS5tYXAoKFtrZXksIGFybl0pID0+XG4gICAgICBMYXllclZlcnNpb24uZnJvbUxheWVyVmVyc2lvbkFybihcbiAgICAgICAgc2NvcGUsXG4gICAgICAgIGAke3RoaXMucHJvcHMubmFtZX0tJHtrZXl9LWxheWVyYCxcbiAgICAgICAgYXJuLFxuICAgICAgKSxcbiAgICApO1xuXG4gICAgcmV0dXJuIG5ldyBBbXBsaWZ5RnVuY3Rpb24oXG4gICAgICBzY29wZSxcbiAgICAgIHRoaXMucHJvcHMubmFtZSxcbiAgICAgIHsgLi4udGhpcy5wcm9wcywgcmVzb2x2ZWRMYXllcnMgfSxcbiAgICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICAgIHRoaXMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgICk7XG4gIH07XG59XG5cbmNsYXNzIEFtcGxpZnlGdW5jdGlvblxuICBleHRlbmRzIEFtcGxpZnlGdW5jdGlvbkJhc2VcbiAgaW1wbGVtZW50cyBBZGRFbnZpcm9ubWVudEZhY3RvcnlcbntcbiAgcmVhZG9ubHkgcmVzb3VyY2VzOiBGdW5jdGlvblJlc291cmNlcztcbiAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvcjogRnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3I7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICBwcm9wczogSHlkcmF0ZWRGdW5jdGlvblByb3BzICYgeyByZXNvbHZlZExheWVyczogSUxheWVyVmVyc2lvbltdIH0sXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEZ1bmN0aW9uT3V0cHV0PixcbiAgKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kpO1xuXG4gICAgY29uc3QgcnVudGltZSA9IG5vZGVWZXJzaW9uTWFwW3Byb3BzLnJ1bnRpbWVdO1xuXG4gICAgY29uc3QgcmVxdWlyZSA9IGNyZWF0ZVJlcXVpcmUoaW1wb3J0Lm1ldGEudXJsKTtcblxuICAgIGNvbnN0IHNoaW1zID1cbiAgICAgIHJ1bnRpbWUgPT09IFJ1bnRpbWUuTk9ERUpTXzE2X1hcbiAgICAgICAgPyBbXVxuICAgICAgICA6IFtyZXF1aXJlLnJlc29sdmUoJy4vbGFtYmRhLXNoaW1zL2Nqc19zaGltJyldO1xuXG4gICAgY29uc3Qgc3NtUmVzb2x2ZXJGaWxlID1cbiAgICAgIHJ1bnRpbWUgPT09IFJ1bnRpbWUuTk9ERUpTXzE2X1hcbiAgICAgICAgPyByZXF1aXJlLnJlc29sdmUoJy4vbGFtYmRhLXNoaW1zL3Jlc29sdmVfc3NtX3BhcmFtc19zZGtfdjInKSAvLyB1c2UgYXdzIGNkayB2MiBpbiBub2RlIDE2XG4gICAgICAgIDogcmVxdWlyZS5yZXNvbHZlKCcuL2xhbWJkYS1zaGltcy9yZXNvbHZlX3NzbV9wYXJhbXMnKTtcblxuICAgIGNvbnN0IGludm9rZVNzbVJlc29sdmVyRmlsZSA9IHJlcXVpcmUucmVzb2x2ZShcbiAgICAgICcuL2xhbWJkYS1zaGltcy9pbnZva2Vfc3NtX3NoaW0nLFxuICAgICk7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGNvZGUgY29uY2F0ZW5hdGVzIHRoZSBjb250ZW50cyBvZiB0aGUgc3NtIHJlc29sdmVyIGFuZCBpbnZva2VyIGludG8gYSBzaW5nbGUgbGluZSB0aGF0IGNhbiBiZSB1c2VkIGFzIHRoZSBlc2J1aWxkIGJhbm5lciBjb250ZW50XG4gICAgICogVGhpcyBiYW5uZXIgaXMgcmVzcG9uc2libGUgZm9yIHJlc29sdmluZyB0aGUgY3VzdG9tZXIncyBTU00gcGFyYW1ldGVycyBhdCBydW50aW1lXG4gICAgICovXG4gICAgY29uc3QgYmFubmVyQ29kZSA9IHJlYWRGaWxlU3luYyhzc21SZXNvbHZlckZpbGUsICd1dGYtOCcpXG4gICAgICAuY29uY2F0KHJlYWRGaWxlU3luYyhpbnZva2VTc21SZXNvbHZlckZpbGUsICd1dGYtOCcpKVxuICAgICAgLnNwbGl0KG5ldyBSZWdFeHAoYCR7RU9MfXxcXG58XFxyYCwgJ2cnKSlcbiAgICAgIC5tYXAoKGxpbmUpID0+IGxpbmUucmVwbGFjZSgvXFwvXFwvLiokLywgJycpKSAvLyBzdHJpcCBvdXQgaW5saW5lIGNvbW1lbnRzIGJlY2F1c2UgdGhlIGJhbm5lciBpcyBnb2luZyB0byBiZSBmbGF0dGVuZWQgaW50byBhIHNpbmdsZSBsaW5lXG4gICAgICAuam9pbignJyk7XG5cbiAgICBjb25zdCBmdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvciA9XG4gICAgICBuZXcgRnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IoaWQpO1xuXG4gICAgLy8gZXNidWlsZCBydW5zIGFzIHBhcnQgb2YgdGhlIE5vZGVqc0Z1bmN0aW9uIGNvbnN0cnVjdG9yLCBzbyB3ZSBlYWdlcmx5IGdlbmVyYXRlIHRoZSBwcm9jZXNzIGVudiBzaGltIHdpdGhvdXQgdHlwZXMgc28gaXQgY2FuIGJlIGluY2x1ZGVkIGluIHRoZSBmdW5jdGlvbiBidW5kbGUuXG4gICAgLy8gVGhpcyB3aWxsIGJlIG92ZXJ3cml0dGVuIHdpdGggdGhlIHR5cGVkIGZpbGUgYXQgdGhlIGVuZCBvZiBzeW50aGVzaXNcbiAgICBmdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvci5nZW5lcmF0ZVByb2Nlc3NFbnZTaGltKCk7XG5cbiAgICBsZXQgZnVuY3Rpb25MYW1iZGE6IE5vZGVqc0Z1bmN0aW9uO1xuICAgIGNvbnN0IGNka0xvZ2dpbmdPcHRpb25zID0gY29udmVydExvZ2dpbmdPcHRpb25zVG9DREsocHJvcHMubG9nZ2luZyk7XG4gICAgdHJ5IHtcbiAgICAgIGZ1bmN0aW9uTGFtYmRhID0gbmV3IE5vZGVqc0Z1bmN0aW9uKHNjb3BlLCBgJHtpZH0tbGFtYmRhYCwge1xuICAgICAgICBlbnRyeTogcHJvcHMuZW50cnksXG4gICAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLnNlY29uZHMocHJvcHMudGltZW91dFNlY29uZHMpLFxuICAgICAgICBtZW1vcnlTaXplOiBwcm9wcy5tZW1vcnlNQixcbiAgICAgICAgYXJjaGl0ZWN0dXJlOiBhcmNoaXRlY3R1cmVNYXBbcHJvcHMuYXJjaGl0ZWN0dXJlXSxcbiAgICAgICAgZXBoZW1lcmFsU3RvcmFnZVNpemU6IFNpemUubWViaWJ5dGVzKHByb3BzLmVwaGVtZXJhbFN0b3JhZ2VTaXplTUIpLFxuICAgICAgICBydW50aW1lOiBub2RlVmVyc2lvbk1hcFtwcm9wcy5ydW50aW1lXSxcbiAgICAgICAgbGF5ZXJzOiBwcm9wcy5yZXNvbHZlZExheWVycyxcbiAgICAgICAgYnVuZGxpbmc6IHtcbiAgICAgICAgICAuLi5wcm9wcy5idW5kbGluZyxcbiAgICAgICAgICBiYW5uZXI6IGJhbm5lckNvZGUsXG4gICAgICAgICAgaW5qZWN0OiBzaGltcyxcbiAgICAgICAgICBleHRlcm5hbE1vZHVsZXM6IE9iamVjdC5rZXlzKHByb3BzLmxheWVycyksXG4gICAgICAgIH0sXG4gICAgICAgIGxvZ1JldGVudGlvbjogY2RrTG9nZ2luZ09wdGlvbnMucmV0ZW50aW9uLFxuICAgICAgICBhcHBsaWNhdGlvbkxvZ0xldmVsVjI6IGNka0xvZ2dpbmdPcHRpb25zLmxldmVsLFxuICAgICAgICBsb2dnaW5nRm9ybWF0OiBjZGtMb2dnaW5nT3B0aW9ucy5mb3JtYXQsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gSWYgdGhlIGVycm9yIGlzIGZyb20gRVMgQnVuZGxlciB3aGljaCBpcyBleGVjdXRlZCBhcyBhIGNoaWxkIHByb2Nlc3MgYnkgQ0RLLFxuICAgICAgLy8gdGhlbiB0aGUgZXJyb3IgZnJvbSBDREsgY29udGFpbnMgdGhlIGNvbW1hbmQgdGhhdCB3YXMgZXhlY3V0ZWQgYWxvbmcgd2l0aCB0aGUgZXhpdCBzdGF0dXMuXG4gICAgICAvLyBXcmFwcGluZyBpdCBoZXJlICB3b3VsZCBjYXVzZSB0aGUgY2RrX2RlcGxveWVyIHRvIHJlLXRocm93IHRoaXMgd3JhcHBlZCBleGNlcHRpb25cbiAgICAgIC8vIGluc3RlYWQgb2Ygc2NyYXBpbmcgdGhlIHN0ZGVyciBmb3IgYWN0dWFsIEVTQnVpbGQgZXJyb3IuXG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiZcbiAgICAgICAgZXJyb3IubWVzc2FnZS5tYXRjaCgvRmFpbGVkIHRvIGJ1bmRsZSBhc3NldC4qZXhpdGVkIHdpdGggc3RhdHVzLylcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnTm9kZUpTRnVuY3Rpb25Db25zdHJ1Y3RJbml0aWFsaXphdGlvbkVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgbm9kZWpzIGZ1bmN0aW9uIGNvbnN0cnVjdCcsXG4gICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICdTZWUgdGhlIHVuZGVybHlpbmcgZXJyb3IgbWVzc2FnZSBmb3IgbW9yZSBkZXRhaWxzLiBVc2UgYC0tZGVidWdgIGZvciBhZGRpdGlvbmFsIGRlYnVnZ2luZyBpbmZvcm1hdGlvbi4nLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvciBhcyBFcnJvcixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNjaGVkdWxlcyA9IGNvbnZlcnRGdW5jdGlvblNjaGVkdWxlc1RvUnVsZVNjaGVkdWxlcyhcbiAgICAgICAgZnVuY3Rpb25MYW1iZGEsXG4gICAgICAgIHByb3BzLnNjaGVkdWxlLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IGxhbWJkYVRhcmdldCA9IG5ldyB0YXJnZXRzLkxhbWJkYUZ1bmN0aW9uKGZ1bmN0aW9uTGFtYmRhKTtcblxuICAgICAgc2NoZWR1bGVzLmZvckVhY2goKHNjaGVkdWxlLCBpbmRleCkgPT4ge1xuICAgICAgICAvLyBMYW1iZGEgbmFtZSB3aWxsIGJlIHByZXBlbmRlZCB0byBydWxlIGlkLCBzbyBvbmx5IHVzaW5nIGluZGV4IGhlcmUgZm9yIHVuaXF1ZW5lc3NcbiAgICAgICAgY29uc3QgcnVsZSA9IG5ldyBSdWxlKGZ1bmN0aW9uTGFtYmRhLCBgc2NoZWR1bGUke2luZGV4fWAsIHtcbiAgICAgICAgICBzY2hlZHVsZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcnVsZS5hZGRUYXJnZXQobGFtYmRhVGFyZ2V0KTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgJ0Z1bmN0aW9uU2NoZWR1bGVJbml0aWFsaXphdGlvbkVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgc2NoZWR1bGUgZm9yIG5vZGVqcyBmdW5jdGlvbicsXG4gICAgICAgICAgcmVzb2x1dGlvbjogJ1NlZSB0aGUgdW5kZXJseWluZyBlcnJvciBtZXNzYWdlIGZvciBtb3JlIGRldGFpbHMuJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgYXMgRXJyb3IsXG4gICAgICApO1xuICAgIH1cblxuICAgIFRhZ3Mub2YoZnVuY3Rpb25MYW1iZGEpLmFkZChUYWdOYW1lLkZSSUVORExZX05BTUUsIGlkKTtcblxuICAgIHRoaXMuZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IgPSBuZXcgRnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IoXG4gICAgICBmdW5jdGlvbkxhbWJkYSxcbiAgICAgIHByb3BzLmVudmlyb25tZW50LFxuICAgICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgICAgZnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IsXG4gICAgKTtcblxuICAgIHRoaXMucmVzb3VyY2VzID0ge1xuICAgICAgbGFtYmRhOiBmdW5jdGlvbkxhbWJkYSxcbiAgICAgIGNmblJlc291cmNlczoge1xuICAgICAgICBjZm5GdW5jdGlvbjogZnVuY3Rpb25MYW1iZGEubm9kZS5maW5kQ2hpbGQoJ1Jlc291cmNlJykgYXMgQ2ZuRnVuY3Rpb24sXG4gICAgICB9LFxuICAgIH07XG5cbiAgICB0aGlzLnN0b3JlT3V0cHV0KCk7XG4gIH1cblxuICBhZGRFbnZpcm9ubWVudCA9IChrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZyB8IEJhY2tlbmRTZWNyZXQpID0+IHtcbiAgICB0aGlzLmZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yLmFkZEVudmlyb25tZW50RW50cnkoa2V5LCB2YWx1ZSk7XG4gIH07XG5cbiAgZ2V0UmVzb3VyY2VBY2Nlc3NBY2NlcHRvciA9ICgpOiBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yID0+XG4gICAgbmV3IEZ1bmN0aW9uUmVzb3VyY2VBY2Nlc3NBY2NlcHRvcihcbiAgICAgIHRoaXMsXG4gICAgICB0aGlzLmZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yLFxuICAgICk7XG59XG5cbmNvbnN0IGlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlID0gKFxuICB0ZXN0OiBudW1iZXIsXG4gIG1pbjogbnVtYmVyLFxuICBtYXg6IG51bWJlcixcbikgPT4gbWluIDw9IHRlc3QgJiYgdGVzdCA8PSBtYXggJiYgdGVzdCAlIDEgPT09IDA7XG5cbmV4cG9ydCB0eXBlIE5vZGVWZXJzaW9uID0gMTYgfCAxOCB8IDIwIHwgMjI7XG5cbmNvbnN0IG5vZGVWZXJzaW9uTWFwOiBSZWNvcmQ8Tm9kZVZlcnNpb24sIFJ1bnRpbWU+ID0ge1xuICAxNjogUnVudGltZS5OT0RFSlNfMTZfWCxcbiAgMTg6IFJ1bnRpbWUuTk9ERUpTXzE4X1gsXG4gIDIwOiBSdW50aW1lLk5PREVKU18yMF9YLFxuICAyMjogUnVudGltZS5OT0RFSlNfMjJfWCxcbn07XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uQXJjaGl0ZWN0dXJlID0gJ3g4Nl82NCcgfCAnYXJtNjQnO1xuXG5jb25zdCBhcmNoaXRlY3R1cmVNYXA6IFJlY29yZDxGdW5jdGlvbkFyY2hpdGVjdHVyZSwgQXJjaGl0ZWN0dXJlPiA9IHtcbiAgYXJtNjQ6IEFyY2hpdGVjdHVyZS5BUk1fNjQsXG4gIHg4Nl82NDogQXJjaGl0ZWN0dXJlLlg4Nl82NCxcbn07XG4iXX0=