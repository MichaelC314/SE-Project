import { AmplifyDataDefinition, } from '@aws-amplify/data-construct';
import { resolveEntryPath } from './resolve_entry_path.js';
import { readFileSync } from 'fs';
/**
 * Determine if the input schema is a derived typed schema object (data-schema), and perform type narrowing.
 * @param schema the schema that might be a derived model schema
 * @returns a boolean indicating whether the schema is a derived model schema, with type narrowing
 */
export const isDataSchema = (schema) => {
    return (schema !== null &&
        typeof schema === 'object' &&
        'transform' in schema &&
        typeof schema.transform === 'function');
};
/**
 * Determine if the input schema is a collection of typed schemas, and perform type narrowing.
 * @param schema the schema that might be a collection of model schemas
 * @returns a boolean indicating whether the schema is a collection of derived model schema, with type narrowing
 */
export const isCombinedSchema = (schema) => {
    return (schema !== null &&
        typeof schema === 'object' &&
        'schemas' in schema &&
        Array.isArray(schema.schemas));
};
// DO NOT EDIT THE FOLLOWING VALUES, UPDATES TO DB TYPE OR STRATEGY WILL RESULT IN DB REPROVISIONING
// Conforms to this interface: https://github.com/aws-amplify/amplify-category-api/blob/274d1176d96e265d02817a975848c767d6d43c31/packages/amplify-graphql-api-construct/src/model-datasource-strategy-types.ts#L35-L41
const DYNAMO_DATA_SOURCE_STRATEGY = {
    dbType: 'DYNAMODB',
    provisionStrategy: 'AMPLIFY_TABLE',
};
// Translate the external engine types to the config values
// Reference: https://github.com/aws-amplify/amplify-category-api/blob/fd7f6fbc17c199331c4b04debaff69ea0424cd74/packages/amplify-graphql-api-construct/src/model-datasource-strategy-types.ts#L25
const SQL_DB_TYPES = {
    mysql: 'MYSQL',
    postgresql: 'POSTGRES',
};
/**
 * Given an input schema type, produce the relevant CDK Graphql Def interface
 * @param schema TS schema builder definition or string GraphQL schema
 * @param backendSecretResolver secret resolver
 * @param stableBackendIdentifiers backend identifiers
 * @returns the cdk graphql definition interface
 */
export const convertSchemaToCDK = (schema, backendSecretResolver, stableBackendIdentifiers) => {
    if (isDataSchema(schema)) {
        /**
         * This is not super obvious, but the IAmplifyDataDefinition interface requires a record of each model type to a
         * data source strategy (how it should be deployed and managed). Normally this is handled for customers by static
         * methods on AmplifyDataDefinition, but since the data-schema-types don't produce that today, we use the builder
         * to generate that argument for us (so it's consistent with a customer using normal Graphql strings), then
         * apply that value back into the final IAmplifyDataDefinition output for data-schema users.
         */
        const { schema: transformedSchema, functionSlots, customSqlDataSourceStrategies, } = schema.transform();
        const provisionStrategyName = stableBackendIdentifiers.getStableBackendHash();
        const dbStrategy = convertDatabaseConfigurationToDataSourceStrategy(schema.data.configuration.database, customSqlDataSourceStrategies, backendSecretResolver, provisionStrategyName);
        const generatedModelDataSourceStrategies = AmplifyDataDefinition.fromString(transformedSchema, dbStrategy).dataSourceStrategies;
        if (dbStrategy.dbType === 'DYNAMODB') {
            return {
                schema: transformedSchema,
                functionSlots,
                dataSourceStrategies: generatedModelDataSourceStrategies,
            };
        }
        return {
            schema: transformedSchema,
            functionSlots,
            dataSourceStrategies: generatedModelDataSourceStrategies,
            customSqlDataSourceStrategies: customSqlDataSourceStrategies?.map((existing) => ({
                ...existing,
                strategy: dbStrategy,
            })) || [],
        };
    }
    return AmplifyDataDefinition.fromString(schema, DYNAMO_DATA_SOURCE_STRATEGY);
};
/**
 * Given an input list of CDK Graphql Def interface schemas, produce the relevant CDK Graphql Def interface
 * @param schemas the cdk graphql definition interfaces to combine
 * @returns the cdk graphql definition interface
 */
export const combineCDKSchemas = (schemas) => {
    return AmplifyDataDefinition.combine(schemas);
};
/**
 * Given the generated rds builder database configuration, convert it into the DataSource strategy
 * @param configuration the database configuration from `data-schema`
 * @returns the data strategy needed to configure the data source
 */
const convertDatabaseConfigurationToDataSourceStrategy = (configuration, customSqlDataSourceStrategies = [], backendSecretResolver, provisionStrategyName) => {
    if (configuration.engine === 'dynamodb') {
        return DYNAMO_DATA_SOURCE_STRATEGY;
    }
    const dbType = SQL_DB_TYPES[configuration.engine];
    let vpcConfiguration = undefined;
    if (configuration.vpcConfig !== undefined) {
        vpcConfiguration = {
            vpcId: configuration.vpcConfig.vpcId,
            securityGroupIds: configuration.vpcConfig.securityGroupIds,
            subnetAvailabilityZoneConfig: configuration.vpcConfig.subnetAvailabilityZones,
        };
    }
    const customSqlStatements = customSqlStatementsFromStrategies(customSqlDataSourceStrategies);
    const { branchSecretPath, sharedSecretPath } = backendSecretResolver.resolvePath(configuration.connectionUri);
    let sslCertConfig;
    if (configuration.sslCert) {
        const { branchSecretPath, sharedSecretPath } = backendSecretResolver.resolvePath(configuration.sslCert);
        sslCertConfig = {
            ssmPath: [branchSecretPath, sharedSecretPath],
        };
    }
    const strategy = {
        dbType,
        name: provisionStrategyName +
            (configuration.identifier ?? configuration.engine),
        dbConnectionConfig: {
            connectionUriSsmPath: [branchSecretPath, sharedSecretPath],
            ...(sslCertConfig ? { sslCertConfig } : undefined),
        },
        vpcConfiguration,
        customSqlStatements,
    };
    return strategy;
};
/**
 * Create a custom sql statement reference dictionary
 * @param customSqlDataSourceStrategies custom sql handler defined in the schema
 * @returns an object mapping the file path to the sql statement
 */
const customSqlStatementsFromStrategies = (customSqlDataSourceStrategies) => {
    const customSqlStatements = customSqlDataSourceStrategies
        .filter((sqlStrategy) => sqlStrategy.entry !== undefined)
        .reduce((acc, sqlStrategy) => {
        const entry = sqlStrategy.entry;
        const reference = typeof entry === 'string' ? entry : entry.relativePath;
        const resolvedPath = resolveEntryPath(entry);
        acc[reference] = readFileSync(resolvedPath, 'utf8');
        return acc;
    }, {});
    return customSqlStatements;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydF9zY2hlbWEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY29udmVydF9zY2hlbWEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBTUEsT0FBTyxFQUNMLHFCQUFxQixHQUt0QixNQUFNLDZCQUE2QixDQUFDO0FBTXJDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzNELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFFbEM7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FBRyxDQUMxQixNQUFrQixFQUNXLEVBQUU7SUFDL0IsT0FBTyxDQUNMLE1BQU0sS0FBSyxJQUFJO1FBQ2YsT0FBTyxNQUFNLEtBQUssUUFBUTtRQUMxQixXQUFXLElBQUksTUFBTTtRQUNyQixPQUFPLE1BQU0sQ0FBQyxTQUFTLEtBQUssVUFBVSxDQUN2QyxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUY7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxNQUFNLGdCQUFnQixHQUFHLENBQzlCLE1BQXVCLEVBQ1UsRUFBRTtJQUNuQyxPQUFPLENBQ0wsTUFBTSxLQUFLLElBQUk7UUFDZixPQUFPLE1BQU0sS0FBSyxRQUFRO1FBQzFCLFNBQVMsSUFBSSxNQUFNO1FBQ25CLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUM5QixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUYsb0dBQW9HO0FBQ3BHLHNOQUFzTjtBQUN0TixNQUFNLDJCQUEyQixHQUFHO0lBQ2xDLE1BQU0sRUFBRSxVQUFVO0lBQ2xCLGlCQUFpQixFQUFFLGVBQWU7Q0FDMUIsQ0FBQztBQUVYLDJEQUEyRDtBQUMzRCxpTUFBaU07QUFDak0sTUFBTSxZQUFZLEdBQUc7SUFDbkIsS0FBSyxFQUFFLE9BQU87SUFDZCxVQUFVLEVBQUUsVUFBVTtDQUNkLENBQUM7QUFFWDs7Ozs7O0dBTUc7QUFDSCxNQUFNLENBQUMs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QW1CLENBQUM7QUFDN0IsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUge1xuICBDdXN0b21TcWxEYXRhU291cmNlU3RyYXRlZ3ksXG4gIERhdGFTb3VyY2VDb25maWd1cmF0aW9uLFxuICBEZXJpdmVkQ29tYmluZWRTY2hlbWEsXG4gIERlcml2ZWRNb2RlbFNjaGVtYSBhcyBEZXJpdmVkRGF0YVNjaGVtYSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2RhdGEtc2NoZW1hLXR5cGVzJztcbmltcG9ydCB7XG4gIEFtcGxpZnlEYXRhRGVmaW5pdGlvbixcbiAgdHlwZSBJQW1wbGlmeURhdGFEZWZpbml0aW9uLFxuICB0eXBlIE1vZGVsRGF0YVNvdXJjZVN0cmF0ZWd5LFxuICB0eXBlIFNzbENlcnRTc21QYXRoQ29uZmlnLFxuICB0eXBlIFZwY0NvbmZpZyxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2RhdGEtY29uc3RydWN0JztcbmltcG9ydCB0eXBlIHsgRGF0YVNjaGVtYSwgRGF0YVNjaGVtYUlucHV0IH0gZnJvbSAnLi90eXBlcy5qcyc7XG5pbXBvcnQgdHlwZSB7XG4gIEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgU3RhYmxlQmFja2VuZElkZW50aWZpZXJzLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IHJlc29sdmVFbnRyeVBhdGggfSBmcm9tICcuL3Jlc29sdmVfZW50cnlfcGF0aC5qcyc7XG5pbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XG5cbi8qKlxuICogRGV0ZXJtaW5lIGlmIHRoZSBpbnB1dCBzY2hlbWEgaXMgYSBkZXJpdmVkIHR5cGVkIHNjaGVtYSBvYmplY3QgKGRhdGEtc2NoZW1hKSwgYW5kIHBlcmZvcm0gdHlwZSBuYXJyb3dpbmcuXG4gKiBAcGFyYW0gc2NoZW1hIHRoZSBzY2hlbWEgdGhhdCBtaWdodCBiZSBhIGRlcml2ZWQgbW9kZWwgc2NoZW1hXG4gKiBAcmV0dXJucyBhIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZSBzY2hlbWEgaXMgYSBkZXJpdmVkIG1vZGVsIHNjaGVtYSwgd2l0aCB0eXBlIG5hcnJvd2luZ1xuICovXG5leHBvcnQgY29uc3QgaXNEYXRhU2NoZW1hID0gKFxuICBzY2hlbWE6IERhdGFTY2hlbWEsXG4pOiBzY2hlbWEgaXMgRGVyaXZlZERhdGFTY2hlbWEgPT4ge1xuICByZXR1cm4gKFxuICAgIHNjaGVtYSAhPT0gbnVsbCAmJlxuICAgIHR5cGVvZiBzY2hlbWEgPT09ICdvYmplY3QnICYmXG4gICAgJ3RyYW5zZm9ybScgaW4gc2NoZW1hICYmXG4gICAgdHlwZW9mIHNjaGVtYS50cmFuc2Zvcm0gPT09ICdmdW5jdGlvbidcbiAgKTtcbn07XG5cbi8qKlxuICogRGV0ZXJtaW5lIGlmIHRoZSBpbnB1dCBzY2hlbWEgaXMgYSBjb2xsZWN0aW9uIG9mIHR5cGVkIHNjaGVtYXMsIGFuZCBwZXJmb3JtIHR5cGUgbmFycm93aW5nLlxuICogQHBhcmFtIHNjaGVtYSB0aGUgc2NoZW1hIHRoYXQgbWlnaHQgYmUgYSBjb2xsZWN0aW9uIG9mIG1vZGVsIHNjaGVtYXNcbiAqIEByZXR1cm5zIGEgYm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHNjaGVtYSBpcyBhIGNvbGxlY3Rpb24gb2YgZGVyaXZlZCBtb2RlbCBzY2hlbWEsIHdpdGggdHlwZSBuYXJyb3dpbmdcbiAqL1xuZXhwb3J0IGNvbnN0IGlzQ29tYmluZWRTY2hlbWEgPSAoXG4gIHNjaGVtYTogRGF0YVNjaGVtYUlucHV0LFxuKTogc2NoZW1hIGlzIERlcml2ZWRDb21iaW5lZFNjaGVtYSA9PiB7XG4gIHJldHVybiAoXG4gICAgc2NoZW1hICE9PSBudWxsICYmXG4gICAgdHlwZW9mIHNjaGVtYSA9PT0gJ29iamVjdCcgJiZcbiAgICAnc2NoZW1hcycgaW4gc2NoZW1hICYmXG4gICAgQXJyYXkuaXNBcnJheShzY2hlbWEuc2NoZW1hcylcbiAgKTtcbn07XG5cbi8vIERPIE5PVCBFRElUIFRIRSBGT0xMT1dJTkcgVkFMVUVTLCBVUERBVEVTIFRPIERCIFRZUEUgT1IgU1RSQVRFR1kgV0lMTCBSRVNVTFQgSU4gREIgUkVQUk9WSVNJT05JTkdcbi8vIENvbmZvcm1zIHRvIHRoaXMgaW50ZXJmYWNlOiBodHRwczovL2dpdGh1Yi5jb20vYXdzLWFtcGxpZnkvYW1wbGlmeS1jYXRlZ29yeS1hcGkvYmxvYi8yNzRkMTE3NmQ5NmUyNjVkMDI4MTdhOTc1ODQ4Yzc2N2Q2ZDQzYzMxL3BhY2thZ2VzL2FtcGxpZnktZ3JhcGhxbC1hcGktY29uc3RydWN0L3NyYy9tb2RlbC1kYXRhc291cmNlLXN0cmF0ZWd5LXR5cGVzLnRzI0wzNS1MNDFcbmNvbnN0IERZTkFNT19EQVRBX1NPVVJDRV9TVFJBVEVHWSA9IHtcbiAgZGJUeXBlOiAnRFlOQU1PREInLFxuICBwcm92aXNpb25TdHJhdGVneTogJ0FNUExJRllfVEFCTEUnLFxufSBhcyBjb25zdDtcblxuLy8gVHJhbnNsYXRlIHRoZSBleHRlcm5hbCBlbmdpbmUgdHlwZXMgdG8gdGhlIGNvbmZpZyB2YWx1ZXNcbi8vIFJlZmVyZW5jZTogaHR0cHM6Ly9naXRodWIuY29tL2F3cy1hbXBsaWZ5L2FtcGxpZnktY2F0ZWdvcnktYXBpL2Jsb2IvZmQ3ZjZmYmMxN2MxOTkzMzFjNGIwNGRlYmFmZjY5ZWEwNDI0Y2Q3NC9wYWNrYWdlcy9hbXBsaWZ5LWdyYXBocWwtYXBpLWNvbnN0cnVjdC9zcmMvbW9kZWwtZGF0YXNvdXJjZS1zdHJhdGVneS10eXBlcy50cyNMMjVcbmNvbnN0IFNRTF9EQl9UWVBFUyA9IHtcbiAgbXlzcWw6ICdNWVNRTCcsXG4gIHBvc3RncmVzcWw6ICdQT1NUR1JFUycsXG59IGFzIGNvbnN0O1xuXG4vKipcbiAqIEdpdmVuIGFuIGlucHV0IHNjaGVtYSB0eXBlLCBwcm9kdWNlIHRoZSByZWxldmFudCBDREsgR3JhcGhxbCBEZWYgaW50ZXJmYWNlXG4gKiBAcGFyYW0gc2NoZW1hIFRTIHNjaGVtYSBidWlsZGVyIGRlZmluaXRpb24gb3Igc3RyaW5nIEdyYXBoUUwgc2NoZW1hXG4gKiBAcGFyYW0gYmFja2VuZFNlY3JldFJlc29sdmVyIHNlY3JldCByZXNvbHZlclxuICogQHBhcmFtIHN0YWJsZUJhY2tlbmRJZGVudGlmaWVycyBiYWNrZW5kIGlkZW50aWZpZXJzXG4gKiBAcmV0dXJucyB0aGUgY2RrIGdyYXBocWwgZGVmaW5pdGlvbiBpbnRlcmZhY2VcbiAqL1xuZXhwb3J0IGNvbnN0IGNvbnZlcnRTY2hlbWFUb0NESyA9IChcbiAgc2NoZW1hOiBEYXRhU2NoZW1hLFxuICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgc3RhYmxlQmFja2VuZElkZW50aWZpZXJzOiBTdGFibGVCYWNrZW5kSWRlbnRpZmllcnMsXG4pOiBJQW1wbGlmeURhdGFEZWZpbml0aW9uID0+IHtcbiAgaWYgKGlzRGF0YVNjaGVtYShzY2hlbWEpKSB7XG4gICAgLyoqXG4gICAgICogVGhpcyBpcyBub3Qgc3VwZXIgb2J2aW91cywgYnV0IHRoZSBJQW1wbGlmeURhdGFEZWZpbml0aW9uIGludGVyZmFjZSByZXF1aXJlcyBhIHJlY29yZCBvZiBlYWNoIG1vZGVsIHR5cGUgdG8gYVxuICAgICAqIGRhdGEgc291cmNlIHN0cmF0ZWd5IChob3cgaXQgc2hvdWxkIGJlIGRlcGxveWVkIGFuZCBtYW5hZ2VkKS4gTm9ybWFsbHkgdGhpcyBpcyBoYW5kbGVkIGZvciBjdXN0b21lcnMgYnkgc3RhdGljXG4gICAgICogbWV0aG9kcyBvbiBBbXBsaWZ5RGF0YURlZmluaXRpb24sIGJ1dCBzaW5jZSB0aGUgZGF0YS1zY2hlbWEtdHlwZXMgZG9uJ3QgcHJvZHVjZSB0aGF0IHRvZGF5LCB3ZSB1c2UgdGhlIGJ1aWxkZXJcbiAgICAgKiB0byBnZW5lcmF0ZSB0aGF0IGFyZ3VtZW50IGZvciB1cyAoc28gaXQncyBjb25zaXN0ZW50IHdpdGggYSBjdXN0b21lciB1c2luZyBub3JtYWwgR3JhcGhxbCBzdHJpbmdzKSwgdGhlblxuICAgICAqIGFwcGx5IHRoYXQgdmFsdWUgYmFjayBpbnRvIHRoZSBmaW5hbCBJQW1wbGlmeURhdGFEZWZpbml0aW9uIG91dHB1dCBmb3IgZGF0YS1zY2hlbWEgdXNlcnMuXG4gICAgICovXG4gICAgY29uc3Qge1xuICAgICAgc2NoZW1hOiB0cmFuc2Zvcm1lZFNjaGVtYSxcbiAgICAgIGZ1bmN0aW9uU2xvdHMsXG4gICAgICBjdXN0b21TcWxEYXRhU291cmNlU3RyYXRlZ2llcyxcbiAgICB9ID0gc2NoZW1hLnRyYW5zZm9ybSgpO1xuXG4gICAgY29uc3QgcHJvdmlzaW9uU3RyYXRlZ3lOYW1lID1cbiAgICAgIHN0YWJsZUJhY2tlbmRJZGVudGlmaWVycy5nZXRTdGFibGVCYWNrZW5kSGFzaCgpO1xuXG4gICAgY29uc3QgZGJTdHJhdGVneSA9IGNvbnZlcnREYXRhYmFzZUNvbmZpZ3VyYXRpb25Ub0RhdGFTb3VyY2VTdHJhdGVneShcbiAgICAgIHNjaGVtYS5kYXRhLmNvbmZpZ3VyYXRpb24uZGF0YWJhc2UsXG4gICAgICBjdXN0b21TcWxEYXRhU291cmNlU3RyYXRlZ2llcyxcbiAgICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICAgIHByb3Zpc2lvblN0cmF0ZWd5TmFtZSxcbiAgICApO1xuXG4gICAgY29uc3QgZ2VuZXJhdGVkTW9kZWxEYXRhU291cmNlU3RyYXRlZ2llcyA9IEFtcGxpZnlEYXRhRGVmaW5pdGlvbi5mcm9tU3RyaW5nKFxuICAgICAgdHJhbnNmb3JtZWRTY2hlbWEsXG4gICAgICBkYlN0cmF0ZWd5LFxuICAgICkuZGF0YVNvdXJjZVN0cmF0ZWdpZXM7XG5cbiAgICBpZiAoZGJTdHJhdGVneS5kYlR5cGUgPT09ICdEWU5BTU9EQicpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHNjaGVtYTogdHJhbnNmb3JtZWRTY2hlbWEsXG4gICAgICAgIGZ1bmN0aW9uU2xvdHMsXG4gICAgICAgIGRhdGFTb3VyY2VTdHJhdGVnaWVzOiBnZW5lcmF0ZWRNb2RlbERhdGFTb3VyY2VTdHJhdGVnaWVzLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc2NoZW1hOiB0cmFuc2Zvcm1lZFNjaGVtYSxcbiAgICAgIGZ1bmN0aW9uU2xvdHMsXG4gICAgICBkYXRhU291cmNlU3RyYXRlZ2llczogZ2VuZXJhdGVkTW9kZWxEYXRhU291cmNlU3RyYXRlZ2llcyxcbiAgICAgIGN1c3RvbVNxbERhdGFTb3VyY2VTdHJhdGVnaWVzOlxuICAgICAgICBjdXN0b21TcWxEYXRhU291cmNlU3RyYXRlZ2llcz8ubWFwKFxuICAgICAgICAgIChleGlzdGluZzogQ3VzdG9tU3FsRGF0YVNvdXJjZVN0cmF0ZWd5KSA9PiAoe1xuICAgICAgICAgICAgLi4uZXhpc3RpbmcsXG4gICAgICAgICAgICBzdHJhdGVneTogZGJTdHJhdGVneSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKSB8fCBbXSxcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIEFtcGxpZnlEYXRhRGVmaW5pdGlvbi5mcm9tU3RyaW5nKHNjaGVtYSwgRFlOQU1PX0RBVEFfU09VUkNFX1NUUkFURUdZKTtcbn07XG5cbi8qKlxuICogR2l2ZW4gYW4gaW5wdXQgbGlzdCBvZiBDREsgR3JhcGhxbCBEZWYgaW50ZXJmYWNlIHNjaGVtYXMsIHByb2R1Y2UgdGhlIHJlbGV2YW50IENESyBHcmFwaHFsIERlZiBpbnRlcmZhY2VcbiAqIEBwYXJhbSBzY2hlbWFzIHRoZSBjZGsgZ3JhcGhxbCBkZWZpbml0aW9uIGludGVyZmFjZXMgdG8gY29tYmluZVxuICogQHJldHVybnMgdGhlIGNkayBncmFwaHFsIGRlZmluaXRpb24gaW50ZXJmYWNlXG4gKi9cbmV4cG9ydCBjb25zdCBjb21iaW5lQ0RLU2NoZW1hcyA9IChcbiAgc2NoZW1hczogSUFtcGxpZnlEYXRhRGVmaW5pdGlvbltdLFxuKTogSUFtcGxpZnlEYXRhRGVmaW5pdGlvbiA9PiB7XG4gIHJldHVybiBBbXBsaWZ5RGF0YURlZmluaXRpb24uY29tYmluZShzY2hlbWFzKTtcbn07XG5cbi8qKlxuICogR2l2ZW4gdGhlIGdlbmVyYXRlZCByZHMgYnVpbGRlciBkYXRhYmFzZSBjb25maWd1cmF0aW9uLCBjb252ZXJ0IGl0IGludG8gdGhlIERhdGFTb3VyY2Ugc3RyYXRlZ3lcbiAqIEBwYXJhbSBjb25maWd1cmF0aW9uIHRoZSBkYXRhYmFzZSBjb25maWd1cmF0aW9uIGZyb20gYGRhdGEtc2NoZW1hYFxuICogQHJldHVybnMgdGhlIGRhdGEgc3RyYXRlZ3kgbmVlZGVkIHRvIGNvbmZpZ3VyZSB0aGUgZGF0YSBzb3VyY2VcbiAqL1xuY29uc3QgY29udmVydERhdGFiYXNlQ29uZmlndXJhdGlvblRvRGF0YVNvdXJjZVN0cmF0ZWd5ID0gKFxuICBjb25maWd1cmF0aW9uOiBEYXRhU291cmNlQ29uZmlndXJhdGlvbixcbiAgY3VzdG9tU3FsRGF0YVNvdXJjZVN0cmF0ZWdpZXM6IEN1c3RvbVNxbERhdGFTb3VyY2VTdHJhdGVneVtdID0gW10sXG4gIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBwcm92aXNpb25TdHJhdGVneU5hbWU6IHN0cmluZyxcbik6IE1vZGVsRGF0YVNvdXJjZVN0cmF0ZWd5ID0+IHtcbiAgaWYgKGNvbmZpZ3VyYXRpb24uZW5naW5lID09PSAnZHluYW1vZGInKSB7XG4gICAgcmV0dXJuIERZTkFNT19EQVRBX1NPVVJDRV9TVFJBVEVHWTtcbiAgfVxuXG4gIGNvbnN0IGRiVHlwZSA9IFNRTF9EQl9UWVBFU1tjb25maWd1cmF0aW9uLmVuZ2luZV07XG4gIGxldCB2cGNDb25maWd1cmF0aW9uOiBWcGNDb25maWcgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG5cbiAgaWYgKGNvbmZpZ3VyYXRpb24udnBjQ29uZmlnICE9PSB1bmRlZmluZWQpIHtcbiAgICB2cGNDb25maWd1cmF0aW9uID0ge1xuICAgICAgdnBjSWQ6IGNvbmZpZ3VyYXRpb24udnBjQ29uZmlnLnZwY0lkLFxuICAgICAgc2VjdXJpdHlHcm91cElkczogY29uZmlndXJhdGlvbi52cGNDb25maWcuc2VjdXJpdHlHcm91cElkcyxcbiAgICAgIHN1Ym5ldEF2YWlsYWJpbGl0eVpvbmVDb25maWc6XG4gICAgICAgIGNvbmZpZ3VyYXRpb24udnBjQ29uZmlnLnN1Ym5ldEF2YWlsYWJpbGl0eVpvbmVzLFxuICAgIH07XG4gIH1cblxuICBjb25zdCBjdXN0b21TcWxTdGF0ZW1lbnRzID0gY3VzdG9tU3FsU3RhdGVtZW50c0Zyb21TdHJhdGVnaWVzKFxuICAgIGN1c3RvbVNxbERhdGFTb3VyY2VTdHJhdGVnaWVzLFxuICApO1xuXG4gIGNvbnN0IHsgYnJhbmNoU2VjcmV0UGF0aCwgc2hhcmVkU2VjcmV0UGF0aCB9ID1cbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVBhdGgoY29uZmlndXJhdGlvbi5jb25uZWN0aW9uVXJpKTtcblxuICBsZXQgc3NsQ2VydENvbmZpZzogU3NsQ2VydFNzbVBhdGhDb25maWcgfCB1bmRlZmluZWQ7XG4gIGlmIChjb25maWd1cmF0aW9uLnNzbENlcnQpIHtcbiAgICBjb25zdCB7IGJyYW5jaFNlY3JldFBhdGgsIHNoYXJlZFNlY3JldFBhdGggfSA9XG4gICAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVBhdGgoY29uZmlndXJhdGlvbi5zc2xDZXJ0KTtcbiAgICBzc2xDZXJ0Q29uZmlnID0ge1xuICAgICAgc3NtUGF0aDogW2JyYW5jaFNlY3JldFBhdGgsIHNoYXJlZFNlY3JldFBhdGhdLFxuICAgIH07XG4gIH1cbiAgY29uc3Qgc3RyYXRlZ3k6IE1vZGVsRGF0YVNvdXJjZVN0cmF0ZWd5ID0ge1xuICAgIGRiVHlwZSxcbiAgICBuYW1lOlxuICAgICAgcHJvdmlzaW9uU3RyYXRlZ3lOYW1lICtcbiAgICAgIChjb25maWd1cmF0aW9uLmlkZW50aWZpZXIgPz8gY29uZmlndXJhdGlvbi5lbmdpbmUpLFxuICAgIGRiQ29ubmVjdGlvbkNvbmZpZzoge1xuICAgICAgY29ubmVjdGlvblVyaVNzbVBhdGg6IFticmFuY2hTZWNyZXRQYXRoLCBzaGFyZWRTZWNyZXRQYXRoXSxcbiAgICAgIC4uLihzc2xDZXJ0Q29uZmlnID8geyBzc2xDZXJ0Q29uZmlnIH0gOiB1bmRlZmluZWQpLFxuICAgIH0sXG4gICAgdnBjQ29uZmlndXJhdGlvbixcbiAgICBjdXN0b21TcWxTdGF0ZW1lbnRzLFxuICB9O1xuXG4gIHJldHVybiBzdHJhdGVneTtcbn07XG5cbi8qKlxuICogQ3JlYXRlIGEgY3VzdG9tIHNxbCBzdGF0ZW1lbnQgcmVmZXJlbmNlIGRpY3Rpb25hcnlcbiAqIEBwYXJhbSBjdXN0b21TcWxEYXRhU291cmNlU3RyYXRlZ2llcyBjdXN0b20gc3FsIGhhbmRsZXIgZGVmaW5lZCBpbiB0aGUgc2NoZW1hXG4gKiBAcmV0dXJucyBhbiBvYmplY3QgbWFwcGluZyB0aGUgZmlsZSBwYXRoIHRvIHRoZSBzcWwgc3RhdGVtZW50XG4gKi9cbmNvbnN0IGN1c3RvbVNxbFN0YXRlbWVudHNGcm9tU3RyYXRlZ2llcyA9IChcbiAgY3VzdG9tU3FsRGF0YVNvdXJjZVN0cmF0ZWdpZXM6IEN1c3RvbVNxbERhdGFTb3VyY2VTdHJhdGVneVtdLFxuKTogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9PiB7XG4gIGNvbnN0IGN1c3RvbVNxbFN0YXRlbWVudHMgPSBjdXN0b21TcWxEYXRhU291cmNlU3RyYXRlZ2llc1xuICAgIC5maWx0ZXIoKHNxbFN0cmF0ZWd5KSA9PiBzcWxTdHJhdGVneS5lbnRyeSAhPT0gdW5kZWZpbmVkKVxuICAgIC5yZWR1Y2UoXG4gICAgICAoYWNjLCBzcWxTdHJhdGVneSkgPT4ge1xuICAgICAgICBjb25zdCBlbnRyeSA9IHNxbFN0cmF0ZWd5LmVudHJ5ITtcbiAgICAgICAgY29uc3QgcmVmZXJlbmNlID1cbiAgICAgICAgICB0eXBlb2YgZW50cnkgPT09ICdzdHJpbmcnID8gZW50cnkgOiBlbnRyeS5yZWxhdGl2ZVBhdGg7XG4gICAgICAgIGNvbnN0IHJlc29sdmVkUGF0aCA9IHJlc29sdmVFbnRyeVBhdGgoZW50cnkpO1xuXG4gICAgICAgIGFjY1tyZWZlcmVuY2VdID0gcmVhZEZpbGVTeW5jKHJlc29sdmVkUGF0aCwgJ3V0ZjgnKTtcbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sXG4gICAgICB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LFxuICAgICk7XG5cbiAgcmV0dXJuIGN1c3RvbVNxbFN0YXRlbWVudHM7XG59O1xuIl19