import { CfnFunctionConfiguration, CfnResolver } from 'aws-cdk-lib/aws-appsync';
import { resolve } from 'path';
import { fileURLToPath } from 'node:url';
import { readFileSync } from 'fs';
import { Asset } from 'aws-cdk-lib/aws-s3-assets';
import { resolveEntryPath } from './resolve_entry_path.js';
const APPSYNC_PIPELINE_RESOLVER = 'PIPELINE';
const APPSYNC_JS_RUNTIME_NAME = 'APPSYNC_JS';
const APPSYNC_JS_RUNTIME_VERSION = '1.0.0';
const JS_PIPELINE_RESOLVER_HANDLER = './assets/js_resolver_handler.js';
/**
 *
 * This returns the top-level passthrough resolver request/response handler (see: https://docs.aws.amazon.com/appsync/latest/devguide/resolver-reference-overview-js.html#anatomy-of-a-pipeline-resolver-js)
 * It's required for defining a pipeline resolver. The only purpose it serves is returning the output of the last function in the pipeline back to the client.
 *
 * Customer-provided handlers are added as a Functions list in `pipelineConfig.functions`
 *
 * Add Amplify API ID and environment name to the context stash for use in the customer-provided handlers.
 */
export const defaultJsResolverCode = (amplifyApiId, amplifyApiEnvironmentName) => {
    const resolvedTemplatePath = resolve(fileURLToPath(import.meta.url), '../../lib', JS_PIPELINE_RESOLVER_HANDLER);
    return readFileSync(resolvedTemplatePath, 'utf-8')
        .replace(new RegExp(/\$\{amplifyApiId\}/, 'g'), amplifyApiId)
        .replace(new RegExp(/\$\{amplifyApiEnvironmentName\}/, 'g'), amplifyApiEnvironmentName);
};
/**
 * Converts JS Resolver definition emitted by data-schema into AppSync pipeline
 * resolvers via L1 construct
 */
export const convertJsResolverDefinition = (scope, amplifyApi, jsResolvers) => {
    if (!jsResolvers || jsResolvers.length < 1) {
        return;
    }
    for (const resolver of jsResolvers) {
        const functions = resolver.handlers.map((handler, idx) => {
            const fnName = `Fn_${resolver.typeName}_${resolver.fieldName}_${idx + 1}`;
            const s3AssetName = `${fnName}_asset`;
            const asset = new Asset(scope, s3AssetName, {
                path: resolveEntryPath(handler.entry),
            });
            const fn = new CfnFunctionConfiguration(scope, fnName, {
                apiId: amplifyApi.apiId,
                dataSourceName: handler.dataSource,
                name: fnName,
                codeS3Location: asset.s3ObjectUrl,
                runtime: {
                    name: APPSYNC_JS_RUNTIME_NAME,
                    runtimeVersion: APPSYNC_JS_RUNTIME_VERSION,
                },
            });
            fn.node.addDependency(amplifyApi);
            return fn.attrFunctionId;
        });
        const resolverName = `Resolver_${resolver.typeName}_${resolver.fieldName}`;
        const amplifyApiEnvironmentName = scope.node.tryGetContext('amplifyEnvironmentName') ?? 'NONE';
        new CfnResolver(scope, resolverName, {
            apiId: amplifyApi.apiId,
            fieldName: resolver.fieldName,
            typeName: resolver.typeName,
            kind: APPSYNC_PIPELINE_RESOLVER,
            // Uses synth-time inline code to avoid circular dependency when adding the API ID as an environment variable.
            code: defaultJsResolverCode(amplifyApi.apiId, amplifyApiEnvironmentName),
            runtime: {
                name: APPSYNC_JS_RUNTIME_NAME,
                runtimeVersion: APPSYNC_JS_RUNTIME_VERSION,
            },
            pipelineConfig: {
                functions,
            },
        }).node.addDependency(amplifyApi);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydF9qc19yZXNvbHZlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY29udmVydF9qc19yZXNvbHZlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLHdCQUF3QixFQUFFLFdBQVcsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRWhGLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN6QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUUzRCxNQUFNLHlCQUF5QixHQUFHLFVBQVUsQ0FBQztBQUM3QyxNQUFNLHVCQUF1QixHQUFHLFlBQVksQ0FBQztBQUM3QyxNQUFNLDBCQUEwQixHQUFHLE9BQU8sQ0FBQztBQUMzQyxNQUFNLDRCQUE0QixHQUFHLGlDQUFpQyxDQUFDO0FBRXZFOzs7Ozs7OztHQVFHO0FBQ0gsTUFBTSxDQUFDLE1BQU0scUJBQXFCLEdBQUcsQ0FDbkMsWUFBb0IsRUFDcEIseUJBQWlDLEVBQ3pCLEVBQUU7SUFDVixNQUFNLG9CQUFvQixHQUFHLE9BQU8sQ0FDbEMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQzlCLFdBQVcsRUFDWCw0QkFBNEIsQ0FDN0IsQ0FBQztJQUVGLE9BQU8sWUFBWSxDQUFDLG9CQUFvQixFQUFFLE9BQU8sQ0FBQztTQUMvQyxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxDQUFDLEVBQUUsWUFBWSxDQUFDO1NBQzVELE9BQU8sQ0FDTixJQUFJLE1BQU0sQ0FBQyxpQ0FBaUMsRUFBRSxHQUFHLENBQUMsRUFDbEQseUJBQXlCLENBQzFCLENBQUM7QUFDTixDQUFDLENBQUM7QUFFRjs7O0dBR0c7QUFDSCxNQUFNLENBQUMsTUFBTSwyQkFBMkIsR0FBRyxDQUN6QyxLQUFnQixFQUNoQixVQUF1QixFQUN2QixXQUFxQyxFQUMvQixFQUFFO0lBQ1IsSUFBSSxDQUFDLFdBQVcsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtRQUMxQyxPQUFPO0tBQ1I7SUFFRCxLQUFLLE1BQU0sUUFBUSxJQUFJLFdBQVcsRUFBRTtRQUNsQyxNQUFNLFNBQVMsR0FBYSxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUNqRSxNQUFNLE1BQU0sR0FBRyxNQUFNLFFBQVEsQ0FBQyxRQUFRLElBQUksUUFBUSxDQUFDLFNBQVMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDMUUsTUFBTSxXQUFXLEdBQUcsR0FBRyxNQUFNLFFBQVEsQ0FBQztZQUV0QyxNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFO2dCQUMxQyxJQUFJLEVBQUUsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQzthQUN0QyxDQUFDLENBQUM7WUFFSCxNQUFNLEVBQUUsR0FBRyxJQUFJLHdCQUF3QixDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUU7Z0JBQ3JELEtBQUssRUFBRSxVQUFVLENBQUMsS0FBSztnQkFDdkIsY0FBYyxFQUFFLE9BQU8sQ0FBQyxVQUFVO2dCQUNsQyxJQUFJLEVBQUUsTUFBTTtnQkFDWixjQUFjLEVBQUUsS0FBSyxDQUFDLFdBQVc7Z0JBQ2pDLE9BQU8sRUFBRTtvQkFDUCxJQUFJLEVBQUUsdUJBQXVCO29CQUM3QixjQUFjLEVBQUUsMEJBQTBCO2lCQUMzQzthQUNGLENBQUMsQ0FBQztZQUNILEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2xDLE9BQU8sRUFBRSxDQUFDLGNBQWMsQ0FBQztRQUMzQixDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sWUFBWSxHQUFHLFlBQVksUUFBUSxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsU0FBUyxFQUFFLENBQUM7UUFFM0UsTUFBTSx5QkFBeUIsR0FDN0IsS0FBSyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsd0JBQXdCLENBQUMsSUFBSSxNQUFNLENBQUM7UUFDL0QsSUFBSSxXQUFXLENBQUMsS0FBSyxFQUFFLFlBQVksRUFBRTtZQUNuQyxLQUFLLEVBQUUsVUFBVSxDQUFDLEtBQUs7WUFDdkIsU0FBUyxFQUFFLFFBQVEsQ0FBQyxTQUFTO1lBQzdCLFFBQVEsRUFBRSxRQUFRLENBQUMsUUFBUTtZQUMzQixJQUFJLEVBQUUseUJBQXlCO1lBQy9CLDhHQUE4RztZQUM5RyxJQUFJLEVBQUUscUJBQXFCLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSx5QkFBeUIsQ0FBQztZQUN4RSxPQUFPLEVBQUU7Z0JBQ1AsSUFBSSxFQUFFLHVCQUF1QjtnQkFDN0IsY0FBYyxFQUFFLDBCQUEwQjthQUMzQztZQUNELGNBQWMsRUFBRTtnQkFDZCxTQUFTO2FBQ1Y7U0FDRixDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztLQUNuQztBQUNILENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgQW1wbGlmeURhdGEgfSBmcm9tICdAYXdzLWFtcGxpZnkvZGF0YS1jb25zdHJ1Y3QnO1xuaW1wb3J0IHsgQ2ZuRnVuY3Rpb25Db25maWd1cmF0aW9uLCBDZm5SZXNvbHZlciB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcHBzeW5jJztcbmltcG9ydCB7IEpzUmVzb2x2ZXIgfSBmcm9tICdAYXdzLWFtcGxpZnkvZGF0YS1zY2hlbWEtdHlwZXMnO1xuaW1wb3J0IHsgcmVzb2x2ZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZmlsZVVSTFRvUGF0aCB9IGZyb20gJ25vZGU6dXJsJztcbmltcG9ydCB7IHJlYWRGaWxlU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IEFzc2V0IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLXMzLWFzc2V0cyc7XG5pbXBvcnQgeyByZXNvbHZlRW50cnlQYXRoIH0gZnJvbSAnLi9yZXNvbHZlX2VudHJ5X3BhdGguanMnO1xuXG5jb25zdCBBUFBTWU5DX1BJUEVMSU5FX1JFU09MVkVSID0gJ1BJUEVMSU5FJztcbmNvbnN0IEFQUFNZTkNfSlNfUlVOVElNRV9OQU1FID0gJ0FQUFNZTkNfSlMnO1xuY29uc3QgQVBQU1lOQ19KU19SVU5USU1FX1ZFUlNJT04gPSAnMS4wLjAnO1xuY29uc3QgSlNfUElQRUxJTkVfUkVTT0xWRVJfSEFORExFUiA9ICcuL2Fzc2V0cy9qc19yZXNvbHZlcl9oYW5kbGVyLmpzJztcblxuLyoqXG4gKlxuICogVGhpcyByZXR1cm5zIHRoZSB0b3AtbGV2ZWwgcGFzc3Rocm91Z2ggcmVzb2x2ZXIgcmVxdWVzdC9yZXNwb25zZSBoYW5kbGVyIChzZWU6IGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9hcHBzeW5jL2xhdGVzdC9kZXZndWlkZS9yZXNvbHZlci1yZWZlcmVuY2Utb3ZlcnZpZXctanMuaHRtbCNhbmF0b215LW9mLWEtcGlwZWxpbmUtcmVzb2x2ZXItanMpXG4gKiBJdCdzIHJlcXVpcmVkIGZvciBkZWZpbmluZyBhIHBpcGVsaW5lIHJlc29sdmVyLiBUaGUgb25seSBwdXJwb3NlIGl0IHNlcnZlcyBpcyByZXR1cm5pbmcgdGhlIG91dHB1dCBvZiB0aGUgbGFzdCBmdW5jdGlvbiBpbiB0aGUgcGlwZWxpbmUgYmFjayB0byB0aGUgY2xpZW50LlxuICpcbiAqIEN1c3RvbWVyLXByb3ZpZGVkIGhhbmRsZXJzIGFyZSBhZGRlZCBhcyBhIEZ1bmN0aW9ucyBsaXN0IGluIGBwaXBlbGluZUNvbmZpZy5mdW5jdGlvbnNgXG4gKlxuICogQWRkIEFtcGxpZnkgQVBJIElEIGFuZCBlbnZpcm9ubWVudCBuYW1lIHRvIHRoZSBjb250ZXh0IHN0YXNoIGZvciB1c2UgaW4gdGhlIGN1c3RvbWVyLXByb3ZpZGVkIGhhbmRsZXJzLlxuICovXG5leHBvcnQgY29uc3QgZGVmYXVsdEpzUmVzb2x2ZXJDb2RlID0gKFxuICBhbXBsaWZ5QXBpSWQ6IHN0cmluZyxcbiAgYW1wbGlmeUFwaUVudmlyb25tZW50TmFtZTogc3RyaW5nLFxuKTogc3RyaW5nID0+IHtcbiAgY29uc3QgcmVzb2x2ZWRUZW1wbGF0ZVBhdGggPSByZXNvbHZlKFxuICAgIGZpbGVVUkxUb1BhdGgoaW1wb3J0Lm1ldGEudXJsKSxcbiAgICAnLi4vLi4vbGliJyxcbiAgICBKU19QSVBFTElORV9SRVNPTFZFUl9IQU5ETEVSLFxuICApO1xuXG4gIHJldHVybiByZWFkRmlsZVN5bmMocmVzb2x2ZWRUZW1wbGF0ZVBhdGgsICd1dGYtOCcpXG4gICAgLnJlcGxhY2UobmV3IFJlZ0V4cCgvXFwkXFx7YW1wbGlmeUFwaUlkXFx9LywgJ2cnKSwgYW1wbGlmeUFwaUlkKVxuICAgIC5yZXBsYWNlKFxuICAgICAgbmV3IFJlZ0V4cCgvXFwkXFx7YW1wbGlmeUFwaUVudmlyb25tZW50TmFtZVxcfS8sICdnJyksXG4gICAgICBhbXBsaWZ5QXBpRW52aXJvbm1lbnROYW1lLFxuICAgICk7XG59O1xuXG4vKipcbiAqIENvbnZlcnRzIEpTIFJlc29sdmVyIGRlZmluaXRpb24gZW1pdHRlZCBieSBkYXRhLXNjaGVtYSBpbnRvIEFwcFN5bmMgcGlwZWxpbmVcbiAqIHJlc29sdmVycyB2aWEgTDEgY29uc3RydWN0XG4gKi9cbmV4cG9ydCBjb25zdCBjb252ZXJ0SnNSZXNvbHZlckRlZmluaXRpb24gPSAoXG4gIHNjb3BlOiBDb25zdHJ1Y3QsXG4gIGFtcGxpZnlBcGk6IEFtcGxpZnlEYXRhLFxuICBqc1Jlc29sdmVyczogSnNSZXNvbHZlcltdIHwgdW5kZWZpbmVkLFxuKTogdm9pZCA9PiB7XG4gIGlmICghanNSZXNvbHZlcnMgfHwganNSZXNvbHZlcnMubGVuZ3RoIDwgMSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGZvciAoY29uc3QgcmVzb2x2ZXIgb2YganNSZXNvbHZlcnMpIHtcbiAgICBjb25zdCBmdW5jdGlvbnM6IHN0cmluZ1tdID0gcmVzb2x2ZXIuaGFuZGxlcnMubWFwKChoYW5kbGVyLCBpZHgpID0+IHtcbiAgICAgIGNvbnN0IGZuTmFtZSA9IGBGbl8ke3Jlc29sdmVyLnR5cGVOYW1lfV8ke3Jlc29sdmVyLmZpZWxkTmFtZX1fJHtpZHggKyAxfWA7XG4gICAgICBjb25zdCBzM0Fzc2V0TmFtZSA9IGAke2ZuTmFtZX1fYXNzZXRgO1xuXG4gICAgICBjb25zdCBhc3NldCA9IG5ldyBBc3NldChzY29wZSwgczNBc3NldE5hbWUsIHtcbiAgICAgICAgcGF0aDogcmVzb2x2ZUVudHJ5UGF0aChoYW5kbGVyLmVudHJ5KSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBmbiA9IG5ldyBDZm5GdW5jdGlvbkNvbmZpZ3VyYXRpb24oc2NvcGUsIGZuTmFtZSwge1xuICAgICAgICBhcGlJZDogYW1wbGlmeUFwaS5hcGlJZCxcbiAgICAgICAgZGF0YVNvdXJjZU5hbWU6IGhhbmRsZXIuZGF0YVNvdXJjZSxcbiAgICAgICAgbmFtZTogZm5OYW1lLFxuICAgICAgICBjb2RlUzNMb2NhdGlvbjogYXNzZXQuczNPYmplY3RVcmwsXG4gICAgICAgIHJ1bnRpbWU6IHtcbiAgICAgICAgICBuYW1lOiBBUFBTWU5DX0pTX1JVTlRJTUVfTkFNRSxcbiAgICAgICAgICBydW50aW1lVmVyc2lvbjogQVBQU1lOQ19KU19SVU5USU1FX1ZFUlNJT04sXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICAgIGZuLm5vZGUuYWRkRGVwZW5kZW5jeShhbXBsaWZ5QXBpKTtcbiAgICAgIHJldHVybiBmbi5hdHRyRnVuY3Rpb25JZDtcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc29sdmVyTmFtZSA9IGBSZXNvbHZlcl8ke3Jlc29sdmVyLnR5cGVOYW1lfV8ke3Jlc29sdmVyLmZpZWxkTmFtZX1gO1xuXG4gICAgY29uc3QgYW1wbGlmeUFwaUVudmlyb25tZW50TmFtZSA9XG4gICAgICBzY29wZS5ub2RlLnRyeUdldENvbnRleHQoJ2FtcGxpZnlFbnZpcm9ubWVudE5hbWUnKSA/PyAnTk9ORSc7XG4gICAgbmV3IENmblJlc29sdmVyKHNjb3BlLCByZXNvbHZlck5hbWUsIHtcbiAgICAgIGFwaUlkOiBhbXBsaWZ5QXBpLmFwaUlkLFxuICAgICAgZmllbGROYW1lOiByZXNvbHZlci5maWVsZE5hbWUsXG4gICAgICB0eXBlTmFtZTogcmVzb2x2ZXIudHlwZU5hbWUsXG4gICAgICBraW5kOiBBUFBTWU5DX1BJUEVMSU5FX1JFU09MVkVSLFxuICAgICAgLy8gVXNlcyBzeW50aC10aW1lIGlubGluZSBjb2RlIHRvIGF2b2lkIGNpcmN1bGFyIGRlcGVuZGVuY3kgd2hlbiBhZGRpbmcgdGhlIEFQSSBJRCBhcyBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZS5cbiAgICAgIGNvZGU6IGRlZmF1bHRKc1Jlc29sdmVyQ29kZShhbXBsaWZ5QXBpLmFwaUlkLCBhbXBsaWZ5QXBpRW52aXJvbm1lbnROYW1lKSxcbiAgICAgIHJ1bnRpbWU6IHtcbiAgICAgICAgbmFtZTogQVBQU1lOQ19KU19SVU5USU1FX05BTUUsXG4gICAgICAgIHJ1bnRpbWVWZXJzaW9uOiBBUFBTWU5DX0pTX1JVTlRJTUVfVkVSU0lPTixcbiAgICAgIH0sXG4gICAgICBwaXBlbGluZUNvbmZpZzoge1xuICAgICAgICBmdW5jdGlvbnMsXG4gICAgICB9LFxuICAgIH0pLm5vZGUuYWRkRGVwZW5kZW5jeShhbXBsaWZ5QXBpKTtcbiAgfVxufTtcbiJdfQ==