import { Duration } from 'aws-cdk-lib';
import { AmplifyUserError } from '@aws-amplify/platform-core';
const DEFAULT_API_KEY_EXPIRATION_DAYS = 7;
const DEFAULT_LAMBDA_AUTH_TIME_TO_LIVE_SECONDS = 60;
/**
 * Function instance provider which uses the
 */
export const buildConstructFactoryProvidedAuthConfig = (authResourceProvider) => {
    if (!authResourceProvider)
        return;
    return {
        userPool: authResourceProvider.resources.userPool,
        identityPoolId: authResourceProvider.resources.identityPoolId,
        authenticatedUserRole: authResourceProvider.resources.authenticatedUserIamRole,
        unauthenticatedUserRole: authResourceProvider.resources.unauthenticatedUserIamRole,
    };
};
/**
 * Convert to CDK ApiKeyAuthorizationConfig.
 */
const convertApiKeyAuthConfigToCDK = ({ description, expiresInDays = DEFAULT_API_KEY_EXPIRATION_DAYS, } = {}) => ({
    description,
    expires: Duration.days(expiresInDays),
});
/**
 * Convert to CDK LambdaAuthorizationConfig.
 */
const convertLambdaAuthorizationConfigToCDK = (getInstanceProps, { function: authFn, timeToLiveInSeconds = DEFAULT_LAMBDA_AUTH_TIME_TO_LIVE_SECONDS, }) => ({
    function: authFn.getInstance(getInstanceProps).resources.lambda,
    ttl: Duration.seconds(timeToLiveInSeconds),
});
/**
 * Convert to CDK OIDCAuthorizationConfig.
 */
const convertOIDCAuthConfigToCDK = ({ oidcProviderName, oidcIssuerUrl, clientId, tokenExpiryFromAuthInSeconds, tokenExpireFromIssueInSeconds, }) => ({
    oidcProviderName,
    oidcIssuerUrl,
    clientId,
    tokenExpiryFromAuth: Duration.seconds(tokenExpiryFromAuthInSeconds),
    tokenExpiryFromIssue: Duration.seconds(tokenExpireFromIssueInSeconds),
});
/**
 * Compute default auth mode based on availability of auth resources.
 *
 * Will default to userPool if userPool is provided and auth resources are not provided.
 *
 * If no auth resources are provided and there's only one mode we'll use that as we implicitly always add iam auth.
 */
const computeDefaultAuthorizationMode = (providedAuthConfig, authModes) => {
    if (isUsingDefaultApiKeyAuth(providedAuthConfig, authModes)) {
        return 'apiKey';
    }
    else if (providedAuthConfig && !authModes) {
        return 'userPool';
    }
    else if (!providedAuthConfig &&
        authModes &&
        Object.keys(authModes).length === 1) {
        if (authModes.oidcAuthorizationMode) {
            return 'oidc';
        }
        else if (authModes.lambdaAuthorizationMode) {
            return 'lambda';
        }
        else if (authModes.apiKeyAuthorizationMode) {
            return 'apiKey';
        }
    }
    throw new AmplifyUserError('DefineDataConfigurationError', {
        message: 'A defaultAuthorizationMode is required if multiple authorization modes are configured',
        resolution: "When calling 'defineData' specify 'authorizationModes.defaultAuthorizationMode'",
    });
};
/**
 * Compute user pool auth config from auth resource provider.
 * @returns a user pool auth config, if relevant
 */
const computeUserPoolAuthFromResource = (providedAuthConfig) => {
    if (providedAuthConfig) {
        return { userPool: providedAuthConfig.userPool };
    }
    return;
};
/**
 * Compute identity pool auth config from auth resource provider.
 * @returns an iam auth config, if relevant
 */
const computeIdentityPoolAuthFromResource = (providedAuthConfig) => {
    if (providedAuthConfig) {
        return {
            authenticatedUserRole: providedAuthConfig.authenticatedUserRole,
            unauthenticatedUserRole: providedAuthConfig.unauthenticatedUserRole,
            identityPoolId: providedAuthConfig.identityPoolId,
        };
    }
    return;
};
/**
 * Compute api key auth config from auth resource provider.
 * @returns an api key auth config, if relevant
 */
const computeApiKeyAuthFromResource = (providedAuthConfig, authModes) => {
    if (isUsingDefaultApiKeyAuth(providedAuthConfig, authModes)) {
        return {
            expires: Duration.days(DEFAULT_API_KEY_EXPIRATION_DAYS),
        };
    }
    return;
};
const authorizationModeMapping = {
    iam: 'AWS_IAM',
    identityPool: 'AWS_IAM',
    userPool: 'AMAZON_COGNITO_USER_POOLS',
    oidc: 'OPENID_CONNECT',
    apiKey: 'API_KEY',
    lambda: 'AWS_LAMBDA',
};
const convertAuthorizationModeToCDK = (mode) => {
    if (!mode)
        return;
    return authorizationModeMapping[mode];
};
/**
 * Convert to CDK AuthorizationModes.
 */
export const convertAuthorizationModesToCDK = (getInstanceProps, authResources, authModes) => {
    const defaultAuthorizationMode = authModes?.defaultAuthorizationMode ??
        computeDefaultAuthorizationMode(authResources, authModes);
    const cdkAuthorizationMode = convertAuthorizationModeToCDK(defaultAuthorizationMode);
    const apiKeyConfig = authModes?.apiKeyAuthorizationMode ||
        // If default auth mode is apiKey, don't require apiKeyAuthorizationMode to be defined
        defaultAuthorizationMode === 'apiKey'
        ? convertApiKeyAuthConfigToCDK(authModes?.apiKeyAuthorizationMode)
        : computeApiKeyAuthFromResource(authResources, authModes);
    const userPoolConfig = computeUserPoolAuthFromResource(authResources);
    const identityPoolConfig = computeIdentityPoolAuthFromResource(authResources);
    const lambdaConfig = authModes?.lambdaAuthorizationMode
        ? convertLambdaAuthorizationConfigToCDK(getInstanceProps, authModes.lambdaAuthorizationMode)
        : undefined;
    const oidcConfig = authModes?.oidcAuthorizationMode
        ? convertOIDCAuthConfigToCDK(authModes.oidcAuthorizationMode)
        : undefined;
    return {
        ...(cdkAuthorizationMode
            ? { defaultAuthorizationMode: cdkAuthorizationMode }
            : undefined),
        ...(apiKeyConfig ? { apiKeyConfig } : undefined),
        ...(userPoolConfig ? { userPoolConfig } : undefined),
        ...(identityPoolConfig ? { identityPoolConfig } : undefined),
        ...(lambdaConfig ? { lambdaConfig } : undefined),
        ...(oidcConfig ? { oidcConfig } : undefined),
        iamConfig: {
            enableIamAuthorizationMode: true,
        },
    };
};
/**
 * Return whether or not the api will use default API_KEY auth due to absence of auth resources and input auth-modes.
 * @param authResources the generated auth resources in the system
 * @param authModes the provided auth modes
 * @returns a boolean indicating whether or not default api key auth will be used.
 */
export const isUsingDefaultApiKeyAuth = (authResources, authModes) => {
    return authModes === undefined && authResources === undefined;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydF9hdXRob3JpemF0aW9uX21vZGVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbnZlcnRfYXV0aG9yaXphdGlvbl9tb2Rlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBeUJ2QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUU5RCxNQUFNLCtCQUErQixHQUFHLENBQUMsQ0FBQztBQUMxQyxNQUFNLHdDQUF3QyxHQUFHLEVBQUUsQ0FBQztBQVNwRDs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLHVDQUF1QyxHQUFHLENBQ3JELG9CQUVhLEVBQ21CLEVBQUU7SUFDbEMsSUFBSSxDQUFDLG9CQUFvQjtRQUFFLE9BQU87SUFDbEMsT0FBTztRQUNMLFFBQVEsRUFBRSxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsUUFBUTtRQUNqRCxjQUFjLEVBQUUsb0JBQW9CLENBQUMsU0FBUyxDQUFDLGNBQWM7UUFDN0QscUJBQXFCLEVBQ25CLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyx3QkFBd0I7UUFDekQsdUJBQXVCLEVBQ3JCLG9CQUFvQixDQUFDLFNBQVMsQ0FBQywwQkFBMEI7S0FDNUQsQ0FBQztBQUNKLENBQUMsQ0FBQztBQUVGOztHQUVHO0FBQ0gsTUFBTSw0QkFBNEIsR0FBRyxDQUFDLEVBQ3BDLFdBQVcsRUFDWCxhQUFhLEdBQUcsK0JBQStCLE1BQ2YsRUFBRSxFQUFnQyxFQUFFLENBQUMsQ0FBQztJQUN0RSxXQUFXO0lBQ1gsT0FBTyxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDO0NBQ3RDLENBQUMsQ0FBQztBQUVIOztHQUVHO0FBQ0gsTUFBTSxxQ0FBcUMsR0FBRyxDQUM1QyxnQkFBa0QsRUFDbEQsRUFDRSxRQUFRLEVBQUUsTUFBTSxFQUNoQixtQkFBbUIsR0FBRyx3Q0FBd0MsR0FDakMsRUFDRCxFQUFF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QkFBb0I7WUFDdEIsQ0FBQyxDQUFDLEVBQUUsd0JBQXdCLEVBQUUsb0JBQW9CLEVBQUU7WUFDcEQsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUNkLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUNoRCxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDcEQsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxFQUFFLGtCQUFrQixFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUM1RCxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDaEQsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQzVDLFNBQVMsRUFBRTtZQUNULDBCQUEwQixFQUFFLElBQUk7U0FDakM7S0FDRixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUY7Ozs7O0dBS0c7QUFDSCxNQUFNLENBQUMsTUFBTSx3QkFBd0IsR0FBRyxDQUN0QyxhQUE2QyxFQUM3QyxTQUF5QyxFQUNoQyxFQUFFO0lBQ1gsT0FBTyxTQUFTLEtBQUssU0FBUyxJQUFJLGFBQWEsS0FBSyxTQUFTLENBQUM7QUFDaEUsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRHVyYXRpb24gfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBJVXNlclBvb2wgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY29nbml0byc7XG5pbXBvcnQgeyBJUm9sZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHtcbiAgQXBpS2V5QXV0aG9yaXphdGlvbkNvbmZpZyBhcyBDREtBcGlLZXlBdXRob3JpemF0aW9uQ29uZmlnLFxuICBBdXRob3JpemF0aW9uTW9kZXMgYXMgQ0RLQXV0aG9yaXphdGlvbk1vZGVzLFxuICBJZGVudGl0eVBvb2xBdXRob3JpemF0aW9uQ29uZmlnIGFzIENES0lkZW50aXR5UG9vbEF1dGhvcml6YXRpb25Db25maWcsXG4gIExhbWJkYUF1dGhvcml6YXRpb25Db25maWcgYXMgQ0RLTGFtYmRhQXV0aG9yaXphdGlvbkNvbmZpZyxcbiAgT0lEQ0F1dGhvcml6YXRpb25Db25maWcgYXMgQ0RLT0lEQ0F1dGhvcml6YXRpb25Db25maWcsXG4gIFVzZXJQb29sQXV0aG9yaXphdGlvbkNvbmZpZyBhcyBDREtVc2VyUG9vbEF1dGhvcml6YXRpb25Db25maWcsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9kYXRhLWNvbnN0cnVjdCc7XG5pbXBvcnQge1xuICBBbXBsaWZ5RGF0YUVycm9yLFxuICBBcGlLZXlBdXRob3JpemF0aW9uTW9kZVByb3BzLFxuICBBdXRob3JpemF0aW9uTW9kZXMsXG4gIERlZmF1bHRBdXRob3JpemF0aW9uTW9kZSxcbiAgTGFtYmRhQXV0aG9yaXphdGlvbk1vZGVQcm9wcyxcbiAgT0lEQ0F1dGhvcml6YXRpb25Nb2RlUHJvcHMsXG59IGZyb20gJy4vdHlwZXMuanMnO1xuaW1wb3J0IHtcbiAgQXV0aFJlc291cmNlcyxcbiAgQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4gIFJlZmVyZW5jZUF1dGhSZXNvdXJjZXMsXG4gIFJlc291cmNlUHJvdmlkZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgQW1wbGlmeVVzZXJFcnJvciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcblxuY29uc3QgREVGQVVMVF9BUElfS0VZX0VYUElSQVRJT05fREFZUyA9IDc7XG5jb25zdCBERUZBVUxUX0xBTUJEQV9BVVRIX1RJTUVfVE9fTElWRV9TRUNPTkRTID0gNjA7XG5cbmV4cG9ydCB0eXBlIFByb3ZpZGVkQXV0aENvbmZpZyA9IHtcbiAgdXNlclBvb2w6IElVc2VyUG9vbDtcbiAgYXV0aGVudGljYXRlZFVzZXJSb2xlOiBJUm9sZTtcbiAgdW5hdXRoZW50aWNhdGVkVXNlclJvbGU6IElSb2xlO1xuICBpZGVudGl0eVBvb2xJZDogc3RyaW5nO1xufTtcblxuLyoqXG4gKiBGdW5jdGlvbiBpbnN0YW5jZSBwcm92aWRlciB3aGljaCB1c2VzIHRoZVxuICovXG5leHBvcnQgY29uc3QgYnVpbGRDb25zdHJ1Y3RGYWN0b3J5UHJvdmlkZWRBdXRoQ29uZmlnID0gKFxuICBhdXRoUmVzb3VyY2VQcm92aWRlcjpcbiAgICB8IFJlc291cmNlUHJvdmlkZXI8QXV0aFJlc291cmNlcyB8IFJlZmVyZW5jZUF1dGhSZXNvdXJjZXM+XG4gICAgfCB1bmRlZmluZWQsXG4pOiBQcm92aWRlZEF1dGhDb25maWcgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoIWF1dGhSZXNvdXJjZVByb3ZpZGVyKSByZXR1cm47XG4gIHJldHVybiB7XG4gICAgdXNlclBvb2w6IGF1dGhSZXNvdXJjZVByb3ZpZGVyLnJlc291cmNlcy51c2VyUG9vbCxcbiAgICBpZGVudGl0eVBvb2xJZDogYXV0aFJlc291cmNlUHJvdmlkZXIucmVzb3VyY2VzLmlkZW50aXR5UG9vbElkLFxuICAgIGF1dGhlbnRpY2F0ZWRVc2VyUm9sZTpcbiAgICAgIGF1dGhSZXNvdXJjZVByb3ZpZGVyLnJlc291cmNlcy5hdXRoZW50aWNhdGVkVXNlcklhbVJvbGUsXG4gICAgdW5hdXRoZW50aWNhdGVkVXNlclJvbGU6XG4gICAgICBhdXRoUmVzb3VyY2VQcm92aWRlci5yZXNvdXJjZXMudW5hdXRoZW50aWNhdGVkVXNlcklhbVJvbGUsXG4gIH07XG59O1xuXG4vKipcbiAqIENvbnZlcnQgdG8gQ0RLIEFwaUtleUF1dGhvcml6YXRpb25Db25maWcuXG4gKi9cbmNvbnN0IGNvbnZlcnRBcGlLZXlBdXRoQ29uZmlnVG9DREsgPSAoe1xuICBkZXNjcmlwdGlvbixcbiAgZXhwaXJlc0luRGF5cyA9IERFRkFVTFRfQVBJX0tFWV9FWFBJUkFUSU9OX0RBWVMsXG59OiBBcGlLZXlBdXRob3JpemF0aW9uTW9kZVByb3BzID0ge30pOiBDREtBcGlLZXlBdXRob3JpemF0aW9uQ29uZmlnID0+ICh7XG4gIGRlc2NyaXB0aW9uLFxuICBleHBpcmVzOiBEdXJhdGlvbi5kYXlzKGV4cGlyZXNJbkRheXMpLFxufSk7XG5cbi8qKlxuICogQ29udmVydCB0byBDREsgTGFtYmRhQXV0aG9yaXphdGlvbkNvbmZpZy5cbiAqL1xuY29uc3QgY29udmVydExhbWJkYUF1dGhvcml6YXRpb25Db25maWdUb0NESyA9IChcbiAgZ2V0SW5zdGFuY2VQcm9wczogQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4gIHtcbiAgICBmdW5jdGlvbjogYXV0aEZuLFxuICAgIHRpbWVUb0xpdmVJblNlY29uZHMgPSBERUZBVUxUX0xBTUJEQV9BVVRIX1RJTUVfVE9fTElWRV9TRUNPTkRTLFxuICB9OiBMYW1iZGFBdXRob3JpemF0aW9uTW9kZVByb3BzLFxuKTogQ0RLTGFtYmRhQXV0aG9yaXphdGlvbkNvbmZpZyA9PiAoe1xuICBmdW5jdGlvbjogYXV0aEZuLmdldEluc3RhbmNlKGdldEluc3RhbmNlUHJvcHMpLnJlc291cmNlcy5sYW1iZGEsXG4gIHR0bDogRHVyYXRpb24uc2Vjb25kcyh0aW1lVG9MaXZlSW5TZWNvbmRzKSxcbn0pO1xuXG4vKipcbiAqIENvbnZlcnQgdG8gQ0RLIE9JRENBdXRob3JpemF0aW9uQ29uZmlnLlxuICovXG5jb25zdCBjb252ZXJ0T0lEQ0F1dGhDb25maWdUb0NESyA9ICh7XG4gIG9pZGNQcm92aWRlck5hbWUsXG4gIG9pZGNJc3N1ZXJVcmwsXG4gIGNsaWVudElkLFxuICB0b2tlbkV4cGlyeUZyb21BdXRoSW5TZWNvbmRzLFxuICB0b2tlbkV4cGlyZUZyb21Jc3N1ZUluU2Vjb25kcyxcbn06IE9JRENBdXRob3JpemF0aW9uTW9kZVByb3BzKTogQ0RLT0lEQ0F1dGhvcml6YXRpb25Db25maWcgPT4gKHtcbiAgb2lkY1Byb3ZpZGVyTmFtZSxcbiAgb2lkY0lzc3VlclVybCxcbiAgY2xpZW50SWQsXG4gIHRva2VuRXhwaXJ5RnJvbUF1dGg6IER1cmF0aW9uLnNlY29uZHModG9rZW5FeHBpcnlGcm9tQXV0aEluU2Vjb25kcyksXG4gIHRva2VuRXhwaXJ5RnJvbUlzc3VlOiBEdXJhdGlvbi5zZWNvbmRzKHRva2VuRXhwaXJlRnJvbUlzc3VlSW5TZWNvbmRzKSxcbn0pO1xuXG4vKipcbiAqIENvbXB1dGUgZGVmYXVsdCBhdXRoIG1vZGUgYmFzZWQgb24gYXZhaWxhYmlsaXR5IG9mIGF1dGggcmVzb3VyY2VzLlxuICpcbiAqIFdpbGwgZGVmYXVsdCB0byB1c2VyUG9vbCBpZiB1c2VyUG9vbCBpcyBwcm92aWRlZCBhbmQgYXV0aCByZXNvdXJjZXMgYXJlIG5vdCBwcm92aWRlZC5cbiAqXG4gKiBJZiBubyBhdXRoIHJlc291cmNlcyBhcmUgcHJvdmlkZWQgYW5kIHRoZXJlJ3Mgb25seSBvbmUgbW9kZSB3ZSdsbCB1c2UgdGhhdCBhcyB3ZSBpbXBsaWNpdGx5IGFsd2F5cyBhZGQgaWFtIGF1dGguXG4gKi9cbmNvbnN0IGNvbXB1dGVEZWZhdWx0QXV0aG9yaXphdGlvbk1vZGUgPSAoXG4gIHByb3ZpZGVkQXV0aENvbmZpZzogUHJvdmlkZWRBdXRoQ29uZmlnIHwgdW5kZWZpbmVkLFxuICBhdXRoTW9kZXM6IEF1dGhvcml6YXRpb25Nb2RlcyB8IHVuZGVmaW5lZCxcbik6IERlZmF1bHRBdXRob3JpemF0aW9uTW9kZSB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmIChpc1VzaW5nRGVmYXVsdEFwaUtleUF1dGgocHJvdmlkZWRBdXRoQ29uZmlnLCBhdXRoTW9kZXMpKSB7XG4gICAgcmV0dXJuICdhcGlLZXknO1xuICB9IGVsc2UgaWYgKHByb3ZpZGVkQXV0aENvbmZpZyAmJiAhYXV0aE1vZGVzKSB7XG4gICAgcmV0dXJuICd1c2VyUG9vbCc7XG4gIH0gZWxzZSBpZiAoXG4gICAgIXByb3ZpZGVkQXV0aENvbmZpZyAmJlxuICAgIGF1dGhNb2RlcyAmJlxuICAgIE9iamVjdC5rZXlzKGF1dGhNb2RlcykubGVuZ3RoID09PSAxXG4gICkge1xuICAgIGlmIChhdXRoTW9kZXMub2lkY0F1dGhvcml6YXRpb25Nb2RlKSB7XG4gICAgICByZXR1cm4gJ29pZGMnO1xuICAgIH0gZWxzZSBpZiAoYXV0aE1vZGVzLmxhbWJkYUF1dGhvcml6YXRpb25Nb2RlKSB7XG4gICAgICByZXR1cm4gJ2xhbWJkYSc7XG4gICAgfSBlbHNlIGlmIChhdXRoTW9kZXMuYXBpS2V5QXV0aG9yaXphdGlvbk1vZGUpIHtcbiAgICAgIHJldHVybiAnYXBpS2V5JztcbiAgICB9XG4gIH1cbiAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3I8QW1wbGlmeURhdGFFcnJvcj4oJ0RlZmluZURhdGFDb25maWd1cmF0aW9uRXJyb3InLCB7XG4gICAgbWVzc2FnZTpcbiAgICAgICdBIGRlZmF1bHRBdXRob3JpemF0aW9uTW9kZSBpcyByZXF1aXJlZCBpZiBtdWx0aXBsZSBhdXRob3JpemF0aW9uIG1vZGVzIGFyZSBjb25maWd1cmVkJyxcbiAgICByZXNvbHV0aW9uOlxuICAgICAgXCJXaGVuIGNhbGxpbmcgJ2RlZmluZURhdGEnIHNwZWNpZnkgJ2F1dGhvcml6YXRpb25Nb2Rlcy5kZWZhdWx0QXV0aG9yaXphdGlvbk1vZGUnXCIsXG4gIH0pO1xufTtcblxuLyoqXG4gKiBDb21wdXRlIHVzZXIgcG9vbCBhdXRoIGNvbmZpZyBmcm9tIGF1dGggcmVzb3VyY2UgcHJvdmlkZXIuXG4gKiBAcmV0dXJucyBhIHVzZXIgcG9vbCBhdXRoIGNvbmZpZywgaWYgcmVsZXZhbnRcbiAqL1xuY29uc3QgY29tcHV0ZVVzZXJQb29sQXV0aEZyb21SZXNvdXJjZSA9IChcbiAgcHJvdmlkZWRBdXRoQ29uZmlnOiBQcm92aWRlZEF1dGhDb25maWcgfCB1bmRlZmluZWQsXG4pOiBDREtVc2VyUG9vbEF1dGhvcml6YXRpb25Db25maWcgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAocHJvdmlkZWRBdXRoQ29uZmlnKSB7XG4gICAgcmV0dXJuIHsgdXNlclBvb2w6IHByb3ZpZGVkQXV0aENvbmZpZy51c2VyUG9vbCB9O1xuICB9XG4gIHJldHVybjtcbn07XG5cbi8qKlxuICogQ29tcHV0ZSBpZGVudGl0eSBwb29sIGF1dGggY29uZmlnIGZyb20gYXV0aCByZXNvdXJjZSBwcm92aWRlci5cbiAqIEByZXR1cm5zIGFuIGlhbSBhdXRoIGNvbmZpZywgaWYgcmVsZXZhbnRcbiAqL1xuY29uc3QgY29tcHV0ZUlkZW50aXR5UG9vbEF1dGhGcm9tUmVzb3VyY2UgPSAoXG4gIHByb3ZpZGVkQXV0aENvbmZpZzogUHJvdmlkZWRBdXRoQ29uZmlnIHwgdW5kZWZpbmVkLFxuKTogQ0RLSWRlbnRpdHlQb29sQXV0aG9yaXphdGlvbkNvbmZpZyB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmIChwcm92aWRlZEF1dGhDb25maWcpIHtcbiAgICByZXR1cm4ge1xuICAgICAgYXV0aGVudGljYXRlZFVzZXJSb2xlOiBwcm92aWRlZEF1dGhDb25maWcuYXV0aGVudGljYXRlZFVzZXJSb2xlLFxuICAgICAgdW5hdXRoZW50aWNhdGVkVXNlclJvbGU6IHByb3ZpZGVkQXV0aENvbmZpZy51bmF1dGhlbnRpY2F0ZWRVc2VyUm9sZSxcbiAgICAgIGlkZW50aXR5UG9vbElkOiBwcm92aWRlZEF1dGhDb25maWcuaWRlbnRpdHlQb29sSWQsXG4gICAgfTtcbiAgfVxuICByZXR1cm47XG59O1xuXG4vKipcbiAqIENvbXB1dGUgYXBpIGtleSBhdXRoIGNvbmZpZyBmcm9tIGF1dGggcmVzb3VyY2UgcHJvdmlkZXIuXG4gKiBAcmV0dXJucyBhbiBhcGkga2V5IGF1dGggY29uZmlnLCBpZiByZWxldmFudFxuICovXG5jb25zdCBjb21wdXRlQXBpS2V5QXV0aEZyb21SZXNvdXJjZSA9IChcbiAgcHJvdmlkZWRBdXRoQ29uZmlnOiBQcm92aWRlZEF1dGhDb25maWcgfCB1bmRlZmluZWQsXG4gIGF1dGhNb2RlczogQXV0aG9yaXphdGlvbk1vZGVzIHwgdW5kZWZpbmVkLFxuKTogQ0RLQXBpS2V5QXV0aG9yaXphdGlvbkNvbmZpZyB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmIChpc1VzaW5nRGVmYXVsdEFwaUtleUF1dGgocHJvdmlkZWRBdXRoQ29uZmlnLCBhdXRoTW9kZXMpKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGV4cGlyZXM6IER1cmF0aW9uLmRheXMoREVGQVVMVF9BUElfS0VZX0VYUElSQVRJT05fREFZUyksXG4gICAgfTtcbiAgfVxuICByZXR1cm47XG59O1xuXG5jb25zdCBhdXRob3JpemF0aW9uTW9kZU1hcHBpbmcgPSB7XG4gIGlhbTogJ0FXU19JQU0nLFxuICBpZGVudGl0eVBvb2w6ICdBV1NfSUFNJyxcbiAgdXNlclBvb2w6ICdBTUFaT05fQ09HTklUT19VU0VSX1BPT0xTJyxcbiAgb2lkYzogJ09QRU5JRF9DT05ORUNUJyxcbiAgYXBpS2V5OiAnQVBJX0tFWScsXG4gIGxhbWJkYTogJ0FXU19MQU1CREEnLFxufSBhcyBjb25zdDtcblxuY29uc3QgY29udmVydEF1dGhvcml6YXRpb25Nb2RlVG9DREsgPSAobW9kZT86IERlZmF1bHRBdXRob3JpemF0aW9uTW9kZSkgPT4ge1xuICBpZiAoIW1vZGUpIHJldHVybjtcblxuICByZXR1cm4gYXV0aG9yaXphdGlvbk1vZGVNYXBwaW5nW21vZGVdO1xufTtcblxuLyoqXG4gKiBDb252ZXJ0IHRvIENESyBBdXRob3JpemF0aW9uTW9kZXMuXG4gKi9cbmV4cG9ydCBjb25zdCBjb252ZXJ0QXV0aG9yaXphdGlvbk1vZGVzVG9DREsgPSAoXG4gIGdldEluc3RhbmNlUHJvcHM6IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICBhdXRoUmVzb3VyY2VzOiBQcm92aWRlZEF1dGhDb25maWcgfCB1bmRlZmluZWQsXG4gIGF1dGhNb2RlczogQXV0aG9yaXphdGlvbk1vZGVzIHwgdW5kZWZpbmVkLFxuKTogQ0RLQXV0aG9yaXphdGlvbk1vZGVzID0+IHtcbiAgY29uc3QgZGVmYXVsdEF1dGhvcml6YXRpb25Nb2RlID1cbiAgICBhdXRoTW9kZXM/LmRlZmF1bHRBdXRob3JpemF0aW9uTW9kZSA/P1xuICAgIGNvbXB1dGVEZWZhdWx0QXV0aG9yaXphdGlvbk1vZGUoYXV0aFJlc291cmNlcywgYXV0aE1vZGVzKTtcbiAgY29uc3QgY2RrQXV0aG9yaXphdGlvbk1vZGUgPSBjb252ZXJ0QXV0aG9yaXphdGlvbk1vZGVUb0NESyhcbiAgICBkZWZhdWx0QXV0aG9yaXphdGlvbk1vZGUsXG4gICk7XG4gIGNvbnN0IGFwaUtleUNvbmZpZyA9XG4gICAgYXV0aE1vZGVzPy5hcGlLZXlBdXRob3JpemF0aW9uTW9kZSB8fFxuICAgIC8vIElmIGRlZmF1bHQgYXV0aCBtb2RlIGlzIGFwaUtleSwgZG9uJ3QgcmVxdWlyZSBhcGlLZXlBdXRob3JpemF0aW9uTW9kZSB0byBiZSBkZWZpbmVkXG4gICAgZGVmYXVsdEF1dGhvcml6YXRpb25Nb2RlID09PSAnYXBpS2V5J1xuICAgICAgPyBjb252ZXJ0QXBpS2V5QXV0aENvbmZpZ1RvQ0RLKGF1dGhNb2Rlcz8uYXBpS2V5QXV0aG9yaXphdGlvbk1vZGUpXG4gICAgICA6IGNvbXB1dGVBcGlLZXlBdXRoRnJvbVJlc291cmNlKGF1dGhSZXNvdXJjZXMsIGF1dGhNb2Rlcyk7XG4gIGNvbnN0IHVzZXJQb29sQ29uZmlnID0gY29tcHV0ZVVzZXJQb29sQXV0aEZyb21SZXNvdXJjZShhdXRoUmVzb3VyY2VzKTtcbiAgY29uc3QgaWRlbnRpdHlQb29sQ29uZmlnID0gY29tcHV0ZUlkZW50aXR5UG9vbEF1dGhGcm9tUmVzb3VyY2UoYXV0aFJlc291cmNlcyk7XG4gIGNvbnN0IGxhbWJkYUNvbmZpZyA9IGF1dGhNb2Rlcz8ubGFtYmRhQXV0aG9yaXphdGlvbk1vZGVcbiAgICA/IGNvbnZlcnRMYW1iZGFBdXRob3JpemF0aW9uQ29uZmlnVG9DREsoXG4gICAgICAgIGdldEluc3RhbmNlUHJvcHMsXG4gICAgICAgIGF1dGhNb2Rlcy5sYW1iZGFBdXRob3JpemF0aW9uTW9kZSxcbiAgICAgIClcbiAgICA6IHVuZGVmaW5lZDtcbiAgY29uc3Qgb2lkY0NvbmZpZyA9IGF1dGhNb2Rlcz8ub2lkY0F1dGhvcml6YXRpb25Nb2RlXG4gICAgPyBjb252ZXJ0T0lEQ0F1dGhDb25maWdUb0NESyhhdXRoTW9kZXMub2lkY0F1dGhvcml6YXRpb25Nb2RlKVxuICAgIDogdW5kZWZpbmVkO1xuXG4gIHJldHVybiB7XG4gICAgLi4uKGNka0F1dGhvcml6YXRpb25Nb2RlXG4gICAgICA/IHsgZGVmYXVsdEF1dGhvcml6YXRpb25Nb2RlOiBjZGtBdXRob3JpemF0aW9uTW9kZSB9XG4gICAgICA6IHVuZGVmaW5lZCksXG4gICAgLi4uKGFwaUtleUNvbmZpZyA/IHsgYXBpS2V5Q29uZmlnIH0gOiB1bmRlZmluZWQpLFxuICAgIC4uLih1c2VyUG9vbENvbmZpZyA/IHsgdXNlclBvb2xDb25maWcgfSA6IHVuZGVmaW5lZCksXG4gICAgLi4uKGlkZW50aXR5UG9vbENvbmZpZyA/IHsgaWRlbnRpdHlQb29sQ29uZmlnIH0gOiB1bmRlZmluZWQpLFxuICAgIC4uLihsYW1iZGFDb25maWcgPyB7IGxhbWJkYUNvbmZpZyB9IDogdW5kZWZpbmVkKSxcbiAgICAuLi4ob2lkY0NvbmZpZyA/IHsgb2lkY0NvbmZpZyB9IDogdW5kZWZpbmVkKSxcbiAgICBpYW1Db25maWc6IHtcbiAgICAgIGVuYWJsZUlhbUF1dGhvcml6YXRpb25Nb2RlOiB0cnVlLFxuICAgIH0sXG4gIH07XG59O1xuXG4vKipcbiAqIFJldHVybiB3aGV0aGVyIG9yIG5vdCB0aGUgYXBpIHdpbGwgdXNlIGRlZmF1bHQgQVBJX0tFWSBhdXRoIGR1ZSB0byBhYnNlbmNlIG9mIGF1dGggcmVzb3VyY2VzIGFuZCBpbnB1dCBhdXRoLW1vZGVzLlxuICogQHBhcmFtIGF1dGhSZXNvdXJjZXMgdGhlIGdlbmVyYXRlZCBhdXRoIHJlc291cmNlcyBpbiB0aGUgc3lzdGVtXG4gKiBAcGFyYW0gYXV0aE1vZGVzIHRoZSBwcm92aWRlZCBhdXRoIG1vZGVzXG4gKiBAcmV0dXJucyBhIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIG9yIG5vdCBkZWZhdWx0IGFwaSBrZXkgYXV0aCB3aWxsIGJlIHVzZWQuXG4gKi9cbmV4cG9ydCBjb25zdCBpc1VzaW5nRGVmYXVsdEFwaUtleUF1dGggPSAoXG4gIGF1dGhSZXNvdXJjZXM6IFByb3ZpZGVkQXV0aENvbmZpZyB8IHVuZGVmaW5lZCxcbiAgYXV0aE1vZGVzOiBBdXRob3JpemF0aW9uTW9kZXMgfCB1bmRlZmluZWQsXG4pOiBib29sZWFuID0+IHtcbiAgcmV0dXJuIGF1dGhNb2RlcyA9PT0gdW5kZWZpbmVkICYmIGF1dGhSZXNvdXJjZXMgPT09IHVuZGVmaW5lZDtcbn07XG4iXX0=