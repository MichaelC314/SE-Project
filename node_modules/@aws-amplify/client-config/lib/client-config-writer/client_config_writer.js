import _fsp from 'fs/promises';
import path from 'path';
import { ClientConfigFormat, } from '../client-config-types/client_config.js';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * A class that persists client config to disk.
 */
export class ClientConfigWriter {
    pathResolver;
    nameResolver;
    formatter;
    fsp;
    /**
     * Creates client config writer
     */
    constructor(pathResolver, nameResolver, formatter, fsp = _fsp) {
        this.pathResolver = pathResolver;
        this.nameResolver = nameResolver;
        this.formatter = formatter;
        this.fsp = fsp;
    }
    /**
     * Persists provided client config as json file to target path.
     */
    writeClientConfig = async (clientConfig, version, outDir, format = ClientConfigFormat.JSON) => {
        const targetPath = await this.pathResolver(this.nameResolver(version), outDir, format);
        const fileContent = this.formatter.format(clientConfig, format);
        try {
            await this.fsp.writeFile(targetPath, fileContent);
        }
        catch (err) {
            const error = err;
            if (error.message.includes('EACCES')) {
                throw new AmplifyUserError('PermissionsError', {
                    message: `You do not have the permissions to write to this file: ${targetPath}`,
                    resolution: `Ensure that you have the right permissions to write to ${targetPath}.`,
                }, error);
            }
            else {
                throw error;
            }
        }
        return {
            filesWritten: [path.relative(process.cwd(), targetPath)],
        };
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50X2NvbmZpZ193cml0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY2xpZW50LWNvbmZpZy13cml0ZXIvY2xpZW50X2NvbmZpZ193cml0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxJQUFJLE1BQU0sYUFBYSxDQUFDO0FBQy9CLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLEVBR0wsa0JBQWtCLEdBR25CLE1BQU0seUNBQXlDLENBQUM7QUFFakQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFZOUQ7O0dBRUc7QUFDSCxNQUFNLE9BQU8sa0JBQWtCO0lBS1Y7SUFDQTtJQUNBO0lBQ0E7SUFQbkI7O09BRUc7SUFDSCxZQUNtQixZQUFzQyxFQUN0QyxZQUFzQyxFQUN0QyxTQUFnQyxFQUNoQyxNQUFNLElBQUk7UUFIVixpQkFBWSxHQUFaLFlBQVksQ0FBMEI7UUFDdEMsaUJBQVksR0FBWixZQUFZLENBQTBCO1FBQ3RDLGNBQVMsR0FBVCxTQUFTLENBQXVCO1FBQ2hDLFFBQUcsR0FBSCxHQUFHLENBQU87SUFDMUIsQ0FBQztJQUNKOztPQUVHO0lBQ0gsaUJBQWlCLEdBQUcsS0FBSyxFQUN2QixZQUEwQixFQUMxQixPQUE0QixFQUM1QixNQUFlLEVBQ2YsU0FBNkIsa0JBQWtCLENBQUMsSUFBSSxFQUNULEVBQUU7UUFDN0MsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUN4QyxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxFQUMxQixNQUFNLEVBQ04sTUFBTSxDQUNQLENBQUM7UUFDRixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFaEUsSUFBSTtZQUNGLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsVUFBVSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1NBQ25EO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixNQUFNLEtBQUssR0FBRyxHQUFZLENBQUM7WUFDM0IsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDcEMsTUFBTSxJQUFJLGdCQUFnQixDQUN4QixrQkFBa0IsRUFDbEI7b0JBQ0UsT0FBTyxFQUFFLDBEQUEwRCxVQUFVLEVBQUU7b0JBQy9FLFVBQVUsRUFBRSwwREFBMEQsVUFBVSxHQUFHO2lCQUNwRixFQUNELEtBQUssQ0FDTixDQUFDO2FBQ0g7aUJBQU07Z0JBQ0wsTUFBTSxLQUFLLENBQUM7YUFDYjtTQUNGO1FBRUQsT0FBTztZQUNMLFlBQVksRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1NBQ3pELENBQUM7SUFDSixDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfZnNwIGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHtcbiAgQ2xpZW50Q29uZmlnLFxuICBDbGllbnRDb25maWdGaWxlQmFzZU5hbWUsXG4gIENsaWVudENvbmZpZ0Zvcm1hdCxcbiAgQ2xpZW50Q29uZmlnVmVyc2lvbixcbiAgR2VuZXJhdGVDbGllbnRDb25maWdUb0ZpbGVSZXN1bHQsXG59IGZyb20gJy4uL2NsaWVudC1jb25maWctdHlwZXMvY2xpZW50X2NvbmZpZy5qcyc7XG5pbXBvcnQgeyBDbGllbnRDb25maWdGb3JtYXR0ZXIgfSBmcm9tICcuL2NsaWVudF9jb25maWdfZm9ybWF0dGVyLmpzJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5cbmV4cG9ydCB0eXBlIENsaWVudENvbmZpZ1BhdGhSZXNvbHZlciA9IChcbiAgZmlsZU5hbWU6IENsaWVudENvbmZpZ0ZpbGVCYXNlTmFtZSxcbiAgb3V0RGlyPzogc3RyaW5nLFxuICBmb3JtYXQ/OiBDbGllbnRDb25maWdGb3JtYXQsXG4pID0+IFByb21pc2U8c3RyaW5nPjtcblxuZXhwb3J0IHR5cGUgQ2xpZW50Q29uZmlnTmFtZVJlc29sdmVyID0gKFxuICB2ZXJzaW9uOiBDbGllbnRDb25maWdWZXJzaW9uLFxuKSA9PiBDbGllbnRDb25maWdGaWxlQmFzZU5hbWU7XG5cbi8qKlxuICogQSBjbGFzcyB0aGF0IHBlcnNpc3RzIGNsaWVudCBjb25maWcgdG8gZGlzay5cbiAqL1xuZXhwb3J0IGNsYXNzIENsaWVudENvbmZpZ1dyaXRlciB7XG4gIC8qKlxuICAgKiBDcmVhdGVzIGNsaWVudCBjb25maWcgd3JpdGVyXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhdGhSZXNvbHZlcjogQ2xpZW50Q29uZmlnUGF0aFJlc29sdmVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbmFtZVJlc29sdmVyOiBDbGllbnRDb25maWdOYW1lUmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBmb3JtYXR0ZXI6IENsaWVudENvbmZpZ0Zvcm1hdHRlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZzcCA9IF9mc3AsXG4gICkge31cbiAgLyoqXG4gICAqIFBlcnNpc3RzIHByb3ZpZGVkIGNsaWVudCBjb25maWcgYXMganNvbiBmaWxlIHRvIHRhcmdldCBwYXRoLlxuICAgKi9cbiAgd3JpdGVDbGllbnRDb25maWcgPSBhc3luYyAoXG4gICAgY2xpZW50Q29uZmlnOiBDbGllbnRDb25maWcsXG4gICAgdmVyc2lvbjogQ2xpZW50Q29uZmlnVmVyc2lvbixcbiAgICBvdXREaXI/OiBzdHJpbmcsXG4gICAgZm9ybWF0OiBDbGllbnRDb25maWdGb3JtYXQgPSBDbGllbnRDb25maWdGb3JtYXQuSlNPTixcbiAgKTogUHJvbWlzZTxHZW5lcmF0ZUNsaWVudENvbmZpZ1RvRmlsZVJlc3VsdD4gPT4ge1xuICAgIGNvbnN0IHRhcmdldFBhdGggPSBhd2FpdCB0aGlzLnBhdGhSZXNvbHZlcihcbiAgICAgIHRoaXMubmFtZVJlc29sdmVyKHZlcnNpb24pLFxuICAgICAgb3V0RGlyLFxuICAgICAgZm9ybWF0LFxuICAgICk7XG4gICAgY29uc3QgZmlsZUNvbnRlbnQgPSB0aGlzLmZvcm1hdHRlci5mb3JtYXQoY2xpZW50Q29uZmlnLCBmb3JtYXQpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuZnNwLndyaXRlRmlsZSh0YXJnZXRQYXRoLCBmaWxlQ29udGVudCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zdCBlcnJvciA9IGVyciBhcyBFcnJvcjtcbiAgICAgIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdFQUNDRVMnKSkge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAnUGVybWlzc2lvbnNFcnJvcicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgbWVzc2FnZTogYFlvdSBkbyBub3QgaGF2ZSB0aGUgcGVybWlzc2lvbnMgdG8gd3JpdGUgdG8gdGhpcyBmaWxlOiAke3RhcmdldFBhdGh9YCxcbiAgICAgICAgICAgIHJlc29sdXRpb246IGBFbnN1cmUgdGhhdCB5b3UgaGF2ZSB0aGUgcmlnaHQgcGVybWlzc2lvbnMgdG8gd3JpdGUgdG8gJHt0YXJnZXRQYXRofS5gLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyb3IsXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgZmlsZXNXcml0dGVuOiBbcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCB0YXJnZXRQYXRoKV0sXG4gICAgfTtcbiAgfTtcbn1cbiJdfQ==