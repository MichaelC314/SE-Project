import { BackendIdentifierConversions } from '@aws-amplify/platform-core';
import { DeleteStackCommand, DescribeStacksCommand, ListStackResourcesCommand, ListStacksCommand, StackStatus, } from '@aws-sdk/client-cloudformation';
import { GetObjectCommand } from '@aws-sdk/client-s3';
import { authOutputKey, functionOutputKey, graphqlOutputKey, platformOutputKey, storageOutputKey, } from '@aws-amplify/backend-output-schemas';
/**
 * Deployment Client
 */
export class DefaultDeployedBackendClient {
    cfnClient;
    s3Client;
    backendOutputClient;
    deployedResourcesEnumerator;
    stackStatusMapper;
    arnParser;
    /**
     * Constructor for deployment client
     */
    constructor(cfnClient, s3Client, backendOutputClient, deployedResourcesEnumerator, stackStatusMapper, arnParser) {
        this.cfnClient = cfnClient;
        this.s3Client = s3Client;
        this.backendOutputClient = backendOutputClient;
        this.deployedResourcesEnumerator = deployedResourcesEnumerator;
        this.stackStatusMapper = stackStatusMapper;
        this.arnParser = arnParser;
    }
    /**
     * Deletes a sandbox with the specified id
     */
    deleteSandbox = async (sandboxBackendIdentifier) => {
        const stackName = BackendIdentifierConversions.toStackName({
            ...sandboxBackendIdentifier,
            type: 'sandbox',
        });
        await this.cfnClient.send(new DeleteStackCommand({ StackName: stackName }));
    };
    /**
     * Fetches all backend metadata for a specified backend
     */
    getBackendMetadata = async (backendId) => {
        const stackName = BackendIdentifierConversions.toStackName(backendId);
        return this.buildBackendMetadata(stackName);
    };
    listBackends = (listBackendsRequest) => {
        const backends = this.listBackendsInternal(listBackendsRequest);
        return {
            getBackendSummaryByPage: () => backends,
        };
    };
    /**
     * Returns a list of stacks for specific deployment type and status
     * @yields
     */
    async *listBackendsInternal(listBackendsRequest) {
        const stackMetadata = [];
        let nextToken;
        const deploymentType = listBackendsRequest?.deploymentType;
        const statusFilter = listBackendsRequest?.backendStatusFilters
            ? listBackendsRequest?.backendStatusFilters
            : [];
        do {
            const listStacksResponse = await this.listStacks(nextToken, statusFilter);
            const stackMetadataPromises = listStacksResponse.stackSummaries
                .filter((stackSummary) => {
                return (this.getBackendStackType(stackSummary.StackName) === deploymentType);
            })
                .map(async (stackSummary) => {
                const deploymentType = await this.tryGetDeploymentType(stackSummary);
                return {
                    name: stackSummary.StackName,
                    backendId: BackendIdentifierConversions.fromStackName(stackSummary.StackName),
                    lastUpdated: stackSummary.LastUpdatedTime ?? stackSummary.CreationTime,
                    status: this.stackStatusMapper.translateStackStatus(stackSummary.StackStatus),
                    deploymentType,
                };
            });
            const stackMetadataResolvedPromises = await Promise.all(stackMetadataPromises);
            const filteredMetadata = stackMetadataResolvedPromises.filter((stackMetadata) => stackMetadata.deploymentType === deploymentType);
            stackMetadata.push(...filteredMetadata);
            nextToken = listStacksResponse.nextToken;
            if (stackMetadata.length !== 0) {
                yield stackMetadata;
            }
        } while (stackMetadata.length === 0 && nextToken);
    }
    getBackendStackType = (stackName) => {
        const backendIdentifier = BackendIdentifierConversions.fromStackName(stackName);
        return backendIdentifier?.type;
    };
    tryGetDeploymentType = async (stackSummary) => {
        const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: stackSummary.StackName }));
        return stackDescription.Stacks?.[0].Tags?.find((tag) => tag.Key === 'amplify:deployment-type')?.Value;
    };
    listStacks = async (nextToken, stackStatusFilter) => {
        const stacks = await this.cfnClient.send(new ListStacksCommand({
            NextToken: nextToken,
            StackStatusFilter: stackStatusFilter.length > 0
                ? stackStatusFilter
                : Object.values(StackStatus).filter((status) => status !== StackStatus.DELETE_COMPLETE),
        }));
        nextToken = stacks.NextToken;
        return { stackSummaries: stacks.StackSummaries ?? [], nextToken };
    };
    buildBackendMetadata = async (stackName) => {
        const stackBackendIdentifier = {
            stackName,
        };
        const backendOutput = await this.backendOutputClient.getOutput(stackBackendIdentifier);
        const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: stackName }));
        const stack = stackDescription?.Stacks?.[0];
        const status = this.stackStatusMapper.translateStackStatus(stack?.StackStatus);
        const lastUpdated = stack?.LastUpdatedTime ?? stack?.CreationTime;
        const stackResources = await this.cfnClient.send(new ListStackResourcesCommand({
            StackName: stackName,
        }));
        const childStackPromises = stackResources.StackResourceSummaries?.filter((stackResourceSummary) => {
            return (stackResourceSummary.ResourceType === 'AWS::CloudFormation::Stack');
        }).map(async (stackResourceSummary) => {
            // arn:aws:{service}:{region}:{account}:stack/{stackName}/{additionalFields}
            const arnParts = stackResourceSummary.PhysicalResourceId?.split('/');
            const childStackName = arnParts?.[1];
            if (!childStackName) {
                return;
            }
            const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: childStackName }));
            const stack = stackDescription?.Stacks?.[0];
            return stack;
        }) ?? [];
        const childStacks = await Promise.all(childStackPromises);
        const authStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('auth'));
        const storageStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('storage'));
        const apiStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('data'));
        const functionStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('function'));
        // stack?.StackId is the ARN of the stack
        const { accountId, region } = this.arnParser.tryParseArn(stack?.StackId);
        const resources = await this.deployedResourcesEnumerator.listDeployedResources(this.cfnClient, stackName, accountId, region);
        const backendMetadataObject = {
            deploymentType: backendOutput[platformOutputKey].payload
                .deploymentType,
            lastUpdated,
            status,
            name: stackName,
            resources,
        };
        if (authStack) {
            backendMetadataObject.authConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(authStack.StackStatus),
                lastUpdated: authStack.LastUpdatedTime ?? authStack.CreationTime,
                userPoolId: backendOutput[authOutputKey]?.payload.userPoolId,
            };
        }
        if (storageStack) {
            backendMetadataObject.storageConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(storageStack.StackStatus),
                lastUpdated: storageStack.LastUpdatedTime ?? storageStack.CreationTime,
                s3BucketName: backendOutput[storageOutputKey]?.payload
                    .bucketName,
            };
        }
        if (apiStack) {
            const additionalAuthTypesString = backendOutput[graphqlOutputKey]?.payload
                .awsAppsyncAdditionalAuthenticationTypes;
            const additionalAuthTypes = additionalAuthTypesString
                ? additionalAuthTypesString.split(',')
                : [];
            backendMetadataObject.apiConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(apiStack.StackStatus),
                lastUpdated: apiStack.LastUpdatedTime ?? apiStack.CreationTime,
                graphqlEndpoint: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncApiEndpoint,
                defaultAuthType: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncAuthenticationType,
                additionalAuthTypes,
                conflictResolutionMode: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncConflictResolutionMode,
                apiId: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncApiId,
                modelSchemaS3Uri: backendOutput[graphqlOutputKey]?.payload
                    .amplifyApiModelSchemaS3Uri,
            };
        }
        if (functionStack) {
            const functionResources = resources.filter((resource) => resource.resourceType === 'AWS::Lambda::Function');
            const functionConfigurations = [];
            const definedFunctionsString = backendOutput[functionOutputKey]?.payload.definedFunctions;
            const customerFunctionNames = definedFunctionsString
                ? JSON.parse(definedFunctionsString)
                : [];
            customerFunctionNames.forEach((functionName) => {
                const resource = functionResources.find((func) => func.physicalResourceId === functionName);
                if (resource) {
                    functionConfigurations.push({
                        status: this.stackStatusMapper.translateStackStatus(resource.resourceStatus),
                        lastUpdated: resource.lastUpdated ??
                            functionStack.LastUpdatedTime ??
                            functionStack.CreationTime,
                        functionName,
                    });
                }
            });
            backendMetadataObject.functionConfigurations = functionConfigurations;
        }
        return backendMetadataObject;
    };
    fetchSchema = async (schemaS3Uri) => {
        if (!schemaS3Uri) {
            throw new Error('schemaS3Uri output is not available');
        }
        // s3://{bucketName}/{fileName}
        const uriParts = schemaS3Uri.split('/');
        const bucketName = uriParts[2];
        const objectPath = uriParts.slice(3, uriParts.length).join('/');
        if (!bucketName || !objectPath) {
            throw new Error('schemaS3Uri is not valid');
        }
        const s3Response = await this.s3Client.send(new GetObjectCommand({ Bucket: bucketName, Key: objectPath }));
        if (!s3Response.Body) {
            throw new Error(`s3Response from ${schemaS3Uri} does not contain a Body`);
        }
        return await s3Response.Body?.transformToString();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwbG95ZWRfYmFja2VuZF9jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZGVwbG95ZWRfYmFja2VuZF9jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBZ0JBLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRTFFLE9BQU8sRUFFTCxrQkFBa0IsRUFDbEIscUJBQXFCLEVBQ3JCLHlCQUF5QixFQUN6QixpQkFBaUIsRUFJakIsV0FBVyxHQUVaLE1BQU0sZ0NBQWdDLENBQUM7QUFFeEMsT0FBTyxFQUFFLGdCQUFnQixFQUFZLE1BQU0sb0JBQW9CLENBQUM7QUFDaEUsT0FBTyxFQUNMLGFBQWEsRUFDYixpQkFBaUIsRUFDakIsZ0JBQWdCLEVBQ2hCLGlCQUFpQixFQUNqQixnQkFBZ0IsR0FDakIsTUFBTSxxQ0FBcUMsQ0FBQztBQUs3Qzs7R0FFRztBQUNILE1BQU0sT0FBTyw0QkFBNEI7SUFLcEI7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBVG5COztPQUVHO0lBQ0gsWUFDbUIsU0FBK0IsRUFDL0IsUUFBa0IsRUFDbEIsbUJBQXdDLEVBQ3hDLDJCQUF3RCxFQUN4RCxpQkFBb0MsRUFDcEMsU0FBb0I7UUFMcEIsY0FBUyxHQUFULFNBQVMsQ0FBc0I7UUFDL0IsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLGdDQUEyQixHQUEzQiwyQkFBMkIsQ0FBNkI7UUFDeEQsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyxjQUFTLEdBQVQsU0FBUyxDQUFXO0lBQ3BDLENBQUM7SUFFSjs7T0FFRztJQUNILGFBQWEsR0FBRyxLQUFLLEVBQ25CLHdCQUF5RCxFQUMxQyxFQUFFO1FBQ2pCLE1BQU0sU0FBUyxHQUFHLDRCQUE0QixDQUFDLFdBQVcsQ0FBQztZQUN6RCxHQUFHLHdCQUF3QjtZQUMzQixJQUFJLEVBQUUsU0FBUztTQUNoQixDQUFDLENBQUM7UUFDSCxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksa0JBQWtCLENBQUMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzlFLENBQUMsQ0FBQztJQUNGOztPQUVHO0lBQ0gsa0JBQWtCLEdBQUcsS0FBSyxFQUN4QixTQUE0QixFQUNGLEVBQUU7UUFDNUIsTUFBTSxTQUFTLEdBQUcsNEJBQTRCLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3RFLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzlDLENBQUMsQ0FBQztJQUVGLFlBQVksR0FBRyxDQUNiLG1CQUF5QyxFQUNuQixFQUFFO1FBQ3hCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ2hFLE9BQU87WUFDTCx1QkFBdUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxRQUFRO1NBQ3hDLENBQUM7SUFDSixDQUFDLENBQUM7SUFFRjs7O09BR0c7SUFDSyxLQUFLLENBQUMsQ0FBQyxvQkFBb0IsQ0FDakMsbUJBQXlDO1FBRXpDLE1BQU0sYUFBYSxHQUE2QixFQUFFLENBQUM7UUFDbkQsSUFBSSxTQUFTLENBQUM7UUFDZCxNQUFNLGNBQWMsR0FBRyxtQkFBbUIsRUFBRSxjQUFjLENBQUM7UUFDM0QsTUFBTSxZQUFZLEdBQUcsbUJBQW1CLEVBQUUsb0JBQW9CO1lBQzVELENBQUMsQ0FBQyxtQkFBbUIsRUFBRSxvQkFBb0I7WUFDM0MsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUNQLEdBQUc7WUFDRCxNQUFNLGtCQUFrQixHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFFMUUsTUFBTSxxQkFBcUIsR0FBRyxrQkFBa0IsQ0FBQyxjQUFjO2lCQUM1RCxNQUFNLENBQUMsQ0FBQyxZQUEwQixFQUFFLEVBQUU7Z0JBQ3JDLE9BQU8sQ0FDTCxJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxLQUFLLGNBQWMsQ0FDcEUsQ0FBQztZQUNKLENBQUMsQ0FBQztpQkFDRCxHQUFHLENBQUMsS0FBSyxFQUFFLFlBQTBCLEVBQUUsRUFBRTtnQkFDeEMsTUFBTSxjQUFjLEdBQUcsTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBRXJFLE9BQU87b0JBQ0wsSUFBSSxFQUFFLFlBQVksQ0FBQyxTQUFtQjtvQkFDdEMsU0FBUyxFQUFFLDRCQUE0QixDQUFDLGFBQWEsQ0FDbkQsWUFBWSxDQUFDLFNBQVMsQ0FDdkI7b0JBQ0QsV0FBVyxFQUNULFlBQVksQ0FBQyxlQUFlLElBQUksWUFBWSxDQUFDLFlBQVk7b0JBQzNELE1BQU0sRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsb0JBQW9CLENBQ2pELFlBQVksQ0FBQyxXQUFXLENBQ3pCO29CQUNELGNBQWM7aUJBQ2YsQ0FBQztZQUNKLENBQUMsQ0FBQyxDQUFDO1lBRUwsTUFBTSw2QkFBNkIsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQ3JELHFCQUFxQixDQUN0QixDQUFDO1lBQ0YsTUFBTSxnQkFBZ0IsR0FBRyw2QkFBNkIsQ0FBQyxNQUFNLENBQzNELENBQUMsYUFBYSxFQUFFLEVBQUUsQ0FBQyxhQUFhLENBQUMsY0FBYyxLQUFLLGNBQWMsQ0FDbkUsQ0FBQztZQUVGLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3hDLFNBQVMsR0FBRyxrQkFBa0IsQ0FBQyxTQUFTLENBQUM7WUFFekMsSUFBSSxhQUFhLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFDOUIsTUFBTSxhQUFhLENBQUM7YUFDckI7U0FDRixRQUFRLGFBQWEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLFNBQVMsRUFBRTtJQUNwRCxDQUFDO0lBRU8sbUJBQW1CLEdBQUcsQ0FDNUIsU0FBNkIsRUFDVCxFQUFFO1FBQ3RCLE1BQU0saUJBQWlCLEdBQ3JCLDRCQUE0QixDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN4RCxPQUFPLGlCQUFpQixFQUFFLElBQUksQ0FBQztJQUNqQyxDQUFDLENBQUM7SUFFTSxvQkFBb0IsR0FBRyxLQUFLLEVBQ2xDLFlBQTBCLEVBQ1csRUFBRTtRQUN2QyxNQUFNLGdCQUFnQixHQUFHLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQ2hELElBQUkscUJBQXFCLENBQUMsRUFBRSxTQUFTLEVBQUUsWUFBWSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQ2pFLENBQUM7UUFFRixPQUFPLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQzVDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLHlCQUF5QixDQUMvQyxFQUFFLEtBQXVCLENBQUM7SUFDN0IsQ0FBQyxDQUFDO0lBRU0sVUFBVSxHQUFHLEtBQUssRUFDeEIsU0FBNkIsRUFDN0IsaUJBQWtDLEVBSWpDLEVBQUU7UUFDSCxNQUFNLE1BQU0sR0FBNEIsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FDL0QsSUFBSSxpQkFBaUIsQ0FBQztZQUNwQixTQUFTLEVBQUUsU0FBUztZQUNwQixpQkFBaUIsRUFDZixpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQztnQkFDMUIsQ0FBQyxDQUFDLGlCQUFpQjtnQkFDbkIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsTUFBTSxDQUMvQixDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsTUFBTSxLQUFLLFdBQVcsQ0FBQyxlQUFlLENBQ25EO1NBQ1IsQ0FBQyxDQUNILENBQUM7UUFDRixTQUFTLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQztRQUM3QixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sQ0FBQyxjQUFjLElBQUksRUFBRSxFQUFFLFNBQVMsRUFBRSxDQUFDO0lBQ3BFLENBQUMsQ0FBQztJQUVNLG9CQUFvQixHQUFHLEtBQUssRUFDbEMsU0FBaUIsRUFDUyxFQUFFO1FBQzVCLE1BQU0sc0JBQXNCLEdBQUc7WUFDN0IsU0FBUztTQUNWLENBQUM7UUFFRixNQUFNLGFBQWEsR0FDakIsTUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQUMsU0FBUyxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFDbkUsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUNoRCxJQUFJLHFCQUFxQixDQUFDLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQ3BELENBQUM7UUFDRixNQUFNLEtBQUssR0FBRyxnQkFBZ0IsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM1QyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsb0JBQW9CLENBQ3hELEtBQUssRUFBRSxXQUFXLENBQ25CLENBQUM7UUFDRixNQUFNLFdBQVcsR0FBRyxLQUFLLEVBQUUsZUFBZSxJQUFJLEtBQUssRUFBRSxZQUFZLENBQUM7UUFFbEUsTUFBTSxjQUFjLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FDOUMsSUFBSSx5QkFBeUIsQ0FBQztZQUM1QixTQUFTLEVBQUUsU0FBUztTQUNyQixDQUFDLENBQ0gsQ0FBQztRQUNGLE1BQU0sa0JBQWtCLEdBQ3RCLGNBQWMsQ0FBQyxzQkFBc0IsRUFBRSxNQUFNLENBQzNDLENBQUMsb0JBQTBDLEVBQUUsRUFBRTtZQUM3QyxPQUFPLENBQ0wsb0JBQW9CLENBQUMsWUFBWSxLQUFLLDRCQUE0QixDQUNuRSxDQUFDO1FBQ0osQ0FBQyxDQUNGLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxvQkFBMEMsRUFBRSxFQUFFO1lBQ3pELDRFQUE0RTtZQUM1RSxNQUFNLFFBQVEsR0FBRyxvQkFBb0IsQ0FBQyxrQkFBa0IsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDckUsTUFBTSxjQUFjLEdBQUcsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckMsSUFBSSxDQUFDLGNBQWMsRUFBRTtnQkFDbkIsT0FBTzthQUNSO1lBQ0QsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUNoRCxJQUFJLHFCQUFxQixDQUFDLEVBQUUsU0FBUyxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQ3pELENBQUM7WUFFRixNQUFNLEtBQUssR0FBRyxnQkFBZ0IsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM1QyxPQUFPLEtBQUssQ0FBQztRQUNmLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUVYLE1BQU0sV0FBVyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQzFELE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQ2hDLENBQUMsV0FBcUMsRUFBRSxFQUFFLENBQ3hDLFdBQVcsRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUMzQyxDQUFDO1FBQ0YsTUFBTSxZQUFZLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FDbkMsQ0FBQyxXQUFxQyxFQUFFLEVBQUUsQ0FDeEMsV0FBVyxFQUFFLFNBQVMsRUFBRSxRQUFRLENBQUMsU0FBUyxDQUFDLENBQzlDLENBQUM7UUFDRixNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBcUMsRUFBRSxFQUFFLENBQzFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUN6QyxDQUFDO1FBQ0YsTUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FDcEMsQ0FBQyxXQUFxQyxFQUFFLEVBQUUsQ0FDeEMsV0FBVyxFQUFFLFNBQVMsRUFBRSxRQUFRLENBQUMsVUFBVSxDQUFDLENBQy9DLENBQUM7UUFFRix5Q0FBeUM7UUFDekMsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FDdEQsS0FBSyxFQUFFLE9BQWlCLENBQ3pCLENBQUM7UUFDRixNQUFNLFNBQVMsR0FDYixNQUFNLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxxQkFBcUIsQ0FDMUQsSUFBSSxDQUFDLFNBQVMsRUFDZCxTQUFTLEVBQ1QsU0FBUyxFQUNULE1BQU0sQ0FDUCxDQUFDO1FBRUosTUFBTSxxQkFBcUIsR0FBb0I7WUFDN0MsY0FBYyxFQUFFLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLE9BQU87aUJBQ3JELGNBQWdDO1lBQ25DLFdBQVc7WUFDWCxNQUFNO1lBQ04sSUFBSSxFQUFFLFNBQVM7WUFDZixTQUFTO1NBQ1YsQ0FBQztRQUVGLElBQUksU0FBUyxFQUFFO1lBQ2IscUJBQXFCLENBQUMsaUJBQWlCLEdBQUc7Z0JBQ3hDLE1BQU0sRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsb0JBQW9CLENBQ2pELFNBQVMsQ0FBQyxXQUFXLENBQ3RCO2dCQUNELFdBQVcsRUFBRSxTQUFTLENBQUMsZUFBZSxJQUFJLFNBQVMsQ0FBQyxZQUFZO2dCQUNoRSxVQUFVLEVBQUUsYUFBYSxDQUFDLGFBQWEsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxVQUFvQjthQUN2RSxDQUFDO1NBQ0g7UUFFRCxJQUFJLFlBQVksRUFBRTtZQUNoQixxQkFBcUIsQ0FBQyxvQkFBb0IsR0FBRztnQkFDM0MsTUFBTSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxvQkFBb0IsQ0FDakQsWUFBWSxDQUFDLFdBQVcsQ0FDekI7Z0JBQ0QsV0FBVyxFQUFFLFlBQVksQ0FBQyxlQUFlLElBQUksWUFBWSxDQUFDLFlBQVk7Z0JBQ3RFLFlBQVksRUFBRSxhQUFhLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxPQUFPO3FCQUNuRCxVQUFvQjthQUN4QixDQUFDO1NBQ0g7UUFFRCxJQUFJLFFBQVEsRUFBRTtZQUNaLE1BQU0seUJBQXlCLEdBQUcsYUFBYSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsT0FBTztpQkFDdkUsdUNBQWlELENBQUM7WUFDckQsTUFBTSxtQkFBbUIsR0FBRyx5QkFBeUI7Z0JBQ25ELENBQUMsQ0FBRSx5QkFBeUIsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFtQjtnQkFDekQsQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUNQLHFCQUFxQixDQUFDLGdCQUFnQixHQUFHO2dCQUN2QyxNQUFNLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLG9CQUFvQixDQUNqRCxRQUFRLENBQUMsV0FBVyxDQUNyQjtnQkFDRCxXQUFXLEVBQUUsUUFBUSxDQUFDLGVBQWUsSUFBSSxRQUFRLENBQUMsWUFBWTtnQkFDOUQsZUFBZSxFQUFFLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLE9BQU87cUJBQ3RELHFCQUErQjtnQkFDbEMsZUFBZSxFQUFFLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLE9BQU87cUJBQ3RELDRCQUEyQztnQkFDOUMsbUJBQW1CO2dCQUNuQixzQkFBc0IsRUFBRSxhQUFhLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxPQUFPO3FCQUM3RCxnQ0FBMEQ7Z0JBQzdELEtBQUssRUFBRSxhQUFhLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxPQUFPO3FCQUM1QyxlQUF5QjtnQkFDNUIsZ0JBQWdCLEVBQUUsYUFBYSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsT0FBTztxQkFDdkQsMEJBQW9DO2FBQ3hDLENBQUM7U0FDSDtRQUVELElBQUksYUFBYSxFQUFFO1lBQ2pCLE1BQU0saUJBQWlCLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FDeEMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEtBQUssdUJBQXVCLENBQ2hFLENBQUM7WUFDRixNQUFNLHNCQUFzQixHQUE0QixFQUFFLENBQUM7WUFDM0QsTUFBTSxzQkFBc0IsR0FDMUIsYUFBYSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsT0FBTyxDQUFDLGdCQUFnQixDQUFDO1lBQzdELE1BQU0scUJBQXFCLEdBQUcsc0JBQXNCO2dCQUNsRCxDQUFDLENBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxzQkFBZ0MsQ0FBYztnQkFDNUQsQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUVQLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDLFlBQVksRUFBRSxFQUFFO2dCQUM3QyxNQUFNLFFBQVEsR0FBRyxpQkFBaUIsQ0FBQyxJQUFJLENBQ3JDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEtBQUssWUFBWSxDQUNuRCxDQUFDO2dCQUVGLElBQUksUUFBUSxFQUFFO29CQUNaLHNCQUFzQixDQUFDLElBQUksQ0FBQzt3QkFDMUIsTUFBTSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxvQkFBb0IsQ0FDakQsUUFBUSxDQUFDLGNBQWMsQ0FDeEI7d0JBQ0QsV0FBVyxFQUNULFFBQVEsQ0FBQyxXQUFXOzRCQUNwQixhQUFhLENBQUMsZUFBZTs0QkFDN0IsYUFBYSxDQUFDLFlBQVk7d0JBQzVCLFlBQVk7cUJBQ2IsQ0FBQyxDQUFDO2lCQUNKO1lBQ0gsQ0FBQyxDQUFDLENBQUM7WUFFSCxxQkFBcUIsQ0FBQyxzQkFBc0IsR0FBRyxzQkFBc0IsQ0FBQztTQUN2RTtRQUVELE9BQU8scUJBQXFCLENBQUM7SUFDL0IsQ0FBQyxDQUFDO0lBRU0sV0FBVyxHQUFHLEtBQUssRUFDekIsV0FBK0IsRUFDZCxFQUFFO1FBQ25CLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDaEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1NBQ3hEO1FBRUQsK0JBQStCO1FBQy9CLE1BQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDeEMsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9CLE1BQU0sVUFBVSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFaEUsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUM5QixNQUFNLElBQUksS0FBSyxDQUFDLDBCQUEwQixDQUFDLENBQUM7U0FDN0M7UUFFRCxNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUN6QyxJQUFJLGdCQUFnQixDQUFDLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FDOUQsQ0FBQztRQUVGLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFO1lBQ3BCLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLFdBQVcsMEJBQTBCLENBQUMsQ0FBQztTQUMzRTtRQUVELE9BQU8sTUFBTSxVQUFVLENBQUMsSUFBSSxFQUFFLGlCQUFpQixFQUFFLENBQUM7SUFDcEQsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBCYWNrZW5kSWRlbnRpZmllcixcbiAgQmFja2VuZE91dHB1dCxcbiAgRGVwbG95bWVudFR5cGUsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHtcbiAgQXBpQXV0aFR5cGUsXG4gIEJhY2tlbmRNZXRhZGF0YSxcbiAgQmFja2VuZFN0YXR1cyxcbiAgQmFja2VuZFN1bW1hcnlNZXRhZGF0YSxcbiAgQ29uZmxpY3RSZXNvbHV0aW9uTW9kZSxcbiAgRGVwbG95ZWRCYWNrZW5kQ2xpZW50LFxuICBGdW5jdGlvbkNvbmZpZ3VyYXRpb24sXG4gIExpc3RCYWNrZW5kc1JlcXVlc3QsXG4gIExpc3RCYWNrZW5kc1Jlc3BvbnNlLFxufSBmcm9tICcuL2RlcGxveWVkX2JhY2tlbmRfY2xpZW50X2ZhY3RvcnkuanMnO1xuaW1wb3J0IHsgQmFja2VuZElkZW50aWZpZXJDb252ZXJzaW9ucyB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7IEJhY2tlbmRPdXRwdXRDbGllbnQgfSBmcm9tICcuL2JhY2tlbmRfb3V0cHV0X2NsaWVudF9mYWN0b3J5LmpzJztcbmltcG9ydCB7XG4gIENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICBEZWxldGVTdGFja0NvbW1hbmQsXG4gIERlc2NyaWJlU3RhY2tzQ29tbWFuZCxcbiAgTGlzdFN0YWNrUmVzb3VyY2VzQ29tbWFuZCxcbiAgTGlzdFN0YWNrc0NvbW1hbmQsXG4gIExpc3RTdGFja3NDb21tYW5kT3V0cHV0LFxuICBTdGFjayxcbiAgU3RhY2tSZXNvdXJjZVN1bW1hcnksXG4gIFN0YWNrU3RhdHVzLFxuICBTdGFja1N1bW1hcnksXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1jbG91ZGZvcm1hdGlvbic7XG5cbmltcG9ydCB7IEdldE9iamVjdENvbW1hbmQsIFMzQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7XG4gIGF1dGhPdXRwdXRLZXksXG4gIGZ1bmN0aW9uT3V0cHV0S2V5LFxuICBncmFwaHFsT3V0cHV0S2V5LFxuICBwbGF0Zm9ybU91dHB1dEtleSxcbiAgc3RvcmFnZU91dHB1dEtleSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHsgRGVwbG95ZWRSZXNvdXJjZXNFbnVtZXJhdG9yIH0gZnJvbSAnLi9kZXBsb3llZC1iYWNrZW5kLWNsaWVudC9kZXBsb3llZF9yZXNvdXJjZXNfZW51bWVyYXRvci5qcyc7XG5pbXBvcnQgeyBTdGFja1N0YXR1c01hcHBlciB9IGZyb20gJy4vZGVwbG95ZWQtYmFja2VuZC1jbGllbnQvc3RhY2tfc3RhdHVzX21hcHBlci5qcyc7XG5pbXBvcnQgeyBBcm5QYXJzZXIgfSBmcm9tICcuL2RlcGxveWVkLWJhY2tlbmQtY2xpZW50L2Fybl9wYXJzZXIuanMnO1xuXG4vKipcbiAqIERlcGxveW1lbnQgQ2xpZW50XG4gKi9cbmV4cG9ydCBjbGFzcyBEZWZhdWx0RGVwbG95ZWRCYWNrZW5kQ2xpZW50IGltcGxlbWVudHMgRGVwbG95ZWRCYWNrZW5kQ2xpZW50IHtcbiAgLyoqXG4gICAqIENvbnN0cnVjdG9yIGZvciBkZXBsb3ltZW50IGNsaWVudFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBjZm5DbGllbnQ6IENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgczNDbGllbnQ6IFMzQ2xpZW50LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYmFja2VuZE91dHB1dENsaWVudDogQmFja2VuZE91dHB1dENsaWVudCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRlcGxveWVkUmVzb3VyY2VzRW51bWVyYXRvcjogRGVwbG95ZWRSZXNvdXJjZXNFbnVtZXJhdG9yLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3RhY2tTdGF0dXNNYXBwZXI6IFN0YWNrU3RhdHVzTWFwcGVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXJuUGFyc2VyOiBBcm5QYXJzZXIsXG4gICkge31cblxuICAvKipcbiAgICogRGVsZXRlcyBhIHNhbmRib3ggd2l0aCB0aGUgc3BlY2lmaWVkIGlkXG4gICAqL1xuICBkZWxldGVTYW5kYm94ID0gYXN5bmMgKFxuICAgIHNhbmRib3hCYWNrZW5kSWRlbnRpZmllcjogT21pdDxCYWNrZW5kSWRlbnRpZmllciwgJ3R5cGUnPixcbiAgKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgY29uc3Qgc3RhY2tOYW1lID0gQmFja2VuZElkZW50aWZpZXJDb252ZXJzaW9ucy50b1N0YWNrTmFtZSh7XG4gICAgICAuLi5zYW5kYm94QmFja2VuZElkZW50aWZpZXIsXG4gICAgICB0eXBlOiAnc2FuZGJveCcsXG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5jZm5DbGllbnQuc2VuZChuZXcgRGVsZXRlU3RhY2tDb21tYW5kKHsgU3RhY2tOYW1lOiBzdGFja05hbWUgfSkpO1xuICB9O1xuICAvKipcbiAgICogRmV0Y2hlcyBhbGwgYmFja2VuZCBtZXRhZGF0YSBmb3IgYSBzcGVjaWZpZWQgYmFja2VuZFxuICAgKi9cbiAgZ2V0QmFja2VuZE1ldGFkYXRhID0gYXN5bmMgKFxuICAgIGJhY2tlbmRJZDogQmFja2VuZElkZW50aWZpZXIsXG4gICk6IFByb21pc2U8QmFja2VuZE1ldGFkYXRhPiA9PiB7XG4gICAgY29uc3Qgc3RhY2tOYW1lID0gQmFja2VuZElkZW50aWZpZXJDb252ZXJzaW9ucy50b1N0YWNrTmFtZShiYWNrZW5kSWQpO1xuICAgIHJldHVybiB0aGlzLmJ1aWxkQmFja2VuZE1ldGFkYXRhKHN0YWNrTmFtZSk7XG4gIH07XG5cbiAgbGlzdEJhY2tlbmRzID0gKFxuICAgIGxpc3RCYWNrZW5kc1JlcXVlc3Q/OiBMaXN0QmFja2VuZHNSZXF1ZXN0LFxuICApOiBMaXN0QmFja2VuZHNSZXNwb25zZSA9PiB7XG4gICAgY29uc3QgYmFja2VuZHMgPSB0aGlzLmxpc3RCYWNrZW5kc0ludGVybmFsKGxpc3RCYWNrZW5kc1JlcXVlc3QpO1xuICAgIHJldHVybiB7XG4gICAgICBnZXRCYWNrZW5kU3VtbWFyeUJ5UGFnZTogKCkgPT4gYmFja2VuZHMsXG4gICAgfTtcbiAgfTtcblxuICAvKipcbiAgICogUmV0dXJucyBhIGxpc3Qgb2Ygc3RhY2tzIGZvciBzcGVjaWZpYyBkZXBsb3ltZW50IHR5cGUgYW5kIHN0YXR1c1xuICAgKiBAeWllbGRzXG4gICAqL1xuICBwcml2YXRlIGFzeW5jICpsaXN0QmFja2VuZHNJbnRlcm5hbChcbiAgICBsaXN0QmFja2VuZHNSZXF1ZXN0PzogTGlzdEJhY2tlbmRzUmVxdWVzdCxcbiAgKSB7XG4gICAgY29uc3Qgc3RhY2tNZXRhZGF0YTogQmFja2VuZFN1bW1hcnlNZXRhZGF0YVtdID0gW107XG4gICAgbGV0IG5leHRUb2tlbjtcbiAgICBjb25zdCBkZXBsb3ltZW50VHlwZSA9IGxpc3RCYWNrZW5kc1JlcXVlc3Q/LmRlcGxveW1lbnRUeXBlO1xuICAgIGNvbnN0IHN0YXR1c0ZpbHRlciA9IGxpc3RCYWNrZW5kc1JlcXVlc3Q/LmJhY2tlbmRTdGF0dXNGaWx0ZXJzXG4gICAgICA/IGxpc3RCYWNrZW5kc1JlcXVlc3Q/LmJhY2tlbmRTdGF0dXNGaWx0ZXJzXG4gICAgICA6IFtdO1xuICAgIGRvIHtcbiAgICAgIGNvbnN0IGxpc3RTdGFja3NSZXNwb25zZSA9IGF3YWl0IHRoaXMubGlzdFN0YWNrcyhuZXh0VG9rZW4sIHN0YXR1c0ZpbHRlcik7XG5cbiAgICAgIGNvbnN0IHN0YWNrTWV0YWRhdGFQcm9taXNlcyA9IGxpc3RTdGFja3NSZXNwb25zZS5zdGFja1N1bW1hcmllc1xuICAgICAgICAuZmlsdGVyKChzdGFja1N1bW1hcnk6IFN0YWNrU3VtbWFyeSkgPT4ge1xuICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICB0aGlzLmdldEJhY2tlbmRTdGFja1R5cGUoc3RhY2tTdW1tYXJ5LlN0YWNrTmFtZSkgPT09IGRlcGxveW1lbnRUeXBlXG4gICAgICAgICAgKTtcbiAgICAgICAgfSlcbiAgICAgICAgLm1hcChhc3luYyAoc3RhY2tTdW1tYXJ5OiBTdGFja1N1bW1hcnkpID0+IHtcbiAgICAgICAgICBjb25zdCBkZXBsb3ltZW50VHlwZSA9IGF3YWl0IHRoaXMudHJ5R2V0RGVwbG95bWVudFR5cGUoc3RhY2tTdW1tYXJ5KTtcblxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBuYW1lOiBzdGFja1N1bW1hcnkuU3RhY2tOYW1lIGFzIHN0cmluZyxcbiAgICAgICAgICAgIGJhY2tlbmRJZDogQmFja2VuZElkZW50aWZpZXJDb252ZXJzaW9ucy5mcm9tU3RhY2tOYW1lKFxuICAgICAgICAgICAgICBzdGFja1N1bW1hcnkuU3RhY2tOYW1lLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGxhc3RVcGRhdGVkOlxuICAgICAgICAgICAgICBzdGFja1N1bW1hcnkuTGFzdFVwZGF0ZWRUaW1lID8/IHN0YWNrU3VtbWFyeS5DcmVhdGlvblRpbWUsXG4gICAgICAgICAgICBzdGF0dXM6IHRoaXMuc3RhY2tTdGF0dXNNYXBwZXIudHJhbnNsYXRlU3RhY2tTdGF0dXMoXG4gICAgICAgICAgICAgIHN0YWNrU3VtbWFyeS5TdGFja1N0YXR1cyxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBkZXBsb3ltZW50VHlwZSxcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcblxuICAgICAgY29uc3Qgc3RhY2tNZXRhZGF0YVJlc29sdmVkUHJvbWlzZXMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgc3RhY2tNZXRhZGF0YVByb21pc2VzLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IGZpbHRlcmVkTWV0YWRhdGEgPSBzdGFja01ldGFkYXRhUmVzb2x2ZWRQcm9taXNlcy5maWx0ZXIoXG4gICAgICAgIChzdGFja01ldGFkYXRhKSA9PiBzdGFja01ldGFkYXRhLmRlcGxveW1lbnRUeXBlID09PSBkZXBsb3ltZW50VHlwZSxcbiAgICAgICk7XG5cbiAgICAgIHN0YWNrTWV0YWRhdGEucHVzaCguLi5maWx0ZXJlZE1ldGFkYXRhKTtcbiAgICAgIG5leHRUb2tlbiA9IGxpc3RTdGFja3NSZXNwb25zZS5uZXh0VG9rZW47XG5cbiAgICAgIGlmIChzdGFja01ldGFkYXRhLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICB5aWVsZCBzdGFja01ldGFkYXRhO1xuICAgICAgfVxuICAgIH0gd2hpbGUgKHN0YWNrTWV0YWRhdGEubGVuZ3RoID09PSAwICYmIG5leHRUb2tlbik7XG4gIH1cblxuICBwcml2YXRlIGdldEJhY2tlbmRTdGFja1R5cGUgPSAoXG4gICAgc3RhY2tOYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gICk6IHN0cmluZyB8IHVuZGVmaW5lZCA9PiB7XG4gICAgY29uc3QgYmFja2VuZElkZW50aWZpZXIgPVxuICAgICAgQmFja2VuZElkZW50aWZpZXJDb252ZXJzaW9ucy5mcm9tU3RhY2tOYW1lKHN0YWNrTmFtZSk7XG4gICAgcmV0dXJuIGJhY2tlbmRJZGVudGlmaWVyPy50eXBlO1xuICB9O1xuXG4gIHByaXZhdGUgdHJ5R2V0RGVwbG95bWVudFR5cGUgPSBhc3luYyAoXG4gICAgc3RhY2tTdW1tYXJ5OiBTdGFja1N1bW1hcnksXG4gICk6IFByb21pc2U8RGVwbG95bWVudFR5cGUgfCB1bmRlZmluZWQ+ID0+IHtcbiAgICBjb25zdCBzdGFja0Rlc2NyaXB0aW9uID0gYXdhaXQgdGhpcy5jZm5DbGllbnQuc2VuZChcbiAgICAgIG5ldyBEZXNjcmliZVN0YWNrc0NvbW1hbmQoeyBTdGFja05hbWU6IHN0YWNrU3VtbWFyeS5TdGFja05hbWUgfSksXG4gICAgKTtcblxuICAgIHJldHVybiBzdGFja0Rlc2NyaXB0aW9uLlN0YWNrcz8uWzBdLlRhZ3M/LmZpbmQoXG4gICAgICAodGFnKSA9PiB0YWcuS2V5ID09PSAnYW1wbGlmeTpkZXBsb3ltZW50LXR5cGUnLFxuICAgICk/LlZhbHVlIGFzIERlcGxveW1lbnRUeXBlO1xuICB9O1xuXG4gIHByaXZhdGUgbGlzdFN0YWNrcyA9IGFzeW5jIChcbiAgICBuZXh0VG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICBzdGFja1N0YXR1c0ZpbHRlcjogQmFja2VuZFN0YXR1c1tdLFxuICApOiBQcm9taXNlPHtcbiAgICBzdGFja1N1bW1hcmllczogU3RhY2tTdW1tYXJ5W107XG4gICAgbmV4dFRva2VuOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIH0+ID0+IHtcbiAgICBjb25zdCBzdGFja3M6IExpc3RTdGFja3NDb21tYW5kT3V0cHV0ID0gYXdhaXQgdGhpcy5jZm5DbGllbnQuc2VuZChcbiAgICAgIG5ldyBMaXN0U3RhY2tzQ29tbWFuZCh7XG4gICAgICAgIE5leHRUb2tlbjogbmV4dFRva2VuLFxuICAgICAgICBTdGFja1N0YXR1c0ZpbHRlcjpcbiAgICAgICAgICBzdGFja1N0YXR1c0ZpbHRlci5sZW5ndGggPiAwXG4gICAgICAgICAgICA/IHN0YWNrU3RhdHVzRmlsdGVyXG4gICAgICAgICAgICA6IE9iamVjdC52YWx1ZXMoU3RhY2tTdGF0dXMpLmZpbHRlcihcbiAgICAgICAgICAgICAgICAoc3RhdHVzKSA9PiBzdGF0dXMgIT09IFN0YWNrU3RhdHVzLkRFTEVURV9DT01QTEVURSxcbiAgICAgICAgICAgICAgKSxcbiAgICAgIH0pLFxuICAgICk7XG4gICAgbmV4dFRva2VuID0gc3RhY2tzLk5leHRUb2tlbjtcbiAgICByZXR1cm4geyBzdGFja1N1bW1hcmllczogc3RhY2tzLlN0YWNrU3VtbWFyaWVzID8/IFtdLCBuZXh0VG9rZW4gfTtcbiAgfTtcblxuICBwcml2YXRlIGJ1aWxkQmFja2VuZE1ldGFkYXRhID0gYXN5bmMgKFxuICAgIHN0YWNrTmFtZTogc3RyaW5nLFxuICApOiBQcm9taXNlPEJhY2tlbmRNZXRhZGF0YT4gPT4ge1xuICAgIGNvbnN0IHN0YWNrQmFja2VuZElkZW50aWZpZXIgPSB7XG4gICAgICBzdGFja05hbWUsXG4gICAgfTtcblxuICAgIGNvbnN0IGJhY2tlbmRPdXRwdXQ6IEJhY2tlbmRPdXRwdXQgPVxuICAgICAgYXdhaXQgdGhpcy5iYWNrZW5kT3V0cHV0Q2xpZW50LmdldE91dHB1dChzdGFja0JhY2tlbmRJZGVudGlmaWVyKTtcbiAgICBjb25zdCBzdGFja0Rlc2NyaXB0aW9uID0gYXdhaXQgdGhpcy5jZm5DbGllbnQuc2VuZChcbiAgICAgIG5ldyBEZXNjcmliZVN0YWNrc0NvbW1hbmQoeyBTdGFja05hbWU6IHN0YWNrTmFtZSB9KSxcbiAgICApO1xuICAgIGNvbnN0IHN0YWNrID0gc3RhY2tEZXNjcmlwdGlvbj8uU3RhY2tzPy5bMF07XG4gICAgY29uc3Qgc3RhdHVzID0gdGhpcy5zdGFja1N0YXR1c01hcHBlci50cmFuc2xhdGVTdGFja1N0YXR1cyhcbiAgICAgIHN0YWNrPy5TdGFja1N0YXR1cyxcbiAgICApO1xuICAgIGNvbnN0IGxhc3RVcGRhdGVkID0gc3RhY2s/Lkxhc3RVcGRhdGVkVGltZSA/PyBzdGFjaz8uQ3JlYXRpb25UaW1lO1xuXG4gICAgY29uc3Qgc3RhY2tSZXNvdXJjZXMgPSBhd2FpdCB0aGlzLmNmbkNsaWVudC5zZW5kKFxuICAgICAgbmV3IExpc3RTdGFja1Jlc291cmNlc0NvbW1hbmQoe1xuICAgICAgICBTdGFja05hbWU6IHN0YWNrTmFtZSxcbiAgICAgIH0pLFxuICAgICk7XG4gICAgY29uc3QgY2hpbGRTdGFja1Byb21pc2VzOiBQcm9taXNlPFN0YWNrIHwgdW5kZWZpbmVkPltdID1cbiAgICAgIHN0YWNrUmVzb3VyY2VzLlN0YWNrUmVzb3VyY2VTdW1tYXJpZXM/LmZpbHRlcihcbiAgICAgICAgKHN0YWNrUmVzb3VyY2VTdW1tYXJ5OiBTdGFja1Jlc291cmNlU3VtbWFyeSkgPT4ge1xuICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICBzdGFja1Jlc291cmNlU3VtbWFyeS5SZXNvdXJjZVR5cGUgPT09ICdBV1M6OkNsb3VkRm9ybWF0aW9uOjpTdGFjaydcbiAgICAgICAgICApO1xuICAgICAgICB9LFxuICAgICAgKS5tYXAoYXN5bmMgKHN0YWNrUmVzb3VyY2VTdW1tYXJ5OiBTdGFja1Jlc291cmNlU3VtbWFyeSkgPT4ge1xuICAgICAgICAvLyBhcm46YXdzOntzZXJ2aWNlfTp7cmVnaW9ufTp7YWNjb3VudH06c3RhY2sve3N0YWNrTmFtZX0ve2FkZGl0aW9uYWxGaWVsZHN9XG4gICAgICAgIGNvbnN0IGFyblBhcnRzID0gc3RhY2tSZXNvdXJjZVN1bW1hcnkuUGh5c2ljYWxSZXNvdXJjZUlkPy5zcGxpdCgnLycpO1xuICAgICAgICBjb25zdCBjaGlsZFN0YWNrTmFtZSA9IGFyblBhcnRzPy5bMV07XG4gICAgICAgIGlmICghY2hpbGRTdGFja05hbWUpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc3RhY2tEZXNjcmlwdGlvbiA9IGF3YWl0IHRoaXMuY2ZuQ2xpZW50LnNlbmQoXG4gICAgICAgICAgbmV3IERlc2NyaWJlU3RhY2tzQ29tbWFuZCh7IFN0YWNrTmFtZTogY2hpbGRTdGFja05hbWUgfSksXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3Qgc3RhY2sgPSBzdGFja0Rlc2NyaXB0aW9uPy5TdGFja3M/LlswXTtcbiAgICAgICAgcmV0dXJuIHN0YWNrO1xuICAgICAgfSkgPz8gW107XG5cbiAgICBjb25zdCBjaGlsZFN0YWNrcyA9IGF3YWl0IFByb21pc2UuYWxsKGNoaWxkU3RhY2tQcm9taXNlcyk7XG4gICAgY29uc3QgYXV0aFN0YWNrID0gY2hpbGRTdGFja3MuZmluZChcbiAgICAgIChuZXN0ZWRTdGFjazogU3RhY2tTdW1tYXJ5IHwgdW5kZWZpbmVkKSA9PlxuICAgICAgICBuZXN0ZWRTdGFjaz8uU3RhY2tOYW1lPy5pbmNsdWRlcygnYXV0aCcpLFxuICAgICk7XG4gICAgY29uc3Qgc3RvcmFnZVN0YWNrID0gY2hpbGRTdGFja3MuZmluZChcbiAgICAgIChuZXN0ZWRTdGFjazogU3RhY2tTdW1tYXJ5IHwgdW5kZWZpbmVkKSA9PlxuICAgICAgICBuZXN0ZWRTdGFjaz8uU3RhY2tOYW1lPy5pbmNsdWRlcygnc3RvcmFnZScpLFxuICAgICk7XG4gICAgY29uc3QgYXBpU3RhY2sgPSBjaGlsZFN0YWNrcy5maW5kKChuZXN0ZWRTdGFjazogU3RhY2tTdW1tYXJ5IHwgdW5kZWZpbmVkKSA9PlxuICAgICAgbmVzdGVkU3RhY2s/LlN0YWNrTmFtZT8uaW5jbHVkZXMoJ2RhdGEnKSxcbiAgICApO1xuICAgIGNvbnN0IGZ1bmN0aW9uU3RhY2sgPSBjaGlsZFN0YWNrcy5maW5kKFxuICAgICAgKG5lc3RlZFN0YWNrOiBTdGFja1N1bW1hcnkgfCB1bmRlZmluZWQpID0+XG4gICAgICAgIG5lc3RlZFN0YWNrPy5TdGFja05hbWU/LmluY2x1ZGVzKCdmdW5jdGlvbicpLFxuICAgICk7XG5cbiAgICAvLyBzdGFjaz8uU3RhY2tJZCBpcyB0aGUgQVJOIG9mIHRoZSBzdGFja1xuICAgIGNvbnN0IHsgYWNjb3VudElkLCByZWdpb24gfSA9IHRoaXMuYXJuUGFyc2VyLnRyeVBhcnNlQXJuKFxuICAgICAgc3RhY2s/LlN0YWNrSWQgYXMgc3RyaW5nLFxuICAgICk7XG4gICAgY29uc3QgcmVzb3VyY2VzID1cbiAgICAgIGF3YWl0IHRoaXMuZGVwbG95ZWRSZXNvdXJjZXNFbnVtZXJhdG9yLmxpc3REZXBsb3llZFJlc291cmNlcyhcbiAgICAgICAgdGhpcy5jZm5DbGllbnQsXG4gICAgICAgIHN0YWNrTmFtZSxcbiAgICAgICAgYWNjb3VudElkLFxuICAgICAgICByZWdpb24sXG4gICAgICApO1xuXG4gICAgY29uc3QgYmFja2VuZE1ldGFkYXRhT2JqZWN0OiBCYWNrZW5kTWV0YWRhdGEgPSB7XG4gICAgICBkZXBsb3ltZW50VHlwZTogYmFja2VuZE91dHB1dFtwbGF0Zm9ybU91dHB1dEtleV0ucGF5bG9hZFxuICAgICAgICAuZGVwbG95bWVudFR5cGUgYXMgRGVwbG95bWVudFR5cGUsXG4gICAgICBsYXN0VXBkYXRlZCxcbiAgICAgIHN0YXR1cyxcbiAgICAgIG5hbWU6IHN0YWNrTmFtZSxcbiAgICAgIHJlc291cmNlcyxcbiAgICB9O1xuXG4gICAgaWYgKGF1dGhTdGFjaykge1xuICAgICAgYmFja2VuZE1ldGFkYXRhT2JqZWN0LmF1dGhDb25maWd1cmF0aW9uID0ge1xuICAgICAgICBzdGF0dXM6IHRoaXMuc3RhY2tTdGF0dXNNYXBwZXIudHJhbnNsYXRlU3RhY2tTdGF0dXMoXG4gICAgICAgICAgYXV0aFN0YWNrLlN0YWNrU3RhdHVzLFxuICAgICAgICApLFxuICAgICAgICBsYXN0VXBkYXRlZDogYXV0aFN0YWNrLkxhc3RVcGRhdGVkVGltZSA/PyBhdXRoU3RhY2suQ3JlYXRpb25UaW1lLFxuICAgICAgICB1c2VyUG9vbElkOiBiYWNrZW5kT3V0cHV0W2F1dGhPdXRwdXRLZXldPy5wYXlsb2FkLnVzZXJQb29sSWQgYXMgc3RyaW5nLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoc3RvcmFnZVN0YWNrKSB7XG4gICAgICBiYWNrZW5kTWV0YWRhdGFPYmplY3Quc3RvcmFnZUNvbmZpZ3VyYXRpb24gPSB7XG4gICAgICAgIHN0YXR1czogdGhpcy5zdGFja1N0YXR1c01hcHBlci50cmFuc2xhdGVTdGFja1N0YXR1cyhcbiAgICAgICAgICBzdG9yYWdlU3RhY2suU3RhY2tTdGF0dXMsXG4gICAgICAgICksXG4gICAgICAgIGxhc3RVcGRhdGVkOiBzdG9yYWdlU3RhY2suTGFzdFVwZGF0ZWRUaW1lID8/IHN0b3JhZ2VTdGFjay5DcmVhdGlvblRpbWUsXG4gICAgICAgIHMzQnVja2V0TmFtZTogYmFja2VuZE91dHB1dFtzdG9yYWdlT3V0cHV0S2V5XT8ucGF5bG9hZFxuICAgICAgICAgIC5idWNrZXROYW1lIGFzIHN0cmluZyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKGFwaVN0YWNrKSB7XG4gICAgICBjb25zdCBhZGRpdGlvbmFsQXV0aFR5cGVzU3RyaW5nID0gYmFja2VuZE91dHB1dFtncmFwaHFsT3V0cHV0S2V5XT8ucGF5bG9hZFxuICAgICAgICAuYXdzQXBwc3luY0FkZGl0aW9uYWxBdXRoZW50aWNhdGlvblR5cGVzIGFzIHN0cmluZztcbiAgICAgIGNvbnN0IGFkZGl0aW9uYWxBdXRoVHlwZXMgPSBhZGRpdGlvbmFsQXV0aFR5cGVzU3RyaW5nXG4gICAgICAgID8gKGFkZGl0aW9uYWxBdXRoVHlwZXNTdHJpbmcuc3BsaXQoJywnKSBhcyBBcGlBdXRoVHlwZVtdKVxuICAgICAgICA6IFtdO1xuICAgICAgYmFja2VuZE1ldGFkYXRhT2JqZWN0LmFwaUNvbmZpZ3VyYXRpb24gPSB7XG4gICAgICAgIHN0YXR1czogdGhpcy5zdGFja1N0YXR1c01hcHBlci50cmFuc2xhdGVTdGFja1N0YXR1cyhcbiAgICAgICAgICBhcGlTdGFjay5TdGFja1N0YXR1cyxcbiAgICAgICAgKSxcbiAgICAgICAgbGFzdFVwZGF0ZWQ6IGFwaVN0YWNrLkxhc3RVcGRhdGVkVGltZSA/PyBhcGlTdGFjay5DcmVhdGlvblRpbWUsXG4gICAgICAgIGdyYXBocWxFbmRwb2ludDogYmFja2VuZE91dHB1dFtncmFwaHFsT3V0cHV0S2V5XT8ucGF5bG9hZFxuICAgICAgICAgIC5hd3NBcHBzeW5jQXBpRW5kcG9pbnQgYXMgc3RyaW5nLFxuICAgICAgICBkZWZhdWx0QXV0aFR5cGU6IGJhY2tlbmRPdXRwdXRbZ3JhcGhxbE91dHB1dEtleV0/LnBheWxvYWRcbiAgICAgICAgICAuYXdzQXBwc3luY0F1dGhlbnRpY2F0aW9uVHlwZSBhcyBBcGlBdXRoVHlwZSxcbiAgICAgICAgYWRkaXRpb25hbEF1dGhUeXBlcyxcbiAgICAgICAgY29uZmxpY3RSZXNvbHV0aW9uTW9kZTogYmFja2VuZE91dHB1dFtncmFwaHFsT3V0cHV0S2V5XT8ucGF5bG9hZFxuICAgICAgICAgIC5hd3NBcHBzeW5jQ29uZmxpY3RSZXNvbHV0aW9uTW9kZSBhcyBDb25mbGljdFJlc29sdXRpb25Nb2RlLFxuICAgICAgICBhcGlJZDogYmFja2VuZE91dHB1dFtncmFwaHFsT3V0cHV0S2V5XT8ucGF5bG9hZFxuICAgICAgICAgIC5hd3NBcHBzeW5jQXBpSWQgYXMgc3RyaW5nLFxuICAgICAgICBtb2RlbFNjaGVtYVMzVXJpOiBiYWNrZW5kT3V0cHV0W2dyYXBocWxPdXRwdXRLZXldPy5wYXlsb2FkXG4gICAgICAgICAgLmFtcGxpZnlBcGlNb2RlbFNjaGVtYVMzVXJpIGFzIHN0cmluZyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKGZ1bmN0aW9uU3RhY2spIHtcbiAgICAgIGNvbnN0IGZ1bmN0aW9uUmVzb3VyY2VzID0gcmVzb3VyY2VzLmZpbHRlcihcbiAgICAgICAgKHJlc291cmNlKSA9PiByZXNvdXJjZS5yZXNvdXJjZVR5cGUgPT09ICdBV1M6OkxhbWJkYTo6RnVuY3Rpb24nLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IGZ1bmN0aW9uQ29uZmlndXJhdGlvbnM6IEZ1bmN0aW9uQ29uZmlndXJhdGlvbltdID0gW107XG4gICAgICBjb25zdCBkZWZpbmVkRnVuY3Rpb25zU3RyaW5nID1cbiAgICAgICAgYmFja2VuZE91dHB1dFtmdW5jdGlvbk91dHB1dEtleV0/LnBheWxvYWQuZGVmaW5lZEZ1bmN0aW9ucztcbiAgICAgIGNvbnN0IGN1c3RvbWVyRnVuY3Rpb25OYW1lcyA9IGRlZmluZWRGdW5jdGlvbnNTdHJpbmdcbiAgICAgICAgPyAoSlNPTi5wYXJzZShkZWZpbmVkRnVuY3Rpb25zU3RyaW5nIGFzIHN0cmluZykgYXMgc3RyaW5nW10pXG4gICAgICAgIDogW107XG5cbiAgICAgIGN1c3RvbWVyRnVuY3Rpb25OYW1lcy5mb3JFYWNoKChmdW5jdGlvbk5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBmdW5jdGlvblJlc291cmNlcy5maW5kKFxuICAgICAgICAgIChmdW5jKSA9PiBmdW5jLnBoeXNpY2FsUmVzb3VyY2VJZCA9PT0gZnVuY3Rpb25OYW1lLFxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChyZXNvdXJjZSkge1xuICAgICAgICAgIGZ1bmN0aW9uQ29uZmlndXJhdGlvbnMucHVzaCh7XG4gICAgICAgICAgICBzdGF0dXM6IHRoaXMuc3RhY2tTdGF0dXNNYXBwZXIudHJhbnNsYXRlU3RhY2tTdGF0dXMoXG4gICAgICAgICAgICAgIHJlc291cmNlLnJlc291cmNlU3RhdHVzLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGxhc3RVcGRhdGVkOlxuICAgICAgICAgICAgICByZXNvdXJjZS5sYXN0VXBkYXRlZCA/P1xuICAgICAgICAgICAgICBmdW5jdGlvblN0YWNrLkxhc3RVcGRhdGVkVGltZSA/P1xuICAgICAgICAgICAgICBmdW5jdGlvblN0YWNrLkNyZWF0aW9uVGltZSxcbiAgICAgICAgICAgIGZ1bmN0aW9uTmFtZSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGJhY2tlbmRNZXRhZGF0YU9iamVjdC5mdW5jdGlvbkNvbmZpZ3VyYXRpb25zID0gZnVuY3Rpb25Db25maWd1cmF0aW9ucztcbiAgICB9XG5cbiAgICByZXR1cm4gYmFja2VuZE1ldGFkYXRhT2JqZWN0O1xuICB9O1xuXG4gIHByaXZhdGUgZmV0Y2hTY2hlbWEgPSBhc3luYyAoXG4gICAgc2NoZW1hUzNVcmk6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgKTogUHJvbWlzZTxzdHJpbmc+ID0+IHtcbiAgICBpZiAoIXNjaGVtYVMzVXJpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NjaGVtYVMzVXJpIG91dHB1dCBpcyBub3QgYXZhaWxhYmxlJyk7XG4gICAgfVxuXG4gICAgLy8gczM6Ly97YnVja2V0TmFtZX0ve2ZpbGVOYW1lfVxuICAgIGNvbnN0IHVyaVBhcnRzID0gc2NoZW1hUzNVcmkuc3BsaXQoJy8nKTtcbiAgICBjb25zdCBidWNrZXROYW1lID0gdXJpUGFydHNbMl07XG4gICAgY29uc3Qgb2JqZWN0UGF0aCA9IHVyaVBhcnRzLnNsaWNlKDMsIHVyaVBhcnRzLmxlbmd0aCkuam9pbignLycpO1xuXG4gICAgaWYgKCFidWNrZXROYW1lIHx8ICFvYmplY3RQYXRoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NjaGVtYVMzVXJpIGlzIG5vdCB2YWxpZCcpO1xuICAgIH1cblxuICAgIGNvbnN0IHMzUmVzcG9uc2UgPSBhd2FpdCB0aGlzLnMzQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgR2V0T2JqZWN0Q29tbWFuZCh7IEJ1Y2tldDogYnVja2V0TmFtZSwgS2V5OiBvYmplY3RQYXRoIH0pLFxuICAgICk7XG5cbiAgICBpZiAoIXMzUmVzcG9uc2UuQm9keSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBzM1Jlc3BvbnNlIGZyb20gJHtzY2hlbWFTM1VyaX0gZG9lcyBub3QgY29udGFpbiBhIEJvZHlgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgczNSZXNwb25zZS5Cb2R5Py50cmFuc2Zvcm1Ub1N0cmluZygpO1xuICB9O1xufVxuIl19