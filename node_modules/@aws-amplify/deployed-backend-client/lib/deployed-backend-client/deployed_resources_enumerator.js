import { ListStackResourcesCommand, } from '@aws-sdk/client-cloudformation';
/**
 * Lists deployed resources
 */
export class DeployedResourcesEnumerator {
    stackStatusMapper;
    arnGenerator;
    arnParser;
    /**
     * Constructs a DeployedResourcesEnumerator
     */
    constructor(stackStatusMapper, arnGenerator, arnParser) {
        this.stackStatusMapper = stackStatusMapper;
        this.arnGenerator = arnGenerator;
        this.arnParser = arnParser;
    }
    /**
     * Lists all resources deployed in all nested cfn stacks
     */
    listDeployedResources = async (cfnClient, stackName, accountId, region) => {
        const deployedBackendResources = [];
        const stackResourceSummaries = [];
        let nextToken;
        do {
            const stackResources = await cfnClient.send(new ListStackResourcesCommand({
                StackName: stackName,
                NextToken: nextToken,
            }));
            nextToken = stackResources.NextToken;
            stackResourceSummaries.push(...(stackResources.StackResourceSummaries ?? []));
        } while (nextToken);
        const childStackArns = stackResourceSummaries
            .filter((stackResourceSummary) => {
            return (stackResourceSummary.ResourceType === 'AWS::CloudFormation::Stack');
        })
            .map((stackResourceSummary) => {
            return stackResourceSummary.PhysicalResourceId;
        }) ?? [];
        const promises = childStackArns.map((childStackArn) => {
            const childStackName = childStackArn?.split('/')?.[1];
            if (!childStackArn || !childStackName) {
                return [];
            }
            const parsedArn = this.arnParser.tryParseArn(childStackArn);
            // Recursive call to get all the resources from child stacks
            return this.listDeployedResources(cfnClient, childStackName, parsedArn.accountId, parsedArn.region);
        });
        const deployedResourcesPerChildStack = await Promise.all(promises);
        deployedBackendResources.push(...deployedResourcesPerChildStack.flat());
        const parentStackNonStackResources = stackResourceSummaries.filter((stackResourceSummary) => {
            return (stackResourceSummary.ResourceType !== 'AWS::CloudFormation::Stack');
        }) ?? [];
        const parentDeployedNonStackResources = parentStackNonStackResources.map((stackResourceSummary) => ({
            logicalResourceId: stackResourceSummary.LogicalResourceId,
            lastUpdated: stackResourceSummary.LastUpdatedTimestamp,
            resourceStatus: this.stackStatusMapper.translateStackStatus(stackResourceSummary.ResourceStatus),
            resourceStatusReason: stackResourceSummary.ResourceStatusReason,
            resourceType: stackResourceSummary.ResourceType,
            physicalResourceId: stackResourceSummary.PhysicalResourceId,
            arn: this.arnGenerator.generateArn(stackResourceSummary, region, accountId),
        }));
        deployedBackendResources.push(...parentDeployedNonStackResources);
        return deployedBackendResources;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwbG95ZWRfcmVzb3VyY2VzX2VudW1lcmF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZGVwbG95ZWQtYmFja2VuZC1jbGllbnQvZGVwbG95ZWRfcmVzb3VyY2VzX2VudW1lcmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVMLHlCQUF5QixHQUcxQixNQUFNLGdDQUFnQyxDQUFDO0FBTXhDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLDJCQUEyQjtJQUtuQjtJQUNBO0lBQ0E7SUFObkI7O09BRUc7SUFDSCxZQUNtQixpQkFBb0MsRUFDcEMsWUFBMEIsRUFDMUIsU0FBb0I7UUFGcEIsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixjQUFTLEdBQVQsU0FBUyxDQUFXO0lBQ3BDLENBQUM7SUFFSjs7T0FFRztJQUNILHFCQUFxQixHQUFHLEtBQUssRUFDM0IsU0FBK0IsRUFDL0IsU0FBaUIsRUFDakIsU0FBNkIsRUFDN0IsTUFBMEIsRUFDVSxFQUFFO1FBQ3RDLE1BQU0sd0JBQXdCLEdBQThCLEVBQUUsQ0FBQztRQUMvRCxNQUFNLHNCQUFzQixHQUEyQixFQUFFLENBQUM7UUFDMUQsSUFBSSxTQUFTLENBQUM7UUFDZCxHQUFHO1lBQ0QsTUFBTSxjQUFjLEdBQ2xCLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FDbEIsSUFBSSx5QkFBeUIsQ0FBQztnQkFDNUIsU0FBUyxFQUFFLFNBQVM7Z0JBQ3BCLFNBQVMsRUFBRSxTQUFTO2FBQ3JCLENBQUMsQ0FDSCxDQUFDO1lBRUosU0FBUyxHQUFHLGNBQWMsQ0FBQyxTQUFTLENBQUM7WUFDckMsc0JBQXNCLENBQUMsSUFBSSxDQUN6QixHQUFHLENBQUMsY0FBYyxDQUFDLHNCQUFzQixJQUFJLEVBQUUsQ0FBQyxDQUNqRCxDQUFDO1NBQ0gsUUFBUSxTQUFTLEVBQUU7UUFFcEIsTUFBTSxjQUFjLEdBQ2xCLHNCQUFzQjthQUNuQixNQUFNLENBQUMsQ0FBQyxvQkFBMEMsRUFBRSxFQUFFO1lBQ3JELE9BQU8sQ0FDTCxvQkFBb0IsQ0FBQyxZQUFZLEtBQUssNEJBQTRCLENBQ25FLENBQUM7UUFDSixDQUFDLENBQUM7YUFDRCxHQUFHLENBQUMsQ0FBQyxvQkFBMEMsRUFBRSxFQUFFO1lBQ2xELE9BQU8sb0JBQW9CLENBQUMsa0JBQWtCLENBQUM7UUFDakQsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWIsTUFBTSxRQUFRLEdBQUcsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLGFBQWEsRUFBRSxFQUFFO1lBQ3BELE1BQU0sY0FBYyxHQUFHLGFBQWEsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0RCxJQUFJLENBQUMsYUFBYSxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUNyQyxPQUFPLEVBQUUsQ0FBQzthQUNYO1lBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDNUQsNERBQTREO1lBQzVELE9BQU8sSUFBSSxDQUFDLHFCQUFxQixDQUMvQixTQUFTLEVBQ1QsY0FBYyxFQUNkLFNBQVMsQ0FBQyxTQUFTLEVBQ25CLFNBQVMsQ0FBQyxNQUFNLENBQ2pCLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sOEJBQThCLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ25FLHdCQUF3QixDQUFDLElBQUksQ0FBQyxHQUFHLDhCQUE4QixDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFFeEUsTUFBTSw0QkFBNEIsR0FDaEMsc0JBQXNCLENBQUMsTUFBTSxDQUMzQixDQUFDLG9CQUEwQyxFQUFFLEVBQUU7WUFDN0MsT0FBTyxDQUNMLG9CQUFvQixDQUFDLFlBQVksS0FBSyw0QkFBNEIsQ0FDbkUsQ0FBQztRQUNKLENBQUMsQ0FDRixJQUFJLEVBQUUsQ0FBQztRQUVWLE1BQU0sK0JBQStCLEdBQUcsNEJBQTRCLENBQUMsR0FBRyxDQUN0RSxDQUFDLG9CQUEwQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQy9DLGlCQUFpQixFQUFFLG9CQUFvQixDQUFDLGlCQUFpQjtZQUN6RCxXQUFXLEVBQUUsb0JBQW9CLENBQUMsb0JBQW9CO1lBQ3RELGNBQWMsRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsb0JBQW9CLENBQ3pELG9CQUFvQixDQUFDLGNBQWMsQ0FDcEM7WUFDRCxvQkFBb0IsRUFBRSxvQkFBb0IsQ0FBQyxvQkFBb0I7WUFDL0QsWUFBWSxFQUFFLG9CQUFvQixDQUFDLFlBQVk7WUFDL0Msa0JBQWtCLEVBQUUsb0JBQW9CLENBQUMsa0JBQWtCO1lBQzNELEdBQUcsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FDaEMsb0JBQW9CLEVBQ3BCLE1BQU0sRUFDTixTQUFTLENBQ1Y7U0FDRixDQUFDLENBQ0gsQ0FBQztRQUVGLHdCQUF3QixDQUFDLElBQUksQ0FBQyxHQUFHLCtCQUErQixDQUFDLENBQUM7UUFDbEUsT0FBTyx3QkFBd0IsQ0FBQztJQUNsQyxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICBMaXN0U3RhY2tSZXNvdXJjZXNDb21tYW5kLFxuICBMaXN0U3RhY2tSZXNvdXJjZXNDb21tYW5kT3V0cHV0LFxuICBTdGFja1Jlc291cmNlU3VtbWFyeSxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNsb3VkZm9ybWF0aW9uJztcbmltcG9ydCB7IERlcGxveWVkQmFja2VuZFJlc291cmNlIH0gZnJvbSAnLi4vZGVwbG95ZWRfYmFja2VuZF9jbGllbnRfZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBTdGFja1N0YXR1c01hcHBlciB9IGZyb20gJy4vc3RhY2tfc3RhdHVzX21hcHBlci5qcyc7XG5pbXBvcnQgeyBBcm5HZW5lcmF0b3IgfSBmcm9tICcuL2Fybl9nZW5lcmF0b3IuanMnO1xuaW1wb3J0IHsgQXJuUGFyc2VyIH0gZnJvbSAnLi9hcm5fcGFyc2VyLmpzJztcblxuLyoqXG4gKiBMaXN0cyBkZXBsb3llZCByZXNvdXJjZXNcbiAqL1xuZXhwb3J0IGNsYXNzIERlcGxveWVkUmVzb3VyY2VzRW51bWVyYXRvciB7XG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RzIGEgRGVwbG95ZWRSZXNvdXJjZXNFbnVtZXJhdG9yXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0YWNrU3RhdHVzTWFwcGVyOiBTdGFja1N0YXR1c01hcHBlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFybkdlbmVyYXRvcjogQXJuR2VuZXJhdG9yLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXJuUGFyc2VyOiBBcm5QYXJzZXIsXG4gICkge31cblxuICAvKipcbiAgICogTGlzdHMgYWxsIHJlc291cmNlcyBkZXBsb3llZCBpbiBhbGwgbmVzdGVkIGNmbiBzdGFja3NcbiAgICovXG4gIGxpc3REZXBsb3llZFJlc291cmNlcyA9IGFzeW5jIChcbiAgICBjZm5DbGllbnQ6IENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICAgIHN0YWNrTmFtZTogc3RyaW5nLFxuICAgIGFjY291bnRJZDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICAgIHJlZ2lvbjogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICApOiBQcm9taXNlPERlcGxveWVkQmFja2VuZFJlc291cmNlW10+ID0+IHtcbiAgICBjb25zdCBkZXBsb3llZEJhY2tlbmRSZXNvdXJjZXM6IERlcGxveWVkQmFja2VuZFJlc291cmNlW10gPSBbXTtcbiAgICBjb25zdCBzdGFja1Jlc291cmNlU3VtbWFyaWVzOiBTdGFja1Jlc291cmNlU3VtbWFyeVtdID0gW107XG4gICAgbGV0IG5leHRUb2tlbjtcbiAgICBkbyB7XG4gICAgICBjb25zdCBzdGFja1Jlc291cmNlczogTGlzdFN0YWNrUmVzb3VyY2VzQ29tbWFuZE91dHB1dCA9XG4gICAgICAgIGF3YWl0IGNmbkNsaWVudC5zZW5kKFxuICAgICAgICAgIG5ldyBMaXN0U3RhY2tSZXNvdXJjZXNDb21tYW5kKHtcbiAgICAgICAgICAgIFN0YWNrTmFtZTogc3RhY2tOYW1lLFxuICAgICAgICAgICAgTmV4dFRva2VuOiBuZXh0VG9rZW4sXG4gICAgICAgICAgfSksXG4gICAgICAgICk7XG5cbiAgICAgIG5leHRUb2tlbiA9IHN0YWNrUmVzb3VyY2VzLk5leHRUb2tlbjtcbiAgICAgIHN0YWNrUmVzb3VyY2VTdW1tYXJpZXMucHVzaChcbiAgICAgICAgLi4uKHN0YWNrUmVzb3VyY2VzLlN0YWNrUmVzb3VyY2VTdW1tYXJpZXMgPz8gW10pLFxuICAgICAgKTtcbiAgICB9IHdoaWxlIChuZXh0VG9rZW4pO1xuXG4gICAgY29uc3QgY2hpbGRTdGFja0FybnM6IChzdHJpbmcgfCB1bmRlZmluZWQpW10gPVxuICAgICAgc3RhY2tSZXNvdXJjZVN1bW1hcmllc1xuICAgICAgICAuZmlsdGVyKChzdGFja1Jlc291cmNlU3VtbWFyeTogU3RhY2tSZXNvdXJjZVN1bW1hcnkpID0+IHtcbiAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgc3RhY2tSZXNvdXJjZVN1bW1hcnkuUmVzb3VyY2VUeXBlID09PSAnQVdTOjpDbG91ZEZvcm1hdGlvbjo6U3RhY2snXG4gICAgICAgICAgKTtcbiAgICAgICAgfSlcbiAgICAgICAgLm1hcCgoc3RhY2tSZXNvdXJjZVN1bW1hcnk6IFN0YWNrUmVzb3VyY2VTdW1tYXJ5KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHN0YWNrUmVzb3VyY2VTdW1tYXJ5LlBoeXNpY2FsUmVzb3VyY2VJZDtcbiAgICAgICAgfSkgPz8gW107XG5cbiAgICBjb25zdCBwcm9taXNlcyA9IGNoaWxkU3RhY2tBcm5zLm1hcCgoY2hpbGRTdGFja0FybikgPT4ge1xuICAgICAgY29uc3QgY2hpbGRTdGFja05hbWUgPSBjaGlsZFN0YWNrQXJuPy5zcGxpdCgnLycpPy5bMV07XG4gICAgICBpZiAoIWNoaWxkU3RhY2tBcm4gfHwgIWNoaWxkU3RhY2tOYW1lKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcGFyc2VkQXJuID0gdGhpcy5hcm5QYXJzZXIudHJ5UGFyc2VBcm4oY2hpbGRTdGFja0Fybik7XG4gICAgICAvLyBSZWN1cnNpdmUgY2FsbCB0byBnZXQgYWxsIHRoZSByZXNvdXJjZXMgZnJvbSBjaGlsZCBzdGFja3NcbiAgICAgIHJldHVybiB0aGlzLmxpc3REZXBsb3llZFJlc291cmNlcyhcbiAgICAgICAgY2ZuQ2xpZW50LFxuICAgICAgICBjaGlsZFN0YWNrTmFtZSxcbiAgICAgICAgcGFyc2VkQXJuLmFjY291bnRJZCxcbiAgICAgICAgcGFyc2VkQXJuLnJlZ2lvbixcbiAgICAgICk7XG4gICAgfSk7XG4gICAgY29uc3QgZGVwbG95ZWRSZXNvdXJjZXNQZXJDaGlsZFN0YWNrID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgIGRlcGxveWVkQmFja2VuZFJlc291cmNlcy5wdXNoKC4uLmRlcGxveWVkUmVzb3VyY2VzUGVyQ2hpbGRTdGFjay5mbGF0KCkpO1xuXG4gICAgY29uc3QgcGFyZW50U3RhY2tOb25TdGFja1Jlc291cmNlczogU3RhY2tSZXNvdXJjZVN1bW1hcnlbXSA9XG4gICAgICBzdGFja1Jlc291cmNlU3VtbWFyaWVzLmZpbHRlcihcbiAgICAgICAgKHN0YWNrUmVzb3VyY2VTdW1tYXJ5OiBTdGFja1Jlc291cmNlU3VtbWFyeSkgPT4ge1xuICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICBzdGFja1Jlc291cmNlU3VtbWFyeS5SZXNvdXJjZVR5cGUgIT09ICdBV1M6OkNsb3VkRm9ybWF0aW9uOjpTdGFjaydcbiAgICAgICAgICApO1xuICAgICAgICB9LFxuICAgICAgKSA/PyBbXTtcblxuICAgIGNvbnN0IHBhcmVudERlcGxveWVkTm9uU3RhY2tSZXNvdXJjZXMgPSBwYXJlbnRTdGFja05vblN0YWNrUmVzb3VyY2VzLm1hcChcbiAgICAgIChzdGFja1Jlc291cmNlU3VtbWFyeTogU3RhY2tSZXNvdXJjZVN1bW1hcnkpID0+ICh7XG4gICAgICAgIGxvZ2ljYWxSZXNvdXJjZUlkOiBzdGFja1Jlc291cmNlU3VtbWFyeS5Mb2dpY2FsUmVzb3VyY2VJZCxcbiAgICAgICAgbGFzdFVwZGF0ZWQ6IHN0YWNrUmVzb3VyY2VTdW1tYXJ5Lkxhc3RVcGRhdGVkVGltZXN0YW1wLFxuICAgICAgICByZXNvdXJjZVN0YXR1czogdGhpcy5zdGFja1N0YXR1c01hcHBlci50cmFuc2xhdGVTdGFja1N0YXR1cyhcbiAgICAgICAgICBzdGFja1Jlc291cmNlU3VtbWFyeS5SZXNvdXJjZVN0YXR1cyxcbiAgICAgICAgKSxcbiAgICAgICAgcmVzb3VyY2VTdGF0dXNSZWFzb246IHN0YWNrUmVzb3VyY2VTdW1tYXJ5LlJlc291cmNlU3RhdHVzUmVhc29uLFxuICAgICAgICByZXNvdXJjZVR5cGU6IHN0YWNrUmVzb3VyY2VTdW1tYXJ5LlJlc291cmNlVHlwZSxcbiAgICAgICAgcGh5c2ljYWxSZXNvdXJjZUlkOiBzdGFja1Jlc291cmNlU3VtbWFyeS5QaHlzaWNhbFJlc291cmNlSWQsXG4gICAgICAgIGFybjogdGhpcy5hcm5HZW5lcmF0b3IuZ2VuZXJhdGVBcm4oXG4gICAgICAgICAgc3RhY2tSZXNvdXJjZVN1bW1hcnksXG4gICAgICAgICAgcmVnaW9uLFxuICAgICAgICAgIGFjY291bnRJZCxcbiAgICAgICAgKSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICBkZXBsb3llZEJhY2tlbmRSZXNvdXJjZXMucHVzaCguLi5wYXJlbnREZXBsb3llZE5vblN0YWNrUmVzb3VyY2VzKTtcbiAgICByZXR1cm4gZGVwbG95ZWRCYWNrZW5kUmVzb3VyY2VzO1xuICB9O1xufVxuIl19