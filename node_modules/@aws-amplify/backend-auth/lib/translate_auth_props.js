/**
 * Translate an Auth factory's loginWith to its Auth construct counterpart. Backend secret fields will be resolved
 * to an CFN token and map to the required construct type. Note that not all construct secret fields are of sdk
 * SecretValue type, many are (wrongly) of type string as well.
 */
export const translateToAuthConstructLoginWith = (authFactoryLoginWith, backendSecretResolver) => {
    const result = authFactoryLoginWith;
    if (!authFactoryLoginWith.externalProviders) {
        return result;
    }
    const externalProviders = authFactoryLoginWith.externalProviders;
    result.externalProviders = {
        ...externalProviders,
    };
    const amazonProps = translateAmazonProps(backendSecretResolver, externalProviders.loginWithAmazon);
    if (amazonProps) {
        result.externalProviders.loginWithAmazon = amazonProps;
    }
    const appleProps = translateAppleProps(backendSecretResolver, externalProviders.signInWithApple);
    if (appleProps) {
        result.externalProviders.signInWithApple = appleProps;
    }
    const facebookProps = translateFacebookProps(backendSecretResolver, externalProviders.facebook);
    if (facebookProps) {
        result.externalProviders.facebook = facebookProps;
    }
    const oidcProps = translateOidcProps(backendSecretResolver, externalProviders.oidc);
    if (oidcProps) {
        result.externalProviders.oidc = oidcProps;
    }
    const googleProps = translateGoogleProps(backendSecretResolver, externalProviders.google);
    if (googleProps) {
        result.externalProviders.google = googleProps;
    }
    return result;
};
/**
 * Translates the senders property from AmplifyAuthProps to AuthProps format.
 * @param senders - The senders object from AmplifyAuthProps.
 * @param getInstanceProps - Properties used to get an instance of the sender.
 * @returns The translated senders object in AuthProps format, or undefined if no valid sender is provided.
 * @description
 * This function handles the translation of the 'senders' property, specifically for email and sms senders.
 * If no senders are provided, it returns undefined.
 * If a sender has a 'getInstance' method, it retrieves the Lambda function and returns it.
 * Otherwise, it returns the sender as is.
 */
export const translateToAuthConstructSenders = (senders, getInstanceProps) => {
    if (!senders || !(senders.email || senders.sms)) {
        return undefined;
    }
    const authConstructSenders = {};
    // Handle CustomEmailSender type
    if (senders.email && 'handler' in senders.email) {
        const lambda = 'getInstance' in senders.email.handler
            ? senders.email.handler.getInstance(getInstanceProps).resources.lambda
            : senders.email.handler;
        authConstructSenders.email = {
            handler: lambda,
            kmsKeyArn: senders.email.kmsKeyArn,
        };
    }
    else if (senders.email && 'fromEmail' in senders.email) {
        // Handle SES configuration
        authConstructSenders.email = { ...senders.email };
    }
    // Handle CustomSmsSender type
    if (senders.sms && 'handler' in senders.sms) {
        const lambda = 'getInstance' in senders.sms.handler
            ? senders.sms.handler.getInstance(getInstanceProps).resources.lambda
            : senders.sms.handler;
        authConstructSenders.sms = {
            handler: lambda,
            kmsKeyArn: senders.sms.kmsKeyArn,
        };
    }
    else if (senders.sms) {
        // Handle SNS configuration
        authConstructSenders.sms = { ...senders.sms };
    }
    return authConstructSenders;
};
const translateAmazonProps = (backendSecretResolver, amazonProviderProps) => {
    if (!amazonProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret, ...noSecretProps } = amazonProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver
            .resolveSecret(clientSecret)
            .unsafeUnwrap(),
    };
};
const translateAppleProps = (backendSecretResolver, amazonProviderProps) => {
    if (!amazonProviderProps) {
        return undefined;
    }
    const { clientId, teamId, keyId, privateKey, ...noSecretProps } = amazonProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        teamId: backendSecretResolver.resolveSecret(teamId).unsafeUnwrap(),
        keyId: backendSecretResolver.resolveSecret(keyId).unsafeUnwrap(),
        privateKey: backendSecretResolver.resolveSecret(privateKey).unsafeUnwrap(),
    };
};
const translateFacebookProps = (backendSecretResolver, facebookProviderProps) => {
    if (!facebookProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret, ...noSecretProps } = facebookProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver
            .resolveSecret(clientSecret)
            .unsafeUnwrap(),
    };
};
const translateOidcProps = (backendSecretResolver, oidcProviderProps) => {
    if (!oidcProviderProps || oidcProviderProps.length === 0) {
        return undefined;
    }
    const result = [];
    for (const provider of oidcProviderProps) {
        const { clientId, clientSecret, ...noSecretProps } = provider;
        result.push({
            ...noSecretProps,
            clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
            clientSecret: backendSecretResolver
                .resolveSecret(clientSecret)
                .unsafeUnwrap(),
        });
    }
    return result;
};
const translateGoogleProps = (backendSecretResolver, googleProviderProps) => {
    if (!googleProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret: clientSecretValue, ...noSecretProps } = googleProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver.resolveSecret(clientSecretValue),
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNsYXRlX2F1dGhfcHJvcHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdHJhbnNsYXRlX2F1dGhfcHJvcHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBd0JBOzs7O0dBSUc7QUFDSCxNQUFNLENBQUMsTUFBTSxpQ0FBaUMsR0FBRyxDQUMvQyxvQkFBK0MsRUFDL0MscUJBQTRDLEVBQ3BCLEVBQUU7SUFDMUIsTUFBTSxNQUFNLEdBQ1Ysb0JBQThDLENBQUM7SUFDakQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGlCQUFpQixFQUFFO1FBQzNDLE9BQU8sTUFBTSxDQUFDO0tBQ2Y7SUFFRCxNQUFNLGlCQUFpQixHQUFHLG9CQUFvQixDQUFDLGlCQUFpQixDQUFDO0lBQ2pFLE1BQU0sQ0FBQyxpQkFBaUIsR0FBRztRQUN6QixHQUFJLGlCQUF5RDtLQUM5RCxDQUFDO0lBRUYsTUFBTSxXQUFXLEdBQUcsb0JBQW9CLENBQ3RDLHFCQUFxQixFQUNyQixpQkFBaUIsQ0FBQyxlQUFlLENBQ2xDLENBQUM7SUFDRixJQUFJLFdBQVcsRUFBRTtRQUNmLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLEdBQUcsV0FBVyxDQUFDO0tBQ3hEO0lBRUQsTUFBTSxVQUFVLEdBQUcsbUJBQW1CLENBQ3BDLHFCQUFxQixFQUNyQixpQkFBaUIsQ0FBQyxlQUFlLENBQ2xDLENBQUM7SUFDRixJQUFJLFVBQVUsRUFBRTtRQUNkLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLEdBQUcsVUFBVSxDQUFDO0tBQ3ZEO0lBRUQsTUFBTSxhQUFhLEdBQUcsc0JBQXNCLENBQzFDLHFCQUFxQixFQUNyQixpQkFBaUIsQ0FBQyxRQUFRLENBQzNCLENBQUM7SUFDRixJQUFJLGFBQWEsRUFBRTtRQUNqQixNQUFNLENBQUMsaUJBQWlCLENBQUMsUUFBUSxHQUFHLGFBQWEsQ0FBQztLQUNuRDtJQUVELE1BQU0sU0FBUyxHQUFHLGtCQUFrQixDQUNsQyxxQkFBcUIsRUFD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QUFpQixDQUFDO0tBQ3JFLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBbWF6b25Qcm92aWRlclByb3BzLFxuICBBcHBsZVByb3ZpZGVyUHJvcHMsXG4gIEF1dGhQcm9wcyxcbiAgRmFjZWJvb2tQcm92aWRlclByb3BzLFxuICBHb29nbGVQcm92aWRlclByb3BzLFxuICBPaWRjUHJvdmlkZXJQcm9wcyxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2F1dGgtY29uc3RydWN0JztcbmltcG9ydCB7XG4gIEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHtcbiAgQW1hem9uUHJvdmlkZXJGYWN0b3J5UHJvcHMsXG4gIEFwcGxlUHJvdmlkZXJGYWN0b3J5UHJvcHMsXG4gIEF1dGhMb2dpbldpdGhGYWN0b3J5UHJvcHMsXG4gIEV4dGVybmFsUHJvdmlkZXJHZW5lcmFsRmFjdG9yeVByb3BzLFxuICBGYWNlYm9va1Byb3ZpZGVyRmFjdG9yeVByb3BzLFxuICBHb29nbGVQcm92aWRlckZhY3RvcnlQcm9wcyxcbiAgT2lkY1Byb3ZpZGVyRmFjdG9yeVByb3BzLFxufSBmcm9tICcuL3R5cGVzLmpzJztcbmltcG9ydCB7IElGdW5jdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgQW1wbGlmeUF1dGhQcm9wcyB9IGZyb20gJy4vZmFjdG9yeS5qcyc7XG5cbi8qKlxuICogVHJhbnNsYXRlIGFuIEF1dGggZmFjdG9yeSdzIGxvZ2luV2l0aCB0byBpdHMgQXV0aCBjb25zdHJ1Y3QgY291bnRlcnBhcnQuIEJhY2tlbmQgc2VjcmV0IGZpZWxkcyB3aWxsIGJlIHJlc29sdmVkXG4gKiB0byBhbiBDRk4gdG9rZW4gYW5kIG1hcCB0byB0aGUgcmVxdWlyZWQgY29uc3RydWN0IHR5cGUuIE5vdGUgdGhhdCBub3QgYWxsIGNvbnN0cnVjdCBzZWNyZXQgZmllbGRzIGFyZSBvZiBzZGtcbiAqIFNlY3JldFZhbHVlIHR5cGUsIG1hbnkgYXJlICh3cm9uZ2x5KSBvZiB0eXBlIHN0cmluZyBhcyB3ZWxsLlxuICovXG5leHBvcnQgY29uc3QgdHJhbnNsYXRlVG9BdXRoQ29uc3RydWN0TG9naW5XaXRoID0gKFxuICBhdXRoRmFjdG9yeUxvZ2luV2l0aDogQXV0aExvZ2luV2l0aEZhY3RvcnlQcm9wcyxcbiAgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4pOiBBdXRoUHJvcHNbJ2xvZ2luV2l0aCddID0+IHtcbiAgY29uc3QgcmVzdWx0OiBBdXRoUHJvcHNbJ2xvZ2luV2l0aCddID1cbiAgICBhdXRoRmFjdG9yeUxvZ2luV2l0aCBhcyBBdXRoUHJvcHNbJ2xvZ2luV2l0aCddO1xuICBpZiAoIWF1dGhGYWN0b3J5TG9naW5XaXRoLmV4dGVybmFsUHJvdmlkZXJzKSB7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGNvbnN0IGV4dGVybmFsUHJvdmlkZXJzID0gYXV0aEZhY3RvcnlMb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnM7XG4gIHJlc3VsdC5leHRlcm5hbFByb3ZpZGVycyA9IHtcbiAgICAuLi4oZXh0ZXJuYWxQcm92aWRlcnMgYXMgRXh0ZXJuYWxQcm92aWRlckdlbmVyYWxGYWN0b3J5UHJvcHMpLFxuICB9O1xuXG4gIGNvbnN0IGFtYXpvblByb3BzID0gdHJhbnNsYXRlQW1hem9uUHJvcHMoXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIGV4dGVybmFsUHJvdmlkZXJzLmxvZ2luV2l0aEFtYXpvbixcbiAgKTtcbiAgaWYgKGFtYXpvblByb3BzKSB7XG4gICAgcmVzdWx0LmV4dGVybmFsUHJvdmlkZXJzLmxvZ2luV2l0aEFtYXpvbiA9IGFtYXpvblByb3BzO1xuICB9XG5cbiAgY29uc3QgYXBwbGVQcm9wcyA9IHRyYW5zbGF0ZUFwcGxlUHJvcHMoXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIGV4dGVybmFsUHJvdmlkZXJzLnNpZ25JbldpdGhBcHBsZSxcbiAgKTtcbiAgaWYgKGFwcGxlUHJvcHMpIHtcbiAgICByZXN1bHQuZXh0ZXJuYWxQcm92aWRlcnMuc2lnbkluV2l0aEFwcGxlID0gYXBwbGVQcm9wcztcbiAgfVxuXG4gIGNvbnN0IGZhY2Vib29rUHJvcHMgPSB0cmFuc2xhdGVGYWNlYm9va1Byb3BzKFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBleHRlcm5hbFByb3ZpZGVycy5mYWNlYm9vayxcbiAgKTtcbiAgaWYgKGZhY2Vib29rUHJvcHMpIHtcbiAgICByZXN1bHQuZXh0ZXJuYWxQcm92aWRlcnMuZmFjZWJvb2sgPSBmYWNlYm9va1Byb3BzO1xuICB9XG5cbiAgY29uc3Qgb2lkY1Byb3BzID0gdHJhbnNsYXRlT2lkY1Byb3BzKFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBleHRlcm5hbFByb3ZpZGVycy5vaWRjLFxuICApO1xuICBpZiAob2lkY1Byb3BzKSB7XG4gICAgcmVzdWx0LmV4dGVybmFsUHJvdmlkZXJzLm9pZGMgPSBvaWRjUHJvcHM7XG4gIH1cblxuICBjb25zdCBnb29nbGVQcm9wcyA9IHRyYW5zbGF0ZUdvb2dsZVByb3BzKFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBleHRlcm5hbFByb3ZpZGVycy5nb29nbGUsXG4gICk7XG4gIGlmIChnb29nbGVQcm9wcykge1xuICAgIHJlc3VsdC5leHRlcm5hbFByb3ZpZGVycy5nb29nbGUgPSBnb29nbGVQcm9wcztcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59O1xuLyoqXG4gKiBUcmFuc2xhdGVzIHRoZSBzZW5kZXJzIHByb3BlcnR5IGZyb20gQW1wbGlmeUF1dGhQcm9wcyB0byBBdXRoUHJvcHMgZm9ybWF0LlxuICogQHBhcmFtIHNlbmRlcnMgLSBUaGUgc2VuZGVycyBvYmplY3QgZnJvbSBBbXBsaWZ5QXV0aFByb3BzLlxuICogQHBhcmFtIGdldEluc3RhbmNlUHJvcHMgLSBQcm9wZXJ0aWVzIHVzZWQgdG8gZ2V0IGFuIGluc3RhbmNlIG9mIHRoZSBzZW5kZXIuXG4gKiBAcmV0dXJucyBUaGUgdHJhbnNsYXRlZCBzZW5kZXJzIG9iamVjdCBpbiBBdXRoUHJvcHMgZm9ybWF0LCBvciB1bmRlZmluZWQgaWYgbm8gdmFsaWQgc2VuZGVyIGlzIHByb3ZpZGVkLlxuICogQGRlc2NyaXB0aW9uXG4gKiBUaGlzIGZ1bmN0aW9uIGhhbmRsZXMgdGhlIHRyYW5zbGF0aW9uIG9mIHRoZSAnc2VuZGVycycgcHJvcGVydHksIHNwZWNpZmljYWxseSBmb3IgZW1haWwgYW5kIHNtcyBzZW5kZXJzLlxuICogSWYgbm8gc2VuZGVycyBhcmUgcHJvdmlkZWQsIGl0IHJldHVybnMgdW5kZWZpbmVkLlxuICogSWYgYSBzZW5kZXIgaGFzIGEgJ2dldEluc3RhbmNlJyBtZXRob2QsIGl0IHJldHJpZXZlcyB0aGUgTGFtYmRhIGZ1bmN0aW9uIGFuZCByZXR1cm5zIGl0LlxuICogT3RoZXJ3aXNlLCBpdCByZXR1cm5zIHRoZSBzZW5kZXIgYXMgaXMuXG4gKi9cbmV4cG9ydCBjb25zdCB0cmFuc2xhdGVUb0F1dGhDb25zdHJ1Y3RTZW5kZXJzID0gKFxuICBzZW5kZXJzOiBBbXBsaWZ5QXV0aFByb3BzWydzZW5kZXJzJ10gfCB1bmRlZmluZWQsXG4gIGdldEluc3RhbmNlUHJvcHM6IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuKTogQXV0aFByb3BzWydzZW5kZXJzJ10gfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoIXNlbmRlcnMgfHwgIShzZW5kZXJzLmVtYWlsIHx8IHNlbmRlcnMuc21zKSkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCBhdXRoQ29uc3RydWN0U2VuZGVyczogQXV0aFByb3BzWydzZW5kZXJzJ10gPSB7fTtcblxuICAvLyBIYW5kbGUgQ3VzdG9tRW1haWxTZW5kZXIgdHlwZVxuICBpZiAoc2VuZGVycy5lbWFpbCAmJiAnaGFuZGxlcicgaW4gc2VuZGVycy5lbWFpbCkge1xuICAgIGNvbnN0IGxhbWJkYTogSUZ1bmN0aW9uID1cbiAgICAgICdnZXRJbnN0YW5jZScgaW4gc2VuZGVycy5lbWFpbC5oYW5kbGVyXG4gICAgICAgID8gc2VuZGVycy5lbWFpbC5oYW5kbGVyLmdldEluc3RhbmNlKGdldEluc3RhbmNlUHJvcHMpLnJlc291cmNlcy5sYW1iZGFcbiAgICAgICAgOiBzZW5kZXJzLmVtYWlsLmhhbmRsZXI7XG5cbiAgICBhdXRoQ29uc3RydWN0U2VuZGVycy5lbWFpbCA9IHtcbiAgICAgIGhhbmRsZXI6IGxhbWJkYSxcbiAgICAgIGttc0tleUFybjogc2VuZGVycy5lbWFpbC5rbXNLZXlBcm4sXG4gICAgfTtcbiAgfSBlbHNlIGlmIChzZW5kZXJzLmVtYWlsICYmICdmcm9tRW1haWwnIGluIHNlbmRlcnMuZW1haWwpIHtcbiAgICAvLyBIYW5kbGUgU0VTIGNvbmZpZ3VyYXRpb25cbiAgICBhdXRoQ29uc3RydWN0U2VuZGVycy5lbWFpbCA9IHsgLi4uc2VuZGVycy5lbWFpbCB9O1xuICB9XG5cbiAgLy8gSGFuZGxlIEN1c3RvbVNtc1NlbmRlciB0eXBlXG4gIGlmIChzZW5kZXJzLnNtcyAmJiAnaGFuZGxlcicgaW4gc2VuZGVycy5zbXMpIHtcbiAgICBjb25zdCBsYW1iZGE6IElGdW5jdGlvbiA9XG4gICAgICAnZ2V0SW5zdGFuY2UnIGluIHNlbmRlcnMuc21zLmhhbmRsZXJcbiAgICAgICAgPyBzZW5kZXJzLnNtcy5oYW5kbGVyLmdldEluc3RhbmNlKGdldEluc3RhbmNlUHJvcHMpLnJlc291cmNlcy5sYW1iZGFcbiAgICAgICAgOiBzZW5kZXJzLnNtcy5oYW5kbGVyO1xuXG4gICAgYXV0aENvbnN0cnVjdFNlbmRlcnMuc21zID0ge1xuICAgICAgaGFuZGxlcjogbGFtYmRhLFxuICAgICAga21zS2V5QXJuOiBzZW5kZXJzLnNtcy5rbXNLZXlBcm4sXG4gICAgfTtcbiAgfSBlbHNlIGlmIChzZW5kZXJzLnNtcykge1xuICAgIC8vIEhhbmRsZSBTTlMgY29uZmlndXJhdGlvblxuICAgIGF1dGhDb25zdHJ1Y3RTZW5kZXJzLnNtcyA9IHsgLi4uc2VuZGVycy5zbXMgfTtcbiAgfVxuICByZXR1cm4gYXV0aENvbnN0cnVjdFNlbmRlcnM7XG59O1xuXG5jb25zdCB0cmFuc2xhdGVBbWF6b25Qcm9wcyA9IChcbiAgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIGFtYXpvblByb3ZpZGVyUHJvcHM/OiBBbWF6b25Qcm92aWRlckZhY3RvcnlQcm9wcyxcbik6IEFtYXpvblByb3ZpZGVyUHJvcHMgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoIWFtYXpvblByb3ZpZGVyUHJvcHMpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgeyBjbGllbnRJZCwgY2xpZW50U2VjcmV0LCAuLi5ub1NlY3JldFByb3BzIH0gPSBhbWF6b25Qcm92aWRlclByb3BzO1xuICByZXR1cm4ge1xuICAgIC4uLm5vU2VjcmV0UHJvcHMsXG4gICAgY2xpZW50SWQ6IGJhY2tlbmRTZWNyZXRSZXNvbHZlci5yZXNvbHZlU2VjcmV0KGNsaWVudElkKS51bnNhZmVVbndyYXAoKSxcbiAgICBjbGllbnRTZWNyZXQ6IGJhY2tlbmRTZWNyZXRSZXNvbHZlclxuICAgICAgLnJlc29sdmVTZWNyZXQoY2xpZW50U2VjcmV0KVxuICAgICAgLnVuc2FmZVVud3JhcCgpLFxuICB9O1xufTtcblxuY29uc3QgdHJhbnNsYXRlQXBwbGVQcm9wcyA9IChcbiAgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIGFtYXpvblByb3ZpZGVyUHJvcHM/OiBBcHBsZVByb3ZpZGVyRmFjdG9yeVByb3BzLFxuKTogQXBwbGVQcm92aWRlclByb3BzIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFhbWF6b25Qcm92aWRlclByb3BzKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IHsgY2xpZW50SWQsIHRlYW1JZCwga2V5SWQsIHByaXZhdGVLZXksIC4uLm5vU2VjcmV0UHJvcHMgfSA9XG4gICAgYW1hem9uUHJvdmlkZXJQcm9wcztcbiAgcmV0dXJuIHtcbiAgICAuLi5ub1NlY3JldFByb3BzLFxuICAgIGNsaWVudElkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRJZCkudW5zYWZlVW53cmFwKCksXG4gICAgdGVhbUlkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldCh0ZWFtSWQpLnVuc2FmZVVud3JhcCgpLFxuICAgIGtleUlkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChrZXlJZCkudW5zYWZlVW53cmFwKCksXG4gICAgcHJpdmF0ZUtleTogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQocHJpdmF0ZUtleSkudW5zYWZlVW53cmFwKCksXG4gIH07XG59O1xuXG5jb25zdCB0cmFuc2xhdGVGYWNlYm9va1Byb3BzID0gKFxuICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgZmFjZWJvb2tQcm92aWRlclByb3BzPzogRmFjZWJvb2tQcm92aWRlckZhY3RvcnlQcm9wcyxcbik6IEZhY2Vib29rUHJvdmlkZXJQcm9wcyB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmICghZmFjZWJvb2tQcm92aWRlclByb3BzKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IHsgY2xpZW50SWQsIGNsaWVudFNlY3JldCwgLi4ubm9TZWNyZXRQcm9wcyB9ID0gZmFjZWJvb2tQcm92aWRlclByb3BzO1xuICByZXR1cm4ge1xuICAgIC4uLm5vU2VjcmV0UHJvcHMsXG4gICAgY2xpZW50SWQ6IGJhY2tlbmRTZWNyZXRSZXNvbHZlci5yZXNvbHZlU2VjcmV0KGNsaWVudElkKS51bnNhZmVVbndyYXAoKSxcbiAgICBjbGllbnRTZWNyZXQ6IGJhY2tlbmRTZWNyZXRSZXNvbHZlclxuICAgICAgLnJlc29sdmVTZWNyZXQoY2xpZW50U2VjcmV0KVxuICAgICAgLnVuc2FmZVVud3JhcCgpLFxuICB9O1xufTtcblxuY29uc3QgdHJhbnNsYXRlT2lkY1Byb3BzID0gKFxuICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgb2lkY1Byb3ZpZGVyUHJvcHM/OiBPaWRjUHJvdmlkZXJGYWN0b3J5UHJvcHNbXSxcbik6IE9pZGNQcm92aWRlclByb3BzW10gfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoIW9pZGNQcm92aWRlclByb3BzIHx8IG9pZGNQcm92aWRlclByb3BzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCByZXN1bHQgPSBbXTtcbiAgZm9yIChjb25zdCBwcm92aWRlciBvZiBvaWRjUHJvdmlkZXJQcm9wcykge1xuICAgIGNvbnN0IHsgY2xpZW50SWQsIGNsaWVudFNlY3JldCwgLi4ubm9TZWNyZXRQcm9wcyB9ID0gcHJvdmlkZXI7XG4gICAgcmVzdWx0LnB1c2goe1xuICAgICAgLi4ubm9TZWNyZXRQcm9wcyxcbiAgICAgIGNsaWVudElkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRJZCkudW5zYWZlVW53cmFwKCksXG4gICAgICBjbGllbnRTZWNyZXQ6IGJhY2tlbmRTZWNyZXRSZXNvbHZlclxuICAgICAgICAucmVzb2x2ZVNlY3JldChjbGllbnRTZWNyZXQpXG4gICAgICAgIC51bnNhZmVVbndyYXAoKSxcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5jb25zdCB0cmFuc2xhdGVHb29nbGVQcm9wcyA9IChcbiAgYmFja2VuZFNlY3JldFJlc29sdmVyOiBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIGdvb2dsZVByb3ZpZGVyUHJvcHM/OiBHb29nbGVQcm92aWRlckZhY3RvcnlQcm9wcyxcbik6IEdvb2dsZVByb3ZpZGVyUHJvcHMgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoIWdvb2dsZVByb3ZpZGVyUHJvcHMpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIGNsaWVudElkLFxuICAgIGNsaWVudFNlY3JldDogY2xpZW50U2VjcmV0VmFsdWUsXG4gICAgLi4ubm9TZWNyZXRQcm9wc1xuICB9ID0gZ29vZ2xlUHJvdmlkZXJQcm9wcztcbiAgcmV0dXJuIHtcbiAgICAuLi5ub1NlY3JldFByb3BzLFxuICAgIGNsaWVudElkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRJZCkudW5zYWZlVW53cmFwKCksXG4gICAgY2xpZW50U2VjcmV0OiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRTZWNyZXRWYWx1ZSksXG4gIH07XG59O1xuIl19