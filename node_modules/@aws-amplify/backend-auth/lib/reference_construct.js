import { Construct } from 'constructs';
import { CustomResource, Duration, Stack, aws_cognito, aws_iam, } from 'aws-cdk-lib';
import { AttributionMetadataStorage, StackMetadataBackendOutputStorageStrategy, } from '@aws-amplify/backend-output-storage';
import * as path from 'path';
import { NodejsFunction } from 'aws-cdk-lib/aws-lambda-nodejs';
import { Runtime } from 'aws-cdk-lib/aws-lambda';
import { Provider } from 'aws-cdk-lib/custom-resources';
import { Role } from 'aws-cdk-lib/aws-iam';
import { fileURLToPath } from 'node:url';
/**
 * Expected key that auth output is stored under - must match backend-output-schemas's authOutputKey
 */
export const authOutputKey = 'AWS::Amplify::Auth';
const REFERENCE_AUTH_CUSTOM_RESOURCE_PROVIDER_ID = 'AmplifyRefAuthCustomResourceProvider';
const REFERENCE_AUTH_CUSTOM_RESOURCE_ID = 'AmplifyRefAuthCustomResource';
const RESOURCE_TYPE = 'Custom::AmplifyRefAuth';
const filename = fileURLToPath(import.meta.url);
const dirname = path.dirname(filename);
const resourcesRoot = path.normalize(path.join(dirname, 'lambda'));
const refAuthLambdaFilePath = path.join(resourcesRoot, 'reference_auth_initializer.js');
const authStackType = 'auth-Cognito';
/**
 * These properties are fetched by the custom resource and must be accounted for
 * in the final AuthOutput payload.
 */
export const OUTPUT_PROPERTIES_PROVIDED_BY_AUTH_CUSTOM_RESOURCE = [
    'allowUnauthenticatedIdentities',
    'signupAttributes',
    'usernameAttributes',
    'verificationMechanisms',
    'passwordPolicyMinLength',
    'passwordPolicyRequirements',
    'mfaConfiguration',
    'mfaTypes',
    'socialProviders',
    'oauthCognitoDomain',
    'oauthScope',
    'oauthRedirectSignIn',
    'oauthRedirectSignOut',
    'oauthResponseType',
    'oauthClientId',
];
/**
 * Reference Auth construct for using external auth resources
 */
export class AmplifyReferenceAuth extends Construct {
    resources;
    configurationCustomResource;
    /**
     * Create a new AmplifyConstruct
     */
    constructor(scope, id, props) {
        super(scope, id);
        this.resources = {
            userPool: aws_cognito.UserPool.fromUserPoolId(this, 'UserPool', props.userPoolId),
            userPoolClient: aws_cognito.UserPoolClient.fromUserPoolClientId(this, 'UserPoolClient', props.userPoolClientId),
            authenticatedUserIamRole: aws_iam.Role.fromRoleArn(this, 'authenticatedUserRole', props.authRoleArn),
            unauthenticatedUserIamRole: aws_iam.Role.fromRoleArn(this, 'unauthenticatedUserRole', props.unauthRoleArn),
            identityPoolId: props.identityPoolId,
            groups: {},
        };
        // mapping of existing group roles
        if (props.groups) {
            Object.entries(props.groups).forEach(([groupName, roleArn]) => {
                this.resources.groups[groupName] = {
                    role: Role.fromRoleArn(this, `${groupName}GroupRole`, roleArn),
                };
            });
        }
        // custom resource lambda
        const refAuthLambda = new NodejsFunction(scope, `${REFERENCE_AUTH_CUSTOM_RESOURCE_PROVIDER_ID}Lambda`, {
            runtime: Runtime.NODEJS_18_X,
            timeout: Duration.seconds(10),
            entry: refAuthLambdaFilePath,
            handler: 'handler',
        });
        // UserPool & UserPoolClient specific permissions
        refAuthLambda.grantPrincipal.addToPrincipalPolicy(new aws_iam.PolicyStatement({
            effect: aws_iam.Effect.ALLOW,
            actions: [
                'cognito-idp:DescribeUserPool',
                'cognito-idp:GetUserPoolMfaConfig',
                'cognito-idp:ListIdentityProviders',
                'cognito-idp:ListGroups',
                'cognito-idp:DescribeUserPoolClient',
            ],
            resources: [this.resources.userPool.userPoolArn],
        }));
        // IdentityPool specific permissions
        const stack = Stack.of(this);
        refAuthLambda.grantPrincipal.addToPrincipalPolicy(new aws_iam.PolicyStatement({
            effect: aws_iam.Effect.ALLOW,
            actions: [
                'cognito-identity:DescribeIdentityPool',
                'cognito-identity:GetIdentityPoolRoles',
            ],
            resources: [
                `arn:aws:cognito-identity:${stack.region}:${stack.account}:identitypool/${this.resources.identityPoolId}`,
            ],
        }));
        const provider = new Provider(scope, REFERENCE_AUTH_CUSTOM_RESOURCE_PROVIDER_ID, {
            onEventHandler: refAuthLambda,
        });
        const initializerProps = {
            userPoolId: props.userPoolId,
            identityPoolId: props.identityPoolId,
            userPoolClientId: props.userPoolClientId,
            authRoleArn: props.authRoleArn,
            unauthRoleArn: props.unauthRoleArn,
            groups: props.groups ?? {},
            region: Stack.of(this).region,
        };
        // custom resource
        this.configurationCustomResource = new CustomResource(scope, REFERENCE_AUTH_CUSTOM_RESOURCE_ID, {
            serviceToken: provider.serviceToken,
            properties: {
                ...initializerProps,
            },
            resourceType: RESOURCE_TYPE,
        });
        this.storeOutput(props.outputStorageStrategy);
        new AttributionMetadataStorage().storeAttributionMetadata(Stack.of(this), authStackType, fileURLToPath(new URL('../package.json', import.meta.url)));
    }
    /**
     * Stores auth output using the provided strategy
     */
    storeOutput = (outputStorageStrategy = new StackMetadataBackendOutputStorageStrategy(Stack.of(this))) => {
        // these properties cannot be overwritten
        const output = {
            userPoolId: this.resources.userPool.userPoolId,
            webClientId: this.resources.userPoolClient.userPoolClientId,
            identityPoolId: this.resources.identityPoolId,
            authRegion: Stack.of(this).region,
        };
        // assign cdk tokens which will be resolved during deployment
        for (const property of OUTPUT_PROPERTIES_PROVIDED_BY_AUTH_CUSTOM_RESOURCE) {
            output[property] =
                this.configurationCustomResource.getAttString(property);
        }
        outputStorageStrategy.addBackendOutputEntry(authOutputKey, {
            version: '1',
            payload: output,
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlX2NvbnN0cnVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9yZWZlcmVuY2VfY29uc3RydWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdkMsT0FBTyxFQUNMLGNBQWMsRUFDZCxRQUFRLEVBQ1IsS0FBSyxFQUNMLFdBQVcsRUFDWCxPQUFPLEdBQ1IsTUFBTSxhQUFhLENBQUM7QUFNckIsT0FBTyxFQUNMLDBCQUEwQixFQUMxQix5Q0FBeUMsR0FDMUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUU3QyxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDL0QsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ2pELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUd6Qzs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxvQkFBb0IsQ0FBQztBQUVsRCxNQUFNLDBDQUEwQyxHQUM5QyxzQ0FBc0MsQ0FBQztBQUN6QyxNQUFNLGlDQUFpQyxHQUFHLDhCQUE4QixDQUFDO0FBQ3pFLE1BQU0sYUFBYSxHQUFHLHdCQUF3QixDQUFDO0FBRS9DLE1BQU0sUUFBUSxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2hELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDdkMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9B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cm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7XG4gIEN1c3RvbVJlc291cmNlLFxuICBEdXJhdGlvbixcbiAgU3RhY2ssXG4gIGF3c19jb2duaXRvLFxuICBhd3NfaWFtLFxufSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQge1xuICBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICBSZWZlcmVuY2VBdXRoUmVzb3VyY2VzLFxuICBSZXNvdXJjZVByb3ZpZGVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7XG4gIEF0dHJpYnV0aW9uTWV0YWRhdGFTdG9yYWdlLFxuICBTdGFja01ldGFkYXRhQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXN0b3JhZ2UnO1xuaW1wb3J0IHsgQXV0aE91dHB1dCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBOb2RlanNGdW5jdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJztcbmltcG9ydCB7IFJ1bnRpbWUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IFByb3ZpZGVyIH0gZnJvbSAnYXdzLWNkay1saWIvY3VzdG9tLXJlc291cmNlcyc7XG5pbXBvcnQgeyBSb2xlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBSZWZlcmVuY2VBdXRoSW5pdGlhbGl6ZXJQcm9wcyB9IGZyb20gJy4vbGFtYmRhL3JlZmVyZW5jZV9hdXRoX2luaXRpYWxpemVyLmpzJztcbmltcG9ydCB7IGZpbGVVUkxUb1BhdGggfSBmcm9tICdub2RlOnVybCc7XG5pbXBvcnQgeyBSZWZlcmVuY2VBdXRoUHJvcHMgfSBmcm9tICcuL3JlZmVyZW5jZV9mYWN0b3J5LmpzJztcblxuLyoqXG4gKiBFeHBlY3RlZCBrZXkgdGhhdCBhdXRoIG91dHB1dCBpcyBzdG9yZWQgdW5kZXIgLSBtdXN0IG1hdGNoIGJhY2tlbmQtb3V0cHV0LXNjaGVtYXMncyBhdXRoT3V0cHV0S2V5XG4gKi9cbmV4cG9ydCBjb25zdCBhdXRoT3V0cHV0S2V5ID0gJ0FXUzo6QW1wbGlmeTo6QXV0aCc7XG5cbmNvbnN0IFJFRkVSRU5DRV9BVVRIX0NVU1RPTV9SRVNPVVJDRV9QUk9WSURFUl9JRCA9XG4gICdBbXBsaWZ5UmVmQXV0aEN1c3RvbVJlc291cmNlUHJvdmlkZXInO1xuY29uc3QgUkVGRVJFTkNFX0FVVEhfQ1VTVE9NX1JFU09VUkNFX0lEID0gJ0FtcGxpZnlSZWZBdXRoQ3VzdG9tUmVzb3VyY2UnO1xuY29uc3QgUkVTT1VSQ0VfVFlQRSA9ICdDdXN0b206OkFtcGxpZnlSZWZBdXRoJztcblxuY29uc3QgZmlsZW5hbWUgPSBmaWxlVVJMVG9QYXRoKGltcG9ydC5tZXRhLnVybCk7XG5jb25zdCBkaXJuYW1lID0gcGF0aC5kaXJuYW1lKGZpbGVuYW1lKTtcbmNvbnN0IHJlc291cmNlc1Jvb3QgPSBwYXRoLm5vcm1hbGl6ZShwYXRoLmpvaW4oZGlybmFtZSwgJ2xhbWJkYScpKTtcbmNvbnN0IHJlZkF1dGhMYW1iZGFGaWxlUGF0aCA9IHBhdGguam9pbihcbiAgcmVzb3VyY2VzUm9vdCxcbiAgJ3JlZmVyZW5jZV9hdXRoX2luaXRpYWxpemVyLmpzJyxcbik7XG5cbmNvbnN0IGF1dGhTdGFja1R5cGUgPSAnYXV0aC1Db2duaXRvJztcblxuLyoqXG4gKiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSBmZXRjaGVkIGJ5IHRoZSBjdXN0b20gcmVzb3VyY2UgYW5kIG11c3QgYmUgYWNjb3VudGVkIGZvclxuICogaW4gdGhlIGZpbmFsIEF1dGhPdXRwdXQgcGF5bG9hZC5cbiAqL1xuZXhwb3J0IGNvbnN0IE9VVFBVVF9QUk9QRVJUSUVTX1BST1ZJREVEX0JZX0FVVEhfQ1VTVE9NX1JFU09VUkNFOiAoa2V5b2YgQXV0aE91dHB1dFsncGF5bG9hZCddKVtdID1cbiAgW1xuICAgICdhbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMnLFxuICAgICdzaWdudXBBdHRyaWJ1dGVzJyxcbiAgICAndXNlcm5hbWVBdHRyaWJ1dGVzJyxcbiAgICAndmVyaWZpY2F0aW9uTWVjaGFuaXNtcycsXG4gICAgJ3Bhc3N3b3JkUG9saWN5TWluTGVuZ3RoJyxcbiAgICAncGFzc3dvcmRQb2xpY3lSZXF1aXJlbWVudHMnLFxuICAgICdtZmFDb25maWd1cmF0aW9uJyxcbiAgICAnbWZhVHlwZXMnLFxuICAgICdzb2NpYWxQcm92aWRlcnMnLFxuICAgICdvYXV0aENvZ25pdG9Eb21haW4nLFxuICAgICdvYXV0aFNjb3BlJyxcbiAgICAnb2F1dGhSZWRpcmVjdFNpZ25JbicsXG4gICAgJ29hdXRoUmVkaXJlY3RTaWduT3V0JyxcbiAgICAnb2F1dGhSZXNwb25zZVR5cGUnLFxuICAgICdvYXV0aENsaWVudElkJyxcbiAgXTtcbi8qKlxuICogUmVmZXJlbmNlIEF1dGggY29uc3RydWN0IGZvciB1c2luZyBleHRlcm5hbCBhdXRoIHJlc291cmNlc1xuICovXG5leHBvcnQgY2xhc3MgQW1wbGlmeVJlZmVyZW5jZUF1dGhcbiAgZXh0ZW5kcyBDb25zdHJ1Y3RcbiAgaW1wbGVtZW50cyBSZXNvdXJjZVByb3ZpZGVyPFJlZmVyZW5jZUF1dGhSZXNvdXJjZXM+XG57XG4gIHJlc291cmNlczogUmVmZXJlbmNlQXV0aFJlc291cmNlcztcblxuICBwcml2YXRlIGNvbmZpZ3VyYXRpb25DdXN0b21SZXNvdXJjZTogQ3VzdG9tUmVzb3VyY2U7XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG5ldyBBbXBsaWZ5Q29uc3RydWN0XG4gICAqL1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogUmVmZXJlbmNlQXV0aFByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIHRoaXMucmVzb3VyY2VzID0ge1xuICAgICAgdXNlclBvb2w6IGF3c19jb2duaXRvLlVzZXJQb29sLmZyb21Vc2VyUG9vbElkKFxuICAgICAgICB0aGlzLFxuICAgICAgICAnVXNlclBvb2wnLFxuICAgICAgICBwcm9wcy51c2VyUG9vbElkLFxuICAgICAgKSxcbiAgICAgIHVzZXJQb29sQ2xpZW50OiBhd3NfY29nbml0by5Vc2VyUG9vbENsaWVudC5mcm9tVXNlclBvb2xDbGllbnRJZChcbiAgICAgICAgdGhpcyxcbiAgICAgICAgJ1VzZXJQb29sQ2xpZW50JyxcbiAgICAgICAgcHJvcHMudXNlclBvb2xDbGllbnRJZCxcbiAgICAgICksXG4gICAgICBhdXRoZW50aWNhdGVkVXNlcklhbVJvbGU6IGF3c19pYW0uUm9sZS5mcm9tUm9sZUFybihcbiAgICAgICAgdGhpcyxcbiAgICAgICAgJ2F1dGhlbnRpY2F0ZWRVc2VyUm9sZScsXG4gICAgICAgIHByb3BzLmF1dGhSb2xlQXJuLFxuICAgICAgKSxcbiAgICAgIHVuYXV0aGVudGljYXRlZFVzZXJJYW1Sb2xlOiBhd3NfaWFtLlJvbGUuZnJvbVJvbGVBcm4oXG4gICAgICAgIHRoaXMsXG4gICAgICAgICd1bmF1dGhlbnRpY2F0ZWRVc2VyUm9sZScsXG4gICAgICAgIHByb3BzLnVuYXV0aFJvbGVBcm4sXG4gICAgICApLFxuICAgICAgaWRlbnRpdHlQb29sSWQ6IHByb3BzLmlkZW50aXR5UG9vbElkLFxuICAgICAgZ3JvdXBzOiB7fSxcbiAgICB9O1xuXG4gICAgLy8gbWFwcGluZyBvZiBleGlzdGluZyBncm91cCByb2xlc1xuICAgIGlmIChwcm9wcy5ncm91cHMpIHtcbiAgICAgIE9iamVjdC5lbnRyaWVzKHByb3BzLmdyb3VwcykuZm9yRWFjaCgoW2dyb3VwTmFtZSwgcm9sZUFybl0pID0+IHtcbiAgICAgICAgdGhpcy5yZXNvdXJjZXMuZ3JvdXBzW2dyb3VwTmFtZV0gPSB7XG4gICAgICAgICAgcm9sZTogUm9sZS5mcm9tUm9sZUFybih0aGlzLCBgJHtncm91cE5hbWV9R3JvdXBSb2xlYCwgcm9sZUFybiksXG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBjdXN0b20gcmVzb3VyY2UgbGFtYmRhXG4gICAgY29uc3QgcmVmQXV0aExhbWJkYSA9IG5ldyBOb2RlanNGdW5jdGlvbihcbiAgICAgIHNjb3BlLFxuICAgICAgYCR7UkVGRVJFTkNFX0FVVEhfQ1VTVE9NX1JFU09VUkNFX1BST1ZJREVSX0lEfUxhbWJkYWAsXG4gICAgICB7XG4gICAgICAgIHJ1bnRpbWU6IFJ1bnRpbWUuTk9ERUpTXzE4X1gsXG4gICAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLnNlY29uZHMoMTApLFxuICAgICAgICBlbnRyeTogcmVmQXV0aExhbWJkYUZpbGVQYXRoLFxuICAgICAgICBoYW5kbGVyOiAnaGFuZGxlcicsXG4gICAgICB9LFxuICAgICk7XG4gICAgLy8gVXNlclBvb2wgJiBVc2VyUG9vbENsaWVudCBzcGVjaWZpYyBwZXJtaXNzaW9uc1xuICAgIHJlZkF1dGhMYW1iZGEuZ3JhbnRQcmluY2lwYWwuYWRkVG9QcmluY2lwYWxQb2xpY3koXG4gICAgICBuZXcgYXdzX2lhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IGF3c19pYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgJ2NvZ25pdG8taWRwOkRlc2NyaWJlVXNlclBvb2wnLFxuICAgICAgICAgICdjb2duaXRvLWlkcDpHZXRVc2VyUG9vbE1mYUNvbmZpZycsXG4gICAgICAgICAgJ2NvZ25pdG8taWRwOkxpc3RJZGVudGl0eVByb3ZpZGVycycsXG4gICAgICAgICAgJ2NvZ25pdG8taWRwOkxpc3RHcm91cHMnLFxuICAgICAgICAgICdjb2duaXRvLWlkcDpEZXNjcmliZVVzZXJQb29sQ2xpZW50JyxcbiAgICAgICAgXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbdGhpcy5yZXNvdXJjZXMudXNlclBvb2wudXNlclBvb2xBcm5dLFxuICAgICAgfSksXG4gICAgKTtcbiAgICAvLyBJZGVudGl0eVBvb2wgc3BlY2lmaWMgcGVybWlzc2lvbnNcbiAgICBjb25zdCBzdGFjayA9IFN0YWNrLm9mKHRoaXMpO1xuICAgIHJlZkF1dGhMYW1iZGEuZ3JhbnRQcmluY2lwYWwuYWRkVG9QcmluY2lwYWxQb2xpY3koXG4gICAgICBuZXcgYXdzX2lhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IGF3c19pYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHk6RGVzY3JpYmVJZGVudGl0eVBvb2wnLFxuICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5OkdldElkZW50aXR5UG9vbFJvbGVzJyxcbiAgICAgICAgXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbXG4gICAgICAgICAgYGFybjphd3M6Y29nbml0by1pZGVudGl0eToke3N0YWNrLnJlZ2lvbn06JHtzdGFjay5hY2NvdW50fTppZGVudGl0eXBvb2wvJHt0aGlzLnJlc291cmNlcy5pZGVudGl0eVBvb2xJZH1gLFxuICAgICAgICBdLFxuICAgICAgfSksXG4gICAgKTtcbiAgICBjb25zdCBwcm92aWRlciA9IG5ldyBQcm92aWRlcihcbiAgICAgIHNjb3BlLFxuICAgICAgUkVGRVJFTkNFX0FVVEhfQ1VTVE9NX1JFU09VUkNFX1BST1ZJREVSX0lELFxuICAgICAge1xuICAgICAgICBvbkV2ZW50SGFuZGxlcjogcmVmQXV0aExhbWJkYSxcbiAgICAgIH0sXG4gICAgKTtcbiAgICBjb25zdCBpbml0aWFsaXplclByb3BzOiBSZWZlcmVuY2VBdXRoSW5pdGlhbGl6ZXJQcm9wcyA9IHtcbiAgICAgIHVzZXJQb29sSWQ6IHByb3BzLnVzZXJQb29sSWQsXG4gICAgICBpZGVudGl0eVBvb2xJZDogcHJvcHMuaWRlbnRpdHlQb29sSWQsXG4gICAgICB1c2VyUG9vbENsaWVudElkOiBwcm9wcy51c2VyUG9vbENsaWVudElkLFxuICAgICAgYXV0aFJvbGVBcm46IHByb3BzLmF1dGhSb2xlQXJuLFxuICAgICAgdW5hdXRoUm9sZUFybjogcHJvcHMudW5hdXRoUm9sZUFybixcbiAgICAgIGdyb3VwczogcHJvcHMuZ3JvdXBzID8/IHt9LFxuICAgICAgcmVnaW9uOiBTdGFjay5vZih0aGlzKS5yZWdpb24sXG4gICAgfTtcbiAgICAvLyBjdXN0b20gcmVzb3VyY2VcbiAgICB0aGlzLmNvbmZpZ3VyYXRpb25DdXN0b21SZXNvdXJjZSA9IG5ldyBDdXN0b21SZXNvdXJjZShcbiAgICAgIHNjb3BlLFxuICAgICAgUkVGRVJFTkNFX0FVVEhfQ1VTVE9NX1JFU09VUkNFX0lELFxuICAgICAge1xuICAgICAgICBzZXJ2aWNlVG9rZW46IHByb3ZpZGVyLnNlcnZpY2VUb2tlbixcbiAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgIC4uLmluaXRpYWxpemVyUHJvcHMsXG4gICAgICAgIH0sXG4gICAgICAgIHJlc291cmNlVHlwZTogUkVTT1VSQ0VfVFlQRSxcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIHRoaXMuc3RvcmVPdXRwdXQocHJvcHMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5KTtcbiAgICBuZXcgQXR0cmlidXRpb25NZXRhZGF0YVN0b3JhZ2UoKS5zdG9yZUF0dHJpYnV0aW9uTWV0YWRhdGEoXG4gICAgICBTdGFjay5vZih0aGlzKSxcbiAgICAgIGF1dGhTdGFja1R5cGUsXG4gICAgICBmaWxlVVJMVG9QYXRoKG5ldyBVUkwoJy4uL3BhY2thZ2UuanNvbicsIGltcG9ydC5tZXRhLnVybCkpLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogU3RvcmVzIGF1dGggb3V0cHV0IHVzaW5nIHRoZSBwcm92aWRlZCBzdHJhdGVneVxuICAgKi9cbiAgcHJpdmF0ZSBzdG9yZU91dHB1dCA9IChcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8QXV0aE91dHB1dD4gPSBuZXcgU3RhY2tNZXRhZGF0YUJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3koXG4gICAgICBTdGFjay5vZih0aGlzKSxcbiAgICApLFxuICApOiB2b2lkID0+IHtcbiAgICAvLyB0aGVzZSBwcm9wZXJ0aWVzIGNhbm5vdCBiZSBvdmVyd3JpdHRlblxuICAgIGNvbnN0IG91dHB1dDogQXV0aE91dHB1dFsncGF5bG9hZCddID0ge1xuICAgICAgdXNlclBvb2xJZDogdGhpcy5yZXNvdXJjZXMudXNlclBvb2wudXNlclBvb2xJZCxcbiAgICAgIHdlYkNsaWVudElkOiB0aGlzLnJlc291cmNlcy51c2VyUG9vbENsaWVudC51c2VyUG9vbENsaWVudElkLFxuICAgICAgaWRlbnRpdHlQb29sSWQ6IHRoaXMucmVzb3VyY2VzLmlkZW50aXR5UG9vbElkLFxuICAgICAgYXV0aFJlZ2lvbjogU3RhY2sub2YodGhpcykucmVnaW9uLFxuICAgIH07XG5cbiAgICAvLyBhc3NpZ24gY2RrIHRva2VucyB3aGljaCB3aWxsIGJlIHJlc29sdmVkIGR1cmluZyBkZXBsb3ltZW50XG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBPVVRQVVRfUFJPUEVSVElFU19QUk9WSURFRF9CWV9BVVRIX0NVU1RPTV9SRVNPVVJDRSkge1xuICAgICAgb3V0cHV0W3Byb3BlcnR5XSA9XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbkN1c3RvbVJlc291cmNlLmdldEF0dFN0cmluZyhwcm9wZXJ0eSk7XG4gICAgfVxuXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LmFkZEJhY2tlbmRPdXRwdXRFbnRyeShhdXRoT3V0cHV0S2V5LCB7XG4gICAgICB2ZXJzaW9uOiAnMScsXG4gICAgICBwYXlsb2FkOiBvdXRwdXQsXG4gICAgfSk7XG4gIH07XG59XG4iXX0=