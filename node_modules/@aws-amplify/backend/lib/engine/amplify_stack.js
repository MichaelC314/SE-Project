import { AmplifyFault, BackendIdentifierConversions, } from '@aws-amplify/platform-core';
import { Aspects, CfnResource, RemovalPolicy, Stack, } from 'aws-cdk-lib';
import { Role } from 'aws-cdk-lib/aws-iam';
/**
 * Amplify-specific Stack implementation to handle cross-cutting concerns for all Amplify stacks
 */
export class AmplifyStack extends Stack {
    /**
     * Default constructor
     */
    constructor(scope, backendId) {
        super(scope, BackendIdentifierConversions.toStackName(backendId));
        Aspects.of(this).add(new CognitoRoleTrustPolicyValidator());
        if (backendId.type === 'sandbox') {
            Aspects.of(this).add(new SandboxRemovalPolicyDestroyAspect());
        }
    }
    /**
     * Overrides Stack.allocateLogicalId to prevent redundant nested stack logical IDs
     */
    allocateLogicalId = (element) => {
        // Nested stack logical IDs have a redundant structure of <name>NestedStack<name>NestedStackResource<hash>
        // This rewrites the nested stack logical ID to <name><hash>
        const defaultId = super.allocateLogicalId(element);
        const match = /(?<name>.*)NestedStack.+NestedStackResource(?<hash>.*)/.exec(defaultId);
        if (match && match.groups && Object.keys(match.groups || {}).length === 2) {
            return `${match.groups.name}${match.groups.hash}`;
        }
        return defaultId;
    };
}
class CognitoRoleTrustPolicyValidator {
    visit = (node) => {
        if (!(node instanceof Role)) {
            return;
        }
        const assumeRolePolicyDocument = node.assumeRolePolicy?.toJSON();
        if (!assumeRolePolicyDocument) {
            return;
        }
        assumeRolePolicyDocument.Statement.forEach(this.cognitoTrustPolicyStatementValidator);
    };
    cognitoTrustPolicyStatementValidator = ({ Action: action, Condition: condition, Effect: effect, Principal: principal, }) => {
        if (action !== 'sts:AssumeRoleWithWebIdentity') {
            return;
        }
        if (principal?.Federated !== 'cognito-identity.amazonaws.com') {
            return;
        }
        if (effect === 'Deny') {
            return;
        }
        // if we got here, we have a policy that allows AssumeRoleWithWebIdentity with Cognito
        // need to validate that the policy has an appropriate condition
        const audCondition = condition?.StringEquals?.['cognito-identity.amazonaws.com:aud'];
        if (typeof audCondition !== 'string' || audCondition.length === 0) {
            throw new AmplifyFault('InvalidTrustPolicyFault', {
                message: 'Cannot create a Role trust policy with Cognito that does not have a StringEquals condition for cognito-identity.amazonaws.com:aud',
            });
        }
        const amrCondition = condition?.['ForAnyValue:StringLike']?.['cognito-identity.amazonaws.com:amr'];
        if (typeof amrCondition !== 'string' || amrCondition.length === 0) {
            throw new AmplifyFault('InvalidTrustPolicyFault', {
                message: 'Cannot create a Role trust policy with Cognito that does not have a StringLike condition for cognito-identity.amazonaws.com:amr',
            });
        }
    };
}
// This aspect sets removal policy of all resources to destroy for sandbox deployments
class SandboxRemovalPolicyDestroyAspect {
    visit(node) {
        if (CfnResource.isCfnResource(node)) {
            node.applyRemovalPolicy(RemovalPolicy.DESTROY);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW1wbGlmeV9zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lbmdpbmUvYW1wbGlmeV9zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsWUFBWSxFQUNaLDRCQUE0QixHQUM3QixNQUFNLDRCQUE0QixDQUFDO0FBRXBDLE9BQU8sRUFDTCxPQUFPLEVBRVAsV0FBVyxFQUVYLGFBQWEsRUFDYixLQUFLLEdBQ04sTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRzNDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLFlBQWEsU0FBUSxLQUFLO0lBQ3JDOztPQUVHO0lBQ0gsWUFBWSxLQUFnQixFQUFFLFNBQTRCO1FBQ3hELEtBQUssQ0FBQyxLQUFLLEVBQUUsNEJBQTRCLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDbEUsT0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSwrQkFBK0IsRUFBRSxDQUFDLENBQUM7UUFFNUQsSUFBSSxTQUFTLENBQUMsSUFBSSxLQUFLLFNBQVMsRUFBRTtZQUNoQyxPQUFPLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLGlDQUFpQyxFQUFFLENBQUMsQ0FBQztTQUMvRDtJQUNILENBQUM7SUFDRDs7T0FFRztJQUNILGlCQUFpQixHQUFHLENBQUMsT0FBbUIsRUFBVSxFQUFFO1FBQ2xELDBHQUEwRztRQUMxRyw0REFBNEQ7UUFDNUQsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ25ELE1BQU0sS0FBSyxHQUFHLHdEQUF3RCxDQUFDLElBQUksQ0FDekUsU0FBUyxDQUNWLENBQUM7UUFDRixJQUFJLEtBQUssSUFBSSxLQUFLLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ3pFLE9BQU8sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ25EO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQyxDQUFDO0NBQ0g7QUFFRCxNQUFNLCtCQUErQjtJQUNuQyxLQUFLLEdBQUcsQ0FBQyxJQUFnQixFQUFFLEVBQUU7UUFDM0IsSUFBSSxDQUFDLENBQUMsSUFBSSxZQUFZLElBQUksQ0FBQyxFQUFFO1lBQzNCLE9BQU87U0FDUjtRQUNELE1BQU0sd0JBQXdCLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLE1BQU0sRUFBRSxDQUFDO1FBQ2pFLElBQUksQ0FBQyx3QkFBd0IsRUFBRTtZQUM3QixPQUFPO1NBQ1I7UUFFRCx3QkFBd0IsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUN4QyxJQUFJLENBQUMsb0NBQW9DLENBQzFDLENBQUM7SUFDSixDQUFDLENBQUM7SUFFTSxvQ0FBb0MsR0FBRyxDQUFDLEVBQzlDLE1BQU0sRUFBRSxNQUFNLEVBQ2QsU0FBUyxFQUFFLFNBQVMsRUFDcEIsTUFBTSxFQUFFLE1BQU0sRUFDZCxTQUFTLEVBQUUsU0FBUyxHQVNyQixFQUFFLEVBQUU7UUFDSCxJQUFJLE1BQU0sS0FBSywrQkFBK0IsRUFBRTtZQUM5QyxPQUFPO1NBQ1I7UUFDRCxJQUFJLFNBQVMsRUFBRSxTQUFTLEtBQUssZ0NBQWdDLEVBQUU7WUFDN0QsT0FBTztTQUNSO1FBQ0QsSUFBSSxNQUFNLEtBQUssTUFBTSxFQUFFO1lBQ3JCLE9BQU87U0FDUjtRQUNELHNGQUFzRjtRQUN0RixnRUFBZ0U7UUFFaEUsTUFBTSxZQUFZLEdBQ2hCLFNBQVMsRUFBRSxZQUFZLEVBQUUsQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO1FBQ2xFLElBQUksT0FBTyxZQUFZLEtBQUssUUFBUSxJQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ2pFLE1BQU0sSUFBSSxZQUFZLENBQUMseUJBQXlCLEVBQUU7Z0JBQ2hELE9BQU8sRUFDTCxtSUFBbUk7YUFDdEksQ0FBQyxDQUFDO1NBQ0o7UUFFRCxNQUFNLFlBQVksR0FDaEIsU0FBUyxFQUFFLENBQUMsd0JBQXdCLENBQUMsRUFBRSxDQUNyQyxvQ0FBb0MsQ0FDckMsQ0FBQztRQUNKLElBQUksT0FBTyxZQUFZLEtBQUssUUFBUSxJQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ2pFLE1BQU0sSUFBSSxZQUFZLENBQUMseUJBQXlCLEVBQUU7Z0JBQ2hELE9BQU8sRUFDTCxpSUFBaUk7YUFDcEksQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDLENBQUM7Q0FDSDtBQUVELHNGQUFzRjtBQUN0RixNQUFNLGlDQUFpQztJQUNyQyxLQUFLLENBQUMsSUFBZ0I7UUFDcEIsSUFBSSxXQUFXLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ25DLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDaEQ7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBbXBsaWZ5RmF1bHQsXG4gIEJhY2tlbmRJZGVudGlmaWVyQ29udmVyc2lvbnMsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7IEJhY2tlbmRJZGVudGlmaWVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQge1xuICBBc3BlY3RzLFxuICBDZm5FbGVtZW50LFxuICBDZm5SZXNvdXJjZSxcbiAgSUFzcGVjdCxcbiAgUmVtb3ZhbFBvbGljeSxcbiAgU3RhY2ssXG59IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IFJvbGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IENvbnN0cnVjdCwgSUNvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuXG4vKipcbiAqIEFtcGxpZnktc3BlY2lmaWMgU3RhY2sgaW1wbGVtZW50YXRpb24gdG8gaGFuZGxlIGNyb3NzLWN1dHRpbmcgY29uY2VybnMgZm9yIGFsbCBBbXBsaWZ5IHN0YWNrc1xuICovXG5leHBvcnQgY2xhc3MgQW1wbGlmeVN0YWNrIGV4dGVuZHMgU3RhY2sge1xuICAvKipcbiAgICogRGVmYXVsdCBjb25zdHJ1Y3RvclxuICAgKi9cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgYmFja2VuZElkOiBCYWNrZW5kSWRlbnRpZmllcikge1xuICAgIHN1cGVyKHNjb3BlLCBCYWNrZW5kSWRlbnRpZmllckNvbnZlcnNpb25zLnRvU3RhY2tOYW1lKGJhY2tlbmRJZCkpO1xuICAgIEFzcGVjdHMub2YodGhpcykuYWRkKG5ldyBDb2duaXRvUm9sZVRydXN0UG9saWN5VmFsaWRhdG9yKCkpO1xuXG4gICAgaWYgKGJhY2tlbmRJZC50eXBlID09PSAnc2FuZGJveCcpIHtcbiAgICAgIEFzcGVjdHMub2YodGhpcykuYWRkKG5ldyBTYW5kYm94UmVtb3ZhbFBvbGljeURlc3Ryb3lBc3BlY3QoKSk7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiBPdmVycmlkZXMgU3RhY2suYWxsb2NhdGVMb2dpY2FsSWQgdG8gcHJldmVudCByZWR1bmRhbnQgbmVzdGVkIHN0YWNrIGxvZ2ljYWwgSURzXG4gICAqL1xuICBhbGxvY2F0ZUxvZ2ljYWxJZCA9IChlbGVtZW50OiBDZm5FbGVtZW50KTogc3RyaW5nID0+IHtcbiAgICAvLyBOZXN0ZWQgc3RhY2sgbG9naWNhbCBJRHMgaGF2ZSBhIHJlZHVuZGFudCBzdHJ1Y3R1cmUgb2YgPG5hbWU+TmVzdGVkU3RhY2s8bmFtZT5OZXN0ZWRTdGFja1Jlc291cmNlPGhhc2g+XG4gICAgLy8gVGhpcyByZXdyaXRlcyB0aGUgbmVzdGVkIHN0YWNrIGxvZ2ljYWwgSUQgdG8gPG5hbWU+PGhhc2g+XG4gICAgY29uc3QgZGVmYXVsdElkID0gc3VwZXIuYWxsb2NhdGVMb2dpY2FsSWQoZWxlbWVudCk7XG4gICAgY29uc3QgbWF0Y2ggPSAvKD88bmFtZT4uKilOZXN0ZWRTdGFjay4rTmVzdGVkU3RhY2tSZXNvdXJjZSg/PGhhc2g+LiopLy5leGVjKFxuICAgICAgZGVmYXVsdElkLFxuICAgICk7XG4gICAgaWYgKG1hdGNoICYmIG1hdGNoLmdyb3VwcyAmJiBPYmplY3Qua2V5cyhtYXRjaC5ncm91cHMgfHwge30pLmxlbmd0aCA9PT0gMikge1xuICAgICAgcmV0dXJuIGAke21hdGNoLmdyb3Vwcy5uYW1lfSR7bWF0Y2guZ3JvdXBzLmhhc2h9YDtcbiAgICB9XG4gICAgcmV0dXJuIGRlZmF1bHRJZDtcbiAgfTtcbn1cblxuY2xhc3MgQ29nbml0b1JvbGVUcnVzdFBvbGljeVZhbGlkYXRvciBpbXBsZW1lbnRzIElBc3BlY3Qge1xuICB2aXNpdCA9IChub2RlOiBJQ29uc3RydWN0KSA9PiB7XG4gICAgaWYgKCEobm9kZSBpbnN0YW5jZW9mIFJvbGUpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGFzc3VtZVJvbGVQb2xpY3lEb2N1bWVudCA9IG5vZGUuYXNzdW1lUm9sZVBvbGljeT8udG9KU09OKCk7XG4gICAgaWYgKCFhc3N1bWVSb2xlUG9saWN5RG9jdW1lbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBhc3N1bWVSb2xlUG9saWN5RG9jdW1lbnQuU3RhdGVtZW50LmZvckVhY2goXG4gICAgICB0aGlzLmNvZ25pdG9UcnVzdFBvbGljeVN0YXRlbWVudFZhbGlkYXRvcixcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgY29nbml0b1RydXN0UG9saWN5U3RhdGVtZW50VmFsaWRhdG9yID0gKHtcbiAgICBBY3Rpb246IGFjdGlvbixcbiAgICBDb25kaXRpb246IGNvbmRpdGlvbixcbiAgICBFZmZlY3Q6IGVmZmVjdCxcbiAgICBQcmluY2lwYWw6IHByaW5jaXBhbCxcbiAgfToge1xuICAgIC8vIFRoZXNlIHByb3BlcnR5IG5hbWVzIGNvbWUgZnJvbSB0aGUgSUFNIHBvbGljeSBkb2N1bWVudCB3aGljaCB3ZSBkbyBub3QgY29udHJvbFxuICAgIC8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiAqL1xuICAgIEFjdGlvbjogc3RyaW5nO1xuICAgIENvbmRpdGlvbj86IFJlY29yZDxzdHJpbmcsIFJlY29yZDxzdHJpbmcsIHN0cmluZz4+O1xuICAgIEVmZmVjdDogJ0FsbG93JyB8ICdEZW55JztcbiAgICBQcmluY2lwYWw/OiB7IEZlZGVyYXRlZD86IHN0cmluZyB9O1xuICAgIC8qIGVzbGludC1lbmFibGUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uICovXG4gIH0pID0+IHtcbiAgICBpZiAoYWN0aW9uICE9PSAnc3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHknKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChwcmluY2lwYWw/LkZlZGVyYXRlZCAhPT0gJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbScpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGVmZmVjdCA9PT0gJ0RlbnknKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIGlmIHdlIGdvdCBoZXJlLCB3ZSBoYXZlIGEgcG9saWN5IHRoYXQgYWxsb3dzIEFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkgd2l0aCBDb2duaXRvXG4gICAgLy8gbmVlZCB0byB2YWxpZGF0ZSB0aGF0IHRoZSBwb2xpY3kgaGFzIGFuIGFwcHJvcHJpYXRlIGNvbmRpdGlvblxuXG4gICAgY29uc3QgYXVkQ29uZGl0aW9uID1cbiAgICAgIGNvbmRpdGlvbj8uU3RyaW5nRXF1YWxzPy5bJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphdWQnXTtcbiAgICBpZiAodHlwZW9mIGF1ZENvbmRpdGlvbiAhPT0gJ3N0cmluZycgfHwgYXVkQ29uZGl0aW9uLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlGYXVsdCgnSW52YWxpZFRydXN0UG9saWN5RmF1bHQnLCB7XG4gICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgJ0Nhbm5vdCBjcmVhdGUgYSBSb2xlIHRydXN0IHBvbGljeSB3aXRoIENvZ25pdG8gdGhhdCBkb2VzIG5vdCBoYXZlIGEgU3RyaW5nRXF1YWxzIGNvbmRpdGlvbiBmb3IgY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmF1ZCcsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBhbXJDb25kaXRpb24gPVxuICAgICAgY29uZGl0aW9uPy5bJ0ZvckFueVZhbHVlOlN0cmluZ0xpa2UnXT8uW1xuICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmFtcidcbiAgICAgIF07XG4gICAgaWYgKHR5cGVvZiBhbXJDb25kaXRpb24gIT09ICdzdHJpbmcnIHx8IGFtckNvbmRpdGlvbi5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5RmF1bHQoJ0ludmFsaWRUcnVzdFBvbGljeUZhdWx0Jywge1xuICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICdDYW5ub3QgY3JlYXRlIGEgUm9sZSB0cnVzdCBwb2xpY3kgd2l0aCBDb2duaXRvIHRoYXQgZG9lcyBub3QgaGF2ZSBhIFN0cmluZ0xpa2UgY29uZGl0aW9uIGZvciBjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YW1yJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcbn1cblxuLy8gVGhpcyBhc3BlY3Qgc2V0cyByZW1vdmFsIHBvbGljeSBvZiBhbGwgcmVzb3VyY2VzIHRvIGRlc3Ryb3kgZm9yIHNhbmRib3ggZGVwbG95bWVudHNcbmNsYXNzIFNhbmRib3hSZW1vdmFsUG9saWN5RGVzdHJveUFzcGVjdCBpbXBsZW1lbnRzIElBc3BlY3Qge1xuICB2aXNpdChub2RlOiBJQ29uc3RydWN0KTogdm9pZCB7XG4gICAgaWYgKENmblJlc291cmNlLmlzQ2ZuUmVzb3VyY2Uobm9kZSkpIHtcbiAgICAgIG5vZGUuYXBwbHlSZW1vdmFsUG9saWN5KFJlbW92YWxQb2xpY3kuREVTVFJPWSk7XG4gICAgfVxuICB9XG59XG4iXX0=