import { NodejsFunction } from 'aws-cdk-lib/aws-lambda-nodejs';
import { Duration } from 'aws-cdk-lib';
import * as iam from 'aws-cdk-lib/aws-iam';
import * as path from 'path';
import { Runtime as LambdaRuntime } from 'aws-cdk-lib/aws-lambda';
import { Provider } from 'aws-cdk-lib/custom-resources';
import { fileURLToPath } from 'node:url';
import { ParameterPathConversions } from '@aws-amplify/platform-core';
const filename = fileURLToPath(import.meta.url);
const dirname = path.dirname(filename);
const resourcesRoot = path.normalize(path.join(dirname, 'lambda'));
const backendSecretLambdaFilePath = path.join(resourcesRoot, 'backend_secret_fetcher.js');
/**
 * The factory to create secret-fetcher provider.
 */
export class BackendSecretFetcherProviderFactory {
    /**
     * Returns a resource provider if it exists in the input scope. Otherwise,
     * creates a new provider.
     */
    getOrCreateInstance = (scope, providerId, backendIdentifier) => {
        const provider = scope.node.tryFindChild(providerId);
        if (provider) {
            return provider;
        }
        const secretLambda = new NodejsFunction(scope, `${providerId}Lambda`, {
            runtime: LambdaRuntime.NODEJS_18_X,
            timeout: Duration.seconds(10),
            entry: backendSecretLambdaFilePath,
            handler: 'handler',
        });
        const backendParameterPrefix = ParameterPathConversions.toParameterPrefix(backendIdentifier);
        const sharedParameterPrefix = ParameterPathConversions.toParameterPrefix(backendIdentifier.namespace);
        secretLambda.grantPrincipal.addToPrincipalPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ['ssm:GetParameter'],
            resources: [
                `arn:aws:ssm:*:*:parameter${backendParameterPrefix}/*`,
                `arn:aws:ssm:*:*:parameter${sharedParameterPrefix}/*`,
            ],
        }));
        return new Provider(scope, providerId, {
            onEventHandler: secretLambda,
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2VuZF9zZWNyZXRfZmV0Y2hlcl9wcm92aWRlcl9mYWN0b3J5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2VuZ2luZS9iYWNrZW5kLXNlY3JldC9iYWNrZW5kX3NlY3JldF9mZXRjaGVyX3Byb3ZpZGVyX2ZhY3RvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkMsT0FBTyxLQUFLLEdBQUcsTUFBTSxxQkFBcUIsQ0FBQztBQUMzQyxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUUsT0FBTyxJQUFJLGFBQWEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRXpDLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRXRFLE1BQU0sUUFBUSxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2hELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDdkMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO0FBQ25FLE1BQU0sMkJBQTJCLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FDM0MsYUFBYSxFQUNiLDJCQUEyQixDQUM1QixDQUFDO0FBRUY7O0dBRUc7QUFDSCxNQUFNLE9BQU8sbUNBQW1DO0lBQzlDOzs7T0FHRztJQUNILG1CQUFtQixHQUFHLENBQ3BCLEtBQWdCLEVBQ2hCLFVBQWtCLEVBQ2xCLGlCQUFvQyxFQUNwQyxFQUFFO1FBQ0YsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFhLENBQUM7UUFDakUsSUFBSSxRQUFRLEVBQUU7WUFDWixPQUFPLFFBQVEsQ0FBQztTQUNqQjtRQUVELE1BQU0sWUFBWSxHQUFHLElBQUksY0FBYyxDQUFDLEtBQUssRUFBRSxHQUFHLFVBQVUsUUFBUSxFQUFFO1lBQ3BFLE9BQU8sRUFBRSxhQUFhLENBQUMsV0FBVztZQUNsQyxPQUFPLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDN0IsS0FBSyxFQUFFLDJCQUEyQjtZQUNsQyxPQUFPLEVBQUUsU0FBUztTQUNuQixDQUFDLENBQUM7UUFFSCxNQUFNLHNCQUFzQixHQUMxQix3QkFBd0IsQ0FBQyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ2hFLE1BQU0scUJBQXFCLEdBQUcsd0JBQXdCLENBQUMsaUJBQWlCLENBQ3RFLGlCQUFpQixDQUFDLFNBQVMsQ0FDNUIsQ0FBQztRQUVGLFlBQVksQ0FBQyxjQUFjLENBQUMsb0JBQW9CLENBQzlDLElBQUksR0FBRyxDQUFDLGVBQWUsQ0FBQztZQUN0QixNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLO1lBQ3hCLE9BQU8sRUFBRSxDQUFDLGtCQUFrQixDQUFDO1lBQzdCLFNBQVMsRUFBRTtnQkFDVCw0QkFBNEIsc0JBQXNCLElBQUk7Z0JBQ3RELDRCQUE0QixxQkFBcUIsSUFBSTthQUN0RDtTQUNGLENBQUMsQ0FDSCxDQUFDO1FBRUYsT0FBTyxJQUFJLFFBQVEsQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFO1lBQ3JDLGNBQWMsRUFBRSxZQUFZO1NBQzdCLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBOb2RlanNGdW5jdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJztcbmltcG9ydCB7IER1cmF0aW9uIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFJ1bnRpbWUgYXMgTGFtYmRhUnVudGltZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgUHJvdmlkZXIgfSBmcm9tICdhd3MtY2RrLWxpYi9jdXN0b20tcmVzb3VyY2VzJztcbmltcG9ydCB7IGZpbGVVUkxUb1BhdGggfSBmcm9tICdub2RlOnVybCc7XG5pbXBvcnQgeyBCYWNrZW5kSWRlbnRpZmllciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgUGFyYW1ldGVyUGF0aENvbnZlcnNpb25zIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuXG5jb25zdCBmaWxlbmFtZSA9IGZpbGVVUkxUb1BhdGgoaW1wb3J0Lm1ldGEudXJsKTtcbmNvbnN0IGRpcm5hbWUgPSBwYXRoLmRpcm5hbWUoZmlsZW5hbWUpO1xuY29uc3QgcmVzb3VyY2VzUm9vdCA9IHBhdGgubm9ybWFsaXplKHBhdGguam9pbihkaXJuYW1lLCAnbGFtYmRhJykpO1xuY29uc3QgYmFja2VuZFNlY3JldExhbWJkYUZpbGVQYXRoID0gcGF0aC5qb2luKFxuICByZXNvdXJjZXNSb290LFxuICAnYmFja2VuZF9zZWNyZXRfZmV0Y2hlci5qcycsXG4pO1xuXG4vKipcbiAqIFRoZSBmYWN0b3J5IHRvIGNyZWF0ZSBzZWNyZXQtZmV0Y2hlciBwcm92aWRlci5cbiAqL1xuZXhwb3J0IGNsYXNzIEJhY2tlbmRTZWNyZXRGZXRjaGVyUHJvdmlkZXJGYWN0b3J5IHtcbiAgLyoqXG4gICAqIFJldHVybnMgYSByZXNvdXJjZSBwcm92aWRlciBpZiBpdCBleGlzdHMgaW4gdGhlIGlucHV0IHNjb3BlLiBPdGhlcndpc2UsXG4gICAqIGNyZWF0ZXMgYSBuZXcgcHJvdmlkZXIuXG4gICAqL1xuICBnZXRPckNyZWF0ZUluc3RhbmNlID0gKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgcHJvdmlkZXJJZDogc3RyaW5nLFxuICAgIGJhY2tlbmRJZGVudGlmaWVyOiBCYWNrZW5kSWRlbnRpZmllcixcbiAgKSA9PiB7XG4gICAgY29uc3QgcHJvdmlkZXIgPSBzY29wZS5ub2RlLnRyeUZpbmRDaGlsZChwcm92aWRlcklkKSBhcyBQcm92aWRlcjtcbiAgICBpZiAocHJvdmlkZXIpIHtcbiAgICAgIHJldHVybiBwcm92aWRlcjtcbiAgICB9XG5cbiAgICBjb25zdCBzZWNyZXRMYW1iZGEgPSBuZXcgTm9kZWpzRnVuY3Rpb24oc2NvcGUsIGAke3Byb3ZpZGVySWR9TGFtYmRhYCwge1xuICAgICAgcnVudGltZTogTGFtYmRhUnVudGltZS5OT0RFSlNfMThfWCxcbiAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLnNlY29uZHMoMTApLFxuICAgICAgZW50cnk6IGJhY2tlbmRTZWNyZXRMYW1iZGFGaWxlUGF0aCxcbiAgICAgIGhhbmRsZXI6ICdoYW5kbGVyJyxcbiAgICB9KTtcblxuICAgIGNvbnN0IGJhY2tlbmRQYXJhbWV0ZXJQcmVmaXggPVxuICAgICAgUGFyYW1ldGVyUGF0aENvbnZlcnNpb25zLnRvUGFyYW1ldGVyUHJlZml4KGJhY2tlbmRJZGVudGlmaWVyKTtcbiAgICBjb25zdCBzaGFyZWRQYXJhbWV0ZXJQcmVmaXggPSBQYXJhbWV0ZXJQYXRoQ29udmVyc2lvbnMudG9QYXJhbWV0ZXJQcmVmaXgoXG4gICAgICBiYWNrZW5kSWRlbnRpZmllci5uYW1lc3BhY2UsXG4gICAgKTtcblxuICAgIHNlY3JldExhbWJkYS5ncmFudFByaW5jaXBhbC5hZGRUb1ByaW5jaXBhbFBvbGljeShcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICBhY3Rpb25zOiBbJ3NzbTpHZXRQYXJhbWV0ZXInXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbXG4gICAgICAgICAgYGFybjphd3M6c3NtOio6KjpwYXJhbWV0ZXIke2JhY2tlbmRQYXJhbWV0ZXJQcmVmaXh9LypgLFxuICAgICAgICAgIGBhcm46YXdzOnNzbToqOio6cGFyYW1ldGVyJHtzaGFyZWRQYXJhbWV0ZXJQcmVmaXh9LypgLFxuICAgICAgICBdLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIHJldHVybiBuZXcgUHJvdmlkZXIoc2NvcGUsIHByb3ZpZGVySWQsIHtcbiAgICAgIG9uRXZlbnRIYW5kbGVyOiBzZWNyZXRMYW1iZGEsXG4gICAgfSk7XG4gIH07XG59XG4iXX0=