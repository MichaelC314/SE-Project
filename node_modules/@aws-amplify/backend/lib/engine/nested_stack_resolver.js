import { NestedStack } from 'aws-cdk-lib';
import { fileURLToPath } from 'node:url';
/**
 * Vends and caches nested stacks under a provided root stack
 */
export class NestedStackResolver {
    rootStack;
    attributionMetadataStorage;
    stacks = {};
    /**
     * Initialize with a root stack
     */
    constructor(rootStack, attributionMetadataStorage) {
        this.rootStack = rootStack;
        this.attributionMetadataStorage = attributionMetadataStorage;
    }
    /**
     * Proxy to getStackFor that appends attribution metadata for custom stacks
     */
    createCustomStack = (name) => {
        if (this.stacks[name]) {
            throw new Error(`Custom stack named ${name} has already been created`);
        }
        const stack = this.getStackFor(name);
        // this is safe even if stack is cached from an earlier invocation because storeAttributionMetadata is a noop if the stack description already exists
        this.attributionMetadataStorage.storeAttributionMetadata(stack, `custom`, fileURLToPath(new URL('../../package.json', import.meta.url)));
        return stack;
    };
    /**
     * Returns a cached NestedStack if resourceGroupName has been seen before
     * Otherwise, creates a new NestedStack, caches it and returns it
     */
    getStackFor = (resourceGroupName) => {
        if (!this.stacks[resourceGroupName]) {
            this.stacks[resourceGroupName] = new NestedStack(this.rootStack, resourceGroupName);
        }
        return this.stacks[resourceGroupName];
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmVzdGVkX3N0YWNrX3Jlc29sdmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2VuZ2luZS9uZXN0ZWRfc3RhY2tfcmVzb2x2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBUyxNQUFNLGFBQWEsQ0FBQztBQUVqRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBVXpDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLG1CQUFtQjtJQU9YO0lBQ0E7SUFQRixNQUFNLEdBQTBCLEVBQUUsQ0FBQztJQUVwRDs7T0FFRztJQUNILFlBQ21CLFNBQWdCLEVBQ2hCLDBCQUFzRDtRQUR0RCxjQUFTLEdBQVQsU0FBUyxDQUFPO1FBQ2hCLCtCQUEwQixHQUExQiwwQkFBMEIsQ0FBNEI7SUFDdEUsQ0FBQztJQUVKOztPQUVHO0lBQ0gsaUJBQWlCLEdBQUcsQ0FBQyxJQUFZLEVBQVMsRUFBRTtRQUMxQyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDckIsTUFBTSxJQUFJLEtBQUssQ0FBQyxzQkFBc0IsSUFBSSwyQkFBMkIsQ0FBQyxDQUFDO1NBQ3hFO1FBQ0QsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNyQyxxSkFBcUo7UUFDckosSUFBSSxDQUFDLDBCQUEwQixDQUFDLHdCQUF3QixDQUN0RCxLQUFLLEVBQ0wsUUFBUSxFQUNSLGFBQWEsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQzlELENBQUM7UUFDRixPQUFPLEtBQUssQ0FBQztJQUNmLENBQUMsQ0FBQztJQUVGOzs7T0FHRztJQUNILFdBQVcsR0FBRyxDQUFDLGlCQUF5QixFQUFTLEVBQUU7UUFDakQsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsRUFBRTtZQUNuQyxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsSUFBSSxXQUFXLENBQzlDLElBQUksQ0FBQyxTQUFTLEVBQ2QsaUJBQWlCLENBQ2xCLENBQUM7U0FDSDtRQUNELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBQ3hDLENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmVzdGVkU3RhY2ssIFN0YWNrIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgQXR0cmlidXRpb25NZXRhZGF0YVN0b3JhZ2UgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc3RvcmFnZSc7XG5pbXBvcnQgeyBmaWxlVVJMVG9QYXRoIH0gZnJvbSAnbm9kZTp1cmwnO1xuXG4vKipcbiAqIFZlbmRzIHN0YWNrcyBmb3IgYSByZXNvdXJjZSBncm91cGluZ1xuICovXG5leHBvcnQgdHlwZSBTdGFja1Jlc29sdmVyID0ge1xuICBnZXRTdGFja0ZvcjogKHJlc291cmNlR3JvdXBOYW1lOiBzdHJpbmcpID0+IFN0YWNrO1xuICBjcmVhdGVDdXN0b21TdGFjazogKG5hbWU6IHN0cmluZykgPT4gU3RhY2s7XG59O1xuXG4vKipcbiAqIFZlbmRzIGFuZCBjYWNoZXMgbmVzdGVkIHN0YWNrcyB1bmRlciBhIHByb3ZpZGVkIHJvb3Qgc3RhY2tcbiAqL1xuZXhwb3J0IGNsYXNzIE5lc3RlZFN0YWNrUmVzb2x2ZXIgaW1wbGVtZW50cyBTdGFja1Jlc29sdmVyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBzdGFja3M6IFJlY29yZDxzdHJpbmcsIFN0YWNrPiA9IHt9O1xuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIHdpdGggYSByb290IHN0YWNrXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJvb3RTdGFjazogU3RhY2ssXG4gICAgcHJpdmF0ZSByZWFkb25seSBhdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZTogQXR0cmlidXRpb25NZXRhZGF0YVN0b3JhZ2UsXG4gICkge31cblxuICAvKipcbiAgICogUHJveHkgdG8gZ2V0U3RhY2tGb3IgdGhhdCBhcHBlbmRzIGF0dHJpYnV0aW9uIG1ldGFkYXRhIGZvciBjdXN0b20gc3RhY2tzXG4gICAqL1xuICBjcmVhdGVDdXN0b21TdGFjayA9IChuYW1lOiBzdHJpbmcpOiBTdGFjayA9PiB7XG4gICAgaWYgKHRoaXMuc3RhY2tzW25hbWVdKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEN1c3RvbSBzdGFjayBuYW1lZCAke25hbWV9IGhhcyBhbHJlYWR5IGJlZW4gY3JlYXRlZGApO1xuICAgIH1cbiAgICBjb25zdCBzdGFjayA9IHRoaXMuZ2V0U3RhY2tGb3IobmFtZSk7XG4gICAgLy8gdGhpcyBpcyBzYWZlIGV2ZW4gaWYgc3RhY2sgaXMgY2FjaGVkIGZyb20gYW4gZWFybGllciBpbnZvY2F0aW9uIGJlY2F1c2Ugc3RvcmVBdHRyaWJ1dGlvbk1ldGFkYXRhIGlzIGEgbm9vcCBpZiB0aGUgc3RhY2sgZGVzY3JpcHRpb24gYWxyZWFkeSBleGlzdHNcbiAgICB0aGlzLmF0dHJpYnV0aW9uTWV0YWRhdGFTdG9yYWdlLnN0b3JlQXR0cmlidXRpb25NZXRhZGF0YShcbiAgICAgIHN0YWNrLFxuICAgICAgYGN1c3RvbWAsXG4gICAgICBmaWxlVVJMVG9QYXRoKG5ldyBVUkwoJy4uLy4uL3BhY2thZ2UuanNvbicsIGltcG9ydC5tZXRhLnVybCkpLFxuICAgICk7XG4gICAgcmV0dXJuIHN0YWNrO1xuICB9O1xuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGEgY2FjaGVkIE5lc3RlZFN0YWNrIGlmIHJlc291cmNlR3JvdXBOYW1lIGhhcyBiZWVuIHNlZW4gYmVmb3JlXG4gICAqIE90aGVyd2lzZSwgY3JlYXRlcyBhIG5ldyBOZXN0ZWRTdGFjaywgY2FjaGVzIGl0IGFuZCByZXR1cm5zIGl0XG4gICAqL1xuICBnZXRTdGFja0ZvciA9IChyZXNvdXJjZUdyb3VwTmFtZTogc3RyaW5nKTogU3RhY2sgPT4ge1xuICAgIGlmICghdGhpcy5zdGFja3NbcmVzb3VyY2VHcm91cE5hbWVdKSB7XG4gICAgICB0aGlzLnN0YWNrc1tyZXNvdXJjZUdyb3VwTmFtZV0gPSBuZXcgTmVzdGVkU3RhY2soXG4gICAgICAgIHRoaXMucm9vdFN0YWNrLFxuICAgICAgICByZXNvdXJjZUdyb3VwTmFtZSxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnN0YWNrc1tyZXNvdXJjZUdyb3VwTmFtZV07XG4gIH07XG59XG4iXX0=