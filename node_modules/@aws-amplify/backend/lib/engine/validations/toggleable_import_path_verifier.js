import path from 'path';
import * as os from 'os';
import { FilePathExtractor } from '@aws-amplify/platform-core';
/**
 * ImportPathVerifier that can be turned into a noop by passing `false` to the constructor
 */
export class ToggleableImportPathVerifier {
    doVerify;
    /**
     * Defaults to verifying, but can be turned into a noop by passing in false.
     */
    constructor(doVerify = true) {
        this.doVerify = doVerify;
    }
    /**
     * @inheritDoc
     */
    verify = (importStack, expectedImportSuffix, errorMessage) => {
        if (!this.doVerify) {
            return;
        }
        if (!importStack) {
            return;
        }
        // normalize EOL to \n so that parsing is consistent across platforms
        importStack = importStack.replaceAll(os.EOL, '\n');
        const stacktraceLines = importStack
            .split('\n')
            .map((line) => line.trim())
            .filter((line) => line.startsWith('at')) || [];
        if (stacktraceLines.length < 2) {
            return;
        }
        const stackTraceImportLine = stacktraceLines[1]; // the first entry is the file where the error was initialized (our code). The second entry is where the customer called our code which is what we are interested in
        const filePath = new FilePathExtractor(stackTraceImportLine).extract();
        if (!filePath) {
            // don't fail if for some reason we can't parse the stack trace
            return;
        }
        const parts = path.parse(filePath);
        const pathWithoutExtension = path.join(parts.dir, parts.name);
        if (!pathWithoutExtension.endsWith(expectedImportSuffix)) {
            throw new Error(errorMessage);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9nZ2xlYWJsZV9pbXBvcnRfcGF0aF92ZXJpZmllci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9lbmdpbmUvdmFsaWRhdGlvbnMvdG9nZ2xlYWJsZV9pbXBvcnRfcGF0aF92ZXJpZmllci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxLQUFLLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFL0Q7O0dBRUc7QUFDSCxNQUFNLE9BQU8sNEJBQTRCO0lBSVY7SUFIN0I7O09BRUc7SUFDSCxZQUE2QixXQUFXLElBQUk7UUFBZixhQUFRLEdBQVIsUUFBUSxDQUFPO0lBQUcsQ0FBQztJQUVoRDs7T0FFRztJQUNILE1BQU0sR0FBRyxDQUNQLFdBQStCLEVBQy9CLG9CQUE0QixFQUM1QixZQUFvQixFQUNkLEVBQUU7UUFDUixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNsQixPQUFPO1NBQ1I7UUFDRCxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ2hCLE9BQU87U0FDUjtRQUNELHFFQUFxRTtRQUNyRSxXQUFXLEdBQUcsV0FBVyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRW5ELE1BQU0sZUFBZSxHQUNuQixXQUFXO2FBQ1IsS0FBSyxDQUFDLElBQUksQ0FBQzthQUNYLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2FBQzFCLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNuRCxJQUFJLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzlCLE9BQU87U0FDUjtRQUNELE1BQU0sb0JBQW9CLEdBQUcsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsb0tBQW9LO1FBRXJOLE1BQU0sUUFBUSxHQUFHLElBQUksaUJBQWlCLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUV2RSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2IsK0RBQStEO1lBQy9ELE9BQU87U0FDUjtRQUVELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkMsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsb0JBQW9CLENBQUMsRUFBRTtZQUN4RCxNQUFNLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQy9CO0lBQ0gsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbXBvcnRQYXRoVmVyaWZpZXIgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IHsgRmlsZVBhdGhFeHRyYWN0b3IgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5cbi8qKlxuICogSW1wb3J0UGF0aFZlcmlmaWVyIHRoYXQgY2FuIGJlIHR1cm5lZCBpbnRvIGEgbm9vcCBieSBwYXNzaW5nIGBmYWxzZWAgdG8gdGhlIGNvbnN0cnVjdG9yXG4gKi9cbmV4cG9ydCBjbGFzcyBUb2dnbGVhYmxlSW1wb3J0UGF0aFZlcmlmaWVyIGltcGxlbWVudHMgSW1wb3J0UGF0aFZlcmlmaWVyIHtcbiAgLyoqXG4gICAqIERlZmF1bHRzIHRvIHZlcmlmeWluZywgYnV0IGNhbiBiZSB0dXJuZWQgaW50byBhIG5vb3AgYnkgcGFzc2luZyBpbiBmYWxzZS5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgZG9WZXJpZnkgPSB0cnVlKSB7fVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgdmVyaWZ5ID0gKFxuICAgIGltcG9ydFN0YWNrOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gICAgZXhwZWN0ZWRJbXBvcnRTdWZmaXg6IHN0cmluZyxcbiAgICBlcnJvck1lc3NhZ2U6IHN0cmluZyxcbiAgKTogdm9pZCA9PiB7XG4gICAgaWYgKCF0aGlzLmRvVmVyaWZ5KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghaW1wb3J0U3RhY2spIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8gbm9ybWFsaXplIEVPTCB0byBcXG4gc28gdGhhdCBwYXJzaW5nIGlzIGNvbnNpc3RlbnQgYWNyb3NzIHBsYXRmb3Jtc1xuICAgIGltcG9ydFN0YWNrID0gaW1wb3J0U3RhY2sucmVwbGFjZUFsbChvcy5FT0wsICdcXG4nKTtcblxuICAgIGNvbnN0IHN0YWNrdHJhY2VMaW5lcyA9XG4gICAgICBpbXBvcnRTdGFja1xuICAgICAgICAuc3BsaXQoJ1xcbicpXG4gICAgICAgIC5tYXAoKGxpbmUpID0+IGxpbmUudHJpbSgpKVxuICAgICAgICAuZmlsdGVyKChsaW5lKSA9PiBsaW5lLnN0YXJ0c1dpdGgoJ2F0JykpIHx8IFtdO1xuICAgIGlmIChzdGFja3RyYWNlTGluZXMubGVuZ3RoIDwgMikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBzdGFja1RyYWNlSW1wb3J0TGluZSA9IHN0YWNrdHJhY2VMaW5lc1sxXTsgLy8gdGhlIGZpcnN0IGVudHJ5IGlzIHRoZSBmaWxlIHdoZXJlIHRoZSBlcnJvciB3YXMgaW5pdGlhbGl6ZWQgKG91ciBjb2RlKS4gVGhlIHNlY29uZCBlbnRyeSBpcyB3aGVyZSB0aGUgY3VzdG9tZXIgY2FsbGVkIG91ciBjb2RlIHdoaWNoIGlzIHdoYXQgd2UgYXJlIGludGVyZXN0ZWQgaW5cblxuICAgIGNvbnN0IGZpbGVQYXRoID0gbmV3IEZpbGVQYXRoRXh0cmFjdG9yKHN0YWNrVHJhY2VJbXBvcnRMaW5lKS5leHRyYWN0KCk7XG5cbiAgICBpZiAoIWZpbGVQYXRoKSB7XG4gICAgICAvLyBkb24ndCBmYWlsIGlmIGZvciBzb21lIHJlYXNvbiB3ZSBjYW4ndCBwYXJzZSB0aGUgc3RhY2sgdHJhY2VcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwYXJ0cyA9IHBhdGgucGFyc2UoZmlsZVBhdGgpO1xuICAgIGNvbnN0IHBhdGhXaXRob3V0RXh0ZW5zaW9uID0gcGF0aC5qb2luKHBhcnRzLmRpciwgcGFydHMubmFtZSk7XG4gICAgaWYgKCFwYXRoV2l0aG91dEV4dGVuc2lvbi5lbmRzV2l0aChleHBlY3RlZEltcG9ydFN1ZmZpeCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UpO1xuICAgIH1cbiAgfTtcbn1cbiJdfQ==