import { AmplifyFault } from '@aws-amplify/platform-core';
import { GetObjectCommand, NoSuchBucket } from '@aws-sdk/client-s3';
/**
 * Handles fetching an object from an s3 bucket and parsing the object contents to a string
 */
export class S3StringObjectFetcher {
    s3Client;
    /**
     * Creates an S3StringObjectFetcher with the provided s3 client
     */
    constructor(s3Client) {
        this.s3Client = s3Client;
    }
    /**
     * Fetches an s3 object and converts its contents to a string
     */
    fetch = async (uri) => {
        const { bucket, key } = this.parseS3Uri(uri);
        try {
            const getSchemaCommandResult = await this.s3Client.send(new GetObjectCommand({ Bucket: bucket, Key: key }));
            const schema = await getSchemaCommandResult.Body?.transformToString();
            if (!schema) {
                // eslint-disable-next-line amplify-backend-rules/prefer-amplify-errors
                throw new Error('Error on parsing output schema');
            }
            return schema;
        }
        catch (caught) {
            if (caught instanceof NoSuchBucket) {
                throw new AmplifyFault('NoSuchBucketFault', {
                    message: `${bucket} does not exist. \n
            Try redeploying your changes again, if the error persists, create a bug report here: https://github.com/aws-amplify/amplify-backend/issues/new/choose`,
                }, caught);
            }
            else {
                throw caught;
            }
        }
    };
    parseS3Uri = (uri) => {
        const { hostname, pathname } = new URL(uri);
        return {
            bucket: hostname,
            key: pathname.replace('/', ''),
        };
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiczNfc3RyaW5nX29iamVjdF9mZXRjaGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3MzX3N0cmluZ19vYmplY3RfZmV0Y2hlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFlBQVksRUFBWSxNQUFNLG9CQUFvQixDQUFDO0FBRTlFOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHFCQUFxQjtJQUlIO0lBSDdCOztPQUVHO0lBQ0gsWUFBNkIsUUFBa0I7UUFBbEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtJQUFHLENBQUM7SUFFbkQ7O09BRUc7SUFDSCxLQUFLLEdBQUcsS0FBSyxFQUFFLEdBQVcsRUFBRSxFQUFFO1FBQzVCLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM3QyxJQUFJO1lBQ0YsTUFBTSxzQkFBc0IsR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUNyRCxJQUFJLGdCQUFnQixDQUFDLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FDbkQsQ0FBQztZQUNGLE1BQU0sTUFBTSxHQUFHLE1BQU0sc0JBQXNCLENBQUMsSUFBSSxFQUFFLGlCQUFpQixFQUFFLENBQUM7WUFDdEUsSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDWCx1RUFBdUU7Z0JBQ3ZFLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQzthQUNuRDtZQUNELE9BQU8sTUFBTSxDQUFDO1NBQ2Y7UUFBQyxPQUFPLE1BQU0sRUFBRTtZQUNmLElBQUksTUFBTSxZQUFZLFlBQVksRUFBRTtnQkFDbEMsTUFBTSxJQUFJLFlBQVksQ0FDcEIsbUJBQW1CLEVBQ25CO29CQUNFLE9BQU8sRUFBRSxHQUFHLE1BQU07a0tBQ29JO2lCQUN2SixFQUNELE1BQU0sQ0FDUCxDQUFDO2FBQ0g7aUJBQU07Z0JBQ0wsTUFBTSxNQUFNLENBQUM7YUFDZDtTQUNGO0lBQ0gsQ0FBQyxDQUFDO0lBRU0sVUFBVSxHQUFHLENBQUMsR0FBVyxFQUFtQyxFQUFFO1FBQ3BFLE1BQU0sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDNUMsT0FBTztZQUNMLE1BQU0sRUFBRSxRQUFRO1lBQ2hCLEdBQUcsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7U0FDL0IsQ0FBQztJQUNKLENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQW1wbGlmeUZhdWx0IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHsgR2V0T2JqZWN0Q29tbWFuZCwgTm9TdWNoQnVja2V0LCBTM0NsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5cbi8qKlxuICogSGFuZGxlcyBmZXRjaGluZyBhbiBvYmplY3QgZnJvbSBhbiBzMyBidWNrZXQgYW5kIHBhcnNpbmcgdGhlIG9iamVjdCBjb250ZW50cyB0byBhIHN0cmluZ1xuICovXG5leHBvcnQgY2xhc3MgUzNTdHJpbmdPYmplY3RGZXRjaGVyIHtcbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4gUzNTdHJpbmdPYmplY3RGZXRjaGVyIHdpdGggdGhlIHByb3ZpZGVkIHMzIGNsaWVudFxuICAgKi9cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBzM0NsaWVudDogUzNDbGllbnQpIHt9XG5cbiAgLyoqXG4gICAqIEZldGNoZXMgYW4gczMgb2JqZWN0IGFuZCBjb252ZXJ0cyBpdHMgY29udGVudHMgdG8gYSBzdHJpbmdcbiAgICovXG4gIGZldGNoID0gYXN5bmMgKHVyaTogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgeyBidWNrZXQsIGtleSB9ID0gdGhpcy5wYXJzZVMzVXJpKHVyaSk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGdldFNjaGVtYUNvbW1hbmRSZXN1bHQgPSBhd2FpdCB0aGlzLnMzQ2xpZW50LnNlbmQoXG4gICAgICAgIG5ldyBHZXRPYmplY3RDb21tYW5kKHsgQnVja2V0OiBidWNrZXQsIEtleToga2V5IH0pLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IHNjaGVtYSA9IGF3YWl0IGdldFNjaGVtYUNvbW1hbmRSZXN1bHQuQm9keT8udHJhbnNmb3JtVG9TdHJpbmcoKTtcbiAgICAgIGlmICghc2NoZW1hKSB7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBhbXBsaWZ5LWJhY2tlbmQtcnVsZXMvcHJlZmVyLWFtcGxpZnktZXJyb3JzXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRXJyb3Igb24gcGFyc2luZyBvdXRwdXQgc2NoZW1hJyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gc2NoZW1hO1xuICAgIH0gY2F0Y2ggKGNhdWdodCkge1xuICAgICAgaWYgKGNhdWdodCBpbnN0YW5jZW9mIE5vU3VjaEJ1Y2tldCkge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeUZhdWx0KFxuICAgICAgICAgICdOb1N1Y2hCdWNrZXRGYXVsdCcsXG4gICAgICAgICAge1xuICAgICAgICAgICAgbWVzc2FnZTogYCR7YnVja2V0fSBkb2VzIG5vdCBleGlzdC4gXFxuXG4gICAgICAgICAgICBUcnkgcmVkZXBsb3lpbmcgeW91ciBjaGFuZ2VzIGFnYWluLCBpZiB0aGUgZXJyb3IgcGVyc2lzdHMsIGNyZWF0ZSBhIGJ1ZyByZXBvcnQgaGVyZTogaHR0cHM6Ly9naXRodWIuY29tL2F3cy1hbXBsaWZ5L2FtcGxpZnktYmFja2VuZC9pc3N1ZXMvbmV3L2Nob29zZWAsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBjYXVnaHQsXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBjYXVnaHQ7XG4gICAgICB9XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgcGFyc2VTM1VyaSA9ICh1cmk6IHN0cmluZyk6IHsgYnVja2V0OiBzdHJpbmc7IGtleTogc3RyaW5nIH0gPT4ge1xuICAgIGNvbnN0IHsgaG9zdG5hbWUsIHBhdGhuYW1lIH0gPSBuZXcgVVJMKHVyaSk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGJ1Y2tldDogaG9zdG5hbWUsXG4gICAgICBrZXk6IHBhdGhuYW1lLnJlcGxhY2UoJy8nLCAnJyksXG4gICAgfTtcbiAgfTtcbn1cbiJdfQ==