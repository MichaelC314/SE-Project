import { createGraphqlModelsGenerator } from './create_graphql_models_generator.js';
import { createGraphqlTypesGenerator } from './create_graphql_types_generator.js';
import { createGraphqlDocumentGenerator } from './create_graphql_document_generator.js';
import { getOutputFileName } from '@aws-amplify/graphql-types-generator';
import path from 'path';
export var GenerateApiCodeFormat;
(function (GenerateApiCodeFormat) {
    GenerateApiCodeFormat["MODELGEN"] = "modelgen";
    GenerateApiCodeFormat["GRAPHQL_CODEGEN"] = "graphql-codegen";
    GenerateApiCodeFormat["INTROSPECTION"] = "introspection";
})(GenerateApiCodeFormat || (GenerateApiCodeFormat = {}));
export var GenerateApiCodeModelTarget;
(function (GenerateApiCodeModelTarget) {
    GenerateApiCodeModelTarget["JAVA"] = "java";
    GenerateApiCodeModelTarget["SWIFT"] = "swift";
    GenerateApiCodeModelTarget["JAVASCRIPT"] = "javascript";
    GenerateApiCodeModelTarget["TYPESCRIPT"] = "typescript";
    GenerateApiCodeModelTarget["DART"] = "dart";
})(GenerateApiCodeModelTarget || (GenerateApiCodeModelTarget = {}));
export var GenerateApiCodeStatementTarget;
(function (GenerateApiCodeStatementTarget) {
    GenerateApiCodeStatementTarget["JAVASCRIPT"] = "javascript";
    GenerateApiCodeStatementTarget["GRAPHQL"] = "graphql";
    GenerateApiCodeStatementTarget["FLOW"] = "flow";
    GenerateApiCodeStatementTarget["TYPESCRIPT"] = "typescript";
    GenerateApiCodeStatementTarget["ANGULAR"] = "angular";
})(GenerateApiCodeStatementTarget || (GenerateApiCodeStatementTarget = {}));
export var GenerateApiCodeTypeTarget;
(function (GenerateApiCodeTypeTarget) {
    GenerateApiCodeTypeTarget["JSON"] = "json";
    GenerateApiCodeTypeTarget["SWIFT"] = "swift";
    GenerateApiCodeTypeTarget["TYPESCRIPT"] = "typescript";
    GenerateApiCodeTypeTarget["FLOW"] = "flow";
    GenerateApiCodeTypeTarget["SCALA"] = "scala";
    GenerateApiCodeTypeTarget["FLOW_MODERN"] = "flow-modern";
    GenerateApiCodeTypeTarget["ANGULAR"] = "angular";
})(GenerateApiCodeTypeTarget || (GenerateApiCodeTypeTarget = {}));
/**
 * Generate api code using Api Code Generator with default generators.
 */
export const generateApiCode = async (props) => {
    const backendIdentifier = props;
    return new ApiCodeGenerator(createGraphqlDocumentGenerator({
        backendIdentifier,
        awsClientProvider: props.awsClientProvider,
    }), createGraphqlTypesGenerator({
        backendIdentifier,
        awsClientProvider: props.awsClientProvider,
    }), createGraphqlModelsGenerator({
        backendIdentifier,
        awsClientProvider: props.awsClientProvider,
    })).generate(props);
};
/**
 * Generator for Api Code resources.
 */
export class ApiCodeGenerator {
    graphqlDocumentGenerator;
    graphqlTypesGenerator;
    graphqlModelsGenerator;
    /**
     * Construct generator, passing in nested generators.
     * @param graphqlDocumentGenerator the graphql document generator
     * @param graphqlTypesGenerator the type generator
     * @param graphqlModelsGenerator the model object generator
     */
    constructor(graphqlDocumentGenerator, graphqlTypesGenerator, graphqlModelsGenerator) {
        this.graphqlDocumentGenerator = graphqlDocumentGenerator;
        this.graphqlTypesGenerator = graphqlTypesGenerator;
        this.graphqlModelsGenerator = graphqlModelsGenerator;
    }
    /**
     * Execute the generation.
     * @param props the required generate options.
     * @returns a promise with the generation results
     */
    generate(props) {
        switch (props.format) {
            case 'graphql-codegen': {
                return this.generateGraphqlCodegenApiCode(props);
            }
            case 'modelgen': {
                return this.generateModelgenApiCode(props);
            }
            case 'introspection': {
                return this.generateIntrospectionApiCode();
            }
            default:
                // eslint-disable-next-line amplify-backend-rules/prefer-amplify-errors
                throw new Error(`${props.format} is not a supported format.`);
        }
    }
    /**
     * Execute document, and optionally type generation with relevant targets, wiring through types into statements if possible.
     */
    async generateGraphqlCodegenApiCode(props) {
        const generateModelsParams = {
            targetFormat: props.statementTarget,
            maxDepth: props.maxDepth,
            typenameIntrospection: props.typeNameIntrospection,
        };
        if (props.statementTarget === GenerateApiCodeStatementTarget.TYPESCRIPT &&
            props.typeTarget === GenerateApiCodeTypeTarget.TYPESCRIPT) {
            // Cast to unknown to string since the original input to this is typed as a required string, but expects an optional
            // value, and we want to rely on that behavior.
            const typeOutputFilepath = getOutputFileName(null, props.typeTarget);
            const fileName = path.parse(typeOutputFilepath).name;
            // This is an node import path, so we don't want to use path.join, since that'll produce invalid paths on windows platforms
            // Hard-coding since this method explicitly writes to the same directory if types are enabled.
            generateModelsParams.relativeTypesPath = `./${fileName}`;
        }
        const documents = await this.graphqlDocumentGenerator.generateModels(generateModelsParams);
        if (props.typeTarget) {
            const types = await this.graphqlTypesGenerator.generateTypes({
                target: props.typeTarget,
                multipleSwiftFiles: props.multipleSwiftFiles,
                maxDepth: props.maxDepth,
                typenameIntrospection: props.typeNameIntrospection,
            });
            return {
                writeToDirectory: async (directoryPath) => {
                    const filesWritten = [];
                    const { filesWritten: documentsFilesWritten } = await documents.writeToDirectory(directoryPath);
                    const { filesWritten: typesFilesWritten } = await types.writeToDirectory(directoryPath);
                    filesWritten.push(...documentsFilesWritten, ...typesFilesWritten);
                    return {
                        filesWritten,
                    };
                },
                getResults: async () => ({
                    ...(await documents.getResults()),
                    ...(await types.getResults()),
                }),
            };
        }
        return documents;
    }
    /**
     * Execute model generation with model target.
     */
    async generateModelgenApiCode(props) {
        return this.graphqlModelsGenerator.generateModels({
            target: props.modelTarget,
            generateIndexRules: props.generateIndexRules,
            emitAuthProvider: props.emitAuthProvider,
            useExperimentalPipelinedTransformer: props.useExperimentalPipelinedTransformer,
            transformerVersion: props.transformerVersion,
            respectPrimaryKeyAttributesOnConnectionField: props.respectPrimaryKeyAttributesOnConnectionField,
            generateModelsForLazyLoadAndCustomSelectionSet: props.generateModelsForLazyLoadAndCustomSelectionSet,
            addTimestampFields: props.addTimestampFields,
            handleListNullabilityTransparently: props.handleListNullabilityTransparently,
        });
    }
    /**
     * Execute model generation with introspection target.
     */
    async generateIntrospectionApiCode() {
        return this.graphqlModelsGenerator.generateModels({
            target: 'introspection',
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVfYXBpX2NvZGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZ2VuZXJhdGVfYXBpX2NvZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBUUEsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDcEYsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDbEYsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDeEYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDekUsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBT3hCLE1BQU0sQ0FBTixJQUFZLHFCQUlYO0FBSkQsV0FBWSxxQkFBcUI7SUFDL0IsOENBQXFCLENBQUE7SUFDckIsNERBQW1DLENBQUE7SUFDbkMsd0RBQStCLENBQUE7QUFDakMsQ0FBQyxFQUpXLHFCQUFxQixLQUFyQixxQkFBcUIsUUFJaEM7QUFFRCxNQUFNLENBQU4sSUFBWSwwQkFNWDtBQU5ELFdBQVksMEJBQTBCO0lBQ3BDLDJDQUFhLENBQUE7SUFDYiw2Q0FBZSxDQUFBO0lBQ2YsdURBQXlCLENBQUE7SUFDekIsdURBQXlCLENBQUE7SUFDekIsMkNBQWEsQ0FBQTtBQUNmLENBQUMsRUFOVywwQkFBMEIsS0FBMUIsMEJBQTBCLFFBTXJDO0FBRUQsTUFBTSxDQUFOLElBQVksOEJBTVg7QUFORCxXQUFZLDhCQUE4QjtJQUN4QywyREFBeUIsQ0FBQTtJQUN6QixxREFBbUIsQ0FBQTtJQUNuQiwrQ0FBYSxDQUFBO0lBQ2IsMkRBQXlCLENBQUE7SUFDekIscURBQW1CLENBQUE7QUFDckIsQ0FBQyxFQU5XLDhCQUE4QixLQUE5Qiw4QkFBOEIsUUFNekM7QUFFRCxNQUFNLENBQU4sSUFBWSx5QkFRWDtBQVJELFdBQVkseUJBQXlCO0lBQ25DLDBDQUFhLENBQUE7SUFDYiw0Q0FBZSxDQUFBO0lBQ2Ysc0RB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QWdCLEVBQUUsS0FBSyxDQUFDLGdCQUFnQjtZQUN4QyxtQ0FBbUMsRUFDakMsS0FBSyxDQUFDLG1DQUFtQztZQUMzQyxrQkFBa0IsRUFBRSxLQUFLLENBQUMsa0JBQWtCO1lBQzVDLDRDQUE0QyxFQUMxQyxLQUFLLENBQUMsNENBQTRDO1lBQ3BELDhDQUE4QyxFQUM1QyxLQUFLLENBQUMsOENBQThDO1lBQ3RELGtCQUFrQixFQUFFLEtBQUssQ0FBQyxrQkFBa0I7WUFDNUMsa0NBQWtDLEVBQ2hDLEtBQUssQ0FBQyxrQ0FBa0M7U0FDM0MsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0ssS0FBSyxDQUFDLDRCQUE0QjtRQUN4QyxPQUFPLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxjQUFjLENBQUM7WUFDaEQsTUFBTSxFQUFFLGVBQWU7U0FDeEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRG9jdW1lbnRHZW5lcmF0aW9uUGFyYW1ldGVycyxcbiAgR2VuZXJhdGVHcmFwaHFsQ29kZWdlblRvRmlsZVJlc3VsdCxcbiAgR2VuZXJhdGlvblJlc3VsdCxcbiAgR3JhcGhxbERvY3VtZW50R2VuZXJhdG9yLFxuICBHcmFwaHFsTW9kZWxzR2VuZXJhdG9yLFxuICBHcmFwaHFsVHlwZXNHZW5lcmF0b3IsXG59IGZyb20gJy4vbW9kZWxfZ2VuZXJhdG9yLmpzJztcbmltcG9ydCB7IGNyZWF0ZUdyYXBocWxNb2RlbHNHZW5lcmF0b3IgfSBmcm9tICcuL2NyZWF0ZV9ncmFwaHFsX21vZGVsc19nZW5lcmF0b3IuanMnO1xuaW1wb3J0IHsgY3JlYXRlR3JhcGhxbFR5cGVzR2VuZXJhdG9yIH0gZnJvbSAnLi9jcmVhdGVfZ3JhcGhxbF90eXBlc19nZW5lcmF0b3IuanMnO1xuaW1wb3J0IHsgY3JlYXRlR3JhcGhxbERvY3VtZW50R2VuZXJhdG9yIH0gZnJvbSAnLi9jcmVhdGVfZ3JhcGhxbF9kb2N1bWVudF9nZW5lcmF0b3IuanMnO1xuaW1wb3J0IHsgZ2V0T3V0cHV0RmlsZU5hbWUgfSBmcm9tICdAYXdzLWFtcGxpZnkvZ3JhcGhxbC10eXBlcy1nZW5lcmF0b3InO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBEZXBsb3llZEJhY2tlbmRJZGVudGlmaWVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2RlcGxveWVkLWJhY2tlbmQtY2xpZW50JztcbmltcG9ydCB7IEFXU0NsaWVudFByb3ZpZGVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBBbXBsaWZ5Q2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWFtcGxpZnknO1xuaW1wb3J0IHsgQ2xvdWRGb3JtYXRpb25DbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtY2xvdWRmb3JtYXRpb24nO1xuaW1wb3J0IHsgUzNDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuXG5leHBvcnQgZW51bSBHZW5lcmF0ZUFwaUNvZGVGb3JtYXQge1xuICBNT0RFTEdFTiA9ICdtb2RlbGdlbicsXG4gIEdSQVBIUUxfQ09ERUdFTiA9ICdncmFwaHFsLWNvZGVnZW4nLFxuICBJTlRST1NQRUNUSU9OID0gJ2ludHJvc3BlY3Rpb24nLFxufVxuXG5leHBvcnQgZW51bSBHZW5lcmF0ZUFwaUNvZGVNb2RlbFRhcmdldCB7XG4gIEpBVkEgPSAnamF2YScsXG4gIFNXSUZUID0gJ3N3aWZ0JyxcbiAgSkFWQVNDUklQVCA9ICdqYXZhc2NyaXB0JyxcbiAgVFlQRVNDUklQVCA9ICd0eXBlc2NyaXB0JyxcbiAgREFSVCA9ICdkYXJ0Jyxcbn1cblxuZXhwb3J0IGVudW0gR2VuZXJhdGVBcGlDb2RlU3RhdGVtZW50VGFyZ2V0IHtcbiAgSkFWQVNDUklQVCA9ICdqYXZhc2NyaXB0JyxcbiAgR1JBUEhRTCA9ICdncmFwaHFsJyxcbiAgRkxPVyA9ICdmbG93JyxcbiAgVFlQRVNDUklQVCA9ICd0eXBlc2NyaXB0JyxcbiAgQU5HVUxBUiA9ICdhbmd1bGFyJyxcbn1cblxuZXhwb3J0IGVudW0gR2VuZXJhdGVBcGlDb2RlVHlwZVRhcmdldCB7XG4gIEpTT04gPSAnanNvbicsXG4gIFNXSUZUID0gJ3N3aWZ0JyxcbiAgVFlQRVNDUklQVCA9ICd0eXBlc2NyaXB0JyxcbiAgRkxPVyA9ICdmbG93JyxcbiAgU0NBTEEgPSAnc2NhbGEnLFxuICBGTE9XX01PREVSTiA9ICdmbG93LW1vZGVybicsXG4gIEFOR1VMQVIgPSAnYW5ndWxhcicsXG59XG5cbmV4cG9ydCB0eXBlIEdlbmVyYXRlTW9kZWxzT3B0aW9ucyA9IHtcbiAgZm9ybWF0OiBHZW5lcmF0ZUFwaUNvZGVGb3JtYXQuTU9ERUxHRU47XG4gIG1vZGVsVGFyZ2V0OiBHZW5lcmF0ZUFwaUNvZGVNb2RlbFRhcmdldDtcbiAgZ2VuZXJhdGVJbmRleFJ1bGVzPzogYm9vbGVhbjtcbiAgZW1pdEF1dGhQcm92aWRlcj86IGJvb2xlYW47XG4gIHVzZUV4cGVyaW1lbnRhbFBpcGVsaW5lZFRyYW5zZm9ybWVyPzogYm9vbGVhbjtcbiAgdHJhbnNmb3JtZXJWZXJzaW9uPzogbnVtYmVyO1xuICByZXNwZWN0UHJpbWFyeUtleUF0dHJpYnV0ZXNPbkNvbm5lY3Rpb25GaWVsZD86IGJvb2xlYW47XG4gIGdlbmVyYXRlTW9kZWxzRm9yTGF6eUxvYWRBbmRDdXN0b21TZWxlY3Rpb25TZXQ/OiBib29sZWFuO1xuICBhZGRUaW1lc3RhbXBGaWVsZHM/OiBib29sZWFuO1xuICBoYW5kbGVMaXN0TnVsbGFiaWxpdHlUcmFuc3BhcmVudGx5PzogYm9vbGVhbjtcbn07XG5cbmV4cG9ydCB0eXBlIEdlbmVyYXRlR3JhcGhxbENvZGVnZW5PcHRpb25zID0ge1xuICBmb3JtYXQ6IEdlbmVyYXRlQXBpQ29kZUZvcm1hdC5HUkFQSFFMX0NPREVHRU47XG4gIHN0YXRlbWVudFRhcmdldDogR2VuZXJhdGVBcGlDb2RlU3RhdGVtZW50VGFyZ2V0O1xuICBtYXhEZXB0aD86IG51bWJlcjtcbiAgdHlwZU5hbWVJbnRyb3NwZWN0aW9uPzogYm9vbGVhbjtcbiAgdHlwZVRhcmdldD86IEdlbmVyYXRlQXBpQ29kZVR5cGVUYXJnZXQ7XG4gIG11bHRpcGxlU3dpZnRGaWxlcz86IGJvb2xlYW47XG59O1xuXG5leHBvcnQgdHlwZSBHZW5lcmF0ZUludHJvc3BlY3Rpb25PcHRpb25zID0ge1xuICBmb3JtYXQ6IEdlbmVyYXRlQXBpQ29kZUZvcm1hdC5JTlRST1NQRUNUSU9OO1xufTtcblxuZXhwb3J0IHR5cGUgR2VuZXJhdGVPcHRpb25zID1cbiAgfCBHZW5lcmF0ZUdyYXBocWxDb2RlZ2VuT3B0aW9uc1xuICB8IEdlbmVyYXRlTW9kZWxzT3B0aW9uc1xuICB8IEdlbmVyYXRlSW50cm9zcGVjdGlvbk9wdGlvbnM7XG5cbmV4cG9ydCB0eXBlIEdlbmVyYXRlQXBpQ29kZVByb3BzID0gR2VuZXJhdGVPcHRpb25zICZcbiAgRGVwbG95ZWRCYWNrZW5kSWRlbnRpZmllciAmIHtcbiAgICBhd3NDbGllbnRQcm92aWRlcjogQVdTQ2xpZW50UHJvdmlkZXI8e1xuICAgICAgZ2V0QW1wbGlmeUNsaWVudDogQW1wbGlmeUNsaWVudDtcbiAgICAgIGdldENsb3VkRm9ybWF0aW9uQ2xpZW50OiBDbG91ZEZvcm1hdGlvbkNsaWVudDtcbiAgICAgIGdldFMzQ2xpZW50OiBTM0NsaWVudDtcbiAgICB9PjtcbiAgfTtcblxuLyoqXG4gKiBHZW5lcmF0ZSBhcGkgY29kZSB1c2luZyBBcGkgQ29kZSBHZW5lcmF0b3Igd2l0aCBkZWZhdWx0IGdlbmVyYXRvcnMuXG4gKi9cbmV4cG9ydCBjb25zdCBnZW5lcmF0ZUFwaUNvZGUgPSBhc3luYyAoXG4gIHByb3BzOiBHZW5lcmF0ZUFwaUNvZGVQcm9wcyxcbik6IFByb21pc2U8R2VuZXJhdGlvblJlc3VsdD4gPT4ge1xuICBjb25zdCBiYWNrZW5kSWRlbnRpZmllciA9IHByb3BzO1xuICByZXR1cm4gbmV3IEFwaUNvZGVHZW5lcmF0b3IoXG4gICAgY3JlYXRlR3JhcGhxbERvY3VtZW50R2VuZXJhdG9yKHtcbiAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgYXdzQ2xpZW50UHJvdmlkZXI6IHByb3BzLmF3c0NsaWVudFByb3ZpZGVyLFxuICAgIH0pLFxuICAgIGNyZWF0ZUdyYXBocWxUeXBlc0dlbmVyYXRvcih7XG4gICAgICBiYWNrZW5kSWRlbnRpZmllcixcbiAgICAgIGF3c0NsaWVudFByb3ZpZGVyOiBwcm9wcy5hd3NDbGllbnRQcm92aWRlcixcbiAgICB9KSxcbiAgICBjcmVhdGVHcmFwaHFsTW9kZWxzR2VuZXJhdG9yKHtcbiAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgYXdzQ2xpZW50UHJvdmlkZXI6IHByb3BzLmF3c0NsaWVudFByb3ZpZGVyLFxuICAgIH0pLFxuICApLmdlbmVyYXRlKHByb3BzKTtcbn07XG5cbi8qKlxuICogR2VuZXJhdG9yIGZvciBBcGkgQ29kZSByZXNvdXJjZXMuXG4gKi9cbmV4cG9ydCBjbGFzcyBBcGlDb2RlR2VuZXJhdG9yIHtcbiAgLyoqXG4gICAqIENvbnN0cnVjdCBnZW5lcmF0b3IsIHBhc3NpbmcgaW4gbmVzdGVkIGdlbmVyYXRvcnMuXG4gICAqIEBwYXJhbSBncmFwaHFsRG9jdW1lbnRHZW5lcmF0b3IgdGhlIGdyYXBocWwgZG9jdW1lbnQgZ2VuZXJhdG9yXG4gICAqIEBwYXJhbSBncmFwaHFsVHlwZXNHZW5lcmF0b3IgdGhlIHR5cGUgZ2VuZXJhdG9yXG4gICAqIEBwYXJhbSBncmFwaHFsTW9kZWxzR2VuZXJhdG9yIHRoZSBtb2RlbCBvYmplY3QgZ2VuZXJhdG9yXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGdyYXBocWxEb2N1bWVudEdlbmVyYXRvcjogR3JhcGhxbERvY3VtZW50R2VuZXJhdG9yLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZ3JhcGhxbFR5cGVzR2VuZXJhdG9yOiBHcmFwaHFsVHlwZXNHZW5lcmF0b3IsXG4gICAgcHJpdmF0ZSByZWFkb25seSBncmFwaHFsTW9kZWxzR2VuZXJhdG9yOiBHcmFwaHFsTW9kZWxzR2VuZXJhdG9yLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGUgdGhlIGdlbmVyYXRpb24uXG4gICAqIEBwYXJhbSBwcm9wcyB0aGUgcmVxdWlyZWQgZ2VuZXJhdGUgb3B0aW9ucy5cbiAgICogQHJldHVybnMgYSBwcm9taXNlIHdpdGggdGhlIGdlbmVyYXRpb24gcmVzdWx0c1xuICAgKi9cbiAgZ2VuZXJhdGUocHJvcHM6IEdlbmVyYXRlT3B0aW9ucyk6IFByb21pc2U8R2VuZXJhdGlvblJlc3VsdD4ge1xuICAgIHN3aXRjaCAocHJvcHMuZm9ybWF0KSB7XG4gICAgICBjYXNlICdncmFwaHFsLWNvZGVnZW4nOiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdlbmVyYXRlR3JhcGhxbENvZGVnZW5BcGlDb2RlKHByb3BzKTtcbiAgICAgIH1cbiAgICAgIGNhc2UgJ21vZGVsZ2VuJzoge1xuICAgICAgICByZXR1cm4gdGhpcy5nZW5lcmF0ZU1vZGVsZ2VuQXBpQ29kZShwcm9wcyk7XG4gICAgICB9XG4gICAgICBjYXNlICdpbnRyb3NwZWN0aW9uJzoge1xuICAgICAgICByZXR1cm4gdGhpcy5nZW5lcmF0ZUludHJvc3BlY3Rpb25BcGlDb2RlKCk7XG4gICAgICB9XG4gICAgICBkZWZhdWx0OlxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgYW1wbGlmeS1iYWNrZW5kLXJ1bGVzL3ByZWZlci1hbXBsaWZ5LWVycm9yc1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYCR7XG4gICAgICAgICAgICAocHJvcHMgYXMgR2VuZXJhdGVBcGlDb2RlUHJvcHMpLmZvcm1hdCBhcyBzdHJpbmdcbiAgICAgICAgICB9IGlzIG5vdCBhIHN1cHBvcnRlZCBmb3JtYXQuYCxcbiAgICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRXhlY3V0ZSBkb2N1bWVudCwgYW5kIG9wdGlvbmFsbHkgdHlwZSBnZW5lcmF0aW9uIHdpdGggcmVsZXZhbnQgdGFyZ2V0cywgd2lyaW5nIHRocm91Z2ggdHlwZXMgaW50byBzdGF0ZW1lbnRzIGlmIHBvc3NpYmxlLlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnZW5lcmF0ZUdyYXBocWxDb2RlZ2VuQXBpQ29kZShcbiAgICBwcm9wczogR2VuZXJhdGVHcmFwaHFsQ29kZWdlbk9wdGlvbnMsXG4gICk6IFByb21pc2U8R2VuZXJhdGlvblJlc3VsdD4ge1xuICAgIGNvbnN0IGdlbmVyYXRlTW9kZWxzUGFyYW1zOiBEb2N1bWVudEdlbmVyYXRpb25QYXJhbWV0ZXJzID0ge1xuICAgICAgdGFyZ2V0Rm9ybWF0OiBwcm9wcy5zdGF0ZW1lbnRUYXJnZXQsXG4gICAgICBtYXhEZXB0aDogcHJvcHMubWF4RGVwdGgsXG4gICAgICB0eXBlbmFtZUludHJvc3BlY3Rpb246IHByb3BzLnR5cGVOYW1lSW50cm9zcGVjdGlvbixcbiAgICB9O1xuICAgIGlmIChcbiAgICAgIHByb3BzLnN0YXRlbWVudFRhcmdldCA9PT0gR2VuZXJhdGVBcGlDb2RlU3RhdGVtZW50VGFyZ2V0LlRZUEVTQ1JJUFQgJiZcbiAgICAgIHByb3BzLnR5cGVUYXJnZXQgPT09IEdlbmVyYXRlQXBpQ29kZVR5cGVUYXJnZXQuVFlQRVNDUklQVFxuICAgICkge1xuICAgICAgLy8gQ2FzdCB0byB1bmtub3duIHRvIHN0cmluZyBzaW5jZSB0aGUgb3JpZ2luYWwgaW5wdXQgdG8gdGhpcyBpcyB0eXBlZCBhcyBhIHJlcXVpcmVkIHN0cmluZywgYnV0IGV4cGVjdHMgYW4gb3B0aW9uYWxcbiAgICAgIC8vIHZhbHVlLCBhbmQgd2Ugd2FudCB0byByZWx5IG9uIHRoYXQgYmVoYXZpb3IuXG4gICAgICBjb25zdCB0eXBlT3V0cHV0RmlsZXBhdGggPSBnZXRPdXRwdXRGaWxlTmFtZShcbiAgICAgICAgbnVsbCBhcyB1bmtub3duIGFzIHN0cmluZyxcbiAgICAgICAgcHJvcHMudHlwZVRhcmdldCxcbiAgICAgICk7XG4gICAgICBjb25zdCBmaWxlTmFtZSA9IHBhdGgucGFyc2UodHlwZU91dHB1dEZpbGVwYXRoKS5uYW1lO1xuICAgICAgLy8gVGhpcyBpcyBhbiBub2RlIGltcG9ydCBwYXRoLCBzbyB3ZSBkb24ndCB3YW50IHRvIHVzZSBwYXRoLmpvaW4sIHNpbmNlIHRoYXQnbGwgcHJvZHVjZSBpbnZhbGlkIHBhdGhzIG9uIHdpbmRvd3MgcGxhdGZvcm1zXG4gICAgICAvLyBIYXJkLWNvZGluZyBzaW5jZSB0aGlzIG1ldGhvZCBleHBsaWNpdGx5IHdyaXRlcyB0byB0aGUgc2FtZSBkaXJlY3RvcnkgaWYgdHlwZXMgYXJlIGVuYWJsZWQuXG4gICAgICBnZW5lcmF0ZU1vZGVsc1BhcmFtcy5yZWxhdGl2ZVR5cGVzUGF0aCA9IGAuLyR7ZmlsZU5hbWV9YDtcbiAgICB9XG4gICAgY29uc3QgZG9jdW1lbnRzID1cbiAgICAgIGF3YWl0IHRoaXMuZ3JhcGhxbERvY3VtZW50R2VuZXJhdG9yLmdlbmVyYXRlTW9kZWxzKGdlbmVyYXRlTW9kZWxzUGFyYW1zKTtcblxuICAgIGlmIChwcm9wcy50eXBlVGFyZ2V0KSB7XG4gICAgICBjb25zdCB0eXBlcyA9IGF3YWl0IHRoaXMuZ3JhcGhxbFR5cGVzR2VuZXJhdG9yLmdlbmVyYXRlVHlwZXMoe1xuICAgICAgICB0YXJnZXQ6IHByb3BzLnR5cGVUYXJnZXQsXG4gICAgICAgIG11bHRpcGxlU3dpZnRGaWxlczogcHJvcHMubXVsdGlwbGVTd2lmdEZpbGVzLFxuICAgICAgICBtYXhEZXB0aDogcHJvcHMubWF4RGVwdGgsXG4gICAgICAgIHR5cGVuYW1lSW50cm9zcGVjdGlvbjogcHJvcHMudHlwZU5hbWVJbnRyb3NwZWN0aW9uLFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHdyaXRlVG9EaXJlY3Rvcnk6IGFzeW5jIChcbiAgICAgICAgICBkaXJlY3RvcnlQYXRoOiBzdHJpbmcsXG4gICAgICAgICk6IFByb21pc2U8R2VuZXJhdGVHcmFwaHFsQ29kZWdlblRvRmlsZVJlc3VsdD4gPT4ge1xuICAgICAgICAgIGNvbnN0IGZpbGVzV3JpdHRlbjogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgICBjb25zdCB7IGZpbGVzV3JpdHRlbjogZG9jdW1lbnRzRmlsZXNXcml0dGVuIH0gPVxuICAgICAgICAgICAgYXdhaXQgZG9jdW1lbnRzLndyaXRlVG9EaXJlY3RvcnkoZGlyZWN0b3J5UGF0aCk7XG4gICAgICAgICAgY29uc3QgeyBmaWxlc1dyaXR0ZW46IHR5cGVzRmlsZXNXcml0dGVuIH0gPVxuICAgICAgICAgICAgYXdhaXQgdHlwZXMud3JpdGVUb0RpcmVjdG9yeShkaXJlY3RvcnlQYXRoKTtcbiAgICAgICAgICBmaWxlc1dyaXR0ZW4ucHVzaCguLi5kb2N1bWVudHNGaWxlc1dyaXR0ZW4sIC4uLnR5cGVzRmlsZXNXcml0dGVuKTtcblxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBmaWxlc1dyaXR0ZW4sXG4gICAgICAgICAgfTtcbiAgICAgICAgfSxcbiAgICAgICAgZ2V0UmVzdWx0czogYXN5bmMgKCkgPT4gKHtcbiAgICAgICAgICAuLi4oYXdhaXQgZG9jdW1lbnRzLmdldFJlc3VsdHMoKSksXG4gICAgICAgICAgLi4uKGF3YWl0IHR5cGVzLmdldFJlc3VsdHMoKSksXG4gICAgICAgIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4gZG9jdW1lbnRzO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGUgbW9kZWwgZ2VuZXJhdGlvbiB3aXRoIG1vZGVsIHRhcmdldC5cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2VuZXJhdGVNb2RlbGdlbkFwaUNvZGUoXG4gICAgcHJvcHM6IEdlbmVyYXRlTW9kZWxzT3B0aW9ucyxcbiAgKTogUHJvbWlzZTxHZW5lcmF0aW9uUmVzdWx0PiB7XG4gICAgcmV0dXJuIHRoaXMuZ3JhcGhxbE1vZGVsc0dlbmVyYXRvci5nZW5lcmF0ZU1vZGVscyh7XG4gICAgICB0YXJnZXQ6IHByb3BzLm1vZGVsVGFyZ2V0LFxuICAgICAgZ2VuZXJhdGVJbmRleFJ1bGVzOiBwcm9wcy5nZW5lcmF0ZUluZGV4UnVsZXMsXG4gICAgICBlbWl0QXV0aFByb3ZpZGVyOiBwcm9wcy5lbWl0QXV0aFByb3ZpZGVyLFxuICAgICAgdXNlRXhwZXJpbWVudGFsUGlwZWxpbmVkVHJhbnNmb3JtZXI6XG4gICAgICAgIHByb3BzLnVzZUV4cGVyaW1lbnRhbFBpcGVsaW5lZFRyYW5zZm9ybWVyLFxuICAgICAgdHJhbnNmb3JtZXJWZXJzaW9uOiBwcm9wcy50cmFuc2Zvcm1lclZlcnNpb24sXG4gICAgICByZXNwZWN0UHJpbWFyeUtleUF0dHJpYnV0ZXNPbkNvbm5lY3Rpb25GaWVsZDpcbiAgICAgICAgcHJvcHMucmVzcGVjdFByaW1hcnlLZXlBdHRyaWJ1dGVzT25Db25uZWN0aW9uRmllbGQsXG4gICAgICBnZW5lcmF0ZU1vZGVsc0ZvckxhenlMb2FkQW5kQ3VzdG9tU2VsZWN0aW9uU2V0OlxuICAgICAgICBwcm9wcy5nZW5lcmF0ZU1vZGVsc0ZvckxhenlMb2FkQW5kQ3VzdG9tU2VsZWN0aW9uU2V0LFxuICAgICAgYWRkVGltZXN0YW1wRmllbGRzOiBwcm9wcy5hZGRUaW1lc3RhbXBGaWVsZHMsXG4gICAgICBoYW5kbGVMaXN0TnVsbGFiaWxpdHlUcmFuc3BhcmVudGx5OlxuICAgICAgICBwcm9wcy5oYW5kbGVMaXN0TnVsbGFiaWxpdHlUcmFuc3BhcmVudGx5LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGUgbW9kZWwgZ2VuZXJhdGlvbiB3aXRoIGludHJvc3BlY3Rpb24gdGFyZ2V0LlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnZW5lcmF0ZUludHJvc3BlY3Rpb25BcGlDb2RlKCk6IFByb21pc2U8R2VuZXJhdGlvblJlc3VsdD4ge1xuICAgIHJldHVybiB0aGlzLmdyYXBocWxNb2RlbHNHZW5lcmF0b3IuZ2VuZXJhdGVNb2RlbHMoe1xuICAgICAgdGFyZ2V0OiAnaW50cm9zcGVjdGlvbicsXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==